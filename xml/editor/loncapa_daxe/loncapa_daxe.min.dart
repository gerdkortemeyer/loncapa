import "dart:html";import "dart:collection";import "dart:async";import "dart:math";import "dart:js";import "dart:typed_data";const BX='mangledGlobalNames';const CX='mangledNames';const DX='metadata';const EX='getIsolateTag';class nS{static const String FX="Chrome";static const String GX="Firefox";static const String HX="Internet Explorer";static const String IX="Opera";static const String JX="Safari";final String DV;final String minimumVersion;const nS(this.DV,[this.minimumVersion]);}class oS{const oS();}class pS{final String name;const pS(this.name);}class qS{const qS();}class rS{const rS();}class VF{static String fP="LocalStrings";static HashMap<String,String> nM=null;static String gJ;static const oM='en';static Future<bool> sS(){Completer<bool> i=new Completer<bool>();bQ().then((String k){if(k!=null)gJ=k;else gJ=oM;String m=gJ.split('_')[0];String o="${fP}_${m}.properties";HttpRequest g=new HttpRequest();g.open("GET",o);g.onLoad.listen((ProgressEvent s){String v=g.responseText;nM=new HashMap<String,String>();List<String> BB=v.split("\n");for(String h in BB){if(h.startsWith('#'))continue;int j=h.indexOf('=');if(j==-1)continue;String EB=h.substring(0,j).trim();String HB=h.substring(j+1).trim();nM[EB]=HB;}i.complete(true);});g.onError.listen((ProgressEvent s){i.completeError("Error when reading the strings in ${fP}");});g.send();});return (i.future);}static String FH(String g){return (nM[g]);}}class hJ{static int gP=0;String XZ;String wK;GD action;String id;bool enabled;bool selected;StreamSubscription<MouseEvent> listener;hJ(this.XZ,this.wK,this.action,{this.enabled: true,this.selected: false}){id="lcdbutton_${gP}";gP++ ;}Element html(){DivElement g=new DivElement();g.id=id;g.classes.add('lcdbutton');if(!enabled)g.classes.add('lcdbutton-disabled');if(selected)g.classes.add('lcdbutton-selected');g.setAttribute('title',XZ);ImageElement h=new ImageElement();h.setAttribute('src','images/'+wK);if(enabled)listener=g.onClick.listen((MouseEvent i)=>action());g.append(h);return (g);}String get title{return (XZ);}void set title(String g){XZ=g;Element h=oB();h.setAttribute('title',XZ);}Element oB(){return (querySelector("#${id}"));}void disable(){if(!enabled)return;enabled=false;Element g=oB();g.classes.add('lcdbutton-disabled');listener.cancel();}void enable(){if(enabled)return;enabled=true;Element g=oB();g.classes.remove('lcdbutton-disabled');listener=g.onClick.listen((MouseEvent h)=>action());}void select(){if(selected)return;selected=true;Element g=oB();g.classes.add('lcdbutton-selected');}void xE(){if(!selected)return;selected=false;Element g=oB();g.classes.remove('lcdbutton-selected');}}class NL extends jJ{static List<String> tS=['if','unless','else','elsif','while','until','for','each','foreach','next','last','break','continue','return','my','our','local','state','BEGIN','END','package','sub','do','given ','when ','default','__END__','__DATA__','__FILE__','__LINE__','__PACKAGE__'];NL.OX(l g):super.QX(g);NL.PX(AB g,n h):super.RX(g,h){if(firstChild is OB&&firstChild.nextSibling==null){firstChild.replaceWith(new pG(firstChild.nodeValue));}}Element html(){Element h=super.html();if(firstChild==null||firstChild.nextSibling!=null||firstChild is!pG)return h;if(state!=2&&BI){DivElement i=h.lastChild;i.classes.add('perl-text');DivElement g=OV();i.style.position='relative';g.style.position='absolute';g.style.top='0px';g.style.left='0px';i.append(g);}return h;}Element OV(){final String SB='\$@%&abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_';final String JB='0123456789';DivElement j=new DivElement();j.classes.add('perl-colored');String QB=firstChild.nodeValue;StringBuffer g=new StringBuffer();bool k=false;bool m=false;bool v=false;bool o=false;bool BB=false;String EB;int HB=0;while(HB<QB.length){String i=QB[HB];if(!o&&!m&&(SB.contains(i)||k&&JB.contains(i)||k&&i=='#'&&g.toString()[g.length-1]=='\$')){if(!k){if(g.length>0){j.append(new Text(g.toString()));g.clear();}k=true;}}else if(!o&&!k&&!m&&(JB.contains(i)||(i=='.'&&v))){if(!v){if(g.length>0){j.append(new Text(g.toString()));g.clear();}v=true;}}else{if(k){String s=g.toString();SpanElement h=new SpanElement();if(tS.contains(s))h.classes.add('keyword');else if(s.startsWith('\$')||s.startsWith('@')||s.startsWith('%'))h.classes.add('variable');else if(s.startsWith('&')||i=='(')h.classes.add('function-call');else h.classes.add('name');h.appendText(s);j.append(h);g.clear();k=false;}else if(v){SpanElement h=new SpanElement();h.classes.add('number');h.appendText(g.toString());j.append(h);g.clear();v=false;}else if(m&&(i=='\n'||i=='\r')){SpanElement h=new SpanElement();h.classes.add('comment');h.appendText(g.toString());j.append(h);g.clear();m=false;}if(!m&&(i=='"'||i=="'")&&!BB){if(o){if(i==EB){j.append(new Text(EB));SpanElement h=new SpanElement();h.classes.add('string');h.appendText(g.toString().substring(1));j.append(h);g.clear();o=false;}}else{if(g.length>0){j.append(new Text(g.toString()));g.clear();}EB=i;o=true;}}else if(!o&&i=='#'){if(g.length>0){j.append(new Text(g.toString()));g.clear();}m=true;}}if(o){if(i=='\\')BB=!BB;else if(BB)BB=false;}g.write(i);HB++ ;}if(g.length>0){if(m){SpanElement h=new SpanElement();h.classes.add('comment');h.appendText(g.toString());j.append(h);}else j.append(new Text(g.toString()));}return (j);}}class OL extends n{static String pM='c, pi, e, hbar, amu';static JsObject qM;static JsObject rM;OL.MX(l g):super.vX(g){}OL.NX(AB g,n h):super.qX(g,h){}Element html(){Element g;if(nodeName=='dlm')g=new DivElement();else g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('math');if(!valid)g.classes.add('invalid');g.onClick.listen((MouseEvent h)=>KS());JL(g);return (g);}void HP(GD g){g();KS();}q QE(){return (null);}q SF(){return (null);}void SO(){Element g=document.getElementById(id);JL(g);}void JL(Element g){String j='?';if(firstChild!=null&&firstChild.nodeValue.trim()!='')j=firstChild.nodeValue;JsObject h;if(getAttribute('mode')=='units'){if(rM==null)rM=new JsObject(context['LCMATH']['Parser'],[true,true,pM]);h=rM;}else{if(qM==null)qM=new JsObject(context['LCMATH']['Parser'],[true,false,pM]);h=qM;}for(Node m in g.childNodes)m.remove();try {JsObject k=h.callMethod('parse',[j]);if(k!=null){Element i=document.createElement('math');i.setAttribute('display',nodeName=='dlm'?'block':'inline');JsObject o=new JsObject.jsify(['#000000']);i.append(k.callMethod('toMathML',[o]));g.append(i);Timer.run((){JsArray s=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],id]);context['MathJax']['Hub'].callMethod('Queue',[s]);context['MathJax']['Hub'].callMethod('Queue',[()=>IB.cursor.refresh()]);});}}catch (v){g.text='Error: '+v.toString();}}void KS(){Element s=document.getElementById(id);if(s==null)return;Element h;if(nodeName=='dlm')h=new DivElement();else h=new SpanElement();h.id=id;TextInputElement g=new TextInputElement();g.classes.add('math');g.setAttribute('data-unit_mode',getAttribute('mode')=='units'?'true':'false');g.setAttribute('data-constants',pM);g.setAttribute('data-implicit_operators','true');g.setAttribute('spellcheck','false');if(firstChild!=null){g.value=firstChild.nodeValue;if(g.value.length>20)g.size=g.value.length;}h.append(g);SelectElement i=new SelectElement();OptionElement m=new OptionElement();m.value='symbols';m.appendText(VF.FH('lm_symbols'));if(getAttribute('mode')!='units')m.setAttribute('selected','selected');i.append(m);OptionElement o=new OptionElement();o.value='units';o.appendText(VF.FH('lm_units'));if(getAttribute('mode')=='units')o.setAttribute('selected','selected');i.append(o);i.onInput.listen((Event k){if(i.value=='symbols'&&getAttribute('mode')=='units'){setAttribute('mode','symbols');g.setAttribute('data-unit_mode','false');context['LCMATH'].callMethod('initEditors');}else if(i.value=='units'&&getAttribute('mode')!='units'){setAttribute('mode','units');g.setAttribute('data-unit_mode','true');context['LCMATH'].callMethod('initEditors');}g.focus();});h.append(i);s.replaceWith(h);g.focus();context['LCMATH'].callMethod('initEditors');var v=(){String j=g.value;if(j!=''){if(firstChild!=null)firstChild.nodeValue=j;else jB(new OB(j));}else{if(firstChild!=null)gC(firstChild);}h.replaceWith(html());};g.onBlur.listen((Event k){Timer.run((){if(document.activeElement==i)return;v();});});i.onBlur.listen((Event k){Timer.run((){if(document.activeElement==g)return;v();});});if(h is DivElement){h.onClick.listen((MouseEvent k){if(k.target!=g&&k.target!=i){IB.KD(new q(parent,parent.ZB(this)+1));}});}g.onKeyDown.listen((KeyboardEvent k){String j=g.value;int BB=g.size;if(j!=null&&j.length>BB)g.size=j.length;});}}class iJ extends n{iJ.KX(l g):super.vX(g){}iJ.LX(AB g,n h):super.qX(g,h){}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.classes.add('tex');g.onClick.listen((MouseEvent h)=>bR(()=>JL()));return (g);}void HP(GD g){bR(()=>g());}q QE(){return (null);}q SF(){return (null);}void SO(){JL();}void JL(){String g='?';if(firstChild!=null&&firstChild.nodeValue.trim()!='')g=firstChild.nodeValue;JsObject j=context['MathJax']['Hub']['Queue'];SpanElement h=document.getElementById(id);h.text=WR(g);JsArray i=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],id]);context['MathJax']['Hub'].callMethod('Queue',[i]);}void bR([GD g]){sM h=new sM(this,g);h.show();}String WR(String g){bool i=false;JsObject j=context['MathJax']['Hub']['Queue'];if(nodeName=='dtm')g="\\[${g}\\]";else g="\\(${g}\\)";g=g.replaceAllMapped(new RegExp(r'\$[a-zA-Z]*[0-9]*(\[[^\]]*\])?'),(h){return "\\mathtt{${h.group(0)}}";});return (g);}}class jJ extends n{List<l> IE;int state;HashMap<String,SD> sH;HashMap<aB,TextInputElement> UG;bool BI;hJ iK;hJ jK;hJ hK;jJ.QX(l g):super.vX(g){state=0;yE();}jJ.RX(AB j,n k):super.qX(j,k){n g=firstChild;while(g!=null){n i=g.nextSibling;if(g is qF){if(g.previousSibling is OB&&g.previousSibling.nodeValue=='\n')gC(g.previousSibling);if(g.nextSibling is OB&&g.nextSibling.nodeValue=='\n'){i=g.nextSibling.nextSibling;gC(g.nextSibling);}String h;if(g.firstChild!=null)h=g.firstChild.nodeValue;else h=null;if(h!=null)insertBefore(new OB(h),g);gC(g);}g=i;}normalize();state=1;yE();NG();}void yE(){IE=t.CB.fE(DB);if(IE!=null&&IE.length>0)sH=new HashMap<String,SD>();UG=null;BI=t.CB.PE(DB)||t.CB.XC(DB).length>0;}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.classes.add('lcdblock');DivElement k=new DivElement();k.classes.add('lcdblock-header');DivElement o=new DivElement();DivElement m=new DivElement();m.classes.add('lcd-button-box');hK=new hJ(VF.FH('lcdblock_collapsed'),'block_collapsed.png',(){JV();},selected:(state==2));m.append(hK.html());jK=new hJ(VF.FH('lcdblock_normal'),'block_normal.png',(){JW();},selected:(state==1));m.append(jK.html());iK=new hJ(VF.FH('lcdblock_editable'),'block_editable.png',(){cR();},enabled:IE!=null&&IE.length>0,selected:(state==0));m.append(iK.html());o.append(m);SpanElement s=new SpanElement();s.classes.add('lcdblock-title');String EB=t.CB.OD(DB);if(EB==null)EB=nodeName;s.append(new Text(EB));s.onDoubleClick.listen((MouseEvent cB){IB.selectNode(this);});o.append(s);o.append(iP(DB,null));k.append(o);if(state==0){TableElement v=new TableElement();v.classes.add('expand');for(l hB in IE){v.append(TO(hB));}for(aB j in attributes){bool QB=false;for(l SB in IE){if(j.localName==t.CB.attributeName(SB)&&j.pB==t.CB.attributeNamespace(SB)){QB=true;break;}}if(!QB){v.append(sW(j));}}k.append(v);}else if(state==1){DivElement h=new DivElement();h.classes.add('lcdblock-attributes');for(aB j in attributes){h.append(new Text(" "));Element HB=new SpanElement();HB.attributes['class']='attribute_name';HB.text=j.localName;h.append(HB);h.append(new Text("="));Element JB=new SpanElement();JB.attributes['class']='attribute_value';JB.text=j.value;h.append(JB);}h.onClick.listen((MouseEvent cB){cR();});k.append(h);}g.append(k);if(state!=2&&BI){DivElement i=new DivElement();i.id='contents-'+id;i.classes.add('indent');i.classes.add('lcdblock-content');hM(i);n BB=firstChild;while(BB!=null){i.append(BB.html());BB=BB.nextSibling;}if(lastChild==null||lastChild.nodeType==n.mB)i.appendText('\n');g.append(i);}return (g);}void BF(List<n> i){super.BF(i);if(BI&&state!=2){DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');}}void vI(){if(state==0){DivElement m=oB();TableElement o=querySelector("#${id}>table");int k=0;for(l h in IE){String i=t.CB.PH(DB,h);String g=getAttribute(i);String j=t.CB.dF(h);if(g==null){if(j!=null)g=j;else g='';}sH[i].iM(g);k++ ;}lF();}}Element dD(){if(state==2||!BI)return (null);return (document.getElementById('contents-'+id));}bool RE(){return (true);}bool RG(){return (BI);}void JE([GD g]){state=0;if(dD()!=null)sD();if(g!=null)g();}q QE(){if(BI)return (new q(this,0));else return (null);}q SF(){if(BI)return (new q(this,PB));else return (null);}void cR(){iK.select();jK.xE();hK.xE();state=0;sD();if(IE.length>0){String g=t.CB.PH(DB,IE.first);sH[g].focus();}}void JW(){iK.xE();jK.select();hK.xE();state=1;sD();}void JV(){iK.xE();jK.xE();hK.select();state=2;sD();}TableRowElement TO(l h){String o=t.CB.PH(DB,h);TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');if(t.CB.vG(DB,h)!=null){ButtonElement v=iP(DB,h);g.append(v);}j.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.fK(DB,h);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');j.append(g);g=new TableCellElement();g.classes.add('expand');String k=getAttribute(o);String s=t.CB.dF(h);if(k==null){if(s!=null)k=s;else k='';}SD m;m=new SD.yY(DB,h,k,valueChanged:()=>ZO(h,m),catchUndo:true);sH[o]=m;Element i=m.html();if(i.firstChild is TextInputElement)(i.firstChild as TextInputElement).classes.add('form_field');else if(i.firstChild is DataListElement&&i.firstChild.nextNode is TextInputElement)(i.firstChild.nextNode as TextInputElement).classes.add('form_field');g.append(i);j.append(g);g=new TableCellElement();g.classes.add('shrink');j.append(g);return (j);}TableRowElement sW(aB i){if(UG==null)UG=new HashMap<aB,TextInputElement>();TextInputElement h=new TextInputElement();h.spellcheck=false;h.size=40;h.value=i.value;h.classes.add('invalid');h.onInput.listen((Event k)=>RR(i,h));h.onKeyUp.listen((KeyboardEvent k)=>RR(i,h));UG[i]=h;TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');j.append(g);g=new TableCellElement();g.classes.add('shrink');g.appendText(i.name);j.append(g);g=new TableCellElement();g.classes.add('expand');g.append(h);j.append(g);g=new TableCellElement();g.classes.add('shrink');j.append(g);return (j);}void ZO(l j,SD m){String h=m.hF();String k=t.CB.PH(DB,j);String i=t.CB.dF(j);aB g;if((h==''&&i==null)||h==i)g=new aB(k,null);else if(h!=''||i!=null)g=new aB(k,h);else g=null;if(g!=null)t.DC(new GB.tX(this,g,updateDisplay:false));lF();}void RR(aB g,TextInputElement k){String h=k.value;if(getAttributeNS(g.pB,g.localName)!=h){String j=g.name;aB i;if(h=='')i=new aB(j,null);else i=new aB(j,h);t.DC(new GB.tX(this,i,updateDisplay:false));lF();}}static ButtonElement iP(final l i,final l j){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';if(j==null){String h=t.CB.wH(i);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.UX(i)).show());}else{String h=t.CB.vG(i,j);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.WX(j,i)).show());}return (g);}}void main(){ND.aT();SL('lcdblock',(l g)=>new jJ.QX(g),(AB h,n i)=>new jJ.RX(h,i));SL('texmathjax',(l g)=>new iJ.KX(g),(AB h,n i)=>new iJ.LX(h,i));SL('lm',(l g)=>new OL.MX(g),(AB h,n i)=>new OL.NX(h,i));SL('perl',(l g)=>new NL.OX(g),(AB h,n i)=>new NL.PX(h,i));Future.wait([LB.LU(),VF.sS(),yS('templates.xml')]).then((List k){uS().then((QB){WF m=xS();if(m!=null)IB.toolbar.add(m);l j=t.CB.hG('m');if(j!=null){jD o=new jD();MC EB=new MC(VF.FH('tex_equation'),'images/tex.png',()=>t.CI(j,'element'),OI.CN,data:new wC([j],null,null));o.add(EB);IB.toolbar.add(o);}Element HB=querySelector('.toolbar');HB.replaceWith(IB.toolbar.html());IB.RO();IB.LC();if(k[2] is sB){Element s=document.getElementsByClassName('menubar')[0];if(t.SH.indexOf('&url=')!=-1){uB JB=new uB(LB.MB('menu.save'),()=>vS(),shortcut:'S');WB v=IB.yF.VH[0];v.add(JB);s.firstChild.replaceWith(IB.yF.OM(v));}WB BB=zS(k[2]);IB.yF.add(BB);s.append(IB.yF.OM(BB));IB.LC();}else print("Error reading templates file, could not build the menu.");});});}class sM{iJ u;GD YZ;sM(this.u,[this.YZ]){}void show(){DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement o=new DivElement();o.classes.add('dlg2');DivElement s=new DivElement();s.classes.add('dlg3');FormElement i=new FormElement();TextAreaElement g=new TextAreaElement();g.id='eqtext';if(u.firstChild!=null)g.value=u.firstChild.nodeValue.trim();g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event v)=>input());i.append(g);DivElement BB=new DivElement();BB.id='preview';i.append(BB);DivElement j=new DivElement();j.classes.add('buttons');ButtonElement k=new ButtonElement();k.attributes['type']='button';k.appendText(LB.MB("button.Cancel"));k.onClick.listen((MouseEvent v)=>h.remove());j.append(k);ButtonElement m=new ButtonElement();m.attributes['type']='submit';m.appendText(LB.MB("button.OK"));m.onClick.listen((MouseEvent v)=>iF(v));j.append(m);i.append(j);s.append(i);o.append(s);h.append(o);document.body.append(h);g.focus();input();}void iF(MouseEvent h){TextAreaElement i=querySelector('textarea#eqtext');String g=i.value;if(g!=''){if(u.firstChild!=null)u.firstChild.nodeValue=g;else u.jB(new OB(g));}else{if(u.firstChild!=null)u.gC(u.firstChild);}querySelector('div#dlg1').remove();if(h!=null)h.preventDefault();if(YZ!=null)YZ();}void input(){TextAreaElement g=querySelector('textarea#eqtext');String h=g.value;DivElement i=document.getElementById('preview');i.text=u.WR(h);JsArray j=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],'preview']);context['MathJax']['Hub'].callMethod('Queue',[j]);}}Future uS(){Completer i=new Completer();t=new PL();IB=new zM();String k=null;String h=null;String m=null;Location o=window.location;String j=o.search;if(j.startsWith('?'))j=j.substring(1);List<String> s=j.split('&');for(String v in s){List<String> g=v.split('=');if(g.length!=2)continue;if(g[0]=='config')h=g[1];else if(g[0]=='file')k=Uri.decodeComponent(g[1]);else if(g[0]=='save')m=g[1];}if(m!=null)t.CL=m;if(h!=null&&k!=null)IB.KP(k,h).then((BB)=>i.complete());else if(h!=null)IB.FP(h).then((BB)=>i.complete());else{window.alert(LB.MB('daxe.missing_config'));i.completeError(LB.MB('daxe.missing_config'));}return (i.future);}void vS(){wS().then((h){window.alert(LB.MB('save.success'));},onError:(CD g){window.alert(LB.MB('save.error')+': '+g.message);});}Future wS(){int i=t.SH.indexOf('&url=');if(i==-1)return (new Future.error(new CD('bad URL')));String h=t.SH.substring(i+5);h=Uri.decodeQueryComponent(h);i=h.lastIndexOf('/');String m;if(i==-1)m=h;else{m=h.substring(i+1);h=h.substring(0,i+1);}Completer o=new Completer();String k='AaB03x';HttpRequest j=new HttpRequest();j.onLoad.listen((ProgressEvent s){o.complete();});j.onError.listen((ProgressEvent s){o.completeError(new CD(j.status.toString()));});j.open('POST','/upload_file');j.setRequestHeader('Content-Type',"multipart/form-data; boundary=${k}");StringBuffer g=new StringBuffer();g.write("--${k}\r\n");g.write('Content-Disposition: form-data; name="uploads_path"\r\n');g.write('Content-type: text/plain; charset=UTF-8\r\n');g.write('Content-transfer-encoding: 8bit\r\n\r\n');g.write(h);g.write("\r\n--${k}\r\n");g.write('Content-Disposition: form-data; name="uploads"; filename="${m}"\r\n');g.write('Content-Type: application/octet-stream\r\n\r\n');t.rC.nF='UTF-8';g.write(t.toString());g.write('\r\n--${k}--\r\n\r\n');j.send(g.toString());return (o.future);}WF xS(){WB j=new WB(VF.FH('Section'));List<l> g=t.CB.nK('section');if(g==null||g.length==0)return (null);l o=t.CB.hG('h1');for(String k in ['introduction','conclusion','prerequisites','objectives','reminder','definition','demonstration','example','advise','remark','warning','more_information','method','activity','bibliography','citation']){uB h=new uB(VF.FH(k),null,data:new wC(g,null,null));h.action=(){wC s=h.data;l v=s.cH;n i=ND.NF(v);i.setAttribute('class','role-'+k);n m=ND.NF(o);if(t.BS(i,IB.vC())){t.insertNode(m,new q(i,0));IB.cursor.moveTo(new q(m,0));IB.LC();}};j.add(h);}WF BB=new WF(j,OI.kT,IB.toolbar);return (BB);}Future<sB> yS(String g){EG h=new EG();return (h.AL(g));}WB zS(sB i){WB h=new WB(VF.FH('Templates'));l j=i.documentElement;for(AB g in j.childNodes){if(g.nodeType==AB.FE&&g.nodeName=='menu'){h.add(hP(g));}}return (h);}WB hP(l j){String k=VF.gJ;String m=VF.oM;String h;for(AB g in j.childNodes){if(g.nodeType==AB.FE&&g.nodeName=='title'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){h=g.firstChild.nodeValue;break;}else if((g as l).getAttribute('lang')==m){h=g.firstChild.nodeValue;}}}}if(h==null)h='?';WB i=new WB(h);for(AB g in j.childNodes){if(g.nodeType==AB.FE){if(g.nodeName=='menu'){i.add(hP(g));}else if(g.nodeName=='item'){i.add(AT(g));}}}return (i);}uB AT(l v){String k=VF.gJ;String m=VF.oM;String o,j,h,i;for(AB g in v.childNodes){if(g.nodeType==AB.FE){if(g.nodeName=='title'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){h=g.firstChild.nodeValue;}else if(h==null&&(g as l).getAttribute('lang')==m){h=g.firstChild.nodeValue;}}}else if(g.nodeName=='path'&&g.firstChild!=null&&g.firstChild.nodeType==AB.kE){o=g.firstChild.nodeValue;}else if(g.nodeName=='type'&&g.firstChild!=null&&g.firstChild.nodeType==AB.kE){j=g.firstChild.nodeValue;}else if(g.nodeName=='help'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){i=g.firstChild.nodeValue;}else if(i==null&&(g as l).getAttribute('lang')==m){i=g.firstChild.nodeValue;}}}}}if(j==null){print("Warning: missing type for template ${h}\n");j='problem';}l BB=t.CB.hG(j);uB s=new uB(h,()=>BT(o),data:BB);if(i!=null)s.KI=i;return s;}void BT(String k){try {EG m=new EG();m.AL(k).then((sB o){l g=o.documentElement;if(g==null)return;t.VS(g);n h=ND.fH(g,null);GB i;q j=IB.vC();if(h.nodeName=='loncapa'&&t.nI()!=null)i=t.LE(h,j,checkValidity:true);else i=new GB.oX(j,h);t.DC(i);IB.LC();});}on UD catch (s){window.alert(s.toString());}}abstract class CT{static const int tM=61;static const int DT=13;static const int ET=10;static const int FT=76;static const String GT="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";static const String HT="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";static String KT(List<int> k,[bool JB=false,bool BB=false]){int o=k.length;if(o==0){return "";}final String j=JB?HT:GT;final int s=o.remainder(3);final int QB=o-s;int v=((o~/3)*4)+((s>0)?4:0);if(BB){v+= ((v-1)~/FT)<<1;}List<int> g=new List<int>(v);int h=0,m=0,EB=0;while(m<QB){int i=((k[m++ ]<<16)&0xFFFFFF)|((k[m++ ]<<8)&0xFFFFFF)|k[m++ ];g[h++ ]=j.codeUnitAt(i>>18);g[h++ ]=j.codeUnitAt((i>>12)&0x3F);g[h++ ]=j.codeUnitAt((i>>6)&0x3F);g[h++ ]=j.codeUnitAt(i&0x3f);if(BB&& ++EB==19&&h<v-2){g[h++ ]=DT;g[h++ ]=ET;EB=0;}}if(s==1){int i=k[m];g[h++ ]=j.codeUnitAt(i>>2);g[h++ ]=j.codeUnitAt((i<<4)&0x3F);g[h++ ]=tM;g[h++ ]=tM;}else if(s==2){int i=k[m];int HB=k[m+1];g[h++ ]=j.codeUnitAt(i>>2);g[h++ ]=j.codeUnitAt(((i<<4)|(HB>>4))&0x3F);g[h++ ]=j.codeUnitAt((HB<<2)&0x3F);g[h++ ]=tM;}return new String.fromCharCodes(g);}}class IT{static String JT(List<int> g,{bool urlSafe: false,bool addLineSeparator: false}){return CT.KT(g,urlSafe,addLineSeparator);}}class jD extends lG{List<MC> HG;jD(){HG=new List<MC>();}add(MC g){HG.add(g);}insert(MC g,int h){HG.insert(h,g);}remove(int g){HG.remove(g);}get length{return (HG.length);}Element html(){DivElement g=new DivElement();g.classes.add('toolbar-box');for(MC h in HG){g.append(h.html());}return (g);}}class uD extends MapBase<String,String>{LinkedHashMap<String,String> map;uD(String h){map=new LinkedHashMap<String,String>();if(h!=null){for(String k in h.split(';')){List<String> g=k.split(':');if(g.length==2){String i=g[0].trim().toLowerCase();String j=g[1].trim().toLowerCase();if(i!=''&&j!='')map[i]=j;}}}}String operator[](String g)=>map[g];void operator[]=(String g,String h){map[g]=h;}String remove(String g){return (map.remove(g));}Iterable<String> get keys{return (map.keys);}void clear(){map.clear;}String toString(){List<String> g=new List<String>();map.forEach((String h,String i)=>g.add(h+': '+i));return (g.join('; '));}bool UV(uD g){List<String> j=keys;List<String> k=g.map.keys;return (j.every((String h)=>map[h]==g.map[h])&&k.every((String i)=>map[i]==g.map[i]));}}class OI{List<lG> items;List<l> WO=null;static final String MD='packages/daxe/images/toolbar/';OI([HH g]){items=new List<lG>();if(t.CL!=null){jD cB=new jD();cB.add(new MC(LB.MB('menu.save'),MD+'document_save.png',()=>IB.save(),null));items.add(cB);}jD QB=new jD();QB.add(new MC(LB.MB('undo.undo'),MD+'history_undo.png',()=>t.aH(),null,data:"undo",enabled:false));QB.add(new MC(LB.MB('undo.redo'),MD+'history_redo.png',()=>t.cM(),null,data:"redo",enabled:false));items.add(QB);jD hB=new jD();hB.add(new MC(LB.MB('find.find_replace'),MD+'find.png',()=>(new jP()).show(),null));items.add(hB);if(g!=null){jD m=new jD();List<l> h=g.yG('fichier');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_image.png');}h=g.yG('equationmem');if(h!=null&&h.length>0){cK(g,m,h,MD+'equation.png');}h=g.yG('symbole2');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_symbol.png');}h=g.yG('tabletexte');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_table.png');}h=g.yG('liste');if(h!=null&&h.length>0){cK(g,m,h,MD+'ul.png');}items.add(m);List<l> o=iC.HU();List<l> s=iC.IU();if(o.length>0||s.length>0){jD BB=new jD();if(o.length>0){MC i=new MC(ZZ(o[0]),MD+'ul.png',null,oP,data:new wC(o,null,null));i.action=(){if(i.selected)iC.QN();else iC.FQ((i.data as wC).cH);};BB.add(i);}if(s.length>0){MC i=new MC(ZZ(s[0]),MD+'ol.png',null,oP,data:new wC(s,null,null));i.action=(){if(i.selected)iC.QN();else iC.FQ((i.data as wC).cH);};BB.add(i);}BB.add(new MC(LB.MB('toolbar.rise_list_level'),MD+'list_rise_level.png',()=>iC.QN(),eT,data:'rise_list_level'));bool SB=true;for(l IC in o)if(t.CB.fF(iC.cL(IC),o)==null)SB=false;for(l QD in s)if(t.CB.fF(iC.cL(QD),s)==null)SB=false;if(SB)BB.add(new MC(LB.MB('toolbar.lower_list_level'),MD+'list_lower_level.png',()=>iC.FU(),fT,data:'lower_list_level'));items.add(BB);}List<l> EB=oG.uT();if(EB!=null&&EB.length>0){jD JB=new jD();MC i=new MC(LB.MB('toolbar.insert_link'),MD+'add_link.png',null,gT,data:new wC(EB,null,null));i.action=()=>oG.vT((i.data as wC).cH);JB.add(i);i=new MC(LB.MB('toolbar.remove_link'),MD+'remove_link.png',()=>oG.AU(),hT,data:new wC(EB,null,null));JB.add(i);i=new MC(LB.MB('toolbar.insert_anchor'),MD+'anchor.png',null,CN,data:new wC(EB,null,null));i.action=()=>oG.zT((i.data as wC).cH);JB.add(i);items.add(JB);}jD j=new jD();List<l> tD=g.uU();for(l k in tD){String qE=g.fO(k);if(qE=='style'){String v=g.bC(k,'style',null);if(v=='GRAS'){OJ(g,j,k,MD+'style_bold.png','B');}else if(v=='ITALIQUE'){OJ(g,j,k,MD+'style_italic.png','I');}else if(v=='EXPOSANT'){OJ(g,j,k,MD+'style_superscript.png');}else if(v=='INDICE'){OJ(g,j,k,MD+'style_subscript.png');}else if(v=='BARRE'){OJ(g,j,k,MD+'style_strikethrough.png');}else if(v=='SOULIGNE'){OJ(g,j,k,MD+'style_underline.png');}}}if(j.length>0){j.add(new MC(LB.MB('toolbar.remove_styles'),MD+'remove_styles.png',()=>zB.eL(),null,data:"remove_styles"));items.add(j);}if(t.ZC!=null){String MF=t.CB.bC(t.ZC[0],'styleAtt','style');List<l> WG=t.CB.fE(t.ZC[0]);bool CC=false;for(l NI in WG){if(t.CB.attributeName(NI)==MF){CC=true;break;}}if(CC){jD HB=new jD();NM(HB,'text-align','left',LB.MB('toolbar.align_left'),MD+'align_left.png');NM(HB,'text-align','right',LB.MB('toolbar.align_right'),MD+'align_right.png');NM(HB,'text-align','center',LB.MB('toolbar.align_center'),MD+'align_center.png');NM(HB,'text-align','justify',LB.MB('toolbar.align_justify'),MD+'align_justify.png');items.add(HB);}}l eJ=YE.EQ();if(eJ!=null){List<String> fJ=['serif','sans-serif','cursive','fantasy','monospace'];WF ML=aZ(LB.MB('toolbar.font'),"font-family",fJ);items.add(ML);}}}WF aZ(String BB,String h,List<String> EB,[String s]){WB k=new WB(BB);k.parent=this;l i=YE.EQ();for(String v in EB){String j=v;if(s!=null)j+= s;uB m=new uB(v,null,data:new wC([i],h,j));m.action=(){if(m.checked){q g=IB.vC();q HB=IB.GF();if(g==HB&&g.u is OB&&g.u.parent.DB==i&&(g.u.parent as zB).CH(h,j)&&g.KB==g.u.PB&&g.u.nextSibling==null){n o=g.u.parent;IB.KD(new q(o.parent,o.parent.ZB(o)+1));IB.LC();}else zB.eL(i,h);}else{zB.JU(i,h,j);}};k.add(m);}WF JB=new WF(k,iT,this);return (JB);}add(lG g){items.add(g);}insert(lG g,int h){items.insert(h,g);}remove(int g){items.remove(g);}List<MC> get HG{List<MC> g=new List<MC>();for(lG h in items){if(h is jD)g.addAll(h.HG);}return (g);}List<l> dR(){if(WO!=null)return (WO);List<l> h=new List<l>();for(lG i in items){if(i is jD){for(MC j in i.HG){if(j.data is wC){wC g=j.data;if(g.kF!=null)h.addAll(g.kF);}}}else if(i is WF){WB m=i.pI;for(uB k in m.items){if(k.data is wC){wC g=k.data;if(g.kF!=null)h.addAll(g.kF);}}}}WO=h;return (h);}Element html(){DivElement g=new DivElement();g.classes.add('toolbar');for(lG h in items){g.append(h.html());}return (g);}String ZZ(l h){String g=t.CB.wH(h);if(g==null)g=t.CB.OD(h);return (g);}cK(HH k,jD i,List<l> h,String j){MC g=new MC(ZZ(h[0]),j,null,CN,data:new wC(h,null,null));g.action=()=>t.CI((g.data as wC).cH,'element');i.add(g);}static void CN(MC g,n j,n k,List<l> i,List<l> m){wC h=g.data;List<l> o=h.kF;if(h.rK(i))g.enable();else g.disable();}OJ(HH v,jD k,l h,String m,[String o=null]){MC i=new MC(ZZ(h),m,null,cT,data:new wC([h],null,null),shortcut:o);i.action=(){if(i.selected){q g=IB.vC();q s=IB.GF();if(g==s&&g.u is OB&&g.u.parent.DB==h&&g.KB==g.u.PB&&g.u.nextSibling==null){n j=g.u.parent;IB.KD(new q(j.parent,j.parent.ZB(j)+1));IB.LC();}else zB.eL(h);}else{zB.KQ(h);}};k.add(i);}static void cT(MC g,n v,n h,List<l> m,List<l> o){wC i=g.data;List<l> j=i.kF;bool k=false;for(l s in j){if(o.contains(s)){k=true;break;}}if(k){g.enable();g.select();}else{if(h!=null&&j.contains(h.DB))g.select();else g.xE();if(i.rK(m))g.enable();else g.disable();}}NM(jD j,String g,String i,String k,String m){MC h=new MC(k,m,null,dT,data:new wC(t.ZC,g,i));h.action=(){if(h.selected){kB.tT(g);}else{kB.yT(g,i);}};j.add(h);}static void dT(MC g,n m,n j,List<l> o,List<l> s){wC i=g.data;bool k=false;for(n h=m;h!=null;h=h.parent){if(t.ZC.contains(h.DB)){if((h as kB).CH(i.jI,i.RJ)){k=true;break;}}}if(k){g.enable();g.select();}else{if(j!=null&&t.ZC.contains(j.DB)&&(j as kB).CH(i.jI,i.RJ)){g.select();}else{g.xE();}if(kB.dL().length>0)g.enable();else g.disable();}}static void oP(MC g,n k,n s,List<l> m,List<l> v){wC i=g.data;List<l> o=i.kF;bool j=false;for(n h=k;h!=null;h=h.parent){if(o.contains(h.DB)){j=true;break;}}if(j){g.enable();g.select();}else{g.xE();if(i.rK(m))g.enable();else g.disable();}}static void eT(MC h,n j,n k,List<l> m,List<l> o){q i=IB.vC();n g=i.u;while(g!=null&&g is!xD)g=g.parent;if(g!=null)h.enable();else h.disable();}static void fT(MC h,n j,n k,List<l> m,List<l> o){q i=IB.vC();n g=i.u;while(g!=null&&g is!xD)g=g.parent;if(g==null||g.previousSibling==null)h.disable();else h.enable();}static void gT(MC g,n j,n k,List<l> h,List<l> m){wC i=g.data;if(IB.vC().u is OB&&i.rK(h))g.enable();else g.disable();}static void hT(MC g,n o,n s,List<l> v,List<l> i){wC j=g.data;List<l> k=j.kF;bool h=false;for(l m in k){if(i.contains(m)){h=true;break;}}if(h)g.enable();else g.disable();}static void iT(WF HB,n JB,n j,List<l> v,List<l> QB){WB BB=HB.pI;uB k=null;for(uB g in BB.items){if(g.data is wC){wC EB=g.data;l h=EB.kF[0];String o=EB.jI;String s=EB.RJ;if(t.ZC.contains(h)){bool m=false;for(n i=JB;i!=null;i=i.parent){if(t.ZC.contains(i.DB)&&(i as kB).CH(o,s)){m=true;break;}}if(m){g.enable();k=g;g.check();}else{if(j!=null&&t.ZC.contains(j.DB)&&(j as kB).CH(o,s)){k=g;g.check();}else{g.dS();}if(kB.dL().length>0)g.enable();else g.disable();}}else if(t.CB.fO(h)=='style'){if(QB.contains(h)){g.enable();k=g;}else{if(j!=null&&h==j.DB)k=g;if(v.contains(h))g.enable();else g.disable();}}else if(t.CB.fO(h)=='stylespan'){bool m=false;for(n i=JB;i!=null;i=i.parent){if(i.DB==h&&(i as YE).CH(o,s)){m=true;break;}}if(m){g.enable();k=g;g.check();}else{if(j!=null&&h==j.DB&&(j as YE).CH(o,s)){k=g;g.check();}else{g.dS();}if(v.contains(h))g.enable();else g.disable();}}else if(h!=null){if(v.contains(h))g.enable();else g.disable();}}}if(k==null)BB.title=HB.title;else BB.title=k.title;}static void kT(WF j,n o,n s,List<l> k,List<l> v){WB m=j.pI;for(uB g in m.items){if(g.data is wC){wC h=g.data;List<l> i=h.kF;if(i!=null&&i.length>0){if(h.rK(k))g.enable();else g.disable();}}}}void update(n i,List<l> s){List<l> j=new List<l>();for(n h=i;h!=null;h=h.parent)j.add(h.DB);n k=null;q g=IB.vC();q v=IB.GF();if(g.u is!OB&&g.u.PB>g.KB){if(v==new q(g.u,g.KB+1))k=g.u.eB(g.KB);}for(MC m in HG){if(m.update!=null)m.update(m,i,k,s,j);}for(lG o in items){if(o is WF){o.update(o,i,k,s,j);}}}}abstract class lG{Element html();}class uM{n RF;l DB;List<l> IE;HashMap<l,SD> controls;HashMap<aB,TextInputElement> UG;GD okfct;uM(this.RF,[this.okfct]){DB=RF.DB;controls=new HashMap<l,SD>();UG=null;}void show(){DivElement s=new DivElement();s.id='attributes_dlg';s.classes.add('dlg1');DivElement SB=new DivElement();SB.classes.add('dlg2');DivElement v=new DivElement();v.classes.add('dlg3');DivElement m=new DivElement();m.classes.add('dlgtitle');m.text=t.CB.OD(DB);v.append(m);FormElement cB=new FormElement();TableElement hB=new TableElement();IE=t.CB.fE(DB);SD BB=null;for(l h in IE){TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();String QD=t.CB.vG(DB,h);if(QD!=null){ButtonElement j=new ButtonElement();j.attributes['type']='button';j.classes.add('help');j.value='?';j.text='?';j.title=QD;j.onClick.listen((Event CC)=>tO(h,DB));g.append(j);}i.append(g);g=new TableCellElement();String WG=t.CB.PH(DB,h);String m=t.CB.fK(DB,h);g.appendText(m);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');i.append(g);g=new TableCellElement();String EB=RF.getAttribute(WG);String tD=t.CB.dF(h);if(EB==null){if(tD!=null)EB=tD;else EB='';}SD IC=new SD.yY(DB,h,EB);controls[h]=IC;List<String> qE=t.CB.hI(h);if(qE==null||qE.length==0)if(BB==null)BB=IC;g.append(IC.html());i.append(g);hB.append(i);}for(aB o in RF.attributes){bool MF=false;for(l h in controls.keys){if(o.localName==t.CB.attributeName(h)&&o.pB==t.CB.attributeNamespace(h)){MF=true;break;}}if(!MF){if(UG==null)UG=new HashMap<aB,TextInputElement>();TextInputElement k=new TextInputElement();k.spellcheck=false;k.size=40;k.value=o.value;k.classes.add('invalid');UG[o]=k;TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();i.append(g);g=new TableCellElement();g.appendText(o.name);i.append(g);g=new TableCellElement();g.append(k);i.append(g);hB.append(i);}}cB.append(hB);DivElement HB=new DivElement();HB.classes.add('buttons');ButtonElement JB=new ButtonElement();JB.attributes['type']='button';JB.appendText(LB.MB("button.Cancel"));JB.onClick.listen((MouseEvent CC)=>cancel());HB.append(JB);ButtonElement QB=new ButtonElement();QB.attributes['type']='submit';QB.appendText(LB.MB("button.OK"));QB.onClick.listen((MouseEvent CC)=>iF(CC));HB.append(QB);cB.append(HB);v.append(cB);SB.append(v);s.append(SB);document.body.append(s);if(BB!=null)BB.focus();}void iF(MouseEvent v){for(l h in controls.keys){SD k=controls[h];String g=k.hF();bool EB=t.CB.BL(DB,h);if(g==''&&EB){v.preventDefault();window.alert(LB.MB('attribute.missing_required'));return;}}LinkedHashMap<String,aB> j=RF.gR();for(l h in controls.keys){SD k=controls[h];String i=t.CB.PH(DB,h);String g=k.hF();String m=t.CB.attributeNamespace(h);String o=t.CB.dF(h);if((g==''&&o==null)||g==o)j.remove(i);else if(g!=''||o!=null)j[i]=new aB.cX(m,i,g);}if(UG!=null){for(aB s in UG.keys){TextInputElement HB=UG[s];String i=s.name;String g=HB.value;String m=s.pB;if(g=='')j.remove(i);else j[i]=new aB.cX(m,i,g);}}querySelector('div#attributes_dlg').remove();v.preventDefault();List<aB> BB=new List.from(j.values);if(RF.oB()!=null){GB JB=new GB.sX(RF,BB);t.DC(JB);}else{RF.attributes=BB;}IB.AH();if(okfct!=null)okfct();}void cancel(){querySelector('div#attributes_dlg').remove();IB.AH();}void tO(l g,l h){XG i=new XG.WX(g,h);i.show();}}class wC{List<l> kF;l cH;String jI;String RJ;wC(this.kF,this.jI,this.RJ){assert(kF!=null&&kF.length>0&&(jI==null||RJ!=null));cH=null;}String get css{if(jI==null)return (null);return ("${jI}: ${RJ}");}bool rK(List<l> h){for(l g in kF){if(h.contains(g)){cH=g;return (true);}}cH=null;return (false);}}class CD implements Exception{final String message;final Exception parentException;const CD([this.message,this.parentException]);String toString(){String g;if(message==null)g='DaxeException';else g=message;if(parentException!=null)g="${g} (parent exception: ${parentException})";return (g);}}class WE{String language;String uH;WE(){List<String> g=LB.hL.split('_');language=g[0];if(g.length>1)uH=g[1];else uH=null;}WE.VX(String g){this.language=g;this.uH=null;}WE.aX(String g,String h){this.language=g;this.uH=h;}int get hashCode{int g=17;g=37*g+language.hashCode;g=37*g+uH.hashCode;return g;}bool operator==(WE g){return (language==g.language&&uH==g.uH);}}class uB{static int vM=0;String iG;String bZ;Object parent;GD action;String shortcut;Object data;bool enabled;bool selected;bool yO;String KI;bool checked;uB(this.bZ,this.action,{this.shortcut,this.data}){this.iG="item_${vM}";vM++ ;parent=null;enabled=true;selected=false;yO=false;checked=false;}uB.eX(){yO=true;enabled=false;checked=false;selected=false;}Element AS(){TableRowElement h=new TableRowElement();if(yO){TableCellElement g=new TableCellElement();g.append(new HRElement());h.append(g);}else{h.id=iG;h.setAttribute('tabindex','-1');h.onKeyDown.listen((KeyboardEvent i){int j=i.keyCode;if(j==KeyCode.ENTER){i.preventDefault();cO();NO();}else if(j==KeyCode.UP){(parent as WB).YJ(this);}else if(j==KeyCode.DOWN){(parent as WB).DL(this);}else if(j==KeyCode.LEFT){if((parent as WB).parent is WB){(parent as WB).UH();(parent as WB).zH().focus();i.preventDefault();i.stopPropagation();}else if((parent as WB).parent is zF)((parent as WB).parent as zF).YJ(parent as WB);}else if(j==KeyCode.RIGHT){Object k=parent;while(k is WB)k=(k as WB).parent;if(k is zF)k.DL(null);}else if(j==KeyCode.TAB){Timer.run(cO);}});TableCellElement g=new TableCellElement();g.text=bZ;g.onMouseUp.listen((MouseEvent i)=>NO());g.onMouseOver.listen((MouseEvent i){if(enabled)select();});g.onMouseOut.listen((MouseEvent i)=>xE());h.append(g);g=new TableCellElement();if(this.shortcut!=null)g.text="Ctrl+${shortcut}";g.onMouseUp.listen((MouseEvent i)=>NO());g.onMouseOver.listen((MouseEvent i){if(enabled)select();});g.onMouseOut.listen((MouseEvent i)=>xE());if(checked)h.classes.add('checked');h.append(g);if(!enabled)h.classes.add('disabled');}if(KI!=null)h.title=KI;return (h);}Element zH(){return (querySelector("#${iG}"));}void NO(){if(!enabled)return;IB.AH();action();}void select(){if(selected)return;selected=true;Element g=zH();g.classes.add('selected');if(this is WB){(this as WB).show();}if(parent is WB)(parent as WB).QV(this);g.focus();}void xE(){if(!selected)return;selected=false;Element g=zH();if(g!=null){g.classes.remove('selected');g.blur();}if(this is WB){(this as WB).UH();}}void disable(){if(!enabled)return;enabled=false;Element g=zH();g.classes.remove('selected');g.classes.add('disabled');if(parent is WB)(parent as WB).bO();}void enable(){if(enabled)return;enabled=true;Element g=zH();g.classes.remove('disabled');if(parent is WB)(parent as WB).bO();}void check(){if(checked)return;checked=true;Element g=zH();g.classes.add('checked');}void dS(){if(!checked)return;checked=false;Element g=zH();g.classes.remove('checked');}String get title{return (bZ);}void set title(String g){bZ=g;TableRowElement h=querySelector("#${iG}");TableCellElement i=h.nodes.first;i.text=g;}void cO(){if(parent is!WB)return;WB g=parent;while(g.parent is WB)g=g.parent;if(g.parent is zF)(g.parent as zF).zR();else g.UH();}}class zF{List<WB> VH;bool xK;WB mF;zF(){VH=new List<WB>();xK=false;mF=null;}add(WB g){VH.add(g);}insert(WB g,int h){VH.insert(h,g);}Element html(){DivElement g=new DivElement();g.classes.add('menubar');bool h=false;for(WB i in VH){DivElement j=OM(i);g.append(j);if(!h&&i.enabled){j.setAttribute('tabindex','0');h=true;}}document.onMouseUp.listen((MouseEvent k)=>RV(k));return (g);}DivElement OM(WB g){DivElement h=new DivElement();h.text=g.title;h.id=g.iG;h.classes.add('menu_title');if(g.parent is OI)h.setAttribute('tabindex','0');else h.setAttribute('tabindex','-1');h.onMouseDown.listen((MouseEvent i)=>FW(i,g));h.onMouseOver.listen((MouseEvent i)=>GW(i,g));h.onClick.listen((MouseEvent i)=>click(g));h.onKeyDown.listen((KeyboardEvent i){if(document.activeElement!=h)return;int j=i.keyCode;if(j==KeyCode.ENTER||j==KeyCode.DOWN){i.preventDefault();if(g==mF)g.dW();else aJ(g);}else if(j==KeyCode.LEFT){YJ(g);}else if(j==KeyCode.RIGHT){DL(g);}else if(j==KeyCode.TAB){Timer.run(zR);}});Element k=g.VM();k.style.display='none';h.append(k);return (h);}void FW(MouseEvent h,WB g){h.preventDefault();if(!g.GS()){aJ(g);xK=true;}else{xK=false;}}void GW(MouseEvent h,WB g){if(mF==null||mF==g)return;VJ(mF);aJ(g);}void click(WB g){if(xK){return;}if(!g.GS()){aJ(g);}else{VJ(g);}}void RV(MouseEvent g){if(mF==null)return;DivElement i=querySelector("#${mF.iG}");Rectangle h=i.getBoundingClientRect();if(g.client.x<h.left||g.client.x>h.right||g.client.y<h.top||g.client.y>h.bottom){VJ(mF);xK=true;}}void aJ(WB g){mF=g;DivElement h=querySelector("#${g.iG}");h.classes.add('selected');g.show();g.zH().focus();}void VJ(WB g){mF=null;DivElement h=querySelector("#${g.iG}");h.classes.remove('selected');g.UH();}void zR(){if(mF!=null)VJ(mF);}void YJ(WB g){if(g==null)g=mF;if(g==null)return;bool i=false;for(WB h in VH.reversed){if(h==g){i=true;}else if(i&&h.enabled){VJ(g);aJ(h);return;}}}void DL(WB g){if(g==null)g=mF;if(g==null)return;bool i=false;for(WB h in VH){if(h==g){i=true;}else if(i&&h.enabled){VJ(g);aJ(h);return;}}}}class WB extends uB{List<uB> items;String CP;WB(String g):super(g,null){items=new List<uB>();this.CP="menu_${uB.vM-1}";}add(uB g){g.parent=this;items.add(g);}Element AS(){TableRowElement g=new TableRowElement();g.id=iG;g.setAttribute('tabindex','-1');g.onKeyDown.listen((KeyboardEvent k){if(document.activeElement!=g)return;int i=k.keyCode;if(i==KeyCode.ENTER){select();}else if(i==KeyCode.UP){(parent as WB).YJ(this);}else if(i==KeyCode.DOWN){(parent as WB).DL(this);}else if(i==KeyCode.LEFT){if(parent is WB){if((parent as WB).parent is WB)(parent as WB).select();else if((parent as WB).parent is zF)((parent as WB).parent as zF).YJ(parent as WB);}}else if(i==KeyCode.RIGHT){for(uB m in items){if(m.enabled){m.select();break;}}}else if(i==KeyCode.TAB){Timer.run(cO);}});TableCellElement h=new TableCellElement();h.text=bZ;h.onMouseOver.listen((MouseEvent k){if(enabled){select();show();}});g.append(h);h=new TableCellElement();h.text=">";DivElement j=VM();j.classes.remove('dropdown_menu');j.classes.add('submenu');j.style.display='none';h.append(j);h.onMouseOver.listen((MouseEvent k){if(enabled){select();show();}});g.append(h);if(!enabled)g.classes.add('disabled');if(KI!=null)g.title=KI;return (g);}Element VM(){DivElement g=new DivElement();g.classes.add('dropdown_menu');g.id=CP;TableElement h=new TableElement();h.classes.add('menu');for(uB i in items){h.append(i.AS());}g.append(h);return (g);}Element vK(){return (querySelector("#${CP}"));}void show(){DivElement g=vK();g.style.display='block';}void UH(){for(uB g in items){if(g is WB)g.UH();g.xE();}DivElement h=vK();h.style.display='none';}bool GS(){DivElement g=vK();return (g.style.display!='none');}void QO(){items.add(new uB.eX());}void QV(uB h){for(uB g in items){if(g!=h)g.xE();}}void set title(String h){bZ=h;Element g=querySelector("#${iG}");if(g is TableRowElement){TableRowElement j=g;TableCellElement k=j.nodes.first;k.text=h;}else if(g is DivElement){Node i=g.firstChild;if(i is Text)i.text=h;}}void bO(){bool g=false;for(uB i in items){if(i.enabled){g=true;break;}}if(g==enabled)return;Element h=querySelector("#${iG}");if(g)h.classes.remove('disabled');else h.classes.add('disabled');enabled=g;if(parent is WB)(parent as WB).bO();}void dW(){for(uB g in items){if(g.enabled){g.select();return;}}}void YJ(uB h){bool i=false;for(uB g in items.reversed){if(g==h){i=true;}else if(i&&g.enabled){h.xE();g.select();break;}}}void DL(uB h){bool i=false;for(uB g in items){if(g==h){i=true;}else if(i&&g.enabled){h.xE();g.select();break;}}}}typedef void LT(WF tbmenu,n parent,n selectedNode,List<l> validRefs,List<l> ancestorRefs);typedef void MT(MC button,n parent,n selectedNode,List<l> validRefs,List<l> ancestorRefs);typedef n kJ(AB node,n parent);class aB{String pB;String EC;String localName;String value;aB.SX(lC g){pB=g.pB;EC=g.EC;if(g.EC!=null)localName=g.localName;else localName=g.name;value=g.nodeValue;}aB(String g,String h){pB=null;EC=null;localName=g;this.value=h;}aB.cX(String i,String g,String j){pB=i;int h=g.indexOf(':');if(h==-1){EC=null;localName=g;}else{EC=g.substring(0,h);localName=g.substring(h+1);}this.value=j;}aB.iX(aB g){pB=g.pB;EC=g.EC;localName=g.localName;value=g.value;}String get name{if(EC==null)return (localName);else return ("${EC}:${localName}");}String toString(){StringBuffer g=new StringBuffer();if(EC!=null){g.write(EC);g.write(':');}g.write(localName);g.write('="');g.write(n.jT(value));g.write('"');return (g.toString());}}class jP{static bool QL=false;static bool AN=false;static String AG='';void show(){DivElement h=document.getElementById('find_dlg');if(h!=null){TextInputElement o=document.getElementById('find_dlg_find_field');o.focus();return;}Element QD=querySelector("#doc1");QD.style.bottom='10.5em';h=new DivElement();h.id='find_dlg';h.classes.add('find');FormElement s=new FormElement();TableElement v=new TableElement();TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.text=LB.MB('find.find');j.append(g);g=new TableCellElement();TextInputElement o=new TextInputElement();o..id='find_dlg_find_field'..name='find'..size=40..value=AG;g.append(o);j.append(g);v.append(j);j=new TableRowElement();g=new TableCellElement();g.text=LB.MB('find.replace_by');j.append(g);g=new TableCellElement();TextInputElement HB=new TextInputElement();HB..id='find_dlg_replace_field'..name='replace_by'..size=40;g.append(HB);j.append(g);v.append(j);h.append(v);DivElement m=new DivElement();m.classes.add('options');CheckboxInputElement BB=new CheckboxInputElement();BB..id='find_cb_ignore_case'..checked=QL..onChange.listen((Event i)=>QL=BB.checked);m.append(BB);LabelElement JB=new LabelElement();JB..htmlFor='find_cb_ignore_case'..text=LB.MB("find.case_sensitive");m.append(JB);CheckboxInputElement EB=new CheckboxInputElement();EB..id='find_cb_backwards'..checked=AN..onChange.listen((Event i)=>AN=EB.checked);m.append(EB);LabelElement QB=new LabelElement();QB..htmlFor='find_cb_backwards'..text=LB.MB("find.backwards");m.append(QB);s.append(m);DivElement k=new DivElement();k.classes.add('buttons');ButtonElement SB=new ButtonElement();SB..attributes['type']='button'..appendText(LB.MB("button.Close"))..onClick.listen((MouseEvent i)=>close());k.append(SB);ButtonElement cB=new ButtonElement();cB..attributes['type']='button'..appendText(LB.MB("find.replace"))..onClick.listen((MouseEvent i)=>replace());k.append(cB);ButtonElement hB=new ButtonElement();hB..attributes['type']='button'..appendText(LB.MB("find.replace_find"))..onClick.listen((MouseEvent i)=>VW());k.append(hB);ButtonElement CC=new ButtonElement();CC..attributes['type']='button'..appendText(LB.MB("find.replace_all"))..onClick.listen((MouseEvent i)=>replaceAll());k.append(CC);ButtonElement IC=new ButtonElement();IC..attributes['type']='button'..appendText(LB.MB("find.next"))..onClick.listen((MouseEvent i)=>next());k.append(IC);s.append(k);h.append(s);document.body.append(h);h.onKeyDown.listen((KeyboardEvent i){if(i.keyCode==KeyCode.ESC){close();}});o.focus();}void next(){AG=((document.getElementById('find_dlg_find_field')) as TextInputElement).value;if(AG=='')return;q g;if(!AN){q h=IB.GF();if(h==null)h=new q(t.rC,0);g=IW(h);}else{q i=IB.vC();if(i==null)i=new q(t.rC,t.rC.PB);g=NP(i);}if(g!=null){IB.KD(g);IB.cursor.gE(g,new q(g.u,g.KB+AG.length));}}q IW(q j){n g=j.u;int h=j.KB;if(g is!OB){g=g.eB(h);h=0;}while(g!=null){if(g is OB){int i;if(!QL)i=g.nodeValue.toLowerCase().indexOf(AG.toLowerCase(),h);else i=g.nodeValue.indexOf(AG,h);if(i!=-1)return (new q(g,i));}g=g.nextNode();h=0;}return (null);}q NP(q k){n g=k.u;int h=k.KB;if(g is!OB){if(h>0)g=g.eB(h-1);else{n i=g;g=null;while(i!=null){if(i.previousSibling!=null){g=i.previousSibling;break;}i=i.parent;}}if(g!=null)h=g.PB;}while(g!=null){if(g is OB){int j;if(!QL)j=g.nodeValue.toLowerCase().substring(0,h).lastIndexOf(AG.toLowerCase());else j=g.nodeValue.substring(0,h).lastIndexOf(AG);if(j!=-1)return (new q(g,j));}g=g.previousNode();if(g!=null)h=g.PB;}return (null);}void replace(){q g=new q.pX(IB.vC());q h=new q.pX(IB.GF());if(g==null||g.u is!OB)return;String i=((document.getElementById('find_dlg_replace_field')) as TextInputElement).value;GB j=new GB.uX(LB.MB('find.replace'));if(i!='')j.TB(new GB.dX(h,i));if(g!=h&&g.u==h.u)j.TB(new GB.kX(g,h.KB-g.KB));t.DC(j);IB.cursor.gE(g,new q(g.u,g.KB+i.length));}void VW(){replace();next();}void replaceAll(){AG=((document.getElementById('find_dlg_find_field')) as TextInputElement).value;if(AG=='')return;String i=((document.getElementById('find_dlg_replace_field')) as TextInputElement).value;q g=NP(new q(t.rC,t.rC.PB));GB h=new GB.uX(LB.MB('find.replace_all'));while(g!=null){if(i!='')h.TB(new GB.dX(new q(g.u,g.KB+AG.length),i));h.TB(new GB.kX(g,AG.length));g=NP(g);}t.DC(h);}void close(){DivElement g=document.getElementById('find_dlg');g.remove();Element h=querySelector("#doc1");h.style.bottom='1.5em';IB.AH();}}abstract class q{factory q(n g,int h){return (new dC(g,h));}factory q.TX(int g){return (new CE(g));}factory q.ZX(int g){return (new vD(g));}factory q.gX(q g){if(g is dC)return (new CE.XX(g));else if(g is CE)return (new CE.mX(g));else if(g is vD)return (new CE.hX(g));}factory q.lX(q g){if(g is dC)return (new vD.YX(g));else if(g is CE)return (new vD.jX(g));else if(g is vD)return (new vD.nX(g));}factory q.pX(q g){if(g is dC)return (new dC(g.u,g.KB));else if(g is CE)return (new CE(g.HF));else if(g is vD)return (new vD(g.UF));}n get u;int get KB;int get HF;int get UF;bool operator==(q g);bool operator<(q g);bool operator<=(q g);bool operator>(q g);bool operator>=(q g);void PG(int g);void zE();HD jF();String MI({bool titles: false});String toString();}class RD{n u;RD parent;RD firstChild;RD nextSibling;bool MG;DivElement div;SpanElement YH;SpanElement oE;RD(this.u,this.parent){MG=false;LV();if(u.parent==t.rC){cJ();}}void KV(){for(n g=u.firstChild;g!=null;g=g.nextSibling){if(g is!OB){jB(new RD(g,this));}}}void US(){if(firstChild!=null)PP(firstChild);}void PP(RD h){RD g=h;while(g!=null){if(g.div!=null)g.div.remove();g=g.nextSibling;}if(firstChild==h)firstChild=null;else h.previousSibling.nextSibling=null;}RD get lastChild{if(firstChild==null)return null;RD g=firstChild;while(g.nextSibling!=null){g=g.nextSibling;}return g;}RD get previousSibling{if(parent==null)return null;for(RD g=parent.firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==this)return g;}return null;}List<RD> get children{List<RD> h=new List<RD>();for(RD g=firstChild;g!=null;g=g.nextSibling)h.add(g);return (h);}void jB(RD g){RD h=lastChild;if(h==null){firstChild=g;}else{h.nextSibling=g;}g.nextSibling=null;g.parent=this;div.append(g.div);}bool get YO{return TL(u);}LV(){div=new DivElement();div.classes.add('tree_div');YH=new SpanElement();YH.classes.add('tree_node_title');YH.setAttribute('tabindex','-1');YH.onKeyDown.listen((KeyboardEvent i){int h=i.keyCode;if(h==KeyCode.DOWN){if(firstChild!=null)firstChild.focus();else if(nextSibling!=null)nextSibling.focus();else if(parent!=null){RD g=parent;while(g.nextSibling==null&&g.parent!=null)g=g.parent;if(g.nextSibling!=null)g.nextSibling.focus();}}else if(h==KeyCode.UP){if(previousSibling!=null){RD g=previousSibling;while(g.lastChild!=null)g=g.lastChild;g.focus();}else if(parent!=null)parent.focus();else document.getElementById('tree_tab_button').focus();}else if(h==KeyCode.ENTER){IB.XS(u);}else if(h==KeyCode.RIGHT&&YO){if(!MG)cJ();firstChild.focus();}else if(h==KeyCode.LEFT&&MG){cJ();}else if(h==KeyCode.LEFT&&parent!=null){parent.focus();}});if(u.DB!=null)YH.appendText(t.CB.OD(u.DB));else YH.appendText(u.nodeName);YH.onClick.listen((MouseEvent i)=>IB.XS(u));if(TL(u)&&u.parent!=t.rC){LR();}div.append(YH);}void LR(){oE=new SpanElement();oE.classes.add('expand_button');ImageElement g=new ImageElement(width:9,height:9);if(MG){oE.classes.add('expanded');g.src='packages/daxe/images/expanded_tree.png';}else{oE.classes.add('collapsed');g.src='packages/daxe/images/collapsed_tree.png';}oE.append(g);oE.onClick.listen((MouseEvent h)=>cJ());div.append(oE);}void cJ(){if(!MG){KV();if(oE!=null){oE.classes.remove('collapsed');oE.classes.add('expanded');ImageElement g=oE.firstChild;g.src='packages/daxe/images/expanded_tree.png';}}else{US();if(oE!=null){oE.classes.remove('expanded');oE.classes.add('collapsed');ImageElement g=oE.firstChild;g.src='packages/daxe/images/collapsed_tree.png';}}MG=!MG;}void update(){if(oE==null&&TL(u)&&u.parent!=t.rC){LR();MG=true;}else if(oE!=null&&!TL(u)){US();MG=false;oE.remove();}if(!MG)return;RD g=firstChild;for(n h=u.firstChild;h!=null;h=h.nextSibling){if(h is!OB){if(g==null){g=new RD(h,this);jB(g);}else if(g.u!=h){PP(g);g=new RD(h,this);jB(g);}else{g.update();}}if(g!=null)g=g.nextSibling;}if(g!=null)PP(g);}void focus(){YH.focus();}static bool TL(n h){for(n g=h.firstChild;g!=null;g=g.nextSibling){if(g is!OB){return (true);}}return (false);}}class PL{int cZ=0;Map<String,n> dZ=new Map<String,n>();nG rC;HH CB;List<GB> WD=new List<GB>();int hE=-1;String SH;String CL;List<l> ZC;l uO;Future FP(String j){Completer g=new Completer();CB=new HH();CB.load(j).then((m){ZC=CB.yG('hiddenp');if(ZC.length==0)ZC=null;uO=CB.mO('hiddendiv');SH=null;rC=new nG();List<l> i=CB.II();if(i.length==1){n h=ND.NF(i[0]);CB.OO(h);rC.jB(h);h.lF();}g.complete();},onError:(CD k){g.completeError(k);});return (g.future);}Future KP(String i,String k,{bool removeIndents: true}){Completer g=new Completer();CB=new HH();CB.load(k).then((v){ZC=CB.yG('hiddenp');if(ZC.length==0)ZC=null;uO=CB.mO('hiddendiv');this.SH=i;EG s=new EG();s.AL(i).then((sB m){if(removeIndents)VS(m.documentElement);rC=ND.fH(m,null);if(CB!=null&&ZC!=null)QP(rC);g.complete();},onError:(UD h){if(h.errorCode==404){rC=new nG();List<l> o=CB.II();if(o.length==1){n j=ND.NF(o[0]);CB.OO(j);rC.jB(j);j.lF();}g.complete();}else g.completeError(new CD("Opening ${i}: ${h}"));});},onError:(CD h){g.completeError(new CD("Reading config ${k}: ${h}"));});return (g.future);}Future bW(){assert(CL!=null);Completer i=new Completer();String j='AaB03x';HttpRequest h=new HttpRequest();h.onLoad.listen((ProgressEvent o){String k=h.responseText;if(k.startsWith('ok'))i.complete();else{String m;if(k.startsWith('erreur\n'))m=k.substring('erreur\n'.length);else m=k;i.completeError(new CD(m));}});h.onError.listen((ProgressEvent o){i.completeError(new CD(h.status.toString()));});h.open('POST',CL);h.setRequestHeader('Content-Type',"multipart/form-data; boundary=${j}");StringBuffer g=new StringBuffer();g.write("--${j}\r\n");g.write('Content-Disposition: form-data; name="chemin"\r\n');g.write('Content-type: text/plain; charset=UTF-8\r\n');g.write('Content-transfer-encoding: 8bit\r\n\r\n');g.write(SH);g.write("\r\n--${j}\r\n");g.write('Content-Disposition: form-data; name="contenu"; filename="${SH}"\r\n');g.write('Content-Type: application/octet-stream\r\n\r\n');rC.nF='UTF-8';g.write(toString());g.write('\r\n--${j}--\r\n\r\n');h.send(g.toString());return (i.future);}String bM(n h){cZ++ ;String g="a${cZ}";dZ[g]=h;return (g);}Element html(){return (rC.html());}n nI(){for(n g=rC.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==n.tC)return (g);}return (null);}void insertNode(n g,q h){GB i=new GB.oX(h,g);DC(i);}void dM(n g){GB h=new GB.rX(g);DC(h);}void XM(q g,String h){GB i=new GB.dX(g,h);DC(i);}void UW(q g,int h){GB i=new GB.kX(g,h);DC(i);}void OP(q g,q h){GB i=GI(g,h);DC(i);}GB GI(q h,q i){assert(h<i);GB j=new GB.uX(LB.MB('undo.remove'));if(h.u==i.u){n o=h.u;if(o.nodeType==n.mB){j.TB(new GB.kX(new q(o,h.KB),i.KB-h.KB));}else{for(int k=h.KB;k<i.KB;k++ ){if(o.eB(k) is OB)j.TB(new GB.rX(o.eB(k)));}for(int k=h.KB;k<i.KB;k++ ){if(o.eB(k) is!OB)j.TB(new GB.rX(o.eB(k)));}}}else{bool v=false;n m;if(h.u.nodeType==n.tC){m=h.u.eB(h.KB);q BB=new q(h.u,h.KB+1);if(i>=BB)v=true;}else{m=h.u;if(m.PB-h.KB>0){j.TB(new GB.kX(new q(m,h.KB),m.PB-h.KB));}}if(i.u.nodeType==n.mB&&i.KB>0){j.TB(new GB.kX(new q(i.u,0),i.KB));}for(n g=m.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<i){if(g.nodeType==n.mB&&i>=new q(g.parent,g.parent.ZB(g)+1)){j.TB(new GB.rX(g));}}else break;}if(v)j.TB(new GB.rX(m));for(n g=m.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<i){if(g.nodeType!=n.mB){j.TB(new GB.rX(g));}}else break;}}return (j);}n iI(q g,q i){assert(g<i);n m=g.u;if(m is OB)m=m.parent;n j=ND.NF(m.DB);if(g.u==i.u){n o=g.u;if(o.nodeType==n.mB){j.jB(new OB(o.nodeValue.substring(g.KB,i.KB)));}else{for(int s=g.KB;s<i.KB;s++ ){j.jB(new n.yX(o.eB(s)));}}}else{n k;if(g.u.nodeType==n.tC){k=g.u.eB(g.KB);q v=new q(g.u,g.KB+1);if(i>=v){j.jB(new n.yX(k));}}else{k=g.u;if(k.PB-g.KB>0){j.jB(new OB(k.nodeValue.substring(g.KB,k.PB)));}}for(n h=k.nextSibling;h!=null;h=h.nextSibling){q BB=new q(h.parent,h.parent.ZB(h));if(BB<i){if(h.nodeType!=n.mB||(h.nodeType==n.mB&&i>=new q(h.parent,h.parent.ZB(h)+1))){j.jB(new n.yX(h));}}else break;}if(i.u.nodeType==n.mB&&i.KB>0){j.jB(new OB(i.u.nodeValue.substring(0,i.KB)));}}return (j);}n IG(n k,q h,q i){while(h.KB==h.u.PB&&h<i){h=new q(h.u.parent,h.u.parent.ZB(h.u)+1);}while(i.KB==0&&i>h){i=new q(i.u.parent,i.u.parent.ZB(i.u));}n j=new n.yX(k);for(n g=j.firstChild;g!=null;g=j.firstChild)j.gC(g);int BB=0;for(n g=k.firstChild;g!=null;g=g.nextSibling){q m=new q(k,BB);q o=new q(k,BB+1);if(m>=h&&o<=i){n EB=new n.yX(g);j.jB(EB);}else if(o<=h||m>=i){}else{if(g is OB){if(m>h&&o>i){assert(g==i.u);if(0<i.KB)j.jB(new OB(g.nodeValue.substring(0,i.KB)));}else if(m<h&&o<i){assert(g==h.u);if(h.KB<g.PB)j.jB(new OB(g.nodeValue.substring(h.KB,g.PB)));}else{int s;if(h.u==g)s=h.KB;else s=0;int v;if(i.u==g)v=i.KB;else v=g.PB;if(s<v)j.jB(new OB(g.nodeValue.substring(s,v)));}}else{n EB=IG(g,h,i);j.jB(EB);}}BB++ ;}return (j);}GB LE(n BB,q i,{bool checkValidity: true}){if(i.u is OB&&i.KB==0)i=new q(i.u.parent,i.u.parent.ZB(i.u));n h=i.u;int o=i.KB;if(h is OB){o=h.parent.ZB(h);h=h.parent;}GB EB=new GB.uX('insertChildren');List<n> s=new List<n>();while(BB.firstChild!=null){s.add(BB.firstChild);BB.gC(BB.firstChild);}q j=new q.pX(i);for(n g in s){if(g is!OB){if(checkValidity&&(h is BG||h is qF||h is IH)){String m;if(g.DB==null)m=g.nodeName;else m=CB.OD(g.DB);throw new CD(m+' '+LB.MB('insert.not_authorized_here'));}if(g is qF){if(checkValidity&&h.nodeType==n.YG)throw new CD(LB.MB('insert.text_not_allowed'));String k=null;if(g.firstChild!=null)k=g.firstChild.nodeValue;if(k==null)k='';if(checkValidity&&k.trim()!=''&&!CB.PE(h.DB)){throw new CD(LB.MB('insert.text_not_allowed'));}EB.TB(new GB.oX(j,g));}else{if(checkValidity){if(h.nodeType==n.YG){if(!CB.II().contains(g.DB))throw new CD(CB.OD(g.DB)+' '+LB.MB('insert.not_authorized_here'));}else if(g is!BG&&g is!IH){if(g.DB==null||!CB.fD(h.DB,g.DB)){String m;if(g.DB==null)m=g.nodeName;else m=CB.OD(g.DB);String QB=CB.OD(h.DB);throw new CD(m+' '+LB.MB('insert.not_authorized_inside')+' '+QB);}if(!CB.WM(h,o,o,g.DB)){throw new CD(CB.OD(g.DB)+' '+LB.MB('insert.not_authorized_here'));}}}EB.TB(new GB.oX(j,g));}if(j.u is OB)j=new q(h,o+2);else j=new q(h,j.KB+1);}}bool HB=false;bool JB=true;for(n g in s){if(g is OB){if(checkValidity&&h.nodeType==n.YG)throw new CD(LB.MB('insert.text_not_allowed'));String k=g.nodeValue;if(k==null)k='';if(checkValidity&&k.trim()!=''&&!CB.PE(h.DB)){throw new CD(LB.MB('insert.text_not_allowed'));}int v=o+s.indexOf(g);if(i.u is OB)v++ ;if(HB)v-- ;if(s.length==1)j=i;else j=new q(h,v);if(JB){if(v>0&&(i.u is OB||h.eB(v-1) is OB))HB=true;JB=false;}EB.TB(new GB.dX(j,g.nodeValue));}}return (EB);}String toString(){return (rC.toString());}sB qW(){lH h=new yJ();sB g=h.createDocument(null,null,null);rC.KF(g);return (g);}void DC(GB g){g.eO();if(hE<WD.length-1)WD.removeRange(hE+1,WD.length);if(hE<0||!WD[hE].oU(g)){WD.add(g);hE++ ;}IB.KL();}void aH(){if(hE<0)return;GB g=WD[hE];g.aH();hE-- ;IB.KL();IB.LC();}void cM(){if(hE>=WD.length-1)return;GB g=WD[hE+1];g.eO();hE++ ;IB.KL();IB.LC();}bool FS(){return (hE>=0);}bool ES(){return (hE<WD.length-1);}String xR(){String g;if(hE>=0)g=WD[hE].title;else g=null;if(g==null)return (LB.MB('undo.undo'));else return ("${LB.MB('undo.undo')} ${g}");}String vR(){String g;if(hE<WD.length-1)g=WD[hE+1].title;else g=null;if(g==null)return (LB.MB('undo.redo'));else return ("${LB.MB('undo.redo')} ${g}");}void lK(String j,int g){GB i=new GB.uX(j);for(int h=WD.length-g;h<WD.length;h++ )i.TB(WD[h]);WD.removeRange(WD.length-g,WD.length);WD.add(i);hE-= (g-1);}void CS(String j,bool EB){q g=IB.vC();q k=IB.GF();if(j=='\n'&&!EB){if(((g.u is JH)||(g.u.nextSibling==null&&g.u.parent is JH))&&g.KB==g.u.PB){UI.xT(g);return;}else{n i=g.u;while(i is OB||i is kB||i is zB||i is YE)i=i.parent;if(i is xD){iC.GU(g);return;}}}if(j=='\n'&&ZC!=null){if(kB.CU())return;}bool m=false;n h=g.u;if(h.nodeType==n.mB)h=h.parent;if(h.mM)m=true;else if(j.trim()!=''){if(h.nodeType==n.YG)m=true;else if(h.DB!=null&&!t.CB.PE(h.DB)){if(ZC!=null){l v=CB.fF(h.DB,ZC);if(v!=null&&g==k){kB o=new kB.WY(v);o.jB(new OB(j));insertNode(o,g);IB.KD(new q(o,o.PB));IB.LC();return;}else m=true;}else m=true;}}if(m){window.alert(LB.MB('insert.text_not_allowed'));IB.cursor.IV();return;}bool BB=false;if(g!=k){g=new q.pX(g);k=new q.pX(k);IB.cursor.xG();OP(g,k);BB=true;if(g.u.parent==null)g=IB.vC();}t.XM(g,j);if(BB){GB s=new GB.uX(LB.MB('undo.insert_text'));s.TB(WD.removeAt(WD.length-2));s.TB(WD.removeLast());WD.add(s);hE-= 1;}}void CI(l j,String h){q i=IB.vC();if(i==null)return;n g=ND.NF(j,h);if(h=='element'&&nI()==null){CB.OO(g);}g.HP(()=>BS(g,i));}bool BS(n i,q g){n k=null;if(IB.vC()!=IB.GF()){q EB=IB.vC();q HB=IB.GF();k=iI(EB,HB);IB.cursor.xG();if(g.u is!OB&&g.KB>0&&g.u.eB(g.KB-1) is OB){n JB=g.u.eB(g.KB-1);g=new q(JB,JB.PB);}OP(EB,HB);if(g.u.parent==null)g=IB.vC();}bool v=false;n j=g.u;if(j is OB)j=j.parent;if(j is kB){kB h=j;if(!CB.fD(h.DB,i.DB)){GB m=new GB.uX(LB.MB('undo.insert_text'));q s=new q(h,h.PB);s.zE();if(g<s){n SB=iI(g,s);m.TB(GI(g,s));kB QB=ND.NF(h.DB);m.TB(new GB.oX(new q(h.parent,h.parent.ZB(h)+1),QB));m.TB(LE(SB,new q(QB,0)));}m.TB(new GB.oX(new q(h.parent,h.parent.ZB(h)+1),i));DC(m);v=true;}}else if(ZC!=null&&j.DB!=null&&!CB.fD(j.DB,i.DB)){l BB=CB.fF(j.DB,ZC);if(BB!=null&&CB.fD(BB,i.DB)){kB h=new kB.WY(BB);h.jB(i);insertNode(h,g);v=true;}}if(!v)insertNode(i,g);q o=i.QE();if(o==null)o=new q(i.parent,i.parent.ZB(i)+1);IB.KD(o);IB.LC();if(k!=null){try {if(o==null)throw new CD(k.toString()+LB.MB('insert.not_authorized_here'));if(t.ZC!=null){kB.RN(i,k);}DC(LE(k,o,checkValidity:true));lK(LB.MB('undo.insert_element'),3);IB.KL();return (true);}on CD catch (cB){window.alert(cB.toString());aH();aH();WD.removeRange(WD.length-2,WD.length);IB.KL();return (false);}}return (true);}void VV(String g,l h){if(g=='jaxe.FonctionNormal'){zB.eL();}else if(nP[g]!=null)nP[g]();}List<l> kO(n i){List<l> g;if(i.nodeType==n.YG){g=t.CB.II();}else if(i.DB==null){g=new List<l>();}else{n h;if(i.nodeType==n.mB)h=i.parent;else h=i;g=CB.XC(h.DB);if(h is kB&&h.parent.DB!=null){LinkedHashSet j=new LinkedHashSet.from(g);j.addAll(CB.XC(h.parent.DB));g=new List.from(j);}else if(ZC!=null){l k=CB.fF(h.DB,ZC);if(k!=null){LinkedHashSet j=new LinkedHashSet.from(g);j.addAll(CB.XC(k));g=new List.from(j);}}}return (g);}List<l> dP(List<l> m){List<l> i=new List<l>();q s=IB.vC();q v=IB.GF();n h=s.u;int BB=s.KB;n k=v.u;int EB=v.KB;if(h.nodeType==n.mB){BB=h.parent.ZB(h);h=h.parent;}if(k.nodeType==n.mB){EB=k.parent.ZB(k);k=k.parent;}if(h!=k)return (i);for(l g in m){if(t.CB.WM(h,BB,EB,g))i.add(g);}if(h is kB&&h.parent.DB!=null){int HB=h.parent.ZB(h)+1;LinkedHashSet j=new LinkedHashSet.from(i);for(l g in m){if(!j.contains(g)){if(t.CB.WM(h.parent,HB,HB,g))j.add(g);}}i=new List.from(j);}else if(ZC!=null){l o=null;for(l g in ZC)if(i.contains(g)){o=g;break;}if(o!=null){LinkedHashSet j=new LinkedHashSet.from(i);for(l g in m){if(!j.contains(g)){if(t.CB.fD(o,g))j.add(g);}}i=new List.from(j);}}return (i);}q zG(num g,num h){return (rC.zG(g,h));}void VS(final l g){eZ(g,null,false,true);}void eZ(final l m,final l s,final bool HB,final bool JB){l o;if(CB!=null)o=CB.UM(m,s);else o=null;bool v=fZ(m,o,s,HB);final bool BB=gZ(m,o,s,JB);AB EB;for(AB j=m.firstChild;j!=null;j=EB){EB=j.nextSibling;if(j.nodeType==AB.FE)eZ(j as l,o,v,BB);else if(!v&&j.nodeType==AB.kE){String g=j.nodeValue;if(BB&&j.parentNode.firstChild==j&&s!=null){int h=0;while(h<g.length&&(g[h]==' '||g[h]=='\t'))h++ ;if(h>0)g=g.substring(h);}int i=g.indexOf("\n ");int k=g.indexOf("\n\t");if(k!=-1&&(i==-1||k<i))i=k;while(i!=-1){int h=i;while(h+1<g.length&&(g[h+1]==' '||g[h+1]=='\t'))h++ ;g=g.substring(0,i+1)+g.substring(h+1);i=g.indexOf("\n ");k=g.indexOf("\n\t");if(k!=-1&&(i==-1||k<i))i=k;}i=g.indexOf("  ");while(i!=-1){int h=i;while(h+1<g.length&&g[h+1]==' ')h++ ;g=g.substring(0,i)+g.substring(h);i=g.indexOf("  ");}if(g.length==0)m.gC(j);else j.nodeValue=g;}}}bool fZ(final l m,final l j,final l v,final bool o){bool g;final String h=m.getAttribute("xml:space");if(h=="preserve")g=true;else if(h=="default")g=false;else g=o;if(j!=null&&h==""){final List<l> s=CB.fE(j);for(l i in s){if(CB.attributeName(i)=="space"&&CB.attributeNamespace(i)=="http://www.w3.org/XML/1998/namespace"){final String k=CB.dF(i);if(k=="preserve")g=true;else if(k=="default")g=false;break;}}}return (g);}bool gZ(final l m,final l j,final l k,final bool o){if(j==null)return true;if(k==null||!CB.PE(j)||!CB.PE(k))return true;AB g=m.previousSibling;while(g!=null){if(g.nodeType==AB.kE){final String h=g.nodeValue;if(!(h.endsWith(" ")||h.endsWith("\n")))return false;return true;}else if(g.nodeType==AB.FE){final AB i=g.lastChild;if(i!=null&&i.nodeType==AB.kE){final String h=i.nodeValue;if(!(h.endsWith(" ")||h.endsWith("\n")))return false;}return true;}g=g.previousSibling;}if(g==null)return o;return true;}void QP(n i){l j;if(i.DB!=null)j=CB.fF(i.DB,ZC);else j=null;bool k=(j!=null);bool m=i is kB;bool s=i is zB;n o;for(n g=i.firstChild;g!=null;g=o){o=g.nextSibling;if(g is OB){if(k||m||s){String h=g.nodeValue;if(g.previousSibling==null||g.previousSibling is!BG||g.nextSibling==null||g.nextSibling is!BG){h=h.replaceAll('\n',' ');}h=h.replaceAll('  ',' ');if(k){if(g.previousSibling!=null&&g.previousSibling.DB!=null&&!CB.fD(j,g.previousSibling.DB)){h=h.trimLeft();}if(g.nextSibling!=null&&g.nextSibling.DB!=null&&!CB.fD(j,g.nextSibling.DB)){h=h.trimRight();}}else if(m){if(g.previousSibling==null)h=h.trimLeft();if(g.nextSibling==null)h=h.trimRight();}if(h.length==0)i.gC(g);else g.nodeValue=h;}}else if(g.firstChild!=null)QP(g);}}void tV(sB g){if(g.documentElement!=null)hZ(g.documentElement,null,false,1);}void hZ(final l i,final l j,final bool BB,final int k){l h;if(CB!=null)h=CB.UM(i,j);else h=null;bool m=fZ(i,h,j,BB);for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE)hZ(g as l,h,m,k+1);else if(!m&&g.nodeType==AB.kE&&g.nodeValue.contains("\n")){StringBuffer o=new StringBuffer("\n");int s=k;if(g.nextSibling==null)s-- ;for(int v=0;v<s;v++ )o.write('  ');String EB=o.toString();g.nodeValue=g.nodeValue.replaceAll("\n",EB);}}}}class wM{RD JF;wM(){}void update(){if(JF==null&&t.nI()!=null){JF=new RD(t.nI(),null);iZ();DivElement g=document.getElementById('tree');g.append(JF.div);}else{if(JF==null){if(t.nI()!=null){JF=new RD(t.nI(),null);DivElement g=document.getElementById('tree');g.append(JF.div);}}else{if(t.nI()==null){JF.div.remove();JF=null;}else JF.update();}}}void iZ(){if(!JF.YO)return;if(!JF.MG)JF.cJ();if(JF.children.length<10){for(RD g=JF.firstChild;g!=null;g=g.nextSibling){if(g.YO&&!g.MG)g.cJ();}}}}class GB{static const int dH=0;static const int eH=1;static const int mJ=2;static const int nJ=3;int gD;String title;q qB;String text;int length;n u;n xF;List<aB> attributes;List<GB> EH;bool LF;GB.dX(q h,String g,{bool updateDisplay: true}){assert(g!=null&&g!='');gD=dH;title=LB.MB('undo.insert_text');this.qB=new q.pX(h);this.text=g;u=null;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.kX(q g,int h,{bool updateDisplay: true}){assert(h>0);assert(g.u.nodeType==n.mB);gD=eH;title=LB.MB('undo.remove_text');this.qB=new q.pX(g);text=null;this.length=h;u=null;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.oX(q g,n h,{bool updateDisplay: true}){gD=dH;title=LB.MB('undo.insert_element');this.qB=new q.pX(g);text=null;this.u=h;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.rX(n g,{bool updateDisplay: true}){gD=eH;title=LB.MB('undo.remove_element');qB=null;text=null;this.u=g;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.sX(n g,List<aB> h,{bool updateDisplay: true}){gD=mJ;title=LB.MB('undo.attributes');qB=null;text=null;this.u=g;xF=null;this.attributes=h;EH=null;this.LF=updateDisplay;}GB.tX(n i,aB g,{bool updateDisplay: true}){gD=mJ;title=LB.MB('undo.attributes');qB=null;text=null;this.u=i;xF=null;LinkedHashMap<String,aB> h=i.gR();if(g.value==null){if(h[g.name]!=null)h.remove(g.name);}else h[g.name]=g;this.attributes=new List.from(h.values);EH=null;this.LF=updateDisplay;}GB.uX(String g){gD=nJ;this.title=g;qB=null;text=null;u=null;xF=null;attributes=null;EH=new List<GB>();LF=true;}bool oU(GB g){if(gD!=g.gD)return (false);if(gD==dH&&u is OB&&g.text!=null&&g.qB.u==u&&g.qB.KB+1==u.PB){return (true);}if(text==null||g.text==null)return (false);if(u!=g.u)return (false);if((gD==dH&&g.qB.KB==qB.KB+text.length)||(gD==eH&&g.qB.KB==qB.KB)){text="${text}${g.text}";return (true);}if((gD==dH&&g.qB.KB==qB.KB)||(gD==eH&&qB.KB==g.qB.KB+g.text.length)){text="${g.text}${text}";if(gD==eH)qB=new q(qB.u,qB.KB-g.text.length);return (true);}return (false);}void TB(GB g){assert(gD==nJ);EH.add(g);}void eO(){if(gD==dH)jZ(LF);else if(gD==eH)kZ(LF);else if(gD==mJ)lZ(LF);else if(gD==nJ){for(GB g in EH){g.eO();}}LF=true;}void aH(){if(gD==dH)kZ(LF);else if(gD==eH)jZ(LF);else if(gD==mJ)lZ(LF);else if(gD==nJ){for(GB g in EH.reversed){g.aH();}}}void jZ(bool j){if(text!=null){qB.zE();if(qB.u.nodeType==n.tC){u=new OB(text);text=null;}}if(text!=null){assert(qB.u.nodeType==n.mB);(qB.u as OB).XM(qB,text);if(j){qB.u.sD();IB.KD(new q(qB.u,qB.KB+text.length));if(qB.u.previousSibling==null&&qB.u.nextSibling==null){qB.u.parent.lF();}}}else{n g=qB.u;n h;List<n> i=new List<n>();i.add(u);if(g.nodeType==n.mB&&u.nodeType==n.mB){String k=g.nodeValue.substring(0,qB.KB);String m=g.nodeValue.substring(qB.KB);g.nodeValue="${k}${u.nodeValue}${m}";h=g;}else if(qB.KB==0){if(g.nodeType==n.mB){g.parent.insertBefore(u,g);h=g.parent;}else{g.insertBefore(u,g.firstChild);h=g;}}else if(g.PB==qB.KB){if(g.nodeType==n.mB){g.parent.insertBefore(u,g.nextSibling);h=g.parent;}else{g.jB(u);h=g;}}else if(g.nodeType==n.mB){if(xF==null)xF=(g as OB).PV(qB.KB);else{g.nodeValue=g.nodeValue.substring(0,qB.KB);g.parent.insertAfter(xF,g);}g.parent.insertBefore(u,xF);i.add(g);i.add(xF);h=g.parent;}else{n o=g.eB(qB.KB);g.insertBefore(u,o);h=g;}if(j){if(u.nodeType==n.tC)u.lF();h.lF();h.BF(i);if(u is OB)IB.KD(new q(u,u.nodeValue.length));else IB.KD(new q(u.parent,u.parent.ZB(u)+1));}u.XO();}}void kZ(bool k){if(u==null&&text==null){if(qB.KB==0&&qB.u.PB==length){u=qB.u;qB=new q(u.parent,u.parent.ZB(u));}else{text=qB.u.nodeValue.substring(qB.KB,qB.KB+length);}}if(text!=null){assert(qB.u.nodeType==n.mB);qB.u.remove(qB,text.length);if(k){qB.u.sD();IB.KD(qB);if(qB.u.previousSibling==null&&qB.u.nextSibling==null){qB.u.parent.lF();}}}else{u.PR();n h=u.parent;assert(h!=null);if(qB==null){if(u.previousSibling!=null&&u.previousSibling.nodeType==n.mB)qB=new q(u.previousSibling,u.previousSibling.PB);else qB=new q(h,h.ZB(u));}n i=u.previousSibling;n g=u.nextSibling;h.gC(u);List<n> j=new List<n>();if(i!=null&&i.nodeType==n.mB&&g!=null&&g.nodeType==n.mB){xF=g;i.nodeValue="${i.nodeValue}${g.nodeValue}";g.parent.gC(g);j.add(i);j.add(u);j.add(g);}else j.add(u);if(k){h.lF();h.BF(j);IB.KD(qB);}}}void lZ(bool g){List<aB> h=u.attributes;u.attributes=attributes;attributes=h;if(g){u.lF();u.vI();}}String toString(){StringBuffer g=new StringBuffer();switch (gD){case dH:g.write("Insert ");break;case eH:g.write("Remove ");break;case mJ:g.write("Attributes ");break;case nJ:g.write("Compound ");break;}if(text!=null)g.write("text '${text}'");else if(u!=null)g.write("node ${u.nodeName}");else if(qB!=null)g.write("${length} chars at ${qB}");return (g.toString());}}class NT{void show(){sB o=t.qW();t.tV(o);DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement i=new DivElement();i.classes.add('source_window');DivElement m=new DivElement();m.classes.add('source_content');PO(o,m);i.append(m);DivElement j=new DivElement();j.classes.add('source_bottom');ButtonElement k=new ButtonElement();k.attributes['type']='button';k.appendText(LB.MB("source.select_all"));k.onClick.listen((MouseEvent s)=>RP());j.append(k);ButtonElement g=new ButtonElement();g.attributes['type']='submit';g.appendText(LB.MB("button.Close"));g.onClick.listen((MouseEvent s)=>close());j.append(g);i.append(j);h.append(i);document.body.append(h);g.focus();}void PO(AB i,Element g){switch (i.nodeType){case AB.FK:SpanElement m=new SpanElement();m.classes.add('source_pi');String BB=(i as sB).VG;String EB=(i as sB).nF;m.appendText('<?xml version="${BB}" encoding="${EB}"?>');g.append(m);g.appendText('\n');for(AB k=i.firstChild;k!=null;k=k.nextSibling){PO(k,g);}break;case AB.FE:g.appendText('<');SpanElement j=new SpanElement();j.classes.add('source_element_name');j.appendText(i.nodeName);g.append(j);if(i.attributes!=null){for(lC v in i.attributes.values){g.appendText(' ');SpanElement o=new SpanElement();o.classes.add('source_attribute_name');o.appendText(v.nodeName);g.append(o);g.appendText('="');SpanElement s=new SpanElement();s.classes.add('source_attribute_value');mZ(s,v.nodeValue);g.append(s);g.appendText('"');}}if(i.firstChild!=null){g.appendText('>');if(i.childNodes!=null){for(AB k in i.childNodes){PO(k,g);}}g.appendText('</');j=new SpanElement();j.classes.add('source_element_name');j.appendText(i.nodeName);g.append(j);g.appendText('>');}else{g.appendText('/>');}break;case AB.kE:mZ(g,i.nodeValue);break;case AB.DK:SpanElement h=new SpanElement();h.classes.add('source_comment');h.appendText(i.toString());g.append(h);break;case AB.TQ:SpanElement h=new SpanElement();h.classes.add('source_entity');h.appendText(i.toString());g.append(h);break;case AB.BK:SpanElement h=new SpanElement();h.classes.add('source_cdata');h.appendText(i.toString());g.append(h);break;case AB.CK:SpanElement h=new SpanElement();h.classes.add('source_pi');h.appendText(i.toString());g.append(h);break;case AB.qL:SpanElement h=new SpanElement();h.classes.add('source_doctype');h.appendText(i.toString());g.append(h);break;default:g.appendText(i.toString());break;}}void mZ(Element i,String g){Map<String,String> k=<String,String>{'&':'&amp;','"':'&quot;','<':'&lt;','>':'&gt;'};Iterable<String> o=k.keys;int h=0;while(h<g.length){String m=g[h];if(o.contains(m)){if(h>0)i.appendText(g.substring(0,h));SpanElement j=new SpanElement();j.classes.add('source_entity');j.appendText(k[m]);i.append(j);g=g.substring(h+1);h=0;}else h++ ;}if(g.length>0)i.appendText(g);}void close(){DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}void RP(){Selection g=window.getSelection();Range h=new Range();h.selectNodeContents(querySelector('.source_content'));g.removeAllRanges();g.addRange(h);}}class xM{int nZ;lP oZ;wM pZ;xM(){nZ=0;oZ=new lP();pZ=new wM();}DivElement html(){DivElement k=new DivElement();k.id='left_panel';DivElement m=new DivElement();m.id='tab_buttons';SpanElement h=new SpanElement();h.id='insert_tab_button';h.classes.add('tab_button');h.classes.add('selected');h.setAttribute('tabindex','-1');h.appendText(LB.MB('left.insert'));h.onClick.listen((MouseEvent j)=>SP());h.onKeyDown.listen((KeyboardEvent j){int g=j.keyCode;if(g==KeyCode.ENTER||g==KeyCode.DOWN){Element s=document.getElementById('insert');if(s.firstChild is ButtonElement){j.preventDefault();(s.firstChild as ButtonElement).focus();}}else if(g==KeyCode.RIGHT){VP();}else if(g==KeyCode.TAB){Timer.run((){IB.cursor.show();IB.cursor.focus();});}});m.append(h);SpanElement i=new SpanElement();i.id='tree_tab_button';i.classes.add('tab_button');i.setAttribute('tabindex','-1');i.appendText(LB.MB('left.tree'));i.onClick.listen((MouseEvent j)=>VP());i.onKeyDown.listen((KeyboardEvent j){int g=j.keyCode;if(g==KeyCode.ENTER||g==KeyCode.DOWN){if(pZ.JF!=null)pZ.JF.focus();}else if(g==KeyCode.LEFT){SP();}else if(g==KeyCode.TAB){Timer.run((){IB.cursor.show();IB.cursor.focus();});}});m.append(i);k.append(m);DivElement v=new DivElement();v.id='insert';k.append(v);DivElement o=new DivElement();o.id='tree';o.style.display='none';k.append(o);return (k);}void SP(){document.getElementById('insert').style.display='block';document.getElementById('tree').style.display='none';document.getElementById('insert_tab_button').classes.add('selected');document.getElementById('tree_tab_button').classes.remove('selected');document.getElementById('insert_tab_button').setAttribute('tabindex','0');document.getElementById('tree_tab_button').setAttribute('tabindex','-1');document.getElementById('insert_tab_button').focus();nZ=0;if(IB.vC()==null)return;n g=IB.vC().u;if(g is OB)g=g.parent;List<l> h=t.kO(g);List<l> i=t.dP(h);oZ.update(g,h,i);}void VP(){document.getElementById('tree').style.display='block';document.getElementById('insert').style.display='none';document.getElementById('tree_tab_button').classes.add('selected');document.getElementById('insert_tab_button').classes.remove('selected');document.getElementById('tree_tab_button').setAttribute('tabindex','0');document.getElementById('insert_tab_button').setAttribute('tabindex','-1');document.getElementById('tree_tab_button').focus();nZ=1;pZ.update();}void update(n g,List<l> h,List<l> i){if(nZ==0)oZ.update(g,h,i);else pZ.update();}}class XG{l eF;l QH;StreamSubscription<KeyboardEvent> zO;XG.UX(this.eF){}XG.WX(this.QH,this.eF){}void show(){DivElement m=new DivElement();m.id='dlg1';m.classes.add('dlg1');DivElement HB=new DivElement();HB.classes.add('dlg2');DivElement g=new DivElement();g.classes.add('dlg3');DivElement h=new DivElement();h.style.position='absolute';h.style.top='0px';h.style.right='0px';h.style.width='16px';h.style.height='16px';ImageElement i=new ImageElement();i.src='packages/daxe/images/close_dialog.png';i.width=16;i.height=16;i.style.position='fixed';i.onClick.listen((MouseEvent j)=>close());h.append(i);g.append(h);DivElement JB=new DivElement();JB.classes.add('dlgtitle');if(QH==null)JB.text=t.CB.OD(eF);else JB.text=t.CB.fK(eF,QH);g.append(JB);if(QH==null){ParagraphElement o=new ParagraphElement();o.appendText(LB.MB('help.element_name')+' ');SpanElement QB=new SpanElement();QB.classes.add('help_element_name');QB.text=t.CB.cD(eF);o.append(QB);g.append(o);}String k;if(QH==null)k=t.CB.wH(eF);else k=t.CB.vG(eF,QH);if(k!=null){k=HH.lT(k);ParagraphElement o=new Element.html("<p>${k}</p>");g.append(o);}if(QH==null){String CC=t.CB.ZD(eF);if(CC!=null){DivElement SB=new DivElement();SB.classes.add('help_regexp');SB.text=CC;g.append(SB);}SpanElement s=new SpanElement();s.id='help_parents';s.classes.add('help_list_title');s.text=LB.MB('help.parents');s.onClick.listen((MouseEvent j)=>XV());g.append(s);SpanElement v=new SpanElement();v.id='help_children';v.classes.add('help_list_title');v.text=LB.MB('help.children');v.onClick.listen((MouseEvent j)=>fR());g.append(v);SpanElement BB=new SpanElement();BB.id='help_attributes';BB.classes.add('help_list_title');BB.text=LB.MB('help.attributes');BB.onClick.listen((MouseEvent j)=>WV());g.append(BB);DivElement cB=new DivElement();cB.classes.add('help_list_div');UListElement IC=new UListElement();IC.id='help_list';cB.append(IC);g.append(cB);}DivElement hB=new DivElement();hB.classes.add('buttons');ButtonElement EB=new ButtonElement();EB.attributes['type']='submit';EB.appendText(LB.MB("button.Close"));EB.onClick.listen((MouseEvent j)=>close());hB.append(EB);g.append(hB);HB.append(g);m.append(HB);document.body.append(m);if(g.clientHeight>m.clientHeight*3/4){HB.style.left="33%";g.style.left="-25%";}if(QH==null)fR();zO=document.onKeyDown.listen(null);zO.onData((KeyboardEvent j){if(j.keyCode==KeyCode.ESC){close();}});EB.focus();}void XV(){SpanElement o=document.getElementById('help_parents');o.classes.add('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.remove('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.remove('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.fC(eF);if(g==null||g.length==0)return;HashMap<l,String> i=OR(g.toSet());g.sort((BB,EB)=>i[BB].toLowerCase().compareTo(i[EB].toLowerCase()));for(l j in g){LIElement h=new LIElement();h.text=i[j];String m=t.CB.wH(j);if(m!=null)h.title=m;h.onClick.listen((MouseEvent HB)=>cS(j));h.classes.add('help_selectable');k.append(h);}}HashMap<l,String> OR(Set<l> EB,[int k=0]){HashMap<String,Set<l>> m=new HashMap<String,Set<l>>();for(l g in EB){Set<l> s=vU(g,k);String o=t.CB.OD(s.first);if(o!=null){bool v=true;for(l HB in s){if(t.CB.OD(HB)!=o){v=false;break;}}if(v){String h;if(k==0)h=t.CB.OD(g);else h=t.CB.OD(g)+" ("+o+")";Set i=m[h];if(i==null){i=new HashSet<l>();m[h]=i;}i.add(g);}}}HashMap<l,String> j=new HashMap<l,String>();for(String h in m.keys){Set<l> i=m[h];if(i.length>1&&k<10){HashMap<l,String> BB=OR(i,k+1);j.addAll(BB);for(l g in i)if(BB[g]==null){if(h.indexOf('(')==-1&&g.getAttribute('type')!='')j[g]=h+" ("+g.getAttribute('type')+")";else j[g]=h;}}else{for(l g in i)j[g]=h;}}return (j);}Set<l> vU(l k,int m){Set<l> g=new Set<l>();g.add(k);for(int h=0;h<m;h++ ){Set<l> i=new Set<l>();for(l o in g){List<l> j=t.CB.fC(o);if(j!=null)i.addAll(j);}g=i;}return (g);}void fR(){SpanElement o=document.getElementById('help_parents');o.classes.remove('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.add('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.remove('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.XC(eF);if(g==null||g.length==0)return;HashMap<l,String> i=new HashMap.fromIterable(g,value:(l BB)=>t.CB.OD(BB));g.sort((EB,HB)=>i[EB].toLowerCase().compareTo(i[HB].toLowerCase()));for(l j in g){LIElement h=new LIElement();h.text=i[j];String m=t.CB.wH(j);if(m!=null)h.title=m;h.onClick.listen((MouseEvent JB)=>cS(j));h.classes.add('help_selectable');k.append(h);}}void WV(){SpanElement o=document.getElementById('help_parents');o.classes.remove('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.remove('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.add('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.fE(eF);if(g==null||g.length==0)return;HashMap<l,String> i=new HashMap.fromIterable(g,value:(l h)=>t.CB.fK(eF,h));g.sort((BB,EB)=>i[BB].toLowerCase().compareTo(i[EB].toLowerCase()));for(l h in g){LIElement j=new LIElement();j.text=i[h];String m=t.CB.vG(eF,h);if(m!=null)j.title=m;k.append(j);}}void cS(l g){this.eF=g;QH=null;close();show();}void close(){zO.cancel();DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}}class GH{TextAreaElement iD;SpanElement QF;q selectionStart;q selectionEnd;List<SpanElement> YP=new List<SpanElement>();List<n> EL=new List<n>();bool visible;static const Duration QT=const Duration(milliseconds:700);Timer bP;HashMap<int,GD> GL;GH(){iD=querySelector("#tacursor");QF=querySelector("#caret");visible=true;GL=new HashMap<int,GD>();iD.onKeyUp.listen((KeyboardEvent g)=>yV(g));iD.onKeyDown.listen((KeyboardEvent g)=>xV(g));iD.onBlur.listen((Event g)=>blur(g));IP();}void jW(HashMap<String,GD> h){HashMap<String,int> g=new HashMap<String,int>();g['A']=KeyCode.A;g['B']=KeyCode.B;g['C']=KeyCode.C;g['D']=KeyCode.D;g['E']=KeyCode.E;g['F']=KeyCode.F;g['G']=KeyCode.G;g['H']=KeyCode.H;g['I']=KeyCode.I;g['J']=KeyCode.J;g['K']=KeyCode.K;g['L']=KeyCode.L;g['M']=KeyCode.M;g['N']=KeyCode.N;g['O']=KeyCode.O;g['P']=KeyCode.P;g['Q']=KeyCode.Q;g['R']=KeyCode.R;g['S']=KeyCode.S;g['T']=KeyCode.T;g['U']=KeyCode.U;g['V']=KeyCode.V;g['W']=KeyCode.W;g['X']=KeyCode.X;g['Y']=KeyCode.Y;g['Z']=KeyCode.Z;for(String i in h.keys){String j=i.toUpperCase();if(g[j]!=null)GL[g[j]]=h[i];}}static q oJ(MouseEvent h){q g=t.zG(h.client.x,h.client.y);if(g==null)return (null);g.zE();assert(g.u!=null);return (g);}void xV(KeyboardEvent h){if(selectionStart==null)return;bool i=h.ctrlKey||h.metaKey;bool j=h.shiftKey;int g=h.keyCode;if(i&&g==KeyCode.X){iD.value=copy();iD.select();}else if(i&&g==KeyCode.C){iD.value=copy();iD.select();}else if(g==KeyCode.PAGE_DOWN){KW();}else if(g==KeyCode.PAGE_UP){LW();}else if(g==KeyCode.END){zV();}else if(g==KeyCode.HOME){AW();}else if(g==KeyCode.LEFT){if(j)kW();else left();}else if(g==KeyCode.UP){tW();}else if(g==KeyCode.RIGHT){if(j)lW();else right();}else if(g==KeyCode.DOWN){SV();}else if(g==KeyCode.BACKSPACE){AV();}else if(g==KeyCode.DELETE){pW();}else if(i&&GL[g]!=null){h.preventDefault();return;}else if(iD.value!=''){String k=iD.value;iD.value='';t.CS(k,j);}else{return;}IP();}void yV(KeyboardEvent j){bool i=j.ctrlKey||j.metaKey;bool h=j.shiftKey;int g=j.keyCode;if(selectionStart==null)return;if(i&&!h&&g==KeyCode.Z){t.aH();iD.value='';}else if(i&&((!h&&g==KeyCode.Y)||(h&&g==KeyCode.Z))){t.cM();iD.value='';}else if(i&&!h&&g==KeyCode.X){eM();iD.value='';IB.LC();}else if(i&&!h&&g==KeyCode.C){iD.value='';}else if(i&&!h&&g==KeyCode.V){if(selectionStart!=selectionEnd){eM();}OW(iD.value);iD.value='';IB.LC();}else if(i&&GL[g]!=null){j.preventDefault();GL[g]();IB.LC();}else if(iD.value!=''){String k=iD.value;iD.value='';t.CS(k,h);}else{return;}IP();}void blur(Event g){UH();}void AW(){HD h=selectionStart.jF();n g=selectionStart.u;if(g==null)return;while(!g.eC&&g.parent!=null)g=g.parent;Element j=g.oB();Rectangle k=j.getBoundingClientRect();h.x=k.left+1;h.y+= 5;q i=t.zG(h.x,h.y);if(i==null)return;if(i!=null){moveTo(i);IB.LC();}}void zV(){HD h=selectionStart.jF();n g=selectionStart.u;if(g==null)return;while(!g.eC&&g.parent!=null)g=g.parent;Element j=g.oB();Rectangle k=j.getBoundingClientRect();h.x=k.right-1;h.y+= 5;q i=t.zG(h.x,h.y);if(i==null)return;if(i!=null){moveTo(i);IB.LC();}}void left(){xG();selectionStart=TS(selectionStart);selectionEnd=new q.pX(selectionStart);bH(true);IB.LC();}void right(){q g=new q.pX(selectionEnd);g=PS(g);xG();selectionStart=new q.pX(g);selectionEnd=new q.pX(g);bH(true);IB.LC();}void tW(){xG();HD g=selectionStart.jF();if(g==null)return;q h=selectionStart;while(h==selectionStart){g.y=g.y-7;h=t.zG(g.x,g.y);h.zE();}if(h!=null){selectionStart=h;selectionEnd=new q.pX(selectionStart);}bH(true);IB.LC();}void SV(){xG();HD g=selectionStart.jF();if(g==null)return;q h=selectionStart;while(h==selectionStart){g.y=g.y+14;h=t.zG(g.x,g.y);h.zE();}if(h!=null){selectionStart=h;selectionEnd=new q.pX(selectionStart);}bH(true);IB.LC();}void kW(){q g=new q.pX(selectionStart);g=TS(g);gE(g,selectionEnd);}void lW(){q g=new q.pX(selectionEnd);g=PS(g);gE(selectionStart,g);}void LW(){HD g=selectionStart.jF();if(g==null)return;DivElement h=document.getElementById('doc1');g.y-= h.offsetHeight;q i=t.zG(g.x,g.y);if(i!=null){int j=h.scrollTop;moveTo(i);h.scrollTop=j-h.offsetHeight;IB.LC();}}void KW(){HD g=selectionStart.jF();if(g==null)return;DivElement h=document.getElementById('doc1');g.y+= h.offsetHeight;q i=t.zG(g.x,g.y);if(i!=null){int j=h.scrollTop;moveTo(i);h.scrollTop=j+h.offsetHeight;IB.LC();}}void AV(){if(selectionStart==selectionEnd){n g=selectionStart.u;int h=selectionStart.KB;if(g is nG&&h==0)return;if(g is OB&&h==0&&g.nodeValue[0]=='\n'&&g.previousSibling!=null&&g.previousSibling.RE()){WJ(selectionStart);return;}if(g is OB&&h==0&&g.nodeValue[0]=='\n'&&g.previousSibling==null&&g.parent.RG()){WJ(selectionStart);return;}bool k=false;while(g!=null&&g.ED&&h==0&&g.PB>0){if(g.ED&&g.eC)k=true;else k=false;h=g.parent.ZB(g);g=g.parent;}if(g is!OB&&h>0){n i=g.eB(h-1);if(k){n j=g.eB(h);assert(j.ED&&j.eC);if(i.DB!=j.DB&&!i.eC&&((i is OB&&t.CB.PE(j.DB))||(i.DB!=null&&t.CB.fD(j.DB,i.DB)))){OS(j);return;}}if(i.ED&&i.eC&&h<g.PB){n j=g.eB(h);if(i.DB!=j.DB&&!j.eC&&((j is OB&&t.CB.PE(i.DB))||(j.DB!=null&&t.CB.fD(i.DB,j.DB)))){NS(i);return;}}if(i.ED&&(!i.eC||(h==g.PB||g.eB(h).DB!=i.DB))){g=g.eB(h-1);h=g.PB;if(g is!OB&&h>0)i=g.eB(h-1);else i=null;}}while((g is!OB&&g.ED)&&g.PB==h&&g.firstChild!=null){g=g.lastChild;h=g.PB;}selectionStart=new q(g,h);selectionEnd=new q.pX(selectionStart);selectionStart.PG(-1);WJ(selectionStart);}else{eM();}IB.LC();}void pW(){if(selectionStart==selectionEnd){if(selectionStart.u is nG&&selectionStart.KB==selectionStart.u.PB)return;n g=selectionStart.u;int i=selectionStart.KB;while(g.ED&&i==g.PB&&g.PB>0){i=g.parent.ZB(g)+1;g=g.parent;}if(g is!OB&&i>0&&i<g.PB){n h=g.eB(i);n j=g.eB(i-1);if(j.ED&&j.eC&&h.DB!=j.DB&&!h.eC&&((h is OB&&t.CB.PE(j.DB))||(h.DB!=null&&t.CB.fD(j.DB,h.DB)))){NS(j);return;}if(h.ED&&h.eC&&h.DB!=j.DB&&!j.eC){if((j is OB&&t.CB.PE(h.DB))||(j.DB!=null&&t.CB.fD(h.DB,j.DB))){OS(h);return;}}}if(g is!OB&&i<g.PB){n h=g.eB(i);while(h!=null&&h.ED&&(!h.eC||(i==0||g.eB(i-1).DB!=h.DB))){g=h;i=0;if(g is!OB&&i<g.PB)h=g.eB(i);else h=null;}}selectionStart=new q(g,i);selectionEnd=new q.pX(selectionStart);WJ(selectionStart);}else{eM();}IB.LC();}q PS(q j){if(j.u is nG&&j.KB==j.u.PB)return (j);n g=j.u;int h=j.KB;while(g!=null&&g.ED&&h==g.PB&&!g.eC){h=g.parent.ZB(g)+1;g=g.parent;}n i;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;while(i!=null&&i.ED&&!i.eC){g=i;h=0;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;}bool k=false;if(h==g.PB){k=(g.ED&&g.eC);h=g.parent.ZB(g)+1;g=g.parent;while(k&&g.ED&&g.eC&&h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}}else if(g is OB){h++ ;}else{g=g.eB(h);q m=g.QE();if(m!=null){g=m.u;h=m.KB;k=(g.ED&&g.eC);}else{h=g.parent.ZB(g)+1;g=g.parent;}}if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;while(i!=null&&i.ED&&(!i.eC||k)){g=i;h=0;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;}return (new q(g,h));}q TS(q j){if(j.u is nG&&j.KB==0)return (j);n g=j.u;int h=j.KB;while(g!=null&&g.ED&&h==0&&!g.eC){h=g.parent.ZB(g);g=g.parent;}n i;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;while(i!=null&&i.ED&&!i.eC){g=i;h=g.PB;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;}bool k=false;if(h==0){k=(g.ED&&g.eC);h=g.parent.ZB(g);g=g.parent;while(k&&g.ED&&g.eC&&h==0){h=g.parent.ZB(g);g=g.parent;}}else if(g is OB){h-- ;}else{g=g.eB(h-1);h=g.PB;q m=g.SF();if(m!=null){g=m.u;h=m.KB;k=(g.ED&&g.eC);}else{h=g.parent.ZB(g);g=g.parent;}}if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;while(i!=null&&i.ED&&(!i.eC||k)){g=i;h=g.PB;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;}return (new q(g,h));}void bH(bool j){if(selectionEnd!=selectionStart)return;HD g=selectionStart.jF();if(g==null){visible=false;}else{visible=true;DivElement h=document.getElementById('doc1');int i=h.offset.top;int k=h.offset.height;if(g.y-i<0||g.y-i>k){if(j){h.scrollTop+= g.y.toInt()-i;g=selectionStart.jF();}else{visible=false;}}}if(visible){QF.style.visibility='visible';QF.style.top="${g.y}px";QF.style.left="${g.x}px";eW();iD.style.top="${g.y}px";iD.style.left="${g.x}px";iD.focus();}else{QF.style.visibility='hidden';}}void eW(){bool i;Element k=selectionStart.u.oB();bool m=qZ(k);if(m&&selectionStart.u.PB>0){bool g;if(selectionStart.KB>0){n o=selectionStart.u.eB(selectionStart.KB-1);Element s=o.oB();g=qZ(s);}else{if(selectionStart.u is xD)g=false;else g=true;}bool h;if(selectionStart.KB<selectionStart.u.PB){n j=selectionStart.u.eB(selectionStart.KB);Element v=j.oB();if(j is xD&&selectionStart.KB==0)h=false;else h=qZ(v);}else h=true;i=g&&h;}else i=false;if(i)QF.classes.add('horizontal');else if(QF.classes.contains('horizontal'))QF.classes.remove('horizontal');}bool qZ(Element g){return (g is DivElement||g is TableElement||g is UListElement||g is LIElement);}void moveTo(q g){xG();selectionStart=new q.pX(g);selectionStart.zE();selectionEnd=new q.pX(selectionStart);bH(true);}void UH(){visible=false;QF.style.visibility='hidden';}void show(){if(selectionStart!=null&&selectionStart==selectionEnd){visible=true;QF.style.visibility='visible';}}void focus(){if(visible)show();iD.focus();}void IV(){iD.value='';}gE(q o,q s){if(selectionStart==o&&selectionEnd==s){if(o==s){bH(false);}return;}xG();q HB=selectionStart;selectionStart=new q.pX(o);selectionEnd=new q.pX(s);if(selectionStart==selectionEnd){bH(false);IB.LC();return;}if(selectionStart>selectionEnd){q JB=selectionStart;selectionStart=selectionEnd;selectionEnd=JB;}while((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==0){selectionStart=new q(selectionStart.u.parent,selectionStart.u.parent.ZB(selectionStart.u));}while((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==selectionStart.u.PB){selectionStart=new q(selectionStart.u.parent,selectionStart.u.parent.ZB(selectionStart.u)+1);}while((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==selectionEnd.u.PB){selectionEnd=new q(selectionEnd.u.parent,selectionEnd.u.parent.ZB(selectionEnd.u)+1);}while((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==0){selectionEnd=new q(selectionEnd.u.parent,selectionEnd.u.parent.ZB(selectionEnd.u));}if(selectionStart!=selectionEnd){if((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==selectionStart.u.PB){n g=selectionStart.u.nextNode();selectionStart=new q(g.parent,g.parent.ZB(g));}if((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==0){n j=selectionEnd.u.previousNode();selectionEnd=new q(j.parent,j.parent.ZB(j)+1);}bool m;do{m=false;if(selectionStart.u is!OB&&selectionStart.KB<selectionStart.u.PB){n g=selectionStart.u.eB(selectionStart.KB);if(new q(selectionStart.u,selectionStart.KB+1)>selectionEnd&&new q(g,0)<selectionEnd){selectionStart=new q(g,0);m=true;}}}while(m);do{m=false;if(selectionEnd.u is!OB&&selectionEnd.KB>0){n j=selectionEnd.u.eB(selectionEnd.KB-1);if(new q(selectionEnd.u,selectionEnd.KB-1)<selectionStart&&new q(j,j.PB)>selectionStart){selectionEnd=new q(j,j.PB);m=true;}}}while(m);}if(selectionStart.u==selectionEnd.u){n v=selectionStart.u;if(v.nodeType==n.mB){TP(v,selectionStart.KB,selectionEnd.KB);}else{for(int BB=selectionStart.KB;BB<selectionEnd.KB;BB++ ){n EB=v.eB(BB);EB.FL(true);EL.add(EB);}}}else{n h=selectionStart.u;if(h.nodeType==n.mB)h=h.parent;if(selectionEnd>new q(h,h.PB))selectionEnd=new q(h,h.PB);else{n k=selectionEnd.u;if(k.nodeType==n.mB)k=k.parent;if(k!=h){while(k.parent!=h){k=k.parent;}selectionEnd=new q(h,h.ZB(k));}}n i;if(selectionStart.u.nodeType==n.tC||selectionStart.u.nodeType==n.YG){i=selectionStart.u.eB(selectionStart.KB);if(i!=null){q QB=new q(selectionStart.u,selectionStart.KB+1);if(selectionEnd>=QB){i.FL(true);EL.add(i);}}}else{i=selectionStart.u;TP(i,selectionStart.KB,i.PB);}if(i!=null){for(n g=i.nextSibling;g!=null;g=g.nextSibling){q SB=new q(g.parent,g.parent.ZB(g));if(SB<selectionEnd){if(g.nodeType!=n.mB||selectionEnd>=new q(g.parent,g.parent.ZB(g)+1)){g.FL(true);EL.add(g);}}else break;}}if(selectionEnd.u.nodeType==n.mB){TP(selectionEnd.u,0,selectionEnd.KB);}}if(selectionEnd!=selectionStart)UH();if(selectionStart!=HB)IB.LC();}void TP(n o,int j,int k){Element h=o.oB();if(h==null)return;Text m=h.nodes.first;Node s=m.nextNode;UH();String i=o.nodeValue;if(j==0){m.remove();}else{m.text=i.substring(0,j);}SpanElement g=new SpanElement();YP.add(g);g.classes.add('selection');g.append(new Text(i.substring(j,k)));if(s==null)h.append(g);else h.insertBefore(g,s);if(k!=i.length){Text v=new Text(i.substring(k));if(g.nextNode==null)h.append(v);else h.insertBefore(v,g.nextNode);}}void xG(){for(SpanElement i in YP){Element g=i.parent;StringBuffer h=new StringBuffer();for(Node j in g.nodes){h.write(j.text);}g.nodes.clear();g.append(new Text(h.toString()));selectionEnd=new q.pX(selectionStart);visible=true;}YP.clear();for(n k in EL){k.FL(false);}EL.clear();}void IP(){if(!visible)return;if(bP!=null)bP.cancel();QF.style.visibility="visible";bP=new Timer.periodic(QT,(Timer g)=>EV());}void EV(){if(!visible)return;if(QF.style.visibility=="hidden")QF.style.visibility="visible";else if(QF.style.visibility=="visible")QF.style.visibility="hidden";}void WJ(q h){n g;if(h.u.nodeType==n.mB&&h.u.PB<h.KB+1&&h.u.nextSibling!=null){n j=h.u;n k=j.nextSibling;while(k==null&&j.parent!=null){j=j.parent;k=j.nextSibling;}g=k;if(g.nodeType==n.mB&&g.parent!=null&&g.PB==1)g=g.parent;}else if(h.u.nodeType==n.mB&&h.u.PB<h.KB+1&&h.u.nextSibling==null){g=h.u;if(g.parent!=null)g=g.parent;if(g.ED&&g.eC){if(g.nextSibling.DB==g.DB){DP(g,g.nextSibling);}else{q m=new q.pX(h);m.PG(1);if(m>h)WJ(m);}return;}}else if(h.u.nodeType==n.tC&&h.u.PB<h.KB+1){g=h.u;if(g.ED&&g.eC){if(g.nextSibling!=null&&g.nextSibling.DB==g.DB){DP(g,g.nextSibling);return;}}}else if(h.u.nodeType==n.tC||h.u.nodeType==n.YG){g=h.u.eB(h.KB);if(g.ED&&g.eC){if(g.previousSibling!=null&&g.previousSibling.DB==g.DB){DP(g.previousSibling,g);return;}else if(g.PB>0){q o=new q.pX(h);o.PG(-1);if(o<h)WJ(o);return;}}if(g==null){window.alert("I'm sorry Dave, I'm afraid I can't do that.");return;}}else if(h.u.nodeType==n.mB&&h.KB==0&&h.u.PB==1&&h.u.parent is zB&&h.u.parent.PB==1){g=h.u.parent;while(g.parent is zB&&g.parent.PB==1)g=g.parent;}else{t.UW(h,1);sE i=zB.VN(selectionStart);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove_text'),2);gE(i.start,i.end);}return;}if(g is xD&&g.parent.PB==1){g=g.parent;}if(!g.dJ){t.dM(g);sE i=zB.VN(selectionStart);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove_element'),2);gE(i.start,i.end);}}}void eM(){if(selectionStart==selectionEnd)return;q g=new q.pX(selectionStart);q h=new q.pX(selectionEnd);xG();if(g.u is iC&&g.u==h.u&&g.KB==0&&h.KB==h.u.PB){t.dM(g.u);}else{t.OP(g,h);sE i=zB.VN(g);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove'),2);gE(i.start,i.end);}}}void refresh(){q g=selectionStart;q h=selectionEnd;selectionStart=null;selectionEnd=null;gE(g,h);}String copy(){StringBuffer h=new StringBuffer();if(selectionStart.u==selectionEnd.u){n j=selectionStart.u;if(j.nodeType==n.mB){h.write(j.nodeValue.substring(selectionStart.KB,selectionEnd.KB));}else{for(int k=selectionStart.KB;k<selectionEnd.KB;k++ ){n m=j.eB(k);h.write(m);}}}else{n i;if(selectionStart.u.nodeType==n.tC){i=selectionStart.u.eB(selectionStart.KB);q o=new q(selectionStart.u,selectionStart.KB+1);if(selectionEnd>=o){h.write(i);}}else{i=selectionStart.u;h.write(i.nodeValue.substring(selectionStart.KB));}for(n g=i.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<selectionEnd){if(g.nodeType!=n.mB||selectionEnd>=new q(g.parent,g.parent.ZB(g)+1)){h.write(g);g.FL(true);}}else break;}if(selectionEnd.u.nodeType==n.mB){h.write(selectionEnd.u.nodeValue.substring(0,selectionEnd.KB));}}return (h.toString());}bool OW(String i){sB k;try {EG v=new EG();k=v.parseFromString("<root>${i}</root>");}on UD catch (m){bool j=false;if(i.trim()!=''){n g=selectionStart.u;if(g.nodeType==n.mB)g=g.parent;if(g.nodeType==n.YG)j=true;else if(g.DB!=null&&!t.CB.PE(g.DB))j=true;}if(j){window.alert(LB.MB('insert.text_not_allowed'));return (false);}t.XM(selectionStart,i);return (true);}n g=selectionStart.u;if(g is OB)g=g.parent;l o=k.documentElement;n h=ND.NF(g.DB);if(o.childNodes!=null){for(AB BB in o.childNodes){n EB=ND.fH(BB,h);h.jB(EB);}}h.NG();if(t.ZC!=null){kB.RN(g,h);t.QP(h);}GB s=new GB.uX(LB.MB('undo.paste'));try {s.TB(t.LE(h,selectionStart,checkValidity:true));}on CD catch (m){window.alert(m.toString());return (false);}t.DC(s);return (true);}void DP(n g,n h){GB j=new GB.uX(LB.MB('undo.remove_text'));n i;q m=new q(h,0);q o=new q(h,h.PB);if(o>m)i=t.iI(m,o);else i=null;j.TB(new GB.rX(h));if(i!=null)j.TB(t.LE(i,new q(g,g.PB)));q k;if(g.lastChild is OB)k=new q(g.lastChild,g.lastChild.PB);else k=new q(g,g.PB);t.DC(j);IB.KD(k);}void OS(n g){assert(g.previousSibling!=null);int s=g.parent.ZB(g);GB k=new GB.uX(LB.MB('undo.remove_text'));int h=s;bool v=t.CB.PE(g.DB);while(h>0){n i=g.parent.eB(h-1);if(i.eC||(i is OB&&!v)||(i.DB!=null&&!t.CB.fD(g.DB,i.DB)))break;h-- ;}q m=new q(g.parent,h);q o=new q(g.parent,s);assert(m<o);n BB=t.IG(g.parent,m,o);k.TB(t.GI(m,o));k.TB(t.LE(BB,new q(g,0)));q j=new q(g,0);j.zE();j=new q.lX(j);t.DC(k);moveTo(j);IB.LC();return;}void NS(n g){assert(g.nextSibling!=null);int s=g.parent.ZB(g.nextSibling);GB k=new GB.uX(LB.MB('undo.remove_text'));int h=s;bool v=t.CB.PE(g.DB);while(h<g.parent.PB){n i=g.parent.eB(h);if(i.eC||(i is OB&&!v)||(i.DB!=null&&!t.CB.fD(g.DB,i.DB)))break;h++ ;}q m=new q(g.parent,h);q o=new q(g.parent,s);assert(o<m);n BB=t.IG(g.parent,o,m);k.TB(t.GI(o,m));k.TB(t.LE(BB,new q(g,g.PB)));q j=new q(g,g.PB);j.zE();j=new q.gX(j);t.DC(k);moveTo(j);IB.LC();return;}}class bB{static const int ME=0;static const int iE=1;static const int BN=2;n rZ;int sZ;bool tZ;bB(n h,int i,[bool g]){rZ=h;sZ=i;if(g!=null)tZ=g;else tZ=false;}Element html(){Element h=new SpanElement();String i;if(sZ==ME)i="start_tag";else if(sZ==iE)i="end_tag";else if(sZ==BN)i="empty_tag";h.classes.add(i);if(tZ)h.classes.add('long');if(sZ!=iE){bool k;if(rZ.DB!=null){List<l> v=t.CB.fE(rZ.DB);k=(v!=null&&v.length>0);}else{k=(rZ is!BG&&rZ is!qF);}if(k){ImageElement BB=new ImageElement(src:'packages/daxe/images/attributes.png',width:16,height:16);BB.onClick.listen((MouseEvent j)=>xU(j));h.append(BB);}}String g;if(rZ.DB!=null){g=t.CB.OD(rZ.DB);if(g==null)g=rZ.nodeName;}else if(rZ is BG){if(sZ==ME)g="(";else g=")";}else if(rZ is IH){if(sZ==ME)g="PI ${rZ.nodeName}";else g="PI";}else if(rZ is qF)g="CDATA";else if(rZ.nodeName!=null)g=rZ.nodeName;else g="?";if(sZ!=iE){bool JB=(t.CB.bC(rZ.DB,'attributsVisibles','false')=='true');if(JB){h.append(new Text(g));for(aB EB in rZ.attributes){h.append(new Text(" "));Element m=new SpanElement();m.attributes['class']='attribute_name';m.text=EB.localName;h.append(m);h.append(new Text("="));Element o=new SpanElement();o.attributes['class']='attribute_value';o.text=EB.value;h.append(o);}}else{List<String> HB=t.CB.dV(rZ.DB)['titreAtt'];if(HB!=null){for(String QB in HB){String s=rZ.getAttribute(QB);if(s!=null&&s!=''){g+= " '${s}'";break;}}}h.append(new Text(g));}}else h.append(new Text(g));h.onDoubleClick.listen((MouseEvent j){IB.selectNode(rZ);j.preventDefault();j.stopPropagation();});return (h);}void xU(MouseEvent g){rZ.JE();}}class yM{n RF;List<InputElement> EI;List<InputElement> LL;GD okfct;yM(this.RF,[this.okfct]){EI=new List<InputElement>();LL=new List<InputElement>();}void show(){DivElement i=new DivElement();i.id='attributes_dlg';i.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement j=new DivElement();j.classes.add('dlg3');DivElement BB=new DivElement();BB.classes.add('dlgtitle');BB.text=RF.nodeName;j.append(BB);FormElement EB=new FormElement();TableElement QB=new TableElement();SD SB=null;for(aB cB in RF.attributes){TableRowElement k=new TableRowElement();TableCellElement g=new TableCellElement();InputElement HB=uZ(cB.name);EI.add(HB);g.append(HB);k.append(g);g=new TableCellElement();InputElement hB=vZ(cB.value);LL.add(hB);g.append(hB);k.append(g);wZ(k,HB);QB.append(k);}EB.append(QB);DivElement h=new DivElement();h.classes.add('buttons');ButtonElement m=new ButtonElement();m.attributes['type']='button';m.appendText(LB.MB("attribute.add"));m.onClick.listen((MouseEvent JB)=>xZ());h.append(m);ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent JB)=>cancel());h.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent JB)=>iF(JB));h.append(s);EB.append(h);j.append(EB);v.append(j);i.append(v);document.body.append(i);if(SB!=null)SB.focus();}void iF(MouseEvent k){List<aB> j=new List<aB>();for(int h=0;h<EI.length;h++ ){TextInputElement g=EI[h];String i=g.value;if(!yZ(i)){k.preventDefault();g.select();g.selectionStart=g.selectionEnd=g.value.length;window.alert(LB.MB('attribute.invalid_attribute_name'));return;}String o=LL[h].value;int BB=i.indexOf(':');aB m;String s=t.CB!=null?t.CB.eK(i):null;m=new aB.cX(s,i,o);j.add(m);}querySelector('div#attributes_dlg').remove();k.preventDefault();if(RF.oB()!=null){GB v=new GB.sX(RF,j);t.DC(v);}else{RF.attributes=j;}IB.AH();if(okfct!=null)okfct();}void cancel(){querySelector('div#attributes_dlg').remove();IB.AH();}void wZ(i,j){TableCellElement h=new TableCellElement();ButtonElement g=new ButtonElement();g.attributes['type']='button';g.value='-';g.text='-';g.onClick.listen((Event k)=>zZ(j));h.append(g);i.append(h);}TextInputElement uZ([String h]){TextInputElement g=new TextInputElement();g.spellcheck=false;g.value=h!=null?h:"";g.size=20;g.onInput.listen((Event i)=>Aa(g));g.onKeyUp.listen((KeyboardEvent i)=>Aa(g));return (g);}bool yZ(String g){final RegExp h=new RegExp("^[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*\$");return (h.hasMatch(g));}void Aa(TextInputElement g){String h=g.value;if(yZ(h)){g.classes.add('valid');g.classes.remove('invalid');}else{g.classes.add('invalid');g.classes.remove('valid');}}TextInputElement vZ([String h]){TextInputElement g=new TextInputElement();g.spellcheck=false;g.value=h!=null?h:"";g.size=40;return (g);}xZ(){TableElement k=document.querySelector("#attributes_dlg table");TextInputElement i=uZ();TextInputElement j=vZ();EI.add(i);LL.add(j);TableRowElement h=new TableRowElement();TableCellElement g=new TableCellElement();g.append(i);h.append(g);g=new TableCellElement();g.append(j);h.append(g);wZ(h,i);k.append(h);}void zZ(InputElement h){for(int g=0;g<EI.length;g++ ){if(EI[g]==h){EI.removeAt(g);LL.removeAt(g);TableRowElement i=document.querySelector("#attributes_dlg table tr:nth-child(${g+1})");i.remove();}}}}class vD implements q{int Ba;vD(int g){assert(g>=0);Ba=g;}vD.YX(dC i){n j=i.u;int k=i.KB;Ba=0;n g=t.rC;int h=g.PB;while(g!=j||h!=k){if(h==0){h=g.parent.ZB(g);g=g.parent;}else if(g is OB){h-- ;}else{g=g.eB(h-1);h=g.PB;}Ba++ ;}}vD.jX(CE k){n i=t.rC;int m=i.PB;int j=0;n g=t.rC;int h=0;while(g!=i||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}Ba=j-k.HF;}vD.nX(vD g){Ba=g.UF;}n get u{dC g=new dC.fX(this);return (g.u);}int get KB{dC g=new dC.fX(this);return (g.KB);}int get HF{CE g=new CE.hX(this);return (g.HF);}int get UF{return (Ba);}bool operator==(q g){return (Ba==g.UF);}bool operator<(q g){return (Ba>g.UF);}bool operator<=(q g){return (Ba>=g.UF);}bool operator>(q g){return (Ba<g.UF);}bool operator>=(q g){return (Ba<=g.UF);}void PG(int g){Ba-= g;}void zE(){dC g=new dC.fX(this);g.zE();Ba=(new vD.YX(g)).Ba;}HD jF(){dC g=new dC.fX(this);return (g.jF());}String MI({bool titles: false}){dC g=new dC.fX(this);return (g.MI(titles:titles));}String toString(){return ("[RightOffsetPosition ${Ba}]");}}typedef n lJ(l elementRef);class CE implements q{int Ca;CE(int g){assert(g>=0);Ca=g;}CE.XX(dC i){n j=i.u;int k=i.KB;Ca=0;n g=t.rC;int h=0;while(g!=j||h!=k){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}Ca++ ;}}CE.hX(vD k){n i=t.rC;int m=i.PB;int j=0;n g=t.rC;int h=0;while(g!=i||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}Ca=j-k.UF;}CE.mX(CE g){Ca=g.HF;}n get u{dC g=new dC.bX(this);return (g.u);}int get KB{dC g=new dC.bX(this);return (g.KB);}int get HF{return (Ca);}int get UF{vD g=new vD.jX(this);return (g.UF);}bool operator==(q g){return (Ca==g.HF);}bool operator<(q g){return (Ca<g.HF);}bool operator<=(q g){return (Ca<=g.HF);}bool operator>(q g){return (Ca>g.HF);}bool operator>=(q g){return (Ca>=g.HF);}void PG(int g){Ca+= g;}void zE(){dC g=new dC.bX(this);g.zE();Ca=g.HF;}HD jF(){dC g=new dC.bX(this);return (g.jF());}String MI({bool titles: false}){dC g=new dC.bX(this);return (g.MI(titles:titles));}String toString(){return ("[LeftOffsetPosition ${Ca}]");}}class HH{static final String kP="string";l Da;String fM;String Ea;HashMap<String,l> Fa;HashMap<l,String> Ga;HashMap<l,String> Ha;HashMap<l,Pattern> Ia=null;HashMap<l,Pattern> Ja=null;HashMap<l,HashMap<String,List<String>>> Ka=null;List<String> La=null;XL Ma;l Na;l Oa;l Pa;l Qa;l Ra;List<l> Sa;HH(){}Future load(final String h){Completer g=new Completer();if(h==null){Da=null;return (new Future.error(new CD("Config.load: null path")));}EG s=new EG();s.AL(h).then((sB i){String m;if(i.documentElement.nodeName=="CONFIG_JAXE")m=null;else m=Ta(i.documentElement);Ea=bT(h);Da=i.documentElement;Ua();Ha=new HashMap<l,String>();final String j=cW();if(j==null){final l o=RC(Va(),"SCHEMA_SIMPLE");if(o==null){g.completeError(new CD("Error: no XML schema is defined in the config file ${h}"));return;}Ma=new gL(o,Wa());fM=null;Xa();g.complete();return;}if(Ea!=null)fM="${Ea}/${j}";else fM=j;Ma=new wB(Wa());(Ma as wB).load(fM).then((v){Xa();g.complete();},onError:(rF k){g.completeError(new CD("Error reading schemaURL: ${k}"));});},onError:(UD k){g.completeError(new CD("Error reading ${h}: ${k}"));});return (g.future);}static String bT(final String g){final int h=g.lastIndexOf("/");if(h>=0){return (g.substring(0,h));}return (null);}List<l> II(){final List<l> h=new List<l>();final List<l> j=Ma.II();l g=RC(Va(),"RACINE");while(g!=null){final String k=g.getAttribute("element");for(final l i in j)if(k==Ma.cD(i))h.add(i);g=kD(g,"RACINE");}return (h);}void OO(final n g){final List<String> o=Ya();for(final String h in o){if(h!=""){final String i=jG(h);String j;if(i!=null&&i!="")j="xmlns:${i}";else j="xmlns";g.setAttributeNS("http://www.w3.org/2000/xmlns/",j,h);}}final String k=nV();final String m=kV();if(k!=null||m!=null){g.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");if(k!=null)g.setAttributeNS("http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",k);if(m!=null)g.setAttributeNS("http://www.w3.org/2001/XMLSchema-instance","xsi:noNamespaceSchemaLocation",m);}}String cW(){final l h=RC(Va(),"FICHIER_SCHEMA");if(h==null)return (null);String g=h.getAttribute("nom");if(g=="")g=null;return (g);}HashMap<String,l> Ua(){Fa=new HashMap<String,l>();if(Da==null)return (Fa);l g=RC(Za(),"AFFICHAGE_ELEMENT");while(g!=null){final String h=g.getAttribute("element");Fa[h]=g;g=kD(g,"AFFICHAGE_ELEMENT");}return (Fa);}l tK(String g){return Fa[g];}void Xa(){Ga=new HashMap<l,String>();if(Da==null)return;final List<l> i=Ma.JD();for(final l g in i){final String h=Ma.cD(g);if(h!=null)Ga[g]=h;}}String Ta(final l h){final l g=RC(h,"FICHIERTITRES");if(g==null)return (null);return (g.getAttribute("nom"));}String nV(){final l g=RC(aa(),"SCHEMALOCATION");if(g!=null){final String h=g.getAttribute("schemaLocation");if(h!="")return (h);}return (null);}String kV(){final l g=RC(aa(),"SCHEMALOCATION");if(g!=null){final String h=g.getAttribute("noNamespaceSchemaLocation");if(h!="")return (h);}return (null);}String jG(final String h){if(h=="http://www.w3.org/XML/1998/namespace")return ("xml");l g=RC(aa(),"PREFIXE_ESPACE");while(g!=null){if(h==g.getAttribute("uri"))return (g.getAttribute("prefixe"));g=kD(g,"PREFIXE_ESPACE");}return (Ma.jG(h));}WB ba(final PL v,final l QB){final String SB=QB.getAttribute("nom");String CC=DI(SB);final WB i=new WB(CC);String cB=MS(SB);if(cB!=null){i.KI=cB;}AB g=QB.firstChild;while(g!=null){uB h=null;final String o=g.nodeName;String BB=null;if(g is l){final String EB=(g as l).getAttribute("raccourci");if(EB!=null&&EB!=""){BB=EB.toUpperCase()[0];}}if(o=="MENU_INSERTION"){final l hB=g as l;final String j=hB.getAttribute("nom");final String HB=DI(j);String s=hB.getAttribute("type_noeud");if(s=="")s="element";l k;if(s=="element"){k=hG(j);if(k==null)pJ("Erreur: MENU_INSERTION: pas de rfrence pour '${j}' dans le schma");}else k=null;h=new uB(HB,()=>v.CI(k,s),shortcut:BB,data:k);i.add(h);String m=wH(k);if(m!=null){h.KI=m;}}else if(o=="MENU_FONCTION"){final l JB=g as l;final String IC=JB.getAttribute("classe");final String j=JB.getAttribute("nom");final String HB=DI(j);h=new uB(HB,()=>v.VV(IC,JB),shortcut:BB);i.add(h);String m=MS(j);if(m!=null){h.KI=m;}}else if(o=="MENU"){h=ba(v,g as l);i.add(h);}else if(o=="SEPARATEUR")i.QO();g=g.nextSibling;}return (i);}zF BW(final PL k){final zF h=new zF();final l i=ca();if(i!=null){l g=RC(i,"MENU");while(g!=null){final WB j=ba(k,g);j.parent=h;h.add(j);g=kD(g,"MENU");}}return (h);}XL mV(){return (Ma);}List<l> uU(){final List<l> g=Ma.JD();return (g);}String cD(final l g){return (Ga[g]);}l UM(final l g,final l h){return (Ma.hG(g,h));}l hG(final String g){final l h=Ma.QM(DN(g));return (h);}List<l> nK(final String g){return (Ma.iO(DN(g)));}String kI(final l g){return (Ma.kI(g));}String PM(final l h){final String g=kI(h);if(g==null)return (null);return (jG(g));}List<String> pK(final l g){final List<String> h=Ma.pK(g);return (h);}bool wO(final l g,final String h){return (Ma.jO(g,h));}List<String> Ya(){if(La!=null)return (La);final List<String> g=new List<String>();final List<String> h=Ma.EP();if(h!=null)g.addAll(h);La=g;return (g);}bool HI(final l g,final l h){return (Ma.HI(g,h));}bool fD(final l h,final l i){final List<l> g=XC(h);if(g==null)return (false);return (g.contains(i));}l fF(final l i,final List<l> j){final List<l> g=XC(i);if(g==null)return (null);for(l h in j)if(g.contains(h))return (h);return (null);}List<l> XC(final l g){return (Ma.XC(g));}String da(final l g,final bool h,final bool i){return (Ma.ZD(g,h,i));}String ZD(final l g){return (Ma.ZD(g,true,false));}bool WM(n h,final int m,final int o,final l s){if(h.nodeType==n.YG){for(n g in h.childNodes){if(g.nodeType==n.tC)return (false);}return (true);}assert(h.nodeType==n.tC);if(Ma is gL)return (true);if(m<0){pJ("Config.insertionPossible: debutSelection < parent.debut");return (false);}if(Ma is wB){final List<l> i=new List<l>();bool j=false;for(n g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==n.tC){int k=h.ZB(g);if(k<m||k>=o){if(!j&&k>=o){i.add(s);j=true;}i.add(g.DB);}}}if(!j)i.add(s);final bool v=(Ma as wB).fS(h.DB,i,true);return (v);}return (false);}bool hO(final n g){if(g is BG||g is IH||g is qF)return (true);if(g.DB==null)return (false);if(!zU(g))return (false);if(g.firstChild==null&&!wO(g.DB,''))return (false);else if(g.childNodes.length==1&&g.firstChild is OB&&g.firstChild.nodeValue!=null&&!wO(g.DB,g.firstChild.nodeValue))return (false);if(Ma is gL)return (true);if(Ma is wB){final List<l> v=new List<l>();bool j=false;for(n i=g.firstChild;i!=null;i=i.nextSibling){if(i.nodeType==n.tC&&i.DB!=null){v.add(i.DB);}else if(i.nodeType==n.mB){if(i.nodeValue.trim()!="")j=true;}else if(i is qF){if(i.firstChild!=null&&i.firstChild.nodeValue.trim()!='')j=true;}}if(j&&!Ma.PE(g.DB))return (false);final wB BB=Ma as wB;return (BB.fS(g.DB,v,false));}final l k=g.DB;final StringBuffer o=new StringBuffer();if(Ja==null)Ja=new HashMap<l,Pattern>();bool j=false;n h=g.firstChild;while(h!=null){if(h is qF){if(h.firstChild!=null&&h.firstChild.nodeValue.trim()!='')j=true;}else if(h.nodeType==n.tC&&h is!BG&&h is!IH){o.write(h.localName);o.write(",");}else if(h.nodeType==n.mB){if(h.nodeValue.trim()!='')j=true;}h=h.nextSibling;}if(j&&!Ma.PE(k))return (false);RegExp m=Ja[k];if(m==null){final String s=da(k,false,true);if(s==null||s=="")return (true);try {m=new RegExp(r"^$expr$");}on Exception catch (EB){pJ("elementValide(JaxeElement, bool, List<String>) - Malformed Pattern: ^${s}\$:",EB);return (true);}Ja[k]=m;}final bool HB=m.hasMatch(o.toString());return (HB);}bool zU(final n h){if(h.nodeType!=n.tC){pJ("Config.attributsValides : ce n'est pas un lment: ${h}");return (false);}final List<l> m=fE(h.DB);List<String> i=new List<String>(m.length);List<String> BB=new List<String>(i.length);for(int g=0;g<m.length;g++ ){final l j=m[g];i[g]=attributeName(j);BB[g]=attributeNamespace(j);final String o=h.getAttribute(i[g]);if(o==null||o==''){if(BL(h.DB,j))return (false);}else if(!eS(j,o))return (false);}final List<aB> EB=h.attributes;for(int g=0;g<EB.length;g++ ){aB s=EB[g];final String v=s.EC;if(v=="xml"||v=="xmlns")continue;final String HB=s.localName;if(v==null&&HB=="xmlns")continue;final String JB=s.pB;if(JB=="http://www.w3.org/2001/XMLSchema-instance")continue;bool QB=false;for(int k=0;k<i.length;k++ ){if(i[k]==HB&&BB[k]==JB){QB=true;break;}}if(!QB)return (false);}return (true);}List<l> fC(final l g){return (Ma.fC(g));}bool PE(final l g){if(g==null)return (true);return (Ma.PE(g));}List<l> fE(final l g){return (Ma.fE(g));}String attributeName(final l g){return (Ma.attributeName(g));}String PH(final l j,final l g){String h=Ma.attributeName(g);String k=Ma.attributeNamespace(g);if(k!=null){String i=NR(j,g);if(i!=null)h="${i}:${h}";}return (h);}String attributeNamespace(final l g){return (Ma.attributeNamespace(g));}String NR(final l i,final l j){final String g=attributeNamespace(j);if(g==null)return (null);if(g=="http://www.w3.org/XML/1998/namespace")return ("xml");if(g=="http://www.w3.org/2000/xmlns/"&&attributeName(j)!="xmlns")return ("xmlns");String h=i.BP(g);if(h==null){if(i.ownerDocument.documentElement!=null)h=i.ownerDocument.BP(g);else h=jG(g);}return (h);}String eK(final String g){return (Ma.eK(g));}bool BL(final l g,final l h){return (Ma.UO(g,h));}List<String> hI(final l g){final List<String> h=Ma.hI(g);return (h);}String dF(final l g){return (Ma.dF(g));}bool eS(final l g,final String h){return (Ma.VO(g,h));}static String DN(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (g);return (g.substring(h+1));}String QS(final l k,final String i,final int h){if(h==AB.FE){final l j=tK(DN(i));if(j==null)return (kP);return (j.getAttribute("type"));}else if(h==AB.CK){l g=RC(Za(),"PLUGIN_INSTRUCTION");while(g!=null){if(i!=null&&i==g.getAttribute("cible"))return ("plugin");g=kD(g,"PLUGIN_INSTRUCTION");}return ("instruction");}else if(h==AB.DK){final l g=RC(Za(),"PLUGIN_COMMENTAIRE");if(g!=null)return ("plugin");return ("commentaire");}else if(h==AB.BK){final l g=RC(Za(),"PLUGIN_CDATA");if(g!=null)return ("plugin");return ("cdata");}else if(h==AB.kE){return ("texte");}return (null);}String fO(final l h){final l g=tK(cD(h));if(g==null)return (kP);return (g.getAttribute("type"));}l mO(final String h){if(Da==null)return (null);l g=RC(Za(),"AFFICHAGE_ELEMENT");while(g!=null){if(h==g.getAttribute("type"))return (hG(g.getAttribute("element")));g=kD(g,"AFFICHAGE_ELEMENT");}return (null);}List<l> yG(final String i){if(Da==null)return (null);List<l> h=new List<l>();l g=RC(Za(),"AFFICHAGE_ELEMENT");while(g!=null){if(i==g.getAttribute("type"))h.addAll(nK(g.getAttribute("element")));g=kD(g,"AFFICHAGE_ELEMENT");}return (h);}String bC(final l g,final String h,final String i){return JP(g,"element",null,h,i);}String JP(final l i,final String j,final String k,final String m,final String o){final HashMap<String,List<String>> s=tR(i,j,k);final List<String> g=s[m];String h;if(g!=null&&g.length>0)h=g[0];else h=o;return h;}HashMap<String,List<String>> ea(final l j){final HashMap<String,List<String>> i=new HashMap<String,List<String>>();l g=RC(j,"PARAMETRE");while(g!=null){final String k=g.getAttribute("nom");final String m=g.getAttribute("valeur");List<String> h=i[k];if(h==null){h=new List<String>();h.add(m);i[k]=h;}else h.add(m);g=kD(g,"PARAMETRE");}Ka[j]=i;return (i);}HashMap<String,List<String>> dV(final l g){return (tR(g,"element",null));}HashMap<String,List<String>> tR(final l m,final String i,final String k){l g;if(i=="element")g=tK(cD(m));else if(i=="instruction"){g=null;l h=RC(Za(),"PLUGIN_INSTRUCTION");while(h!=null){if(k!=null&&k==h.getAttribute("cible")){g=h;break;}h=kD(h,"PLUGIN_INSTRUCTION");}}else if(i=="commentaire"){final l h=RC(Za(),"PLUGIN_COMMENTAIRE");if(h==null){g=null;}else{g=h;}}else g=null;if(g==null)return (new HashMap<String,List<String>>());if(Ka==null)Ka=new HashMap<l,HashMap<String,List<String>>>();HashMap<String,List<String>> j=Ka[g];if(j==null)j=ea(g);return (j);}List<String> TV(final l i){final Set<String> g=new LinkedHashSet<String>();List<String> m=Ma.kM(i);if(m!=null)g.addAll(Ma.kM(i));final l j=tK(cD(i));if(j!=null){l h=RC(j,"VALEUR_SUGGEREE");while(h!=null){final String k=ZG(h);if(k!=null)g.add(k);h=kD(h,"VALEUR_SUGGEREE");}}if(g.length==0)return (null);else return (g.toList());}List<String> yU(final l s,final l j){final Set<String> h=new LinkedHashSet<String>();List<String> k=Ma.aP(j);if(k!=null)h.addAll(k);final l m=tK(cD(s));if(m!=null){final String v=attributeName(j);l g=RC(m,"AFFICHAGE_ATTRIBUT");while(g!=null){if(g.getAttribute("attribut")==v){l i=RC(g,"VALEUR_SUGGEREE");while(i!=null){final String o=ZG(i);if(o!=null)h.add(o);i=kD(i,"VALEUR_SUGGEREE");}}g=kD(g,"AFFICHAGE_ATTRIBUT");}}if(h.length==0)return (null);else return (h.toList());}List<l> fa(){final WE k=new WE();final List<l> i=new List<l>();final List<l> m=ga();for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){WE j;if(g.getAttribute("pays")=="")j=new WE.VX(h);else j=new WE.aX(h,g.getAttribute("pays"));if(k==j&&!i.contains(g))i.add(g);}}for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){final WE o=new WE.aX(k.language,k.uH);WE j;if(g.getAttribute("pays")=="")j=new WE.VX(h);else j=new WE.aX(h,g.getAttribute("pays"));if(o==j&&!i.contains(g))i.add(g);}}for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){final WE o=new WE.VX(k.language);if(o==new WE.VX(h)&&!i.contains(g))i.add(g);}}for(final l g in m){if(!i.contains(g))i.add(g);}return (i);}String DI(final String h){final List<l> m=fa();for(final l j in m){l g=qP(j,"STRINGS_MENU");while(g!=null){if(h==g.getAttribute("menu")){final l i=RC(g,"TITRE");if(i!=null&&i.firstChild!=null){return (ZG(i));}break;}g=EN(j,g,"STRINGS_MENU");}}final l k=hG(h);if(k!=null)return (OD(k));return (h);}String MS(final String j){final List<l> k=fa();for(final l i in k){l g=qP(i,"STRINGS_MENU");while(g!=null){if(j==g.getAttribute("menu")){final l h=RC(g,"DOCUMENTATION");if(h!=null&&h.firstChild!=null){return (ZG(h));}break;}g=EN(i,g,"STRINGS_MENU");}}return (null);}HashMap<String,String> Wa(){HashMap<String,String> h=new HashMap<String,String>();final List<l> m=fa();for(final l o in m){l g=RC(o,"STRINGS_ELEMENT");while(g!=null){String i=g.getAttribute("element");if(h[i]==null){String k=i;final l j=RC(g,"TITRE");if(j!=null&&j.firstChild!=null)k=ZG(j);h[i]=k;}g=kD(g,"STRINGS_ELEMENT");}}return (h);}String OD(final l i){String g=null;g=Ha[i];if(g!=null)return (g);final String j=cD(i);if(j==null){pJ("Config.elementTitle : no name for ${i}");return (null);}final List<l> m=fa();for(final l o in m){if(g==null){l h=RC(o,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==j){final l k=RC(h,"TITRE");if(k!=null&&k.firstChild!=null){g=ZG(k);break;}break;}h=kD(h,"STRINGS_ELEMENT");}}}if(g==null||g=="")g=j;Ha[i]=g;return (g);}String wH(final l h){if(h==null)return (null);final String j=cD(h);final List<l> k=fa();for(final l m in k){l g=RC(m,"STRINGS_ELEMENT");while(g!=null){if(j==g.getAttribute("element")){final l i=RC(g,"DOCUMENTATION");if(i!=null&&i.firstChild!=null)return (ZG(i));break;}g=kD(g,"STRINGS_ELEMENT");}}return (Ma.gO(h));}static String lT(final String h){String g=h;g=g.replaceAll("&","&amp;");g=g.replaceAll("<","&lt;");g=g.replaceAll(">","&gt;");g=g.replaceAll("\n","<br>");return (g);}String oK(final l k,final String i){final String m=cD(k);final List<l> o=fa();final String s=(new WE()).language;for(final l j in o){l h=RC(j,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==m){l g=RC(h,"TITRE_VALEUR");while(g!=null){if(g.getAttribute("valeur")==i&&g.firstChild!=null)return (ZG(g));g=kD(g,"TITRE_VALEUR");}break;}h=kD(h,"STRINGS_ELEMENT");}final String v=j.getAttribute("langue");if(v==s)return (i);}return (i);}String fK(final l k,final l m){final String s=cD(k);final String i=attributeName(m);final List<l> v=fa();for(final l BB in v){l g=RC(BB,"STRINGS_ELEMENT");while(g!=null){if(g.getAttribute("element")==s){l h=RC(g,"STRINGS_ATTRIBUT");while(h!=null){if(h.getAttribute("attribut")==i){final l j=RC(h,"TITRE");if(j!=null&&j.firstChild!=null)return (ZG(j));break;}h=kD(h,"STRINGS_ATTRIBUT");}}g=kD(g,"STRINGS_ELEMENT");}}final String o=NR(k,m);if(o!=null)return ("${o}:${i}");return (i);}String gK(final l m,final l o,final String j){final String s=cD(m);final String v=attributeName(o);final List<l> BB=fa();final String EB=(new WE()).language;for(final l k in BB){l h=RC(k,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==s){l i=RC(h,"STRINGS_ATTRIBUT");while(i!=null){if(i.getAttribute("attribut")==v){l g=RC(i,"TITRE_VALEUR");while(g!=null){if(g.getAttribute("valeur")==j&&g.firstChild!=null)return (ZG(g));g=kD(g,"TITRE_VALEUR");}break;}i=kD(i,"STRINGS_ATTRIBUT");}}h=kD(h,"STRINGS_ELEMENT");}final String HB=k.getAttribute("langue");if(HB==EB)return (j);}return (j);}String vG(final l k,final l j){final String m=cD(k);final String o=attributeName(j);final List<l> s=fa();for(final l v in s){l g=RC(v,"STRINGS_ELEMENT");while(g!=null){if(g.getAttribute("element")==m){l h=RC(g,"STRINGS_ATTRIBUT");while(h!=null){if(h.getAttribute("attribut")==o){final l i=RC(h,"DOCUMENTATION");if(i!=null&&i.firstChild!=null)return (ZG(i));break;}h=kD(h,"STRINGS_ATTRIBUT");}}g=kD(g,"STRINGS_ELEMENT");}}return (Ma.vG(j));}static String ZG(final AB i){final AB g=i.firstChild;if(g==null)return (null);final String h=g.nodeValue;if(h==null)return (null);return (h.trim());}l Va(){if(Na==null){Na=RC(Da,"LANGAGE");}return Na;}l aa(){if(Oa==null){Oa=RC(Da,"ENREGISTREMENT");if(Oa==null){Oa=Da.ownerDocument.createElement("ENREGISTREMENT");}}return Oa;}l ca(){if(Pa==null){Pa=RC(Da,"MENUS");if(Pa==null){Pa=Da.ownerDocument.createElement("MENUS");}}return Pa;}l Za(){if(Qa==null){Qa=RC(Da,"AFFICHAGE_NOEUDS");if(Qa==null){Qa=Da.ownerDocument.createElement("AFFICHAGE_NOEUDS");}}return Qa;}List<l> ga(){if(Sa==null){Sa=new List<l>();AB g=Da.firstChild;while(g!=null){if(g.nodeType==AB.FE&&g.nodeName=="STRINGS"){Sa.add(g as l);}g=g.nextSibling;}}return Sa;}static l RC(final AB g,final String h){final AB i=g.firstChild;return pP(i,h);}static l kD(final AB g,final String h){final AB i=g.nextSibling;return pP(i,h);}static l pP(AB g,final String h){if(h==null)return null;while(g!=null){if(g.nodeType==AB.FE&&h==g.nodeName){return g as l;}g=g.nextSibling;}return null;}static l qP(final AB g,final String h){return EN(g,g,h);}static l EN(final AB i,final AB j,final String k){AB g=j;AB h;while(g!=null){if(g.hasChildNodes()){g=(g.firstChild);}else if(g!=i&&null!=(h=g.nextSibling)){g=h;}else{h=null;while(g!=i){h=g.nextSibling;if(h!=null)break;g=g.parentNode;}g=h;}if(g!=i&&g!=null&&g.nodeType==AB.FE&&g.nodeName==k){return g as l;}}return null;}static void pJ(String g,[Exception h]){if(h!=null)print("Config: ${g}: ${h}");else print("Config: ${g}");}}class zM{static const int PT=400;GH ha;q selectionStart;q selectionEnd;zF yF;uB LI;uB FI;WB FF;Point dO;OI toolbar;xM ia;q ZM;DateTime AP;bool sI;zM(){ha=new GH();ia=new xM();ZM=null;AP=null;sI=false;}Future FP(String i){Completer g=new Completer();t.FP(i).then((m){ja();yE();ia.SP();document.title=LB.MB('page.new_document');g.complete();},onError:(CD j){Element k=document.getElementById('doc2');String h="Error creating the new document: ${j}";k.text=h;g.completeError(h);});return (g.future);}Future KP(String h,String j,{bool removeIndents: true}){Completer g=new Completer();t.KP(h,j).then((o){ja();yE();ia.VP();t.rC.XO();document.title=h.split('/').last;g.complete();},onError:(CD k){Element m=document.getElementById('doc2');String i="Error reading the document: ${k}";m.text=i;g.completeError(i);});return (g.future);}void yE(){Element h=document.getElementById('doc2');h.children.clear();document.body.insertBefore(ia.html(),document.getElementById('doc1'));RO();window.onResize.listen((Event g)=>RO());Element j=t.html();h.append(j);q k=new q(t.rC,0);ha.moveTo(k);LC();h.onMouseDown.listen((MouseEvent g)=>onMouseDown(g));h.onMouseMove.listen((MouseEvent g)=>onMouseMove(g));h.onMouseUp.listen((MouseEvent g)=>onMouseUp(g));h.onContextMenu.listen((MouseEvent g)=>onContextMenu(g));document.getElementById('doc1').onScroll.listen((Event g)=>onScroll(g));document.onMouseUp.listen((MouseEvent g){if(FF!=null){Element i=FF.vK();if(i.scrollHeight>i.clientHeight&&g.target==i&&g.client.x>i.offsetLeft+i.clientWidth)return;if(g.client!=dO)TR();g.preventDefault();}});}void RO(){Element h=document.getElementById('headers');num i=h.getBoundingClientRect().bottom;String g=(i.round()+2).toString()+"px";document.getElementById('left_panel').style.top=g;document.getElementById('doc1').style.top=g;}void ja(){yF=t.CB.BW(t);WB i=new WB(LB.MB('menu.file'));i.parent=yF;uB g;if(t.CL!=null){g=new uB(LB.MB('menu.save'),()=>save(),shortcut:'S');i.add(g);}g=new uB(LB.MB('menu.source'),()=>nW());i.add(g);g=new uB(LB.MB('menu.validation'),()=>(new OT()).show());i.add(g);yF.insert(i,0);WB h=new WB(LB.MB('menu.edit'));h.parent=yF;LI=new uB(LB.MB('undo.undo'),()=>t.aH(),shortcut:'Z');LI.enabled=false;h.add(LI);FI=new uB(LB.MB('undo.redo'),()=>t.cM(),shortcut:'Y');FI.enabled=false;h.add(FI);h.add(new uB(LB.MB('menu.select_all'),()=>RP(),shortcut:'A'));uB o=new uB(LB.MB('find.find_replace'),()=>(new jP()).show(),shortcut:'F');h.add(o);yF.insert(h,1);Element m=document.getElementById('headers');m.append(yF.html());toolbar=new OI(t.CB);m.append(toolbar.html());HashMap<String,GD> j=new HashMap<String,GD>();for(MC k in toolbar.HG)if(k.shortcut!=null)j[k.shortcut]=k.action;for(WB s in yF.VH){MR(s,j);}ha.jW(j);}MR(WB i,HashMap<String,GD> h){for(uB g in i.items){if(g.shortcut!=null&&g.action!=null)h[g.shortcut]=g.action;if(g is WB)MR(g,h);}}void onMouseDown(MouseEvent g){if(FF!=null)TR();if(g.target is ImageElement||g.target is ButtonElement||g.target is TextInputElement||g.target is SelectElement)return;Element h=g.target;while(h is Element&&!h.classes.contains('dn')){h=h.parent;}if(h!=null&&h.attributes['contenteditable']=='true')return;if(g.button==1)return;g.preventDefault();if(g.button==2){return;}if(g.shiftKey){selectionStart=new q.pX(ha.selectionStart);selectionEnd=GH.oJ(g);if(selectionEnd!=null)ha.gE(selectionStart,selectionEnd);}else{selectionStart=GH.oJ(g);if(selectionStart!=null&&ZM==selectionStart&&AP.difference(new DateTime.now()).inMilliseconds.abs()<PT&&selectionStart.u.nodeType!=n.tC){List<q> i=ka(selectionStart);selectionStart=i[0];selectionEnd=i[1];ha.gE(selectionStart,selectionEnd);sI=true;}}}void onMouseMove(MouseEvent h){if(selectionStart==null)return;if(FF!=null)return;q g=GH.oJ(h);if(sI){if(selectionEnd>selectionStart&&g<=selectionStart)selectionStart=selectionEnd;else if(selectionEnd<selectionStart&&g>=selectionStart)selectionStart=selectionEnd;}selectionEnd=g;if(selectionStart!=null&&selectionEnd!=null){if(sI&&selectionEnd.u.nodeType!=n.tC){List<q> i=ka(selectionEnd);if(selectionEnd>selectionStart)selectionEnd=i[1];else selectionEnd=i[0];}ha.gE(selectionStart,selectionEnd);}h.preventDefault();}List<q> ka(q g){List<q> j=new List<q>();String k=g.u.nodeValue;int h=g.KB;int i=g.KB;String m=' \n,;:.?!/()[]{}';while(h>0&&m.indexOf(k[h-1])==-1)h-- ;while(i<k.length&&m.indexOf(k[i])==-1)i++ ;j.add(new q(g.u,h));j.add(new q(g.u,i));return (j);}void onMouseUp(MouseEvent g){if(!sI)selectionEnd=GH.oJ(g);ZM=null;if(selectionStart!=null&&selectionEnd!=null){if(!sI)ha.gE(selectionStart,selectionEnd);if(selectionStart==selectionEnd){ZM=selectionStart;AP=new DateTime.now();}}selectionStart=null;selectionEnd=null;sI=false;g.preventDefault();}void onContextMenu(MouseEvent h){if(h.shiftKey)return;q g=GH.oJ(h);if(g!=null){h.preventDefault();if(ha.selectionStart==null||ha.selectionEnd==null||(g<ha.selectionStart&&g<ha.selectionEnd)||(g>ha.selectionStart&&g>ha.selectionEnd)){ha.gE(g,g);}if(ha.selectionStart!=null)mW(h);}}void onScroll(Event g){ha.bH(false);}void mW(MouseEvent EB){if(t.CB==null||ha.selectionStart.u==null)return;dO=EB.client;n h;if(ha.selectionStart.u is OB)h=ha.selectionStart.u.parent;else h=ha.selectionStart.u;List<l> QB=t.kO(h);List<l> SB=t.dP(QB);FF=new WB(null);bool o=false;if(h.DB!=null){String k=t.CB.DI(h.nodeName);String i="${LB.MB('contextual.select_element')} ${k}";FF.add(new uB(i,()=>selectNode(h)));List<l> m=t.CB.fE(h.DB);if(m!=null&&m.length>0){i="${LB.MB('contextual.edit_attributes')} ${k}";FF.add(new uB(i,()=>h.JE()));}i="${LB.MB('contextual.help_about_element')} ${k}";FF.add(new uB(i,()=>(new XG.UX(h.DB)).show()));o=true;}if(t.uO!=null){n j=h;while(j!=null&&j is!xI)j=j.parent;if(j!=null){if(o)FF.QO();String k=t.CB.DI(j.nodeName);List<l> m=t.CB.fE(j.DB);if(m!=null&&m.length>0){String i="${LB.MB('contextual.edit_attributes')} ${k}";FF.add(new uB(i,()=>j.JE()));}FF.add(new uB(LB.MB('div.remove'),()=>(j as xI).SW()));o=true;}}List<l> s;if(toolbar!=null)s=toolbar.dR();else s=null;bool HB=true;for(l v in SB){if(s!=null&&s.contains(v))continue;if(t.ZC!=null&&t.ZC.contains(v))continue;if(HB&&o)FF.QO();HB=false;String cB=t.CB.cD(v);String i=t.CB.DI(cB);uB hB=new uB(i,()=>t.CI(v,'element'));FF.add(hB);}DivElement g=FF.VM();g.style.position='fixed';g.style.display='block';int BB=EB.client.x;int JB=EB.client.y;g.style.left="${BB}px";g.style.top="${JB}px";g.style.maxHeight="${window.innerHeight-JB}px";g.style.overflowY='auto';document.body.append(g);if(g.scrollHeight>g.clientHeight)g.style.paddingRight="${g.offsetWidth-g.clientWidth}px";if(BB+g.offsetWidth>window.innerWidth){BB=window.innerWidth-g.offsetWidth;g.style.left="${BB}px";}}void TR(){DivElement g=FF.vK();g.remove();FF=null;dO=null;}GH get cursor{return (ha);}q vC(){return (ha.selectionStart);}q GF(){return (ha.selectionEnd);}void KD(q g){ha.moveTo(g);}void AH(){ha.focus();}void XS(n g){q j=new q(g.parent,g.parent.ZB(g));HD h=j.jF();if(h==null)return;DivElement i=document.getElementById('doc1');int k=i.offset.top;i.scrollTop+= h.y.toInt()-k-10;}void selectNode(n g){int h=g.parent.ZB(g);q i=new q(g.parent,h);q j=new q(g.parent,h+1);ha.moveTo(i);ha.gE(i,j);LC();}void RP(){ha.gE(new q(t.rC,0),new q(t.rC,t.rC.PB));}void LC(){if(ha.selectionStart==null)return;n g=ha.selectionStart.u;if(g is OB)g=g.parent;List<l> h=t.kO(g);List<l> i=t.dP(h);ia.update(g,h,i);vW(g,i);wW();}void vW(n h,List<l> g){List<WB> i=yF.VH;for(WB j in i){la(j,g);}if(toolbar!=null)toolbar.update(h,g);}void la(WB m,List<l> i){for(uB g in m.items){if(g is WB){la(g,i);}else if(g.data is l){l j=g.data;String o=t.CB.cD(j);bool k=false;for(l h in i){if(t.CB.cD(h)==o){k=true;if(h!=j){g.data=h;g.action=()=>t.CI(h,'element');}break;}}if(k)g.enable();else g.disable();}}}void wW(){Element g=document.getElementById('path');if(ha.selectionStart==null)g.text="";else g.text=ha.selectionStart.MI(titles:true);}void KL(){if(t.FS()){if(!LI.enabled)LI.enable();}else{if(LI.enabled)LI.disable();}if(t.ES()){if(!FI.enabled)FI.enable();}else{if(FI.enabled)FI.disable();}LI.title=t.xR();FI.title=t.vR();if(toolbar!=null){for(MC g in toolbar.HG){if(g.data=="undo"){if(t.FS())g.enable();else g.disable();g.title=t.xR();}else if(g.data=="redo"){if(t.ES())g.enable();else g.disable();g.title=t.vR();}}}}void save(){t.bW().then((h){window.alert(LB.MB('save.success'));},onError:(CD g){window.alert(LB.MB('save.error')+': '+g.message);});}void nW(){(new NT()).show();}}abstract class n{static const int tC=1;static const int mB=3;static const int YG=9;static const String RT='GRAS';static const String ST='ITALIQUE';static const String TT='EXPOSANT';static const String UT='INDICE';static const String VT='SOULIGNE';static const String WT='BARRE';static const String XT='FCOULEUR';static const String YT='PCOULEUR';static const String ZT="^.*\\[(x[0-9a-fA-F]{2}|[0-9]{1,3}),(x[0-9a-fA-F]{2}|[0-9]{1,3}),(x[0-9a-fA-F]{2}|[0-9]{1,3})\\]\$";l DB;String ma;n parent;int nodeType;String na;String EC;String localName;String nodeValue;n firstChild;n nextSibling;List<aB> attributes;bool dJ=false;bool mM=false;bool valid;n.qX(AB g,n h,{bool createChildren: true}){ma=t.bM(this);this.parent=h;if(g.nodeType==AB.FE||g.nodeType==AB.kE||g.nodeType==AB.FK)nodeType=g.nodeType;else nodeType=tC;na=g.pB;EC=g.EC;if(g.nodeType==AB.CK)localName=g.nodeName;else if(g.nodeType==AB.BK)localName='#cdata-section';else if(g.nodeType==AB.DK)localName='#comment';else if(g.nodeType==AB.FK)localName='#document';else localName=g.localName;if(nodeType==n.mB)nodeValue=g.nodeValue;attributes=new List<aB>();LinkedHashMap<String,lC> m=g.attributes;if(m!=null){for(AB i in m.values){attributes.add(new aB.SX(i));}}if(g is l){DB=t.CB.UM(g,h==null?null:h.DB);if(DB==null&&h!=null){DB=t.CB.hG(localName);}}if(createChildren){if(g.childNodes!=null){n j=null;for(AB i in g.childNodes){n k=ND.fH(i,this);if(j==null)firstChild=k;else j.nextSibling=k;j=k;}}else if((g.nodeType==AB.BK||g.nodeType==AB.CK||g.nodeType==AB.DK)&&g.nodeValue!=null&&g.nodeValue!=''){jB(new OB(g.nodeValue));}}if(nodeType==n.tC)valid=t.CB.hO(this);else valid=true;}n.vX(l g){DB=g;ma=t.bM(this);parent=null;nodeType=tC;na=t.CB.kI(DB);EC=t.CB.PM(DB);localName=t.CB.cD(DB);nodeValue=null;firstChild=null;nextSibling=null;attributes=new List<aB>();valid=true;}n.wX(int g){DB=null;ma=t.bM(this);parent=null;this.nodeType=g;na=null;EC=null;localName=null;nodeValue=null;firstChild=null;nextSibling=null;attributes=new List<aB>();valid=true;}n.xX(String g){ma=t.bM(this);parent=null;nodeType=n.mB;na=null;this.EC=null;this.localName=null;nodeValue=g;firstChild=null;nextSibling=null;attributes=null;valid=true;}factory n.yX(n g){lH i=new yJ();sB j=i.createDocument(null,null,null);AB k=g.KF(j);n h=ND.fH(k,g.parent);h.parent=null;return (h);}String get id{return (ma);}Element oB(){return (document.getElementById(ma));}Element dD(){Element g=oB();if(g!=null&&!g.nodes.isEmpty&&g.firstChild is Element)g=g.firstChild;return (g);}String get nodeName{if(nodeType==mB)return ('#text');StringBuffer g=new StringBuffer();if(EC!=null){g.write(EC);g.write(":");}g.write(localName);return (g.toString());}String get pB{return (na);}int get PB{if(nodeType==mB)return (nodeValue.length);int h=0;for(n g=firstChild;g!=null;g=g.nextSibling)h++ ;return (h);}bool get ED{return (false);}bool get eC{if(RE())return (true);Element g=oB();return (g is DivElement||g is TableElement||g is UListElement);}List<n> get childNodes{List<n> h=new List<n>();for(n g=firstChild;g!=null;g=g.nextSibling){h.add(g);}return (h);}n get previousSibling{if(parent==null)return (null);for(n g=parent.firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==this)return (g);}return (null);}n get lastChild{for(n g=firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==null)return (g);}return (null);}n eB(int i){assert(nodeType!=mB);int h=0;for(n g=firstChild;g!=null;g=g.nextSibling){if(h==i)return (g);h++ ;}return (null);}n nextNode(){if(firstChild!=null)return (firstChild);if(nextSibling!=null)return (nextSibling);n g=parent;while(g!=null){if(g.nextSibling!=null)return (g.nextSibling);g=g.parent;}return (null);}n previousNode(){if(firstChild!=null)return (lastChild);if(previousSibling!=null)return (previousSibling);n g=parent;while(g!=null){if(g.previousSibling!=null)return (g.previousSibling);g=g.parent;}return (null);}int ZB(n i){int h=0;for(n g=firstChild;g!=null;g=g.nextSibling){if(g==i)return (h);h++ ;}assert(false);return (-1);}String getAttribute(String h){for(aB g in attributes){if(g.localName==h)return (g.value);}return (null);}String getAttributeNS(String h,String i){if(attributes==null)return (null);for(aB g in attributes){if(g.pB==h&&g.localName==i)return (g.value);}return (null);}void setAttribute(String g,String h){for(aB i in attributes){if(i.localName==g){i.value=h;return;}}attributes.add(new aB(g,h));return;}void setAttributeNS(String m,String g,String o){String i,j;int k=g.indexOf(":");if(k!=-1){i=g.substring(0,k);j=g.substring(k+1);}else{i=null;j=g;}aB h=SM(m,j);if(h!=null){h.EC=i;h.value=o;return;}h=new aB.cX(m,g,o);attributes.add(h);}aB RM(String h){for(aB g in attributes){if(g.localName==h)return (g);}return (null);}aB SM(String h,String i){if(attributes==null)return (null);for(aB g in attributes){if(g.pB==h&&g.localName==i){return (g);}}return (null);}LinkedHashMap<String,aB> gR(){LinkedHashMap<String,aB> g=new LinkedHashMap<String,aB>();for(aB h in attributes)g[h.name]=new aB.iX(h);return (g);}Element html();void sD(){Element g=oB();if(g==null)return;Element h=html();g.replaceWith(h);}void BF(List<n> o){List<n> s=childNodes;for(n g in o){Element m=g.oB();if(!s.contains(g)){if(m!=null)m.remove();else{sD();return;}}else if(m==null){n j=g.nextSibling;Node i=null;while(i==null&&j!=null){i=j.oB();if(i==null)j=j.nextSibling;}n k=g.previousSibling;Node h=null;while(h==null&&k!=null){h=k.oB();if(h==null)k=k.previousSibling;}if(i!=null){i.parent.insertBefore(g.html(),i);}else if(h!=null){if(h.nextNode!=null)h.parent.insertBefore(g.html(),h.nextNode);else h.parent.append(g.html());}else{sD();return;}}else{g.sD();}}}void vI(){sD();}void FL(bool h){Element g=oB();if(g==null)return;if(h)g.classes.add('selected');else g.classes.remove('selected');}void jB(n g){n h=lastChild;if(h!=null)h.nextSibling=g;else firstChild=g;g.parent=this;}void insertBefore(n h,n i){assert(i==null||this==i.parent);h.parent=this;n g=firstChild;if(g==i){n j=firstChild;firstChild=h;h.nextSibling=j;}else{while(g!=null&&g.nextSibling!=i){g=g.nextSibling;}assert(g!=null);assert(g.nextSibling==i);n j=g.nextSibling;g.nextSibling=h;h.nextSibling=j;}}void insertAfter(n h,n g){assert(this==g.parent);if(g.nextSibling==null)jB(h);else insertBefore(h,g.nextSibling);}void gC(n g){if(g.previousSibling!=null)g.previousSibling.nextSibling=g.nextSibling;if(g==firstChild)firstChild=g.nextSibling;g.parent=null;g.nextSibling=null;}void replaceWith(n g){if(parent.firstChild==this)parent.firstChild=g;else previousSibling.nextSibling=g;g.parent=parent;g.nextSibling=nextSibling;parent=null;nextSibling=null;}void normalize(){for(n g=firstChild;g!=null;g=g.nextSibling){while(g.nodeType==mB&&g.nextSibling!=null&&g.nextSibling.nodeType==mB){g.nodeValue="${g.nodeValue}${g.nextSibling.nodeValue}";gC(g.nextSibling);}}}void remove(q g,int h){if(nodeType==tC){for(int i=g.KB;i<h;i++ ){gC(eB(g.KB));}}else{String j=nodeValue;String k=j.substring(0,g.KB);String m=j.substring(g.KB+h);nodeValue="${k}${m}";}}bool RE(){return (false);}bool RG(){return (false);}void NG(){if(RG()&&firstChild!=null&&firstChild is OB){String g=firstChild.nodeValue;if(g.startsWith('\n')){if(g.length==1)gC(firstChild);else firstChild.nodeValue=g.substring(1);}}n i=lastChild;while(i!=null&&i is OB)i=i.previousSibling;if(RG()&&lastChild is OB&&(i==null||!i.RE())){String g=lastChild.nodeValue;if(g.endsWith('\n')){if(g.length==1)gC(lastChild);else lastChild.nodeValue=g.substring(0,g.length-1);}}for(n h=firstChild;h!=null;h=h.nextSibling){if(h.RE()&&h.nextSibling is OB){String g=h.nextSibling.nodeValue;if(g.startsWith('\n')){if(g.length==1)gC(h.nextSibling);else h.nextSibling.nodeValue=g.substring(1);}}}}AB KF(sB i){assert(nodeType==tC);l g=i.createElementNS(pB,nodeName);for(aB k in attributes)g.setAttributeNS(k.pB,k.name,k.value);if(RG()||firstChild!=null){if(RG())g.jB(i.wG('\n'));for(n j=firstChild;j!=null;j=j.nextSibling){g.jB(j.KF(i));if(j.RE())g.jB(i.wG('\n'));}n h=lastChild;while(h!=null&&h is OB)h=h.previousSibling;if(RG()&&lastChild!=null&&(h==null||!h.RE()))g.jB(i.wG('\n'));}return (g);}String toString(){lH g=new yJ();sB h=g.createDocument(null,null,null);AB i=KF(h);return (i.toString());}static String jT(String g){g=g.replaceAll('&','&amp;');g=g.replaceAll('"','&quot;');g=g.replaceAll('<','&lt;');g=g.replaceAll('>','&gt;');return (g);}void lF(){valid=t.CB.hO(this);Element g=oB();if(g==null)return;if(valid&&g.classes.contains('invalid'))g.classes.remove('invalid');else if(!valid&&!g.classes.contains('invalid'))g.classes.add('invalid');}void HP(GD g){if(DB!=null&&t.CB.fE(DB).length>0)JE(()=>g());else g();}void JE([GD h]){if(DB!=null){uM g=new uM(this,h);g.show();}else{yM g=new yM(this,h);g.show();}}q zG(num CC,num BB){q QD=new q(this,0);if(nodeType==tC||nodeType==YG){for(n QB=firstChild;QB!=null;QB=QB.nextSibling){Element g=QB.oB();if(g==null)continue;double SB,EB,HB,JB;double cB,hB;if(g is DivElement&&g.nodes.length>0&&g.firstChild is SpanElement&&(g.firstChild as SpanElement).classes.contains('start_tag')&&g.lastChild is SpanElement&&(g.lastChild as SpanElement).classes.contains('end_tag')){Element i=g.firstChild;Rectangle h=i.getBoundingClientRect();SB=h.left;EB=h.top;cB=i.offset.height.toDouble();i=g.lastChild;h=i.getBoundingClientRect();HB=h.right;JB=h.bottom;hB=i.offset.height.toDouble();}else if(g is DivElement||g is TableCellElement||g is TableRowElement||g is TableElement||g is ImageElement||g.classes.contains('form')){Rectangle h=g.getBoundingClientRect();SB=h.left;EB=h.top;if(g.classes.contains('form'))HB=g.querySelector('table').getBoundingClientRect().right;else HB=h.right;JB=h.bottom;cB=hB=h.height;}else if(g is SpanElement&&g.nodes.length==1&&g.firstChild is Text&&!g.firstChild.nodeValue.endsWith('\n')){List<Rectangle> k=g.getClientRects();if(k.length==0)return (null);Rectangle h=k.first;SB=h.left;EB=h.top;cB=h.height*1.4;h=k.last;HB=h.right;JB=h.bottom;hB=h.height*1.4;}else if(g.firstChild is Element&&g.lastChild is SpanElement&&g.lastChild.lastChild is Text&&!g.lastChild.lastChild.nodeValue.endsWith('\n')){Element i=g.firstChild;List<Rectangle> k=i.getClientRects();if(k.length==0)return (null);Rectangle h=k.first;SB=h.left;EB=h.top;cB=h.height*1.3;i=g.lastChild;k=i.getClientRects();if(k.length==0)return (null);h=k.last;HB=h.right;JB=h.bottom;hB=h.height*1.3;}else{Element i=new Element.tag('span');i.append(new Text("|"));if(g.nodes.length==1&&g.firstChild is BRElement){g.append(i);Rectangle h=i.getBoundingClientRect();SB=-1.0;EB=h.top;cB=hB=i.offset.height.toDouble()*1.4;HB=-1.0;JB=h.bottom;i.remove();}else{if(g.nodes.isEmpty)g.append(i);else g.insertBefore(i,g.firstChild);Rectangle h=i.getBoundingClientRect();SB=h.left;EB=h.top;cB=i.offset.height.toDouble()*1.4;i.remove();if(g is LIElement){Node m=g;while(m.firstChild!=null&&(m.lastChild is!Text||(m.lastChild.nodeValue=='\n'&&m.lastChild.previousNode!=null))&&m.lastChild is!ImageElement){if(m.lastChild is Text&&m.lastChild.nodeValue=='\n'&&m.lastChild.previousNode!=null)m=m.lastChild.previousNode;else m=m.lastChild;}m.append(i);}else g.append(i);h=i.getBoundingClientRect();HB=h.left;JB=h.bottom;hB=i.offset.height.toDouble()*1.4;i.remove();}}if((BB<EB+cB&&(BB<EB-1||(CC<SB+1&&g is!LIElement&&QB is!kB)))){return (QD);}if(BB>JB-hB&&(BB>JB+1||(CC>HB-1&&g is!LIElement))){QD=new q(this,ZB(QB)+1);}else{QD=QB.zG(CC,BB);return (QD);}}}else if(nodeType==mB){int o=0;for(Node g in oB().nodes){Text v;if(g is Text)v=g;else if(g is Element)v=g.firstChild;else continue;Range IC=new Range();for(int j=0;j<v.length;j++ ){if(nodeValue[o+j]!='\n'){IC.setStart(v,j);IC.setEnd(v,j+1);List<Rectangle> k=IC.getClientRects();for(Rectangle s in k){if(window.navigator.appVersion.contains("Trident")&&o+j+1<nodeValue.length&&nodeValue[o+j+1]=='\n'&&s.width==0){continue;}if(j<nodeValue.length-1&&s.left==s.right&&CC<s.left&&BB<s.bottom){return (new q(this,o+j+1));}if(CC<s.right&&BB<=s.bottom){if(CC<(s.left+s.right)/2)return (new q(this,o+j));else return (new q(this,o+j+1));}else if(BB<s.top-5){if(o+j==0||nodeValue[o+j]==' ')return (new q(this,o+j));else return (new q(this,o+j-1));}}}else{String tD=v.text;v.text="${tD.substring(0,j)}|${tD.substring(j)}";IC.setStart(v,j);IC.setEnd(v,j+1);List<Rectangle> k=IC.getClientRects();v.text=tD;if(window.navigator.appVersion.contains("Trident")){if(BB<=k.first.bottom){return (new q(this,o+j));}}else{for(Rectangle s in k){if(BB<=s.bottom){return (new q(this,o+j));}}}}}o+= v.length;}}return (new q(this,PB));}q QE(){return (new q(this,0));}q SF(){return (new q(this,PB));}void hM(Element g){String j=t.CB.bC(DB,'style',null);if(j!=null){List<String> m=j.split(';');for(String h in m){if(h==RT){g.style.fontWeight='bold';}else if(h==ST){g.style.fontStyle='italic';}else if(h==TT){g.style.verticalAlign='super';g.style.fontSize='80%';}else if(h==UT){g.style.verticalAlign='sub';g.style.fontSize='80%';}else if(h==VT){g.style.textDecoration='underline';}else if(h==WT){g.style.textDecoration='line-through';}else if(h.startsWith(XT)){g.style.background=oa(h);}else if(h.startsWith(YT)){g.style.color=oa(h);}}}String i=t.CB.bC(DB,'police',null);if(i!=null){if(i=='Monospaced')i='monospace';g.style.fontFamily=i;}String k=t.CB.bC(DB,'taille',null);if(k!=null){g.style.fontSize=k;}}String oa(String j){Iterable<Match> k=ZT.allMatches(j);for(Match m in k){final List<int> g=new List<int>();for(int h=0;h<3;h++ ){String i=m.group(h+1);if(i.startsWith("x"))g[h]=int.parse(i.substring(1),radix:16);else g[h]=int.parse(i);}return ("rgb(${g[0]}, ${g[1]}, ${g[2]})");}return (null);}void XO(){SO();for(n g=firstChild;g!=null;g=g.nextSibling){g.XO();}}void PR(){CV();for(n g=firstChild;g!=null;g=g.nextSibling){g.PR();}}void SO(){}void CV(){}}class dC implements q{n rZ;int pa;dC(n g,int h){assert(g!=null);assert(h>=0);rZ=g;pa=h;}dC.bX(CE g){rZ=t.rC;pa=0;PG(g.HF);}dC.fX(vD g){rZ=t.rC;pa=rZ.PB;PG(-g.UF);}n get u{return (rZ);}int get KB{return (pa);}int get HF{CE g=new CE.XX(this);return (g.HF);}int get UF{vD g=new vD.YX(this);return (g.UF);}bool operator==(q g){dC h;if(g is dC)h=g;else if(g is CE)h=new dC.bX(g);else if(g is vD)h=new dC.fX(g);return (rZ==h.rZ&&pa==h.pa);}bool operator<(q i){dC j;if(i is dC)j=i;else if(i is CE)j=new dC.bX(i);else if(i is vD)j=new dC.fX(i);n o=null;n g=rZ;double k=pa.toDouble();while(g!=null){n h=j.rZ;double m=j.pa.toDouble();while(h!=null){if(g==h){return (k<m);}if(h.parent==null)break;m=h.parent.ZB(h)+0.5;h=h.parent;}if(g.parent==null)break;k=g.parent.ZB(g)+0.5;g=g.parent;}assert(false);return (false);}bool operator<=(q g){return (this<g||this==g);}bool operator>(q g){return (!(this==g||this<g));}bool operator>=(q g){return (this>g||this==g);}void PG(int h){if(h>0){int g=h;while(g>0){if(pa==rZ.PB){pa=rZ.parent.ZB(rZ)+1;rZ=rZ.parent;}else if(rZ is OB){pa++ ;}else{rZ=rZ.eB(pa);pa=0;}g-- ;}}else if(h<0){int g=h;while(g<0){if(pa==0){pa=rZ.parent.ZB(rZ);rZ=rZ.parent;}else if(rZ is OB){pa-- ;}else{rZ=rZ.eB(pa-1);pa=rZ.PB;}g++ ;}}}void zE(){if(rZ.nodeType==n.tC&&pa>0&&rZ.eB(pa-1).nodeType==n.mB){rZ=rZ.eB(pa-1);pa=rZ.PB;}else if(rZ.nodeType==n.tC&&pa<rZ.PB&&rZ.eB(pa).nodeType==n.mB){rZ=rZ.eB(pa);pa=0;}else if(pa==0&&rZ.firstChild!=null&&rZ.firstChild.nodeType==n.mB){rZ=rZ.firstChild;}}HD jF(){if(rZ.nodeType==n.mB){Element o=rZ.dD();if(o==null||o.nodes.length==0)return (null);assert(o.nodes.first is Text);Text h=o.nodes.first;int i=pa;String k=h.text;assert(k.length!=0);Range j=new Range();HD v;if(i==0){j.setStart(h,i);j.setEnd(h,k.length);Rectangle g=j.getClientRects().first;v=new HD(g.left,g.top);}else if(k[i-1]=='\n'||k[i-1]==' '){if(i==k.length){if(rZ.nextSibling!=null&&rZ.nextSibling.nodeType==n.tC&&(k[i-1]=='\n'||!rZ.nextSibling.eC)){Rectangle g=(rZ.nextSibling.oB()).getClientRects()[0];v=new HD(g.left,g.top);}else if(k[i-1]==' '){j.setStart(h,0);j.setEnd(h,i);Rectangle g=j.getClientRects().last;v=new HD(g.right,g.top);}else{SpanElement BB=new SpanElement();BB.appendText("|");if(h.nextNode==null)o.append(BB);else o.insertBefore(BB,h.nextNode);Rectangle g=BB.getClientRects()[0];v=new HD(g.left,g.top);BB.remove();}}else{j.setStart(h,i);j.setEnd(h,i+1);List<Rectangle> m=j.getClientRects();Rectangle g;if(k[i-1]==' '&&i<k.length&&k[i]=='\n'){if(window.navigator.appVersion.contains("Trident")){j.setStart(h,i-1);j.setEnd(h,i);m=j.getClientRects();g=m.first;g=new Rectangle(g.left+7,g.top,g.width,g.height);}else g=m.first;}else if(k[i]=='\n'&&m.length==3)g=m[1];else if((window.navigator.userAgent.toLowerCase().indexOf('msie')>=0||window.navigator.appVersion.contains("Trident"))&&k[i-1]=='\n'&&k[i]=='\n'&&m.length==2)g=m.first;else{g=m.last;for(Rectangle QB in m)if(QB.width>1){g=QB;break;}}v=new HD(g.left,g.top);}}else{Rectangle g;if(window.navigator.appVersion.contains("Trident")&&i<k.length&&k[i]=='\n'){j.setStart(h,i-1);j.setEnd(h,i);g=j.getClientRects().first;}else{j.setStart(h,0);j.setEnd(h,i);g=j.getClientRects().last;}v=new HD(g.right,g.top);}return (v);}else{List<n> s=rZ.childNodes;if(s!=null&&pa>0&&pa==s.length){Element h=s[pa-1].oB();if(h==null)return (null);Rectangle g;if(h is ImageElement||h is TableRowElement){g=h.getBoundingClientRect();return (new HD(g.right,g.top));}else if(h is DivElement||h is TableElement||h is UListElement||h is LIElement){g=h.getBoundingClientRect();return (new HD(g.left,g.bottom));}else{List<Rectangle> m=h.getClientRects();if(m.length==0)return (null);Rectangle g=m.last;return (new HD(g.right,g.top));}}else if(s!=null&&pa<s.length){Element o=s[pa].oB();if(o==null)return (null);if(pa>0){n JB=s[pa-1];n SB=s[pa];Element cB=JB.oB();Element hB=o;if(JB.eC&&!SB.eC){List<Rectangle> CC=hB.getClientRects();if(CC.length==0)return (null);Rectangle EB=CC.first;return (new HD(EB.left,EB.top));}else if(JB.eC&&SB.eC){Rectangle HB=cB.getBoundingClientRect();Rectangle EB=hB.getBoundingClientRect();return (new HD(EB.left,(HB.bottom+EB.top)/2));}else{List<Rectangle> IC=cB.getClientRects();if(IC.length==0)return (null);Rectangle HB=IC.last;return (new HD(HB.right,HB.top));}}if(s[pa] is xD){Rectangle g=o.getClientRects()[0];return (new HD(g.left-21,g.top+2));}Rectangle g=o.getClientRects()[0];return (new HD(g.left,g.top));}else{assert(pa==0);Element o=rZ.dD();if(o==null)return (null);List<Rectangle> m=o.getClientRects();if(m.length==0)return (null);Rectangle g=m[0];return (new HD(g.left,g.top));}}}String MI({bool titles: false}){String i="";n g=rZ;while(g!=null){String k="";if(g.parent!=null){int m=1;for(n h=g.parent.firstChild;h!=null;h=h.nextSibling){if(h==g)break;if(h.nodeType==n.tC&&h.nodeName==g.nodeName)m++ ;}k="[${m}]";}if(g.nodeType==n.tC){String j;if(titles&&t.CB!=null&&g.DB!=null)j=t.CB.OD(g.DB);else j=g.nodeName;i="${j}${k}/${i}";}else if(g.nodeType==n.mB)i="#text";g=g.parent;}return ("/${i}");}String toString(){return ("[NodeOffsetPosition ${rZ.nodeName} ${pa}]");}}class OT{void show(){DivElement k=new DivElement();k.id='dlg1';k.classes.add('dlg1');DivElement s=new DivElement();s.classes.add('dlg2');DivElement h=new DivElement();h.classes.add('dlg3');DivElement g=new DivElement();g.classes.add('dlgtitle');g.text=LB.MB('validation.validation');h.append(g);List<n> EB=DS(t.rC);if(EB.length==0){h.appendText(LB.MB('validation.no_error'));}else{DivElement i=new DivElement();i.style.maxHeight='30em';i.style.overflow='auto';i.appendText(LB.MB('validation.errors'));UListElement HB=new UListElement();for(n m in EB){LIElement o=new LIElement();String g;if(m.DB!=null)g=t.CB.OD(m.DB);else g=null;q JB=new q(m,0);String v;if(g!=null)v="${g} ${JB.MI()}";else v=JB.MI();o.appendText(v);o.onClick.listen((MouseEvent QB)=>select(m));o.style.cursor='default';HB.append(o);}i.append(HB);h.append(i);}DivElement BB=new DivElement();BB.classes.add('buttons');ButtonElement j=new ButtonElement();j.attributes['type']='submit';j.appendText(LB.MB("button.Close"));j.onClick.listen((MouseEvent QB)=>close());BB.append(j);h.append(BB);s.append(h);k.append(s);document.body.append(k);j.focus();}List<n> DS(n g){List<n> h=new List<n>();if(g.nodeType==n.tC&&g is!qF){if(g.parent is jE){bool j=t.CB.HI(g.parent.DB,g.DB);if(j&&g.firstChild==null){h.add(g);return (h);}else if(!j&&g.firstChild==null&&(g.attributes==null||g.attributes.length==0)){return (h);}}if(!t.CB.hO(g))h.add(g);}for(n i=g.firstChild;i!=null;i=i.nextSibling)h.addAll(DS(i));return (h);}void select(n g){DivElement h=document.getElementById('dlg1');h.remove();IB.selectNode(g);}void close(){DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}}ND RL=new ND();class lP{void update(n k,List<l> BB,List<l> EB){Element h=document.getElementById('insert');for(Element HB in h.children)HB.remove();HH j=t.CB;if(j==null)return;if(k.nodeType==n.tC&&k.DB!=null){h.append(qa(k.DB));String m=j.cD(k.DB);SpanElement v=new SpanElement();v.appendText(j.DI(m));h.append(v);h.append(new HRElement());}List<l> o;if(IB.toolbar!=null)o=IB.toolbar.dR();else o=null;for(l i in BB){if(o!=null&&o.contains(i))continue;if(t.ZC!=null&&t.ZC.contains(i))continue;h.append(qa(i));ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('insertb');String m=j.cD(i);g.value=m;g.text=j.DI(m);if(!EB.contains(i))g.disabled=true;g.onClick.listen((Event s)=>insert(i));g.onKeyDown.listen((KeyboardEvent s){int JB=s.keyCode;if(JB==KeyCode.ENTER){s.preventDefault();insert(i);}});h.append(g);h.append(new BRElement());}}ButtonElement qa(l h){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';String i=t.CB.wH(h);if(i!=null)g.title=i;g.onClick.listen((Event j)=>tO(h));return (g);}void insert(l g){t.CI(g,'element');}void tO(l g){XG h=new XG.UX(g);h.show();}}class WF extends lG{WB pI;String title;LT update;WF(this.pI,this.update,OI g){title=pI.title;pI.parent=g;}Element html(){DivElement g=new DivElement();g.classes.add('toolbar-menu');g.append(IB.yF.OM(pI));return (g);}}class MC{static int mP=0;String bZ;String wK;GD action;MT update;Object data;String id;bool enabled;bool selected;StreamSubscription<MouseEvent> listener;String shortcut;int iconWidth;int iconHeight;MC(this.bZ,this.wK,this.action,this.update,{this.data,this.enabled: true,this.shortcut,this.iconWidth: 16,this.iconHeight: 16}){selected=false;id="button_${mP}";mP++ ;}Element html(){DivElement g=new DivElement();g.id=id;g.classes.add('toolbar-button');if(!enabled)g.classes.add('button-disabled');else g.setAttribute('tabindex','0');if(selected)g.classes.add('button-selected');g.setAttribute('title',bZ);ImageElement h=new ImageElement();h.src=wK;h.width=iconWidth;h.height=iconHeight;if(enabled)listener=g.onClick.listen((MouseEvent i)=>action());g.append(h);g.onKeyDown.listen((KeyboardEvent i){int j=i.keyCode;if(j==KeyCode.ENTER){i.preventDefault();action();}});return (g);}String get title{return (bZ);}void set title(String g){bZ=g;Element h=oB();h.setAttribute('title',bZ);}Element oB(){return (querySelector("#${id}"));}void disable(){if(!enabled)return;enabled=false;Element g=oB();g.classes.add('button-disabled');listener.cancel();g.setAttribute('tabindex','-1');}void enable(){if(enabled)return;enabled=true;Element g=oB();g.classes.remove('button-disabled');listener=g.onClick.listen((MouseEvent h)=>action());g.setAttribute('tabindex','0');}void select(){if(selected)return;selected=true;Element g=oB();g.classes.add('button-selected');}void xE(){if(!selected)return;selected=false;Element g=oB();g.classes.remove('button-selected');}}class ND{HashMap<String,lJ> VR=new HashMap<String,lJ>();HashMap<String,kJ> UR=new HashMap<String,kJ>();static void aT(){hC('anchor',(l i)=>new oG.GY(i),(AB g,n h)=>new oG.jY(g,h));hC('area',(l i)=>new CJ.VY(i),(AB g,n h)=>new CJ.kY(g,h));hC('br',(l i)=>new ZL.DY(i),(AB g,n h)=>new ZL.RY(g,h));hC('champ',(l i)=>new wI.HY(i),(AB g,n h)=>new wI.iY(g,h));hC('division',(l i)=>new bL.YY(i),(AB g,n h)=>new bL.mY(g,h));hC('empty',(l i)=>new yI.FY(i),(AB g,n h)=>new yI.ZY(g,h));hC('equationmem',(l i)=>new DJ.qY(i),(AB g,n h)=>new DJ.vY(g,h));hC('equatexmem',(l i)=>new EJ.wY(i),(AB g,n h)=>new EJ.AZ(g,h));hC('field',(l i)=>new wI.HY(i),(AB g,n h)=>new wI.iY(g,h));hC('hr',(l i)=>new YL.AY(i),(AB g,n h)=>new YL.IY(g,h));hC('item',(l i)=>new JH.CY(i),(AB g,n h)=>new JH.OY(g,h));hC('list',(l i)=>new UI.JY(i),(AB g,n h)=>new UI.oY(g,h));hC('liste',(l i)=>new UI.JY(i),(AB g,n h)=>new UI.oY(g,h));hC('fichier',(l i)=>new jH.hY(i),(AB g,n h)=>new jH.rY(g,h));hC('file',(l i)=>new jH.hY(i),(AB g,n h)=>new jH.rY(g,h));hC('form',(l i)=>new jE.eY(i),(AB g,n h)=>new jE.tY(g,h));hC('formulaire',(l i)=>new jE.eY(i),(AB g,n h)=>new jE.tY(g,h));hC('hiddendiv',(l i)=>new xI.EY(i),(AB g,n h)=>new xI.cY(g,h));hC('hiddenp',(l i)=>new kB.WY(i),(AB g,n h)=>new kB.lY(g,h));hC('simpletype',(l i)=>new BJ.SY(i),(AB g,n h)=>new BJ.dY(g,h));hC('string',(l i)=>new AJ.KY(i),(AB g,n h)=>new AJ.fY(g,h));hC('style',(l i)=>new zB.sY(i),(AB g,n h)=>new zB.uY(g,h));hC('stylespan',(l i)=>new YE.NY(i),(AB g,n h)=>new YE.gY(g,h));hC('symbol2',(l i)=>new zI.MY(i),(AB g,n h)=>new zI.aY(g,h));hC('symbole2',(l i)=>new zI.MY(i),(AB g,n h)=>new zI.aY(g,h));hC('table',(l i)=>new bG.xY(i),(AB g,n h)=>new bG.zY(g,h));hC('texttable',(l i)=>new bG.xY(i),(AB g,n h)=>new bG.zY(g,h));hC('tabletexte',(l i)=>new bG.xY(i),(AB g,n h)=>new bG.zY(g,h));hC('text',null,(AB g,n h)=>new OB.zX(g,h));hC('texte',null,(AB g,n h)=>new OB.zX(g,h));hC('typesimple',(l i)=>new BJ.SY(i),(AB g,n h)=>new BJ.dY(g,h));hC('vide',(l i)=>new yI.FY(i),(AB g,n h)=>new yI.ZY(g,h));hC('zone',(l i)=>new CJ.VY(i),(AB g,n h)=>new CJ.kY(g,h));hC('witem',(l i)=>new xD.BY(i),(AB g,n h)=>new xD.LY(g,h));hC('wlist',(l i)=>new iC.UY(i),(AB g,n h)=>new iC.pY(g,h));}static void hC(String g,lJ h,kJ i){if(h!=null)RL.VR[g]=h;if(i!=null)RL.UR[g]=i;}static n fH(AB g,n h){l j;if(g is sB){return (new nG.TY(g));}else if(g is pL){return (new BG.QY(g,h));}else if(g is oL){return (new IH.XY(g,h));}else if(g is nL){return (new qF.PY(g,h));}if(g is l){j=t.CB.UM(g,h!=null?h.DB:null);}else{j=null;}String m=t.CB.QS(j,g.nodeName,g.nodeType);kJ o=RL.UR[m];n i;if(o!=null)i=o(g,h);else if(m=='plugin'){String k=t.CB.JP(j,'element',g.nodeName,"classe",null);if(k=='xpages.JEEquationMemoire')i=new DJ.vY(g,h);else if(k=='xpages.JEEquaTeXMemoire')i=new EJ.AZ(g,h);else if(k=='xpages.jeimage.JEImage')i=new jH.rY(g,h);}else i=new AJ.fY(g,h);return (i);}static n NF(l g,[String i='element']){if(i=='commentaire'){return (new BG());}else if(i=='instruction'){return (new IH());}else if(i=='cdata'){return (new qF());}String k=t.CB.QS(g,t.CB.cD(g),AB.FE);lJ m=RL.VR[k];n h;if(m!=null)h=m(g);else if(k=='plugin'){String j=t.CB.JP(g,'element',t.CB.cD(g),"classe",null);if(j=='xpages.JEEquationMemoire')h=new DJ.qY(g);else if(j=='xpages.JEEquaTeXMemoire')h=new EJ.wY(g);else if(j=='xpages.jeimage.JEImage')h=new jH.hY(g);}else h=new AJ.KY(g);return (h);}}typedef void GD();zM IB;PL t;Map<String,GD> nP=new Map<String,GD>();class HD{num x;num y;HD(num this.x,num this.y);}void SL(String g,lJ h,kJ i){ND.hC(g,h,i);}class GN{String ra;String sa;String ta;AQ ua;oD va;GN(String g,{String labelName,String labelValue,AQ okfct}){ra=g;sa=labelName;ta=labelValue;ua=okfct;}void show(){DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement BB=new DivElement();BB.classes.add('dlg3');FormElement i=new FormElement();CanvasElement j=new CanvasElement(width:500,height:300);j.id='eqcanvas';lB QB=new lB(ra);va=new oD(element:QB.uK(),context:j.context2D);va.GC(j.context2D);i.append(j);TextAreaElement g=new TextAreaElement();g.id='eqtext';g.value=ra;g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event EB)=>LF());i.append(g);if(sa!=null){DivElement k=new DivElement();SpanElement JB=new SpanElement();JB.text=sa;k.append(JB);k.appendText(' ');TextInputElement HB=new TextInputElement();HB.id='eqlabel';if(ta!=null)HB.value=ta;k.append(HB);i.append(k);}DivElement m=new DivElement();m.classes.add('buttons');ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent EB)=>h.remove());m.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent EB)=>iF(EB));m.append(s);i.append(m);BB.append(i);v.append(BB);h.append(v);document.body.append(h);g.focus();}void iF(MouseEvent g){TextAreaElement h=querySelector('textarea#eqtext');ra=h.value;if(sa!=null){TextInputElement i=querySelector('input#eqlabel');ta=i.value;}querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(ua!=null)ua();}String fB(){return (ra);}String getData(){if(ra=='')return (null);CanvasElement g=new CanvasElement(width:va.dB(),height:va.OC());lB h=new lB(ra);oD i=new oD(element:h.uK(),context:g.context2D);i.GC(g.context2D);String j=g.toDataUrl('image/png');String k=j.substring('data:image/png;base64,'.length);return (k);}String kR(){return (ta);}void LF(){TextAreaElement g=querySelector('textarea#eqtext');ra=g.value;if(ra.length>0&&ra.contains('\n')){g.value=ra.replaceAll('\n','');iF(null);return;}CanvasElement h=querySelector('canvas#eqcanvas');lB i=new lB(ra);va.aS(i.uK());va.GC(h.context2D);}}class YC extends XB{YC():super();}class qJ extends XB{qJ():super();void GC(final CanvasRenderingContext2D o,final double QB,final double s){int g,h;final List<double> v=new List<double>(PC());final List<double> EB=new List<double>(PC());for(g=0;g<PC();g++ ){v[g]=qR(g);EB[g]=rR(g);}final int BB=oR();final List<double> m=new List<double>(BB);for(g=0;g<BB;g++ )m[g]=pR(g);final double HB=QB;final double SB=-OC(true)/2+v[0]-rD();double j=HB;double k=SB;for(g=0;g<PC();g++ ){final XB JB=NB(g);j=HB;for(h=0;(h<BB)&&(h<JB.PC());h++ ){final QI i=JB.NB(h) as QI;if(i.hR()=="left")i.GC(o,j+1,s+k);else if(i.hR()=="right")i.GC(o,j+m[h]-i.dB(true),s+k);else i.GC(o,j+m[h]/2-i.dB(true)/2,s+k);j+= m[h];}k+= EB[g];if(g<PC()-1)k+= v[g+1];}}double qR(final int i){if(i>=PC())return 0.0;final XB j=NB(i);double g=0.0;for(int h=0;h<j.PC();h++ )g=max(g,j.NB(h).rB(true));return g;}double rR(final int i){if(i>=PC())return 0.0;final XB j=NB(i);double g=0.0;for(int h=0;h<j.PC();h++ )g=max(g,j.NB(h).yB(true));return g;}double pR(final int i){double g=0.0;for(int h=0;h<PC();h++ ){final XB j=NB(h);if(i<j.PC())g=max(g,j.NB(i).dB(true));}return g+2;}int oR(){int g=0;for(int h=0;h<PC();h++ ){final XB i=NB(h);g=max(g,i.PC());}return g;}double dB(final bool j){double h=0.0;final int i=oR();for(int g=0;g<i;g++ )h+= pR(g);return h;}double OC(final bool i){double h=0.0;for(int g=0;g<PC();g++ )h+= qR(g)+rR(g);return h;}double rB(final bool g){return OC(true)/2+rD();}double yB(final bool g){return OC(true)/2-rD();}}class QI extends XB{String wa="center";QI():super();void fW(final String g){wa=g;}String hR(){return wa;}}class aG extends XB{aG():super();void GC(final CanvasRenderingContext2D g,final double h,final double i){g.font=zC();g.fillText(fB(),h,i);}double dB(final bool g){return JI(fB().replaceAll(' ','A'));}double OC(final bool g){return AD().mE+AD().vH;}double uR(){wD g=pV(fB());return (g.actualBoundingBoxAscent);}double rB(final bool g){return AD().mE;}double yB(final bool g){return AD().vH;}}class rP extends XB{rP():super();void GC(final CanvasRenderingContext2D h,final double i,final double j){if(TJ().YM())debug(h,i,j);final double m=xa();double k=i;for(int g=0;g<PC();g++ ){NB(g).GC(h,k,j);k+= m;}}double xa(){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).dB(true));return g;}double dB(final bool g){return xa()*PC();}double OC(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).OC(i));return g;}double rB(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).rB(i));return g;}double yB(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).yB(i));return g;}}class sP extends XB{sP():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D g,final double h,final double i){if(PC()<2)return;final XB m=NB(0);final XB o=NB(1);final double BB=dB(true);final double EB=m.dB(true);final double k=8.0;final double j=o.dB(true);final double HB=o.OC(true);final double s=m.rB(true);final double v=m.yB(true);g.beginPath();g.moveTo(h,i);g.lineTo(h+j,i);g.moveTo(h+j,i);g.lineTo(h+k/2+j,i+v);g.moveTo(h+j-1,i);g.lineTo(h+k/2+j,i+v);g.moveTo(h+k/2+j,i+v);g.lineTo(h+k+j,i-(s+2));g.moveTo(h+k+j,i-(s+2));g.lineTo(h+BB,i-(s+2));g.stroke();m.GC(g,h+k+j,i);o.GC(g,h,i-o.yB(true));}double dB(final bool g){if(PC()<2)return 0.0;return NB(0).dB(g)+8+NB(1).dB(g);}double OC(final bool g){if(PC()<2)return 0.0;return yB(true)+max(NB(0).rB(true)+4,NB(1).OC(true));}double rB(final bool g){if(PC()<2)return 0.0;return max(NB(0).rB(true)+4,NB(1).OC(true));}double yB(final bool g){if(PC()<2)return 0.0;return NB(0).yB(true);}}class tP extends aG{}class uP extends XB{uP():super();void GC(final CanvasRenderingContext2D g,final double h,final double i){final double BB=dB(true);final double EB=nR();final double j=8.0;final double k=lR(true);final double m=mR(true);g.beginPath();g.moveTo(h,i);g.lineTo(h+3,i-1);g.moveTo(h+3,i);g.lineTo(h+j/2+1,i+m);g.moveTo(h+2,i-1);g.lineTo(h+j/2+1,i+m);g.moveTo(h+j/2+1,i+m);g.lineTo(h+j+3,i-(k+1));g.moveTo(h+j+3,i-(k+1));g.lineTo(h+BB,i-(k+1));g.stroke();double v=h+j+3;XB o;for(int s=0;s<PC();s++ ){o=NB(s);o.GC(g,v,i);v+= o.dB(true);}}double nR(){double h=0.0;for(int g=0;g<PC();g++ )h+= NB(g).dB(true);return h;}double dB(final bool g){return nR()+8+3;}double gV(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).OC(true));return g;}double OC(final bool g){return gV(true)+4;}double lR(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).rB(true));return g;}double rB(final bool g){return lR(true)+2;}double mR(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).yB(true));return g;}double yB(final bool g){return mR(true)+2;}}class nB extends XB{bool ya=true;double za=0.0;double Ab=0.0;nB():super();void ZJ(final bool g){this.ya=g;}void gW(final double g){this.za=g;}void iW(final double g){this.Ab=g;}void zK(final CanvasRenderingContext2D g,final double h,final double i,final String EB,final String HB,final String JB){g.font=zC();final double j=yH();final double k=iR();wD m=new wD(EB,zC());wD o=new wD(HB,zC());wD s=new wD(JB,zC());double v=m.actualBoundingBoxAscent+m.actualBoundingBoxDescent;double SB=m.actualBoundingBoxAscent;double cB=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent;double hB=o.actualBoundingBoxAscent;double BB=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent;double CC=s.actualBoundingBoxAscent;if(j-v-BB>0){final double IC=j-v-BB+2;double QB=IC/cB;g.save();g.scale(1,QB);g.fillText(HB,h,(i-k+v)/QB+hB);g.restore();}g.fillText(EB,h,i-k+SB);g.fillText(JB,h,i+j-k-(BB-CC).round());}void RS(final CanvasRenderingContext2D g,final double h,final double i,final String v,final String BB,final String m,final String EB){final double HB=yH();g.fillStyle='black';g.font=zC();wD s=new wD(m,zC());final double j=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent;final int o=((HB/j)/2).floor();for(int k=1;k<o;k++ ){g.fillText(m,h,i-j*k);g.fillText(m,h,i+j*k);}g.fillText(BB,h,i);g.fillText(v,h,i-j*o);g.fillText(EB,h,i+j*o);}void SS(final CanvasRenderingContext2D g,final double h,final double i,final String s,final String v,final String o,final String BB){final double EB=getParent().dB(true);final double HB=i-rD();g.save();g.fillStyle='black';g.font=zC();g.translate(h,i);g.rotate(PI/2.0);g.translate(-h,-HB);final double j=AD().mE-1;int JB=(EB/j).floor();final int m=JB~/2;for(int k=1;k<m;k++ ){g.fillText(o,h,i-j*k);g.fillText(o,h,i+j*k);}g.fillText(v,h,i);g.fillText(s,h,i-j*m);g.fillText(BB,h,i+j*m);g.restore();}void GC(final CanvasRenderingContext2D g,double h,final double i){if(za!=0){final double s=JI('A');h+= za*s;}if(fB().length==1&&"[{(|)}]\u222B".indexOf(fB()[0])>=0&&ya){final double m=getParent().rB(false);final double o=getParent().yB(false);final double j=m+o-1;if(fB()=="("){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u239B','\u239C','\u239D');}else if(fB()==")"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u239E','\u239F','\u23A0');}else if(fB()=="["){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u23A1','\u23A2','\u23A3');}else if(fB()=="]"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u23A4','\u23A5','\u23A6');}else if(fB()=="{"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else RS(g,h,i,'\u23A7','\u23A8','\u23AA','\u23A9');}else if(fB()=="}"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else RS(g,h,i,'\u23AB','\u23AC','\u23AA','\u23AD');}else if(fB()=="|"){g.beginPath();g.moveTo(h+2,i-m);g.lineTo(h+2,i+o);g.stroke();}else if(fB()=="\u222B"){zK(g,h,i,'\u2320','\u23AE','\u2321');}}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0){if(fB()=="\uFE37")SS(g,h,i,'\u23A7','\u23A8','\u23AA','\u23A9');else if(fB()=="\uFE38")SS(g,h,i,'\u23AB','\u23AC','\u23AA','\u23AD');}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&ya){g.strokeStyle='black';g.fillStyle='black';if(yH()>AD().height){final String v=TJ().zC(ID()*2);g.font=v;}else g.font=zC();if("\u2211".indexOf(fB()[0])>=0)g.fillText("\u2211",h,i);else g.fillText("\u220F",h,i);g.font=zC();}else if(fB()=="\u00AF"&&ya){final double k=getParent().dB(false)-2;g.beginPath();g.moveTo(h,i);g.lineTo(h+k,i);g.stroke();}else if(fB()=="^"&&ya){final double k=getParent().dB(false)-3;g.beginPath();g.moveTo(h,i);g.lineTo(h+k/2,i-3);g.moveTo(h+k/2,i-3);g.lineTo(h+k,i);g.stroke();}else if(fB()=="."||fB()==".."||fB()=="..."){g.font=zC();g.fillText(fB(),h+1,i);}else{g.font=zC();g.fillText(fB(),h,i);}}XB pO(){if(fB()=="\u222B"||"\u2211\u220F".contains(fB())){YC k;if(getParent() is YC)k=getParent() as YC;else k=getParent().getParent() as YC;final XB h=k.NB(1);if(!(h is YC&&h.PC()>0))return (h);final XB i=h.NB(0);if(!(i is YC&&i.PC()>0))return (h);final XB g=i.NB(0);if(!(g is SI||g is sJ||g is pF||g is nB))return (h);XB j;if(g is SI||g is sJ||g is pF)j=g.NB(0);else j=g;if(!(j.fB()=="\u222B"||"\u2211\u220F".contains(j.fB())))return (h);return (i.NB(1));}else return (getParent());}double yH(){return (pO().OC(false));}double iR(){return (pO().rB(false));}double eV(){return (pO().yB(false));}double dB(final bool k){double g=0.0;if(za!=0||Ab!=0){final double j=JI('A');final double m=za*j;final double o=Ab*j;g=m+o;}if(fB().length==1){final String h=fB()[0];if("|".indexOf(h)>=0)return 5+g;else if("\uFE37\uFE38".indexOf(h)>=0)return 1+g;else if("\u222B".indexOf(h)>=0){wD i=new wD(fB(),TJ().zC(ID()*2));return i.width+g;}else if("\u2211\u220F".indexOf(h)>=0){if(yH()>AD().height){wD i=new wD(fB(),TJ().zC(ID()*2));return i.width+g;}else return JI(fB()).round()+g;}else if("^\u00AF".indexOf(h)>=0&&ya&&k)return getParent().dB(false)-2;}return JI(fB()).round()+g;}double OC(final bool g){return rB(g)+yB(g);}double rB(final bool i){if(fB().length==1&&"[()]\u222B".indexOf(fB()[0])>=0){if(!i||!ya)return AD().mE;return (iR()+1);}else if(fB().length==1&&"{}".indexOf(fB()[0])>=0){if(!i||!ya)return AD().mE;final double g=AD().mE;final int h=(yH()/g).floor()+1;if("{}".indexOf(fB()[0])>=0)if(h%2==0)return (h+1)*g*0.5+rD();return h*g*0.5+rD();}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&ya){if(yH()>AD().height)return TJ().AD(ID()*2).mE;else return AD().mE;}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0)return 0.0;else if(fB()=="\u00AF"&&ya)return (3.0);else if(fB()=="\u223C"&&ya)return ((AD().mE~/2).toDouble());else if(fB()=="."||fB()==".."||fB()=="...")return ((AD().mE~/2).toDouble());else return AD().mE;}double yB(final bool i){if(fB().length==1&&"[()]\u222B".indexOf(fB()[0])>=0){if(!i||!ya)return AD().vH;return (eV()+1);}else if(fB().length==1&&"{}".indexOf(fB()[0])>=0){if(!i||!ya)return AD().vH;final double g=AD().mE;final int h=(yH()/g).floor()+1;if("{}".indexOf(fB()[0])>=0)if(h%2==0)return (h+1)*g*0.5-rD();return h*g*0.5-rD();}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&ya){if(yH()>AD().height)return TJ().AD(ID()*2).vH;else return AD().vH;}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0)return JI("}");else return AD().vH;}}class gH extends XB{static final int nT=0;static final int WL=1;int Bb=nT;bool Cb=false;gH():super();int jV(){return Bb;}void XP(final bool g){this.Cb=g;}bool YM(){return Cb;}void MW(final CanvasRenderingContext2D g){if(Cb){g.strokeStyle='blue';g.beginPath();g.moveTo(0,0);g.lineTo(SJ()-1,0);g.moveTo(SJ()-1,0);g.lineTo(SJ()-1,mI()-1);g.moveTo(0,0);g.lineTo(0,mI()-1);g.moveTo(0,mI()-1);g.lineTo(SJ()-1,mI()-1);g.stroke();g.strokeStyle='cyan';g.moveTo(0,mI()/2);g.lineTo(SJ()-1,mI()/2);g.stroke();g.strokeStyle='black';}if(NB(0)!=null){final double i=NB(0).rB(true)-rD();final double h=NB(0).yB(true)+rD();if(i>=h)GC(g,0.0,rB(true));else GC(g,0.0,h+rD());}}int SJ(){return dB(true).ceil();}int mI(){return OC(true).ceil();}void GC(final CanvasRenderingContext2D g,final double h,final double i){if(NB(0)!=null)NB(0).GC(g,h,i);}double dB(final bool g){if(NB(0)==null)return 0.0;return NB(0).dB(true)+1;}double OC(final bool i){if(NB(0)==null)return 0.0;if(Bb==WL)return NB(0).OC(true)+2;final double g=NB(0).rB(true)-rD();final double h=NB(0).yB(true)+rD();return max(g,h)*2;}double rB(final bool g){if(NB(0)==null)return 0.0;if(Bb==WL)return NB(0).rB(true);return max(NB(0).rB(true),NB(0).yB(true));}double yB(final bool g){if(NB(0)==null)return 0.0;if(Bb==WL)return NB(0).yB(true);return max(NB(0).rB(true),NB(0).yB(true));}}class rJ extends XB{int Db=1;rJ():super();void GC(final CanvasRenderingContext2D g,final double h,final double s){final XB j=NB(0);final XB k=NB(1);final double m=s-rD();final double o=dB(true);j.GC(g,h+(o-j.dB(true))/2,m-j.yB(true)-1);g.lineWidth=Db;g.beginPath();double i=m-Db/2;if(Db==1)i=i.floorToDouble()+0.5;g.moveTo(h+1,i);g.lineTo(h+o-1,i);g.stroke();g.lineWidth=1;k.GC(g,h+(o-k.dB(true))/2,m+k.rB(true)+1);}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g))+4;}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return NB(0).OC(true)+1+Db/2+rD();}double yB(final bool g){return max(0,NB(1).OC(true)+1+Db/2-rD());}}class pF extends XB{bool Eb=false;pF():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2&&!Eb)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null&&!Eb)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);final double m=dB(true);g.GC(i,j+(m-g.dB(true))/2,k);if(Eb){double o;if(g is aG||g is RI)o=g.uR()+3;else o=g.rB(true);h.GC(i,j+(m-h.dB(true))/2,k-o);}else h.GC(i,j+(m-h.dB(true))/2,k-(g.rB(true)+h.yB(true)));}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g));}double OC(final bool g){if(Eb)return NB(0).OC(g)+NB(1).rB(g)+1;else return NB(0).OC(g)+NB(1).OC(g);}double rB(final bool g){if(Eb)return NB(0).rB(true)+NB(1).rB(true);else return NB(0).rB(true)+NB(1).OC(true);}double yB(final bool g){return NB(0).yB(true);}void WP(final bool g){this.Eb=g;}}class sJ extends XB{sJ():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);final double m=dB(true);g.GC(i,j+(m-g.dB(true))/2,k);h.GC(i,j+(m-h.dB(true))/2,k+g.yB(true)+h.rB(true));}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g));}double OC(final bool g){return NB(0).OC(g)+NB(1).OC(g);}double rB(final bool g){return NB(0).rB(true);}double yB(final bool g){return NB(0).yB(true)+NB(1).OC(true);}}class RI extends aG{String Fb="italic";void ZS(final String g){this.Fb=g;}void GC(final CanvasRenderingContext2D h,final double i,final double j){final String k=fB();String g;if(Fb=='italic')g=fV();else if(Fb=='bold')g=ZV();else if(Fb=='bold-italic')g=aV();else g=zC();h.font=g;h.fillText(k,i,j);}String zC(){if(base!=null)return base.zC(BH,oD.KN);return null;}}class VL extends XB{VL():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);g.GC(i,j,k);h.GC(i,j+g.dB(true),k-max(h.yB(true)+rD(),g.rB(true)-h.yB(true)));}double dB(final bool g){return NB(0).dB(g)+NB(1).dB(g);}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool i){final XB h=NB(0);final XB g=NB(1);return (g.rB(true)+max(g.yB(true)+rD(),h.rB(true)-g.yB(true)));}double yB(final bool g){return NB(0).yB(true);}}class UL extends XB{UL():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D g,final double h,final double i){final XB j=NB(0);final XB k=NB(1);j.GC(g,h,i);k.GC(g,h+j.dB(true),i+k.rB(true)-rD());}double dB(final bool g){return NB(0).dB(g)+NB(1).dB(g);}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return NB(0).rB(true);}double yB(final bool g){return max(NB(0).yB(true),NB(1).OC(true)-rD());}}class oD{static String vP='STIXSubset-Regular';static String wP='STIXSubset-Italic';static String JN='STIXSubset-Bold';static bool xP=false;static const int mT=0;static const int yP=1;static const int KN=2;static const int zP=3;int Gb;int Hb;final int aM=8;final int yK=60;List<wD> Ib=null;bool Cb=false;static final int pT=0;final int Bb=pT;gH Jb;CanvasRenderingContext2D Kb;oD({final gH element,final int inlinefontsize: 15,final int displayfontsize: 16,final CanvasRenderingContext2D context}){this.Gb=inlinefontsize;this.Hb=displayfontsize;if(context!=null)Ib=new List<wD>(yK);if(element!=null)aS(element);if(context!=null)this.Kb=context;}static void CQ(){if(xP)return;CanvasElement h=new CanvasElement(width:10,height:10);CanvasRenderingContext2D g=h.context2D;g.font="15px ${vP}";g.fillText('.',0,0);g.font="15px ${wP}";g.fillText('.',0,0);g.font="15px ${JN}";g.fillText('.',0,0);xP=true;}void aS(final gH g){if(g==null)return;Jb=g;Jb.gM(this);if(g.jV()==gH.WL)Jb.WC(Hb);else Jb.WC(Gb);Jb.XP(YM());}void XP(final bool g){this.Cb=g;if(Jb!=null)Jb.XP(g);}bool YM(){return Cb;}String zC(final int j,[int k=oD.mT]){int i;if(j<aM)i=aM;else if(j>yK)i=yK;else i=j;String g,h;if(k==oD.KN){g='';h=wP;}else if(k==oD.yP){g='';h=JN;}else if(k==oD.zP){g='italic';h=JN;}else{g='';h=vP;}return ("${g} ${i}px ${h}");}wD AD(final int h){int g;if(h<aM)g=aM;else if(h>yK)g=yK;else g=h;if(Ib[g]==null)Ib[g]=MV(zC(h));return Ib[g];}wD MV(String g){return (new wD('Hg',g));}double JI(String g,String h){String i=Kb.font;Kb.font=h;double j=Kb.measureText(g).width;Kb.font=i;return (j);}void GC(final CanvasRenderingContext2D g){g.clearRect(0,0,g.canvas.width,g.canvas.height);if(Jb!=null)Jb.MW(g);}int dB(){if(Jb!=null&&Ib!=null)return Jb.SJ();return 0;}int OC(){if(Jb!=null&&Ib!=null)return Jb.mI();return 0;}}class XB{oD base;XB parent;int BH=14;final List<XB> children=new List<XB>();final StringBuffer text=new StringBuffer();XB([final oD g,final int h]){if(g!=null)gM(g);if(h!=null)WC(h);}void RB(final XB g){if(g!=null){children.add(g);g.gM(base);g.hW(this);g.WC(BH);}}XB NB(final int g){if((g>=0)&&(g<children.length))return children[g];return null;}int PC(){return children.length;}void VC(final String h){for(int g=0;g<h.length;g++ )if(" \t\n\r".indexOf(h[g])<0)this.text.write(h[g]);else if((' '==h[g])&&(g>0)&&(' '!=h[g-1]))this.text.write(h[g]);}String fB(){return text.toString().trim();}void gM(final oD g){this.base=g;for(final XB h in children)h.gM(g);}oD TJ(){return base;}void hW(final XB g){this.parent=g;}XB getParent(){return parent;}void WC(final int g){this.BH=max(g,8);for(final XB h in children)h.WC(this.BH);}int ID(){return BH;}String zC(){if(base!=null)return base.zC(BH);return null;}String fV(){if(base!=null)return base.zC(BH,oD.KN);return null;}String ZV(){if(base!=null)return base.zC(BH,oD.yP);return null;}String aV(){if(base!=null)return base.zC(BH,oD.zP);return null;}wD AD(){if(base!=null)return base.AD(BH);return null;}double JI(g){return (base.JI(g,zC()));}wD pV(String g){return (new wD(g,zC()));}void debug(final CanvasRenderingContext2D g,final double h,final double i){g.strokeStyle='blue';g.beginPath();g.moveTo(h,i-rB(true));g.lineTo(h+dB(true),i-rB(true));g.moveTo(h+dB(true),i-rB(true));g.lineTo(h+dB(true),i+yB(true));g.moveTo(h,i+yB(true));g.lineTo(h+dB(true),i+yB(true));g.moveTo(h,i-rB(true));g.lineTo(h,i+yB(true));g.stroke();g.strokeStyle='red';g.beginPath();g.moveTo(h,i);g.lineTo(h+dB(true),i);g.stroke();g.strokeStyle='black';}void GC(final CanvasRenderingContext2D i,final double j,final double k){if(base.YM())debug(i,j,k);double m=j;XB g;for(int h=0;h<PC();h++ ){g=NB(h);g.GC(i,m,k);m+= g.dB(true)+2;}}double dB(final bool h){double g=0.0;for(final XB i in children)g+= i.dB(h)+2;return g-2;}double OC(final bool g){return rB(g)+yB(g);}double uR(){return rB(true);}double rB(final bool h){double g=0.0;for(final XB i in children)g=max(g,i.rB(h));return g;}double yB(final bool h){double g=0.0;for(final XB i in children)g=max(g,i.yB(h));return g;}double rD(){return base.AD(ID()).mE*0.30;}}class SI extends XB{SI():super();void RB(final XB g){super.RB(g);if(g!=null){if((PC()==2)||(PC()==3))g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);if(NB(2)!=null)NB(2).WC(ID()-2);}void GC(final CanvasRenderingContext2D h,final double i,final double j){final XB g=NB(0);final XB k=NB(1);final XB m=NB(2);final double o=dB(true);g.GC(h,i+(o-g.dB(true))/2,j);k.GC(h,i+(o-k.dB(true))/2,j+g.yB(true)+k.rB(true));m.GC(h,i+(o-m.dB(true))/2,j-(g.rB(true)+m.yB(true)));}double dB(final bool g){return max(NB(0).dB(g),max(NB(1).dB(g),NB(2).dB(g)));}double OC(final bool g){return NB(0).OC(g)+NB(1).OC(g)+NB(2).OC(g);}double rB(final bool g){return NB(0).rB(true)+NB(1).OC(true);}double yB(final bool g){return NB(0).yB(true)+NB(2).OC(true);}}class HN extends XB{HN():super();void RB(final XB g){super.RB(g);if(g!=null){if((PC()==2)||(PC()==3))g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);if(NB(2)!=null)NB(2).WC(ID()-2);}void GC(final CanvasRenderingContext2D h,final double i,final double j){final XB g=NB(0);final XB k=NB(1);final XB o=NB(2);final double m=k.rD();final double s=j+g.yB(true)+m/2;final double v=j-g.rB(true)+m;g.GC(h,i,j);k.GC(h,i+g.dB(true),s);o.GC(h,i+g.dB(true),v);}double dB(final bool g){return NB(0).dB(g)+max(NB(1).dB(g),NB(2).dB(g));}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return max(NB(0).rB(true),NB(2).OC(true)+rD());}double yB(final bool g){return max(NB(0).yB(true),NB(1).OC(true)-rD());}}class wD{static final IN=new CanvasElement(width:500,height:300);double width;double height;double mE;double vH;double actualBoundingBoxAscent;double actualBoundingBoxDescent;wD(final String JB,final String QB){SpanElement i=new SpanElement();i.setAttribute('style',"font: ${QB}");i.text=JB;DivElement j=new DivElement();j.setAttribute('style','display: inline-block; width: 1px; height: 0px;');DivElement m=new DivElement();m.append(i);m.append(j);document.body.append(m);width=i.offset.width.toDouble();j.style.verticalAlign='bottom';height=(j.offset.top-i.offset.top).toDouble();j.style.verticalAlign='baseline';mE=(j.offset.top-i.offset.top).toDouble();vH=height-mE;m.remove();CanvasRenderingContext2D k=IN.context2D;k.font=QB;k.fillStyle='white';k.fillRect(0,0,IN.width,IN.height);k.fillStyle='black';k.fillText(JB,0,mE);int h=width.ceil();int o=height.ceil();List<int> s=k.getImageData(0,0,h,o).data;int v=0;bool SB=false;int EB=v;int BB=o-1;bool cB=false;int HB=BB;for(int g=0;g<h*o;g++ ){if(!SB&&s[g*4]!=0xFF){v=g~/h;EB=v;SB=true;}if(s[g*4]<0x90){EB=g~/h;break;}}double hB=(v+EB)/2;for(int g=h*o-1;g>=0;g-- ){if(!cB&&s[g*4]!=0xFF){BB=g~/h;HB=BB;cB=true;}if(s[g*4]<0x90){HB=g~/h;break;}}double CC=(BB+HB)/2;actualBoundingBoxAscent=mE-hB;actualBoundingBoxDescent=CC-mE;}}class lB{gH Jb;static final List<List<String>> oT=[["<==","\u21D0"],["==>","\u21D2"],["<=>","\u21D4"],["!=","\u2260"],["~=","\u2248"],["~","\u223C"],["<=","\u2264"],[">=","\u2265"],["<<","\u226A"],[">>","\u226B"],["-->","\u2192"],["<->","\u2194"],["->","\u2192"],["<--","\u2190"],["equiv","\u2261"],["forall","\u2200"],["quelquesoit","\u2200"],["exists","\u2203"],["ilexiste","\u2203"],["part","\u2202"],["drond","\u2202"],["nabla","\u2207"],["prop","\u221D"],["times",""],["cross",""],["croix",""],["wedge","\u2227"],["pvec","\u2227"],["plusmn",""],["plusoumoins",""],["plusminus",""],["cap","\u2229"],["cup","\u222A"],["...","\u2026"]];static final String LN="_^#*/\u2207\u2213\u2227-+\u2200\u2203\u2202=\u2260\u2248\u223C\u2261<>\u2264\u2265\u226A\u226B\u221D"+"|\u2229\u222A\u2190\u2192\u2194\u21D0\u21D2\u21D4";static final List<List<String>> BQ=[["alpha","\u03B1"],["beta","\u03B2"],["gamma","\u03B3"],["delta","\u03B4"],["epsilon","\u03B5"],["zeta","\u03B6"],["eta","\u03B7"],["theta","\u03B8"],["iota","\u03B9"],["kappa","\u03BA"],["lambda","\u03BB"],["mu","\u03BC"],["nu","\u03BD"],["xi","\u03BE"],["omicron","\u03BF"],["rho","\u03C1"],["sigma","\u03C3"],["tau","\u03C4"],["upsilon","\u03C5"],["phi","\u03C6"],["chi","\u03C7"],["psi","\u03C8"],["omega","\u03C9"],["Alpha","\u0391"],["Beta","\u0392"],["Gamma","\u0393"],["Delta","\u0394"],["Epsilon","\u0395"],["Zeta","\u0396"],["Eta","\u0397"],["Theta","\u0398"],["Iota","\u0399"],["Kappa","\u039A"],["Lambda","\u039B"],["Mu","\u039C"],["Nu","\u039D"],["Xi","\u039E"],["Omicron","\u039F"],["Pi","\u03A0"],["Rho","\u03A1"],["Sigma","\u03A3"],["Tau","\u03A4"],["Upsilon","\u03A5"],["Phi","\u03A6"],["Chi","\u03A7"],["Psi","\u03A8"],["Omega","\u03A9"],["thetasym","\u03D1"],["upsih","\u03D2"],["piv","\u03D6"],["phiv","\u03D5"],["phi1","\u03D5"]];static final List<List<String>> DQ=[["pi","\u03C0"],["infin","\u221E"],["infty","\u221E"],["infini","\u221E"],["parallel","\u2225"],["parallle","\u2225"],["sun","\u2609"],["soleil","\u2609"],["star","\u2605"],["toile","\u2605"],["mercury","\u263F"],["mercure","\u263F"],["venus","\u2640"],["vnus","\u2640"],["earth","\u2295"],["terre","\u2295"],["mars","\u2642"],["jupiter","\u2643"],["saturn","\u2644"],["saturne","\u2644"],["uranus","\u26E2"],["neptun","\u2646"],["neptune","\u2646"],["planck","\u210F"],["angstrom","\u212B"],["angstrm","\u212B"],["asterisk","*"],["astrisque","*"],["ell","\u2113"],["smalll","\u2113"],["petitl","\u2113"],["Ascr","\u{1D49C}"],["biga","\u{1D49C}"],["granda","\u{1D49C}"],["Bscr","\u212C"],["bigb","\u212C"],["grandb","\u212C"],["Cscr","\u{1D49E}"],["bigc","\u{1D49E}"],["grandc","\u{1D49E}"],["Dscr","\u{1D49F}"],["bigd","\u{1D49F}"],["grandd","\u{1D49F}"],["Escr","\u2130"],["bige","\u2130"],["grande","\u2130"],["Fscr","\u2131"],["bigf","\u2131"],["grandf","\u2131"],["Gscr","\u{1D4A2}"],["bigg","\u{1D4A2}"],["grandg","\u{1D4A2}"],["Hscr","\u210B"],["bigh","\u210B"],["grandh","\u210B"],["Iscr","\u2110"],["bigi","\u2110"],["grandi","\u2110"],["Jscr","\u{1D4A5}"],["bigj","\u{1D4A5}"],["grandj","\u{1D4A5}"],["Kscr","\u{1D4A6}"],["bigk","\u{1D4A6}"],["grandk","\u{1D4A6}"],["Lscr","\u2112"],["bigl","\u2112"],["grandl","\u2112"],["Mscr","\u2133"],["bigm","\u2133"],["grandm","\u2133"],["Nscr","\u{1D4A9}"],["bign","\u{1D4A9}"],["grandn","\u{1D4A9}"],["Oscr","\u{1D4AA}"],["bigo","\u{1D4AA}"],["grando","\u{1D4AA}"],["Pscr","\u{1D4AB}"],["bigp","\u{1D4AB}"],["grandp","\u{1D4AB}"],["Qscr","\u{1D4AC}"],["bigq","\u{1D4AC}"],["grandq","\u{1D4AC}"],["Rscr","\u211B"],["bigr","\u211B"],["grandr","\u211B"],["Sscr","\u{1D4AE}"],["bigs","\u{1D4AE}"],["grands","\u{1D4AE}"],["Tscr","\u{1D4AF}"],["bigt","\u{1D4AF}"],["grandt","\u{1D4AF}"],["Uscr","\u{1D4B0}"],["bigu","\u{1D4B0}"],["grandu","\u{1D4B0}"],["Vscr","\u{1D4B1}"],["bigv","\u{1D4B1}"],["grandv","\u{1D4B1}"],["Wscr","\u{1D4B2}"],["bigw","\u{1D4B2}"],["grandw","\u{1D4B2}"],["Xscr","\u{1D4B3}"],["bigx","\u{1D4B3}"],["grandx","\u{1D4B3}"],["Yscr","\u{1D4B4}"],["bigy","\u{1D4B4}"],["grandy","\u{1D4B4}"],["Zscr","\u{1D4B5}"],["bigz","\u{1D4B5}"],["grandz","\u{1D4B5}"]];static final List<String> qT=["sin","cos","tan","acos","asin","atan"];static final RegExp rT=new RegExp("^\\s?([0-9]+([\\.,][0-9]+)?|[\\.,][0-9]+)([Ee][+-]?[0-9]+)?\\s?\$");lB(final String h){Jb=new gH();final String j=sT(WW(h));if(h!=''){final aD i=qI(j);XB g;if(i==null)g=null;else g=i.CF();Jb.RB(g);}}gH uK(){return Jb;}String WW(String g){for(final List<String> h in oT){int i=g.indexOf(h[0]);while(i!=-1){g=g.substring(0,i)+h[1]+g.substring(i+h[0].length);i=g.indexOf(h[0]);}}return g;}static bool hH(String i,int h){String g=i[h];if(LN.indexOf(g)==-1)return (false);if(g!='+'&&g!='-')return (true);if(h<2)return (true);g=i[h-1];if(g!='E'&&g!='e')return (true);g=i[h-2];if("0123456789".indexOf(g)!=-1)return (false);return (true);}static String sT(String g){int h=g.indexOf(';');while(h!=-1){int i=0;bool s=false;String o;for(int j=h-1;j>=0&&i>=0;j-- ){o=g[j];if(o==';'&&i==0)break;if(o=='(')i-- ;else if(o==')')i++ ;else if(hH(g,j))s=true;if(i<0&&s){g=g.substring(0,j)+'('+g.substring(j,h)+')'+g.substring(h);h+= 2;}}i=0;s=false;for(int j=h+1;j<g.length&&i>=0;j++ ){o=g[j];if(o=='(')i++ ;else if(o==')')i-- ;else if(hH(g,j))s=true;if((i<0||i==0&&o==';')&&s)g=g.substring(0,h+1)+'('+g.substring(h+1,j)+')'+g.substring(j);if(o==';'&&i==0)break;}final int HB=g.substring(h+1).indexOf(';');if(HB==-1)h=HB;else h+= HB+1;}for(int JB=0;JB<LN.length;JB++ ){final String QB=LN[JB];h=g.indexOf(QB);while(h!=-1&&!hH(g,h))h=g.indexOf(QB,h+1);int SB=h;int m,k;String v=' ',BB=' ';int i;bool EB;while(SB!=-1){EB=false;m=h-1;if(m>=0)v=g[m];i=0;while(m>=0&&(i!=0||v!='(')&&(i!=0||!hH(g,m))){if(v==')')i++ ;else if(v=='(')i-- ;m-- ;if(m>=0)v=g[m];}if(m<0||hH(g,m))EB=true;k=h+1;if(k>=0&&k<=g.length-1)BB=g[k];i=0;while(k<g.length&&(i!=0||BB!=')')&&(i!=0||!hH(g,k))){if(BB=='(')i++ ;else if(BB==')')i-- ;k++ ;if(k<g.length)BB=g[k];}if(k>=g.length||hH(g,k))EB=true;if(EB){g=g.substring(0,m+1)+"("+g.substring(m+1,k)+")"+g.substring(k);h++ ;}SB=g.substring(h+1).indexOf(QB);h=SB+h+1;}}return g;}aD qI(String g){if(g==null||g=='')return null;if(g[0]=='('&&g[g.length-1]==')'){int i=0;for(int h=1;h<g.length-1;h++ ){if(g[h]=='(')i++ ;else if(g[h]==')')i-- ;if(i==-1)break;}if(i!=-1)g=g.substring(1,g.length-1);}int m=-1;int i=0;for(int h=0;h<g.length;h++ ){if(i==0&&hH(g,h)){m=h;break;}else if(g[h]=='(')i++ ;else if(g[h]==')')i-- ;}if(m==-1){bool BB;try {BB=rT.hasMatch(g);}on FormatException catch (hB){BB=false;}if(BB)return (new TI(g));final int o=g.indexOf('(');if(o!=-1&&g[g.length-1]==')'){int s=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j=='('&&i==0&&h!=o){s=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}String CC=null;aD EB=null;if(s==-1){EB=new mG(g.substring(0,o));g=g.substring(o+1,g.length-1);}else{EB=qI(g.substring(0,s));g=g.substring(s+1,g.length-1);}final List<aD> v=new List<aD>();int k=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j==';'&&i==0){k=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}if(k==-1)v.add(qI(g.trim()));else while(k!=-1){v.add(qI(g.substring(0,k).trim()));g=g.substring(k+1);k=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j==';'&&i==0){k=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}if(k==-1)v.add(qI(g.trim()));}return (new iH(EB,v));}else return (new mG(g));}final String cB=g[m];final String QB=g.substring(0,m).trim();aD HB;if(QB=='')HB=null;else HB=qI(QB);final String SB=g.substring(m+1).trim();aD JB;if(SB=='')JB=null;else JB=qI(SB);return (new XE(cB,HB,JB));}static XB HC(final aD g){if(g!=null)return g.CF();final aG h=new aG();h.VC("?");return h;}}typedef void AQ();abstract class aD{XB CF();void XH();}class iH implements aD{aD TF;List<aD> pE;final RegExp HW=new RegExp("^[0-9]+.*\$");iH(final aD g,final List<aD> h){this.TF=g;if(g is mG&&HW.hasMatch(g.TF)){g.TF="?";}pE=h;if((UJ()=="unit"||UJ()=="unit")&&pE.length>1&&pE[1]!=null)pE[1].XH();}void XH(){for(aD g in pE)if(g!=null)g.XH();}String UJ(){if(TF is mG)return ((TF as mG).TF);else return (null);}XB CF(){aD j,o,v,EB;if(pE.length>0)j=pE[0];else j=null;if(pE.length>1)o=pE[1];else o=null;if(pE.length>2)v=pE[2];else v=null;if(pE.length>3)EB=pE[3];else EB=null;String i=UJ();XB h;if(i=="sqrt"||(i=="racine"&&(j==null||o==null))){h=new uP();h.RB(lB.HC(j));}else if(i=="racine"||i=="root"){h=new sP();h.RB(lB.HC(j));h.RB(lB.HC(o));}else if(i=="exp"){h=new VL();final RI MF=new RI();MF.VC("e");h.RB(MF);h.RB(lB.HC(j));}else if(i=="abs"){h=new YC();nB g=new nB();g.VC("|");h.RB(g);h.RB(lB.HC(j));g=new nB();g.VC("|");h.RB(g);}else if(i=="norm"||i=="norme"){h=new YC();nB g=new nB();g.VC("\u2016");h.RB(g);h.RB(lB.HC(j));g=new nB();g.VC("\u2016");h.RB(g);}else if(i=="fact"||i=="factorielle"||i=="factorial"){h=new YC();nB g;if(!(j is mG||j is TI)){g=new nB();g.VC("(");h.RB(g);}h.RB(j.CF());if(!(j is mG||j is TI)){g=new nB();g.VC(")");h.RB(g);}g=new nB();g.VC("!");h.RB(g);}else if(i=="int"||i=="intgrale"){h=new YC();nB g=new nB();g.VC("\u222B");g.ZJ(true);if(v!=null&&EB!=null){final SI s=new SI();s.RB(g);s.RB(lB.HC(v));s.RB(lB.HC(EB));h.RB(s);}else if(v!=null){final sJ IC=new sJ();IC.RB(g);IC.RB(lB.HC(v));h.RB(IC);}else if(EB!=null){final pF k=new pF();k.RB(g);k.RB(lB.HC(EB));h.RB(k);}else h.RB(g);final YC m=new YC();m.RB(lB.HC(j));if(o!=null){g=new nB();g.VC("d");m.RB(g);m.RB(o.CF());}h.RB(m);}else if(i=="prod"||i=="sum"||i=="produit"||i=="somme"){h=new YC();final SI s=new SI();final nB g=new nB();if(i=="prod"||i=="produit")g.VC("\u220F");else if(i=="sum"||i=="somme")g.VC("\u2211");g.ZJ(true);s.RB(g);s.RB(lB.HC(o));s.RB(lB.HC(v));h.RB(s);final YC m=new YC();m.RB(lB.HC(j));h.RB(m);}else if(i=="over"||i=="dessus"){final pF k=new pF();k.RB(lB.HC(j));k.RB(lB.HC(o));h=k;}else if(i=="subsup"){final HN hB=new HN();hB.RB(lB.HC(j));hB.RB(lB.HC(o));hB.RB(lB.HC(v));h=hB;}else if(i=="accent"){final pF k=new pF();k.WP(true);k.RB(lB.HC(j));if(o is XE&&(o as XE).SE=='\u223C'){final nB g=new nB();g.ZJ(true);g.VC("\u223C");k.RB(g);}else k.RB(lB.HC(o));h=k;}else if(i=="matrix"||i=="matrice"){h=new YC();nB g=new nB();g.VC("(");h.RB(g);final qJ QB=new qJ();for(final aD SB in pE)QB.RB(lB.HC(SB));h.RB(QB);g=new nB();g.VC(")");h.RB(g);}else if(i=="system"||i=="systme"){h=new YC();final nB g=new nB();g.VC("{");h.RB(g);final qJ QB=new qJ();for(final aD SB in pE){final YC m=new YC();final QI HB=new QI();HB.fW("left");HB.RB(lB.HC(SB));m.RB(HB);QB.RB(m);}h.RB(QB);}else if(i=="line"||i=="ligne"){h=new rP();for(final aD SB in pE){final QI HB=new QI();HB.RB(lB.HC(SB));h.RB(HB);}}else if(i=="slash"){h=new YC();h.RB(lB.HC(j));final nB g=new nB();g.VC("/");h.RB(g);h.RB(lB.HC(o));}else if(i=="frac"||i=="fraction"){final rJ QD=new rJ();QD.RB(lB.HC(j));QD.RB(lB.HC(o));h=QD;}else if(i=="pscalaire"||i=="scalarp"){final YC m=new YC();m.RB(lB.HC(j));final nB g=new nB();g.VC(".");m.RB(g);m.RB(lB.HC(o));return m;}else if(i=="dtemps"||i=="timed"){final pF k=new pF();k.WP(true);k.RB(lB.HC(j));nB CC=new nB();if(o is TI){try {final int eJ=int.parse((o as TI).cP);String tD="";for(int JB=0;JB<eJ;JB++ )tD=tD+'.';CC.VC(tD);}on FormatException catch (ML){CC.VC("?");}}else CC.VC("?");k.RB(CC);h=k;}else if(i=="unit"||i=="unit"){final YC m=new YC();m.RB(lB.HC(j));final nB g=new nB();g.VC(" ");m.RB(g);m.RB(lB.HC(o));return m;}else if(i=="moyenne"||i=="mean"){h=new YC();nB g=new nB();g.VC("\u2329");h.RB(g);h.RB(lB.HC(j));g=new nB();g.VC("\u232A");h.RB(g);}else if(i=="vecteur"||i=="vector"){final XB BB=lB.HC(j);if(BB is RI){BB.ZS("bold");h=BB;}else if(BB is UL&&BB.NB(0) is RI){(BB.NB(0) as RI).ZS("bold");h=BB;}else{final pF k=new pF();k.WP(true);k.RB(lB.HC(j));final nB g=new nB();g.ZJ(true);g.VC("\u2192");k.RB(g);h=k;}}else{h=new YC();bool qE=true;if(TF is mG){aG WG=new aG();for(final List<String> cB in lB.BQ)if(i==cB[0]){i=cB[1];break;}for(final List<String> cB in lB.DQ)if(i==cB[0]){i=cB[1];break;}WG.VC(i);if(o==null&&j is mG)for(final String fJ in lB.qT)if(i==fJ){qE=false;break;}h.RB(WG);}else h.RB(TF.CF());if(qE){final nB g=new nB();g.VC("(");h.RB(g);}h.RB(lB.HC(j));for(int JB=1;JB<pE.length;JB++ ){final nB g=new nB();g.VC(";");h.RB(g);h.RB(pE[JB].CF());}if(qE){final nB g=new nB();g.VC(")");h.RB(g);}else{final aG NI=new aG();NI.VC("\u00A0");h.RB(NI);}}return h;}}class XE implements aD{String SE;aD PD;aD nD;bool uI;XE(final String h,final aD i,final aD g){SE=h;this.PD=i;this.nD=g;uI=false;if(SE=='#'&&g!=null)g.XH();}void XH(){uI=true;if(PD!=null)PD.XH();if(nD!=null)nD.XH();}XB CF(){if(SE=='/'){final rJ v=new rJ();v.RB(lB.HC(PD));v.RB(lB.HC(nD));return v;}else if(SE=='^'){final VL BB=new VL();bool m;if(PD is iH){String j=(PD as iH).UJ();if(j=="sqrt"||j=="racine")m=false;else if(j=="abs")m=false;else if(j=="matrice")m=false;else if(j=="dtemps"||j=="timed")m=false;else m=true;}else if(PD is XE){String QB=(PD as XE).SE;if(QB=='_')m=false;else m=true;}else m=false;XB k;if(m)k=gI(PD.CF());else k=lB.HC(PD);BB.RB(k);BB.RB(lB.HC(nD));return BB;}else if(SE=='_'){final UL EB=new UL();EB.RB(lB.HC(PD));EB.RB(lB.HC(nD));return EB;}else if(SE=='#'){final YC g=new YC();g.RB(lB.HC(PD));g.RB(lB.HC(nD));return g;}else if(SE=='*'){final YC g=new YC();XB k=lB.HC(PD);if(PD is XE&&"+-".indexOf((PD as XE).SE)!=-1)k=gI(k);g.RB(k);aD o=nD;if(nD!=null)while(o is XE&&(o as XE).PD!=null){o=(o as XE).PD;}final bool SB=o is TI;bool HB=false;if(PD is iH){final String j=(PD as iH).UJ();if(j=="pscalaire"||j=="scalarp")HB=true;}bool JB=false;if(nD is iH){final String j=(nD as iH).UJ();if(j=="pscalaire"||j=="scalarp")JB=true;}if((SB)||(HB&&JB)){final nB i=new nB();i.VC("");g.RB(i);}else{if(uI){final nB i=new nB();i.VC(".");g.RB(i);}}XB h=lB.HC(nD);if(nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);return g;}else if(SE=='-'){final YC g=new YC();if(PD!=null)g.RB(PD.CF());final nB i=new nB();i.VC("-");g.RB(i);if(nD!=null){XB h=nD.CF();if(nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);}return g;}else if(SE=='+'){final YC g=new YC();if(PD!=null)g.RB(PD.CF());final nB i=new nB();i.VC("+");g.RB(i);if(nD!=null){XB h=nD.CF();if(h is YC&&h.PC()>0){XB s=h;while(s is YC&&s.PC()>0)s=s.NB(0);if(s.fB()=="-")h=gI(h);}g.RB(h);}return g;}else{final YC g=new YC();if(PD!=null){XB k=PD.CF();if(SE=='\u2227'&&PD is XE&&"+-".indexOf((PD as XE).SE)!=-1)k=gI(k);g.RB(k);}final nB i=new nB();i.VC(SE);if("=\u2260\u2248\u223C\u2261\u2264\u2265\u226A\u226B\u221D".indexOf(SE)!=-1){i.gW(0.5);i.iW(0.5);}g.RB(i);if(nD!=null){XB h=nD.CF();if(SE=='\u2227'&&nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);}return g;}}XB gI(final XB i){final YC h=new YC();nB g=new nB();g.VC("(");h.RB(g);h.RB(i);g=new nB();g.VC(")");h.RB(g);return h;}}class TI implements aD{String cP;TI(final String g){this.cP=g;}void XH(){}XB CF(){final tP g=new tP();g.VC(cP);return g;}}class mG implements aD{String TF;bool uI;final RegExp BV=new RegExp("^[0-9]+[a-zA-Z]+\$");mG(final String g){this.TF=g.trim();uI=false;}void XH(){uI=true;}XB CF(){if(TF=="hat"||TF=="chapeau"){final nB h=new nB();h.ZJ(true);h.VC("^");return h;}else if(TF=="bar"||TF=="barre"){final nB h=new nB();h.ZJ(true);h.VC("\u00AF");return h;}else{String g=TF;bool k=uI;for(final List<String> i in lB.BQ)if(g==i[0]){g=i[1];break;}for(final List<String> i in lB.DQ)if(g==i[0]){g=i[1];k=true;break;}if(g.indexOf(',')!=-1||g.indexOf('.')!=-1||g.indexOf('(')!=-1||g.indexOf(')')!=-1)g="?";if(g.indexOf(' ')!=-1)g=g.replaceAll(" ","?");if(g.indexOf('\u00A0')!=-1)g=g.replaceAll("\u00A0","?");if(BV.hasMatch(g))g="?";XB j;if(k)j=new aG();else j=new RI();j.VC(g);return j;}}}abstract class XL{l QM(final String g);List<l> iO(final String g);l hG(final l g,final l h);String cD(final l g);String kI(final l g);String PM(final l g);String gO(final l g);List<String> pK(final l g);List<String> kM(final l g);bool jO(final l g,final String h);List<String> EP();String jG(final String g);String KE();List<l> JD();List<l> II();bool HI(final l g,final l h);bool mD(final l g,final l h);List<l> XC(final l g);String ZD(final l g,final bool h,final bool i);List<l> fC(final l g);List<l> fE(final l g);String attributeName(final l g);String attributeNamespace(final l g);String vG(final l g);String eK(final String g);bool UO(final l g,final l h);List<String> hI(final l g);List<String> aP(final l g);String dF(final l g);VO(final l g,final String h);bool PE(final l g);}class BG extends n{bB Lb;bB Mb;BG():super.wX(n.tC){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}BG.QY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Lb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Mb.html());g.style.color="#808080";return (g);}Element dD(){return (oB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.YR(g));}}class qF extends n{bB Lb;bB Mb;qF():super.wX(n.tC){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}qF.PY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Lb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Mb.html());return (g);}Element dD(){return (oB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.XR(g));}void lF(){super.lF();parent.lF();}}class nG extends n{String VG;String nF;nG():super.wX(n.YG){VG='1.0';nF='UTF-8';}nG.TY(AB g):super.qX(g,null){VG=(g as sB).VG;nF=(g as sB).nF;}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}if(lastChild==null||lastChild.nodeType==n.mB)g.appendText('\n');return (g);}AB KF(sB g){g.VG=VG;g.nF=nF;for(n h=firstChild;h!=null;h=h.nextSibling){g.jB(h.KF(g));}return (g);}}class OB extends n{OB(String g):super.xX(g){}OB.zX(AB g,n h):super.qX(g,h){}Element html(){Element g;g=new SpanElement();g.attributes['id']="${id}";g.attributes['class']='dn';if(nodeValue!=null){g.append(new Text(nodeValue));}return (g);}void XM(q h,String i){assert(h.u==this);String g=nodeValue;if(g==null)g='';nodeValue="${g.substring(0,h.KB)}${i}${g.substring(h.KB)}";}OB PV(int g){String i=nodeValue.substring(0,g);String j=nodeValue.substring(g);nodeValue=i;n h=new OB(j);parent.insertBefore(h,nextSibling);return (h);}AB KF(sB g){return (g.wG(nodeValue));}bool get ED{return (true);}}class IH extends n{bB Lb;bB Mb;IH():super.wX(n.tC){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}IH.XY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Lb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Mb.html());return (g);}Element dD(){return (oB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.ZR(nodeName,g));}}class wI extends n{bool TG;SD control;wI.HY(l g):super.vX(g){List<l> h=t.CB.XC(DB);TG=(h.length==0);}wI.iY(AB h,n k):super.qX(h,k,createChildren:false){List<l> m=t.CB.XC(DB);TG=(m.length==0);if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(TG&&j.nodeType==AB.kE)g=new pG.bY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}}Element html(){ButtonElement s=jE.fL(DB,null);TableRowElement h=new TableRowElement();h.id="${id}";h.classes.add('dn');TableCellElement g=new TableCellElement();g.classes.add('shrink');g.append(s);h.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.OD(DB);if(t.CB.HI(parent.DB,DB))g.classes.add('required');else g.classes.add('optional');h.append(g);g=new TableCellElement();g.classes.add('expand');if(TG){String k;if(firstChild!=null)k=firstChild.nodeValue;else k='';control=new SD.nY(DB,k,valueChanged:()=>aO());Element m=control.html();m.id="content_${id}";TextInputElement o=m.querySelector('input');if(o!=null)o.classes.add('form_field');g.append(m);}else{DivElement i=new DivElement();i.id="content_${id}";i.classes.add('form_field');n j=firstChild;while(j!=null){i.append(j.html());j=j.nextSibling;}g.append(i);}h.append(g);if(parent is jE)(parent as jE).dK(h,this);return (h);}Element dD(){return (document.getElementById("content_${id}"));}void aO(){String h=control.hF();GB g=new GB.uX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.rX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.oX(new q(this,0),new pG(h),updateDisplay:false));t.DC(g);lM();}void BF(List<n> g){sD();}void lM(){if(parent is jE){TableRowElement g=oB();g.nodes.last.remove();(parent as jE).dK(g,this);}}}class xI extends n{String Nb;xI.EY(l g):super.vX(g){Nb=t.CB.bC(DB,'styleAtt','style');}xI.cY(AB g,n h):super.qX(g,h){Nb=t.CB.bC(DB,'styleAtt','style');NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');if(css!=null)g.setAttribute('style',css);for(n h=firstChild;h!=null;){g.append(h.html());h=h.nextSibling;}if(lastChild==null||lastChild.nodeType==n.mB)g.appendText('\n');return (g);}Element dD(){return (oB());}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');}bool RE(){return (true);}bool get ED{return (true);}void set css(String g){setAttribute(Nb,g);}String get css{return (getAttribute(Nb));}void SW(){GB g=new GB.uX(LB.MB('undo.remove_element'));n h=t.iI(new q(this,0),new q(this,PB));if(t.ZC!=null){kB.RN(parent,h);}g.TB(new GB.rX(this));g.TB(t.LE(h,new q(parent,parent.ZB(this)),checkValidity:false));t.DC(g);}}class xD extends n{xD.BY(l g):super.vX(g){}xD.LY(AB g,n h):super.qX(g,h){NG();}Element html(){LIElement g=new LIElement();g.id="${id}";g.classes.add('dn');n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}return (g);}Element dD(){return (oB());}bool RE(){return (true);}}class YL extends n{YL.AY(l g):super.vX(g){}YL.IY(AB g,n h):super.qX(g,h){}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');g.classes.add('hr');List<l> h=t.CB.fE(DB);if(h!=null&&h.length>0){g.onClick.listen((MouseEvent i)=>JE());}g.append(new HRElement());return (g);}q QE(){return (null);}q SF(){return (null);}}class ZL extends n{bB Lb;ZL.DY(l g):super.vX(g){}ZL.RY(AB g,n h):super.qX(g,h){}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(new BRElement());return (g);}q QE(){return (null);}q SF(){return (null);}}class oG extends n{String Ob;String Pb;oG.GY(l g):super.vX(g){Ob=t.CB.bC(DB,'nameAtt','name');Pb=t.CB.bC(DB,'hrefAtt','href');}oG.jY(AB g,n h):super.qX(g,h){Ob=t.CB.bC(DB,'nameAtt','name');Pb=t.CB.bC(DB,'hrefAtt','href');}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('anchor');if(!valid)g.classes.add('invalid');if(firstChild==null){ImageElement h=new ImageElement();h.src='packages/daxe/images/toolbar/anchor.png';h.width=16;h.height=16;if(getAttribute(Ob)!=null)h.title=getAttribute(Ob);h.onClick.listen((MouseEvent j)=>JE());g.append(h);}else{if(getAttribute(Pb)!=null)g.title=getAttribute(Pb);n i=firstChild;while(i!=null){g.append(i.html());i=i.nextSibling;}g.onDoubleClick.listen((MouseEvent j)=>JE());}return (g);}void BF(List<n> g){super.sD();}bool get ED{return (true);}static List<l> uT(){return (t.CB.yG('anchor'));}static void vT(l m){q g=IB.vC();if(g==IB.GF()){if(g.u is OB){String j=g.u.nodeValue;int k=g.KB;int h=k;if(h>0)h-- ;int i=k;while(h>0&&j[h]!=' ')h-- ;while(i<j.length&&j[i]!=' ')i++ ;IB.cursor.gE(new q(g.u,h),new q(g.u,i));}}t.CI(m,'element');}static void zT(l g){t.CI(g,'element');}static void AU(){q k=IB.vC();n h=k.u;while(h!=null){if(h is oG)break;h=h.parent;}if(h==null)return;oG g=h;if(g.firstChild==null){t.dM(g);IB.LC();return;}h=g.parent;GB i=new GB.uX(LB.MB('undo.remove_element'));n m=t.iI(new q(g,0),new q(g,g.PB));i.TB(new GB.rX(g));q j;if(g.previousSibling is OB)j=new q(g.previousSibling,g.previousSibling.PB);else j=new q(h,h.ZB(g));i.TB(t.LE(m,j,checkValidity:false));t.DC(i);IB.LC();}}class JH extends n{JH.CY(l g):super.vX(g){}JH.OY(AB g,n h):super.qX(g,h){NG();}Element html(){LIElement h=new LIElement();h.id="${id}";h.classes.add('dn');ImageElement i=new ImageElement(src:'packages/daxe/images/bullet1.png',width:13,height:13);i.classes.add('bullet');List<l> j=t.CB.fE(DB);if(j!=null&&j.length>0)i.onClick.listen((MouseEvent g)=>JE());else{i.onDoubleClick.listen((MouseEvent g){IB.selectNode(this);g.preventDefault();g.stopPropagation();});}h.append(i);SpanElement o=new SpanElement();n k=firstChild;while(k!=null){o.append(k.html());k=k.nextSibling;}h.append(o);ImageElement m=new ImageElement(src:'packages/daxe/images/bullet2.png',width:13,height:13);m.classes.add('bullet');if(j!=null&&j.length>0)m.onClick.listen((MouseEvent g)=>JE());else{m.onDoubleClick.listen((MouseEvent g){IB.selectNode(this);g.preventDefault();g.stopPropagation();});}h.append(m);return (h);}Element dD(){return (oB().nodes[1]);}bool RE(){return (true);}}class SD{static int aL=0;l IF;l AF;String value;String Qb;List<String> UE;List<String> LD;HashMap<String,String> tI;Element BD;GD valueChanged;bool catchUndo;WB MP;SD.nY(this.IF,this.value,{this.valueChanged}){AF=null;Qb="control${aL}";aL++ ;UE=t.CB.pK(IF);if(UE==null||UE.length==0)LD=t.CB.TV(IF);else{if(!UE.contains(''))UE.add('');}catchUndo=true;}SD.yY(this.IF,this.AF,this.value,{this.valueChanged,this.catchUndo: false}){Qb="control${aL}";aL++ ;UE=t.CB.hI(AF);if(UE==null||UE.length==0)LD=t.CB.yU(IF,AF);else{String g=t.CB.dF(AF);if(!UE.contains('')&&g==null)UE.add('');}}Element html(){SpanElement BB=new SpanElement();bool HB;final List<String> SB=['true','false','1','0'];if(UE==null||UE.length!=SB.length||(value!=null&&!SB.contains(value))){HB=false;}else{HB=true;for(int JB=0;JB<UE.length;JB++ ){if(UE[JB]!=SB[JB]){HB=false;break;}}}if(HB){CheckboxInputElement QB=new CheckboxInputElement();BD=QB;if(value==null)value='false';QB.checked=(value=='true'||value=='1');QB.onChange.listen((Event g)=>PJ(true));BB.append(QB);}else if(UE==null||UE.length==0){TextInputElement i=new TextInputElement();i.spellcheck=false;BD=i;i.size=40;if(value==null)value="";i.value=value;PJ(false);i.onInput.listen((Event g)=>PJ(true));i.onKeyUp.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(catchUndo&&v&&((!k&&m==KeyCode.Z)||(!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){}else PJ(true);});if(LD!=null&&LD.length>0){String h;if(AF!=null)h=t.CB.gK(IF,AF,value);else h=t.CB.oK(IF,value);i.value=h;DataListElement cB=new DataListElement();cB.id='datalist_${Qb}';tI=new HashMap<String,String>();MP=new WB('');for(String o in LD){OptionElement j=new OptionElement();String h;if(AF!=null)h=t.CB.gK(IF,AF,o);else h=t.CB.oK(IF,o);j.value=h;tI[h]=o;cB.append(j);MP.add(new uB(h,(){i.value=h;PJ(true);}));}i.attributes['list']='datalist_${Qb}';BB.append(cB);}BB.append(i);if(LD!=null&&LD.length>0){i.style.width="90%";SpanElement s=new SpanElement();s.text='';s.style.cursor='default';s.onClick.listen((Event g)=>oW(i));s.onMouseOver.listen((Event g)=>s.style.background='#E0E0E0');s.onMouseOut.listen((Event g)=>s.style.background=null);BB.append(s);}}else{SelectElement EB=new SelectElement();BD=EB;if(value==null)value='';tI=new HashMap<String,String>();for(String o in UE){OptionElement j=new OptionElement();String h;if(AF!=null)h=t.CB.gK(IF,AF,o);else h=t.CB.oK(IF,o);j.text=h;j.value=o;tI[h]=o;if(o==value){j.defaultSelected=true;j.selected=true;}EB.append(j);}if(!UE.contains(value)){OptionElement j=new OptionElement();j.text=value;j.selected=true;EB.append(j);BD.classes.add('invalid');}EB.onChange.listen((Event g)=>PJ(true));BB.append(EB);}if(catchUndo){BD.onKeyDown.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(v&&!k&&m==KeyCode.Z){g.preventDefault();}else if(v&&((!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){g.preventDefault();}});BD.onKeyUp.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(v&&!k&&m==KeyCode.Z){g.preventDefault();t.aH();}else if(v&&((!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){g.preventDefault();t.cM();}});}return (BB);}void PJ(bool i){String j=value;if(BD is InputElement&&(BD as InputElement).type=='text'){String g=(BD as TextInputElement).value;if(tI!=null&&tI[g]!=null)value=tI[g];else value=g;}else if(BD is SelectElement){value=(BD as SelectElement).value;}else if(BD is InputElement&&(BD as InputElement).type=='checkbox'){bool k=(BD as CheckboxInputElement).checked;if(k)value='true';else value='false';}bool h;if(AF!=null)h=t.CB.eS(AF,value);else h=(value==''||t.CB.wO(IF,value));if(h){BD.classes.add('valid');BD.classes.remove('invalid');}else{BD.classes.add('invalid');BD.classes.remove('valid');}if(i&&value!=j&&valueChanged!=null)valueChanged();}String hF()=>value;void iM(String g){this.value=g;if(BD is InputElement&&(BD as InputElement).type=='text'){TextInputElement k=BD as TextInputElement;if(AF!=null)k.value=t.CB.gK(IF,AF,g);else k.value=t.CB.oK(IF,g);}else if(BD is SelectElement){SelectElement i=BD as SelectElement;while(i.options.length>0)i.options[0].remove();for(String j in UE){OptionElement h=new OptionElement();if(AF!=null)h.text=t.CB.gK(IF,AF,j);else h.text=t.CB.oK(IF,j);if(j==g)h.selected=true;i.append(h);}if(!UE.contains(g)){OptionElement h=new OptionElement();h.text=g;h.selected=true;i.append(h);BD.classes.add('invalid');}i.value=g;}else if(BD is InputElement&&(BD as InputElement).type=='checkbox')(BD as CheckboxInputElement).checked=(g=='true'||g=='1');}void focus(){if(BD is TextInputElement){TextInputElement g=BD as TextInputElement;g.select();g.selectionStart=g.selectionEnd=g.value.length;}else if(BD!=null){BD.focus();}}void oW(TextInputElement j){DivElement g=MP.VM();g.style.position='absolute';g.style.display='block';Rectangle h=j.getBoundingClientRect();g.style.left="${h.left}px";g.style.top="${h.bottom}px";g.style.width="${h.width}px";((g.firstChild) as Element).style.width="${h.width}px";document.body.append(g);StreamSubscription<MouseEvent> i=document.onMouseUp.listen(null);i.onData((MouseEvent k){i.cancel();g.remove();k.preventDefault();});}}class jE extends n{List<l> tH;List<l> IE;HashMap<String,SD> sH;bool TG;SD control;jE.eY(l g):super.vX(g){tH=t.CB.XC(DB);IE=t.CB.fE(DB);TG=(tH.length==0&&IE.length==0);yE();}jE.tY(AB h,n k):super.qX(h,k,createChildren:false){tH=t.CB.XC(DB);IE=t.CB.fE(DB);TG=(tH.length==0&&IE.length==0);if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(TG&&j.nodeType==AB.kE)g=new pG.bY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}if(!TG){List<n> m=childNodes;for(n g in m){if(g is OB)gC(g);}}yE();}void yE(){if(IE.length>0)sH=new HashMap<String,SD>();rU();}void rU(){n h=null;for(l i in tH){bool j=false;for(n g in childNodes){if(g.DB==i){j=true;h=g;}}if(!j){n g=ND.NF(i);if(h!=null)insertAfter(g,h);else if(firstChild!=null)insertBefore(g,firstChild);else jB(g);h=g;}}}Element html(){ButtonElement s=fL(DB,null);if(TG){TableRowElement h=new TableRowElement();h.id="${id}";h.classes.add('dn');TableCellElement g=new TableCellElement();g.classes.add('shrink');g.append(s);h.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.OD(DB);if(t.CB.HI(parent.DB,DB))g.classes.add('required');else g.classes.add('optional');h.append(g);g=new TableCellElement();String m;if(firstChild!=null)m=firstChild.nodeValue;else m='';control=new SD.nY(DB,m,valueChanged:()=>aO());g.append(control.html());h.append(g);if(parent is jE)(parent as jE).dK(h,this);return (h);}else{DivElement j=new DivElement();j.id="${id}";j.classes.add('dn');j.classes.add('form');SpanElement i=new SpanElement();i.classes.add('form_title');i.append(s);i.appendText(' ');i.appendText(t.CB.OD(DB));if(t.CB.HI(parent.DB,DB))i.classes.add('required');else i.classes.add('optional');j.append(i);TableElement k=new TableElement();k.classes.add('expand');for(l v in IE){k.append(TO(v));}for(l BB in tH){for(n o in childNodes){if(o.DB==BB){o.dJ=true;nU(k,o);}}}j.append(k);return (j);}}void aO(){String h=control.hF();GB g=new GB.uX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.rX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.oX(new q(this,0),new pG(h),updateDisplay:false));t.DC(g);lM();}Element dD(){if(TG){return (oB().nodes[2]);}else{return (oB().nodes[1]);}}TableRowElement TO(l h){String o=t.CB.PH(DB,h);TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');ButtonElement v=fL(DB,h);g.append(v);i.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.fK(DB,h);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');i.append(g);g=new TableCellElement();g.classes.add('expand');String j=getAttribute(o);String s=t.CB.dF(h);if(j==null){if(s!=null)j=s;else j='';}SD k;k=new SD.yY(DB,h,j,valueChanged:()=>ZO(h,k),catchUndo:true);sH[o]=k;Element m=k.html();if(m.firstChild is TextInputElement)(m.firstChild as TextInputElement).classes.add('form_field');g.append(m);i.append(g);g=new TableCellElement();g.classes.add('shrink');i.append(g);return (i);}void ZO(l j,SD m){String h=m.hF();String k=t.CB.PH(DB,j);String i=t.CB.dF(j);aB g;if((h==''&&i==null)||h==i)g=new aB(k,null);else if(h!=''||i!=null)g=new aB(k,h);else g=null;if(g!=null)t.DC(new GB.tX(this,g,updateDisplay:false));}void nU(TableElement m,n i){Element j=i.html();TableRowElement h;if(j is TableRowElement)h=j;else{h=new TableRowElement();TableCellElement g;int k;if(i is!jE){g=new TableCellElement();ButtonElement o=fL(i.DB,null);g.append(o);h.append(g);k=2;}else k=3;g=new TableCellElement();g.colSpan=k;g.append(j);h.append(g);dK(h,i);}m.append(h);}void dK(TableRowElement k,n g){TableCellElement j=new TableCellElement();j.classes.add('shrink');if(t.CB.mV().mD(DB,g.DB)){if(g.nextSibling==null||g.nextSibling.DB!=g.DB){if(g.firstChild!=null||g is!jE){ButtonElement h=new ButtonElement();h.attributes['type']='button';h.value='+';h.text='+';h.onClick.listen((Event m)=>qU(g));j.append(h);}}if((g.previousSibling!=null&&g.previousSibling.DB==g.DB)||(g.nextSibling!=null&&g.nextSibling.DB==g.DB)){ButtonElement i=new ButtonElement();i.attributes['type']='button';i.value='-';i.text='-';i.onClick.listen((Event m)=>t.dM(g));j.append(i);}}k.append(j);}void qU(n g){n h=ND.NF(g.DB);t.insertNode(h,new q(this,ZB(g)+1));}void JE([GD g]){if(g!=null)g();}void sD(){if(!TG){super.sD();return;}String g;if(firstChild!=null)g=firstChild.nodeValue;else g='';if(control.hF()!=g)control.iM(g);lM();}void BF(List<n> g){sD();}void lM(){if(parent is jE){TableRowElement g=oB();g.nodes.last.remove();(parent as jE).dK(g,this);}}void vI(){DivElement m=oB();TableElement o=querySelector("#${id}>table");int k=0;for(l h in IE){String i=t.CB.PH(DB,h);String g=getAttribute(i);String j=t.CB.dF(h);if(g==null){if(j!=null)g=j;else g='';}sH[i].iM(g);k++ ;}}bool RE(){return (tH.length!=0);}AB KF(sB h){if(tH.length==0)return (super.KF(h));l i=h.createElementNS(pB,nodeName);for(aB j in attributes)i.setAttributeNS(j.pB,j.name,j.value);i.jB(h.wG('\n'));for(n g=firstChild;g!=null;g=g.nextSibling){if(g.firstChild!=null||(g.attributes!=null&&g.attributes.length>0)){i.jB(g.KF(h));i.jB(h.wG('\n'));}}return (i);}static ButtonElement fL(final l i,final l j){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';if(j==null){String h=t.CB.wH(i);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.UX(i)).show());}else{String h=t.CB.vG(i,j);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.WX(j,i)).show());}return (g);}}class yI extends n{bB Lb;yI.FY(l g):super.vX(g){Lb=new bB(this,bB.BN);}yI.ZY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.BN);}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Lb.html());return (g);}q QE(){return (null);}q SF(){return (null);}Element dD(){return (null);}}class zI extends n{MN Rb;String Sb;zI.MY(l g):super.vX(g){}zI.aY(AB g,n h):super.qX(g,h,createChildren:false){Sb=g.firstChild.nodeValue;}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('special');g.text=Sb;return (g);}void JE([GD g]){Rb=new MN(Sb,okfct:(){Sb=Rb.bV();if(g!=null)g();});Rb.show();}q QE(){return (null);}q SF(){return (null);}AB KF(sB g){l h=g.createElementNS(pB,nodeName);h.jB(g.wG(Sb));return (h);}}class UI extends n{bB Lb;bB Mb;l Tb;UI.JY(l g):super.vX(g){yE();}UI.oY(AB g,n h):super.qX(g,h){yE();NG();}void yE(){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);List<l> g=t.CB.XC(DB);if(g.length>0)Tb=g[0];}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Lb.html());UListElement i=new UListElement();i.classes.add('list');n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Mb.html());return (g);}Element dD(){return (oB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}static void xT(q h){JH g;if(h.u is JH)g=h.u;else g=h.u.parent;JH i=ND.NF(g.DB);t.insertNode(i,new q(g.parent,g.parent.ZB(g)+1));IB.KD(new q(i,0));IB.LC();}}class AJ extends n{bB Lb;bB Mb;AJ.KY(l g):super.vX(g){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}AJ.fY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Lb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}hM(i);g.append(i);g.append(Mb.html());return (g);}Element dD(){return (oB().nodes[1]);}}class YE extends zB{String Nb;YE.NY(l g):super.sY(g){Nb=t.CB.bC(DB,'styleAtt','style');}YE.gY(AB g,n h):super.uY(g,h){Nb=t.CB.bC(DB,'styleAtt','style');}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');if(firstChild!=null){SpanElement h=new SpanElement();n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(css!=null)h.setAttribute('style',css);g.append(h);}else{bB j=new bB(this,bB.ME);bB k=new bB(this,bB.iE);g.append(j.html());SpanElement h=new SpanElement();h.setAttribute('style',css);g.append(h);g.append(k.html());}return (g);}void set css(String g){setAttribute(Nb,g);}String get css{return (getAttribute(Nb));}void BF(List<n> g){super.sD();}Element dD(){if(firstChild!=null)return (oB().nodes.first);else return (oB().nodes[1]);}static l EQ(){return (t.CB.mO('stylespan'));}bool matches(zB g){if(g is YE){uD h=new uD(css);uD i=new uD(g.css);return (h.UV(i));}else{return (false);}}bool CH(String g,String h){if(css==null)return (false);uD i=new uD(css);return (i[g]==h);}bool LS(String g){if(css==null)return (false);uD h=new uD(css);return (h[g]!=null);}}class BJ extends n{SD control;BJ.SY(l g):super.vX(g){}BJ.dY(AB h,n k):super.qX(h,k,createChildren:false){if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(j.nodeType==AB.kE)g=new pG.bY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('simple_type');List<l> j=t.CB.fE(DB);if(j!=null&&j.length>0){ImageElement k=new ImageElement(src:'images/attributes.png',width:16,height:15);k.onClick.listen((MouseEvent h)=>JE());g.append(k);}String m=t.CB.OD(DB);g.append(new Text(m));String i;if(firstChild!=null)i=firstChild.nodeValue;else i='';control=new SD.nY(DB,i,valueChanged:()=>GV());g.append(control.html());g.onDoubleClick.listen((MouseEvent h){IB.selectNode(this);h.preventDefault();h.stopPropagation();});return (g);}void GV(){String h=control.hF();GB g=new GB.uX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.rX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.oX(new q(this,0),new pG(h),updateDisplay:false));t.DC(g);control.focus();}void sD(){String g;if(firstChild!=null)g=firstChild.nodeValue;else g='';if(control.hF()!=g)control.iM(g);}q QE(){return (null);}q SF(){return (null);}}class iC extends n{l Tb;String type;iC.UY(l g):super.vX(g){yE();}iC.pY(AB h,n i):super.qX(h,i){yE();NG();for(n g in childNodes){if(g is OB&&g.nodeValue.trim()==''){gC(g);}}}void yE(){Tb=cL(DB);type=t.CB.bC(DB,'type','ul');}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');Element h;if(type=='ul')h=new UListElement();else h=new OListElement();h.classes.add('wlist');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}g.append(h);return (g);}q QE(){if(firstChild==null){return (null);}return (new q(firstChild,0));}q SF(){if(lastChild==null){return (null);}return (new q(lastChild,lastChild.PB));}Element dD(){return (oB().firstChild);}bool RE(){return (true);}bool RG(){return (true);}static l cL(l h){List<l> g=t.CB.XC(h);if(g.length>0)return (g[0]);return (null);}static void FQ(l QB){l qE=cL(QB);q BB=IB.vC();q NI=IB.GF();GB j=new GB.uX(t.CB.OD(QB));q SB;xD i=new xD.BY(qE);n m=BB.u;while(m!=null&&m is!iC){m=m.parent;}if(m is iC&&m.DB!=QB){SB=new q.gX(BB);iC v=new iC.UY(QB);for(n h=m.firstChild;h!=null;h=h.nextSibling){v.jB(new n.yX(h));}j.TB(new GB.oX(new q(m.parent,m.parent.ZB(m)),v));j.TB(new GB.rX(m));t.DC(j);IB.KD(SB);IB.LC();return;}n g=BB.u;while(g!=null&&g is!kB)g=g.parent;if(g is kB){for(n h=g.firstChild;h!=null;h=h.nextSibling)i.jB(new n.yX(h));if(g.previousSibling is iC&&g.nextSibling is iC){j.TB(new GB.oX(new q(g.previousSibling,g.previousSibling.PB),i));n MF=new n.yX(g.nextSibling);j.TB(t.LE(MF,new q(g.previousSibling,g.previousSibling.PB+1)));j.TB(new GB.rX(g.nextSibling));}else if(g.previousSibling is iC){j.TB(new GB.oX(new q(g.previousSibling,g.previousSibling.PB),i));}else if(g.nextSibling is iC){j.TB(new GB.oX(new q(g.nextSibling,0),i));}else{n v=new iC.UY(QB);v.jB(i);j.TB(new GB.oX(new q(g.parent,g.parent.ZB(g)),v));}j.TB(new GB.rX(g));SB=new q(i,i.PB);}else{n k=BB.u;int WG=BB.KB;while(k is OB||k is zB){WG=k.parent.ZB(k);k=k.parent;}int CC=WG;while(CC>0){n h=k.eB(CC-1);if((h is!OB&&!t.CB.fD(qE,h.DB))||h.RE())break;CC-- ;}q EB=new q(k,CC);n HB=BB.u;int cB=BB.KB;while(HB is OB||HB is zB){cB=HB.parent.ZB(HB)+1;HB=HB.parent;}assert(HB==k);while(cB<k.PB){n h=k.eB(cB);if((h is!OB&&!t.CB.fD(qE,h.DB))||h.RE())break;cB++ ;}q s=new q(k,cB);n IC;if(EB<s){IC=t.iI(EB,s);for(n h=IC.firstChild;h!=null;h=IC.firstChild){IC.gC(h);i.jB(h);}n QD=i.eB(0);if(QD is OB){String hB=QD.nodeValue.trimLeft();if(hB=='')i.gC(QD);else QD.nodeValue=hB;}n tD=i.eB(i.PB-1);if(tD is OB){String hB=tD.nodeValue.trimRight();if(hB=='')i.gC(tD);else tD.nodeValue=hB;}}n o;if(EB.KB>0)o=EB.u.eB(EB.KB-1);else o=null;n JB;if(s.KB<s.u.PB)JB=s.u.eB(s.KB);else JB=null;if(o is iC&&JB is iC){j.TB(new GB.oX(new q(o,o.PB),i));n MF=new n.yX(JB);j.TB(t.LE(MF,new q(o,o.PB+1)));j.TB(new GB.rX(JB));}else if(o is iC){j.TB(new GB.oX(new q(o,o.PB),i));}else if(JB is iC){j.TB(new GB.oX(new q(JB,0),i));}else{n v=new iC.UY(QB);v.jB(i);j.TB(new GB.oX(s,v));}if(EB<s)j.TB(t.GI(EB,s));SB=new q(i,i.PB);}t.DC(j);IB.KD(SB);IB.LC();}static void QN(){q SB=IB.vC();n g=SB.u;while(g!=null&&g is!xD)g=g.parent;if(g==null)return;GB i=new GB.uX(LB.MB('toolbar.lower_level'));xD s=g;iC j=s.parent;n v=null;if(s.nextSibling!=null){v=new iC.UY(j.DB);for(g=s.nextSibling;g!=null;g=g.nextSibling){v.jB(new n.yX(g));i.TB(new GB.rX(g));}}n h=new n.yX(s);q BB;if(j.parent is xD){xD JB=j.parent;iC QB=JB.parent;if(v!=null)h.jB(v);i.TB(new GB.oX(new q(QB,QB.ZB(JB)+1),h));BB=new q(h,h.PB);}else{q m=new q(j.parent,j.parent.ZB(j)+1);if(v!=null)i.TB(new GB.oX(m,v));if(t.ZC!=null&&t.CB.fF(j.parent.DB,t.ZC)!=null){l EB=t.CB.fF(j.parent.DB,t.ZC);if(h.firstChild!=null){n o=h.firstChild;n HB=null;kB k=null;while(o!=null){HB=o.nextSibling;if(o is OB||t.CB.fD(EB,o.DB)){if(k==null)k=new kB.WY(EB);h.gC(o);k.jB(o);h.insertBefore(k,HB);}else{k=null;}o=HB;}BB=m;i.TB(t.LE(h,m));}else{kB k=new kB.WY(EB);i.TB(new GB.oX(m,k));BB=new q(k,0);}}else{if(h.firstChild!=null){BB=m;i.TB(t.LE(h,m));}else{BB=m;}}}if(s.previousSibling!=null)i.TB(new GB.rX(s));else i.TB(new GB.rX(j));t.DC(i);IB.KD(BB);IB.LC();}static void FU(){q s=IB.vC();n g=s.u;while(g!=null&&g is!xD)g=g.parent;if(g==null)return;xD i=g;xD h=i.previousSibling;if(h==null)return;GB j=new GB.uX(LB.MB('toolbar.rise_level'));j.TB(new GB.rX(i));n k=new n.yX(i);if(h.lastChild is iC){iC m=h.lastChild;j.TB(new GB.oX(new q(m,m.PB),k));}else{n o=new iC.UY(i.parent.DB);o.jB(k);j.TB(new GB.oX(new q(h,h.PB),o));}t.DC(j);IB.KD(new q(k,k.PB));IB.LC();}static void GU(q k){xD g;n h=k.u;while(h!=null&&h is!xD)h=h.parent;assert(h!=null);if(h==null)return;g=h;q i=new q(g.parent,g.parent.ZB(g));q o=new q(g.parent,g.parent.ZB(g)+1);n s=t.IG(g,i,k);n m=t.IG(g,k,o);GB j=new GB.uX(LB.MB('undo.insert_text'));j.TB(new GB.oX(i,s));i=new q(g.parent,g.parent.ZB(g)+1);j.TB(new GB.oX(i,m));j.TB(new GB.rX(g));t.DC(j);IB.KD(new q(m,0));IB.LC();}static List<l> HU(){List<l> g=new List<l>();List<l> i=t.CB.yG('wlist');for(l h in i)if(t.CB.bC(h,'type','ul')=='ul')g.add(h);return (g);}static List<l> IU(){List<l> g=new List<l>();List<l> i=t.CB.yG('wlist');for(l h in i)if(t.CB.bC(h,'type','ul')=='ol')g.add(h);return (g);}}class pG extends OB{pG(String g):super(g){}pG.bY(AB g,n h):super.zX(g,h){}void sD(){parent.sD();}}class kB extends n{String Nb;kB.WY(l g):super.vX(g){Nb=t.CB.bC(DB,'styleAtt','style');}kB.lY(AB g,n h):super.qX(g,h){Nb=t.CB.bC(DB,'styleAtt','style');}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');g.classes.add('hiddenp');if(!valid)g.classes.add('invalid');if(css!=null)g.setAttribute('style',css);for(n h=firstChild;h!=null;){g.append(h.html());h=h.nextSibling;}return (g);}Element dD(){return (oB());}bool get ED{return (true);}bool RE(){return (true);}void set css(String g){setAttribute(Nb,g);}String get css{return (getAttribute(Nb));}bool CH(String g,String h){if(css==null)return (false);uD i=new uD(css);return (i[g]==h);}static void tT(String j){List<kB> g=dL();if(g.length==0)return;GB h=new GB.uX(LB.MB('style.remove_styles'));for(kB k in g){GB i=wT(k,j);if(i!=null)h.TB(i);}t.DC(h);IB.cursor.refresh();}static GB wT(kB g,String i){String k=g.css;if(k==null)return (null);uD h=new uD(g.css);if(h[i]!=null){h.remove(i);String m=h.toString();aB j=g.RM(g.Nb);j.value=m;return (new GB.sX(g,[j],updateDisplay:true));}return (null);}static void yT(String j,String k){List<kB> g=dL();if(g.length==0)return;GB h=new GB.uX(LB.MB('style.apply_style'));for(kB m in g){GB i=BU(m,j,k);if(i!=null)h.TB(i);}t.DC(h);IB.cursor.refresh();}static GB BU(kB g,String k,String m){uD i=new uD(g.css);i[k]=m;String j=i.toString();aB h=g.RM(g.Nb);if(h==null)h=new aB(g.Nb,j);else h.value=j;return (new GB.sX(g,[h],updateDisplay:true));}static List<kB> dL(){List<kB> j=new List<kB>();q h=IB.vC();q m=IB.GF();n i=h.u;while(i!=null&&i is!kB)i=i.parent;n g;if(i is kB)g=i;else if(h.u is OB)g=h.u.parent;else if(h.KB<h.u.PB)g=h.u.eB(h.KB);else if(h.u.PB==0)g=h.u;else g=h.u.lastChild.nextNode();if(g==null)return (j);if(g is kB)j.add(g);if(g.parent==null)return (j);q k=new q(g.parent,g.parent.ZB(g)+1);while(k<m){g=g.nextNode();if(g==null)break;if(g is kB)j.add(g);k=new q(g.parent,g.parent.ZB(g)+1);}return (j);}static bool CU(){q o=IB.vC();q k=IB.GF();n g=o.u;int SB=o.KB;while(g is OB||g is zB){SB=g.parent.ZB(g);g=g.parent;}if(g is kB){GB h=new GB.uX(LB.MB('undo.insert_text'));kB i=g;q IC=new q(i.parent,i.parent.ZB(i));q MF=new q(i,0);q QD=new q(i,i.PB);assert(k<=QD);n s=t.IG(i,MF,o);n j=t.IG(i,k,QD);h.TB(new GB.rX(i));h.TB(new GB.oX(IC,j));h.TB(new GB.oX(IC,s));t.DC(h);IB.KD(new q(j,0));IB.LC();return (true);}if(o.u!=k.u)return (false);if(g.DB==null)return (false);if(g is kB)return (false);l v=t.CB.fF(g.DB,t.ZC);if(v==null)return (false);if(!t.CB.WM(g,SB,SB,v))return (false);GB h=new GB.uX(LB.MB('undo.insert_text'));int EB=SB;while(EB>0){n HB=g.eB(EB-1);if(HB is!OB&&!t.CB.fD(v,HB.DB))break;EB-- ;}q JB=new q(g,EB);n s=null;if(JB<o)s=t.IG(g,JB,o);n m=k.u;int QB=k.KB;while(m is OB||m is zB){QB=m.parent.ZB(m)+1;m=m.parent;}assert(m==g);while(QB<g.PB){n HB=g.eB(QB);if(HB is!OB&&!t.CB.fD(v,HB.DB))break;QB++ ;}q cB=new q(g,QB);n j=null;if(cB>k){j=t.IG(g,k,cB);n hB=j.eB(j.PB-1);if(hB is OB){String BB=hB.nodeValue;if(BB.length>0&&BB[BB.length-1]=='\n'){if(BB.length==1)j.gC(hB);else hB.nodeValue=BB.substring(0,BB.length-1);}}}if(JB<cB){h.TB(t.GI(JB,cB));}int tD=EB;if(s!=null||g.PB==0){kB qE=ND.NF(v);h.TB(new GB.oX(JB,qE));if(s!=null)h.TB(t.LE(s,new q(qE,0)));tD++ ;}kB CC=ND.NF(v);h.TB(new GB.oX(new q(g,tD),CC));if(j!=null)h.TB(t.LE(j,new q(CC,0)));t.DC(h);IB.KD(new q(CC,0));IB.LC();return (true);}static void RN(n j,n i){if(t.ZC==null)return;n k;for(n g=i.firstChild;g!=null;g=k){k=g.nextSibling;if(g is kB&&!t.CB.fD(j.DB,g.DB)){n o;for(n m=g.firstChild;m!=null;m=o){o=m.nextSibling;g.gC(m);i.insertBefore(m,g);}i.gC(g);}}l h;if(j.DB!=null)h=t.CB.fF(j.DB,t.ZC);else h=null;if(h!=null){for(n g=i.firstChild;g!=null;g=k){k=g.nextSibling;if(g.DB!=h&&((g is OB&&!t.CB.PE(j.DB))||(!t.CB.fD(j.DB,g.DB)&&t.CB.fD(h,g.DB)))){i.gC(g);if(g.previousSibling!=null&&g.previousSibling.DB==h){g.previousSibling.jB(g);}else{kB s=new kB.WY(h);s.jB(g);i.insertBefore(s,k);}}}}}}class CJ extends n{bB Lb;bB Mb;CJ.VY(l g):super.vX(g){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);}CJ.kY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME);Mb=new bB(this,bB.iE);NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Lb.html());DivElement h=new DivElement();h.classes.add('indent');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');hM(h);g.append(h);g.append(Mb.html());return (g);}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');}void vI(){Element g=oB().nodes[0];Lb=new bB(this,bB.ME,true);g.replaceWith(Lb.html());}Element dD(){return (oB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}}class bL extends n{bB Lb;bB Mb;bL.YY(l g):super.vX(g){Lb=new bB(this,bB.ME,true);Mb=new bB(this,bB.iE,true);}bL.mY(AB g,n h):super.qX(g,h){Lb=new bB(this,bB.ME,true);Mb=new bB(this,bB.iE,true);NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Lb.html());DivElement h=new DivElement();h.classes.add('indent');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');g.append(h);g.append(Mb.html());return (g);}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.mB)h.appendText('\n');}void vI(){Element g=oB().nodes[0];Lb=new bB(this,bB.ME,true);g.replaceWith(Lb.html());}Element dD(){return (oB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}}class jH extends n{ImageElement Ub;String Vb;jH.hY(l g):super.vX(g){Vb=t.CB.bC(DB,'srcAtt','src');}jH.rY(AB g,n h):super.qX(g,h){Vb=t.CB.bC(DB,'srcAtt','src');}Element html(){assert(t.SH!=null);Ub=new ImageElement();Ub.id="${id}";Ub.classes.add('dn');String g='';String h=t.SH;int i=h.lastIndexOf('/');if(i!=-1)g=h.substring(0,i+1);String j="${g}${getAttribute(Vb)}";Ub.src=j;Ub.alt=getAttribute(Vb);Ub.onLoad.listen((Event k)=>sV());Ub.onClick.listen((MouseEvent k)=>JE());return (Ub);}void sV(){if(Ub.naturalWidth>500){Ub.width=500;}if(IB.vC()!=null&&IB.vC()>new q(this,0))IB.cursor.bH(false);}q QE(){return (null);}q SF(){return (null);}}class DJ extends n{ImageElement Ub;String Wb;String Xb;GN Rb;DJ.qY(l g):super.vX(g){Wb=t.CB.bC(DB,'texteAtt','src');oD.CQ();}DJ.vY(AB g,n h):super.qX(g,h,createChildren:false){Wb=t.CB.bC(DB,'texteAtt','src');if(g.firstChild!=null)Xb=g.firstChild.nodeValue.replaceAll('\n','');else Xb=null;oD.CQ();}Element html(){Ub=new ImageElement();Ub.attributes['id']="${id}";Ub.attributes['class']='dn';if(Xb!=null){String g="data:image/png;base64,${Xb}";Ub.attributes['src']=g;}Ub.onLoad.listen((Event h)=>nO());Ub.onClick.listen((MouseEvent h)=>JE());Ub.style.verticalAlign='middle';return (Ub);}void nO(){if(Ub.naturalWidth>500){Ub.width=500;}}q QE(){return (null);}q SF(){return (null);}void JE([GD h]){String g=getAttribute(Wb);if(g==null)g='';Rb=new GN(g,okfct:(){String g=Rb.fB();if(oB()!=null){aB i=new aB(Wb,g);GB j=new GB.tX(this,i,updateDisplay:false);t.DC(j);}else{setAttribute(Wb,g);}Xb=Rb.getData();if(Ub!=null){String k="data:image/png;base64,${Xb}";Ub.attributes['src']=k;}if(h!=null)h();Ub.onLoad.listen((Event m)=>IB.KD(new q(parent,parent.ZB(this)+1)));});Rb.show();}void vI(){IL();sD();}void IL(){String j=getAttribute(Wb);lB h=new lB(j);CanvasElement k=new CanvasElement(width:500,height:300);oD i=new oD(element:h.uK(),context:k.context2D);CanvasElement g=new CanvasElement(width:i.dB(),height:i.OC());oD m=new oD(element:h.uK(),context:g.context2D);m.GC(g.context2D);String o=g.toDataUrl('image/png');Xb=o.substring('data:image/png;base64,'.length);}AB KF(sB k){l h=k.createElementNS(pB,nodeName);for(aB i in attributes)h.setAttributeNS(i.pB,i.name,i.value);if(Xb!=null){StringBuffer j=new StringBuffer();String g=Xb;while(g!=''){if(g.length<=76){j.write(g);g='';}else{j.writeln(g.substring(0,76));g=g.substring(76);}}h.jB(k.wG(j.toString()));}return (h);}}class zB extends n{String Yb;zB.sY(l g):super.vX(g){Yb=t.CB.bC(g,'style',null);}zB.uY(AB g,n h):super.qX(g,h){Yb=t.CB.bC(DB,'style',null);}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');if(firstChild!=null){SpanElement h=new SpanElement();n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}hM(h);g.append(h);}else{bB j=new bB(this,bB.ME);bB k=new bB(this,bB.iE);g.append(j.html());SpanElement h=new SpanElement();g.append(h);g.append(k.html());}return (g);}void BF(List<n> g){super.sD();}Element dD(){if(firstChild!=null)return (oB().nodes.first);else return (oB().nodes[1]);}bool get ED{return (true);}void set css(String g){assert(false);}String get css{return (null);}bool matches(zB g){if(g is YE)return (false);return (DB==g.DB);}bool CH(String g,String h){return (false);}bool LS(String g){return (false);}static sE GQ(q h,q i,[l BB,String hB]){h=new q.pX(h);i=new q.pX(i);IB.cursor.xG();h.zE();i.zE();assert(h!=i);GB o=new GB.uX(LB.MB('style.remove_styles'));n g=DU(h.u,i.u);n s=g.parent;while(s!=null){if(s is zB&&(BB==null||SN(s,BB,hB)))g=s;s=s.parent;}if(g is OB){q QB=new q.gX(h);q SB=new q.lX(i);sE cB=new sE(o,QB,SB);return (cB);}if(g is zB)g=g.parent;q j=new q(g,0);q EB=new q(g,g.PB);n k;if(j!=h)k=t.IG(g,j,h);else k=null;n v=t.IG(g,h,i);n m;if(EB!=i)m=t.IG(g,i,EB);else m=null;if(BB==null)HQ(v);else PN(v,BB,cssName:hB);int CC=new q.gX(j).HF;int HB;if(k!=null){HB=IQ(k);if(k.lastChild is OB&&v.firstChild is OB){HB-- ;}}else HB=0;q QB=new q.TX(CC+HB);int IC=new q.lX(EB).UF;int JB;if(m!=null){JB=IQ(m);if(m.firstChild is OB&&v.lastChild is OB){JB-- ;}}else JB=0;q SB=new q.ZX(IC+JB);o.TB(t.GI(j,EB));if(m!=null)o.TB(t.LE(m,j,checkValidity:false));o.TB(t.LE(v,j,checkValidity:false));if(k!=null)o.TB(t.LE(k,j,checkValidity:false));sE cB=new sE(o,QB,SB);return (cB);}static n DU(n i,n j){n g=i;while(g!=null){n h=j;while(h!=null){if(g==h){return (g);}if(h.parent==null)break;h=h.parent;}if(g.parent==null)break;g=g.parent;}return (null);}static HQ(n h){for(n g=h.firstChild;g!=null;){if(g is zB){n j=g.firstChild;for(n i=g.firstChild;i!=null;){n k=i.nextSibling;h.insertBefore(i,g);i=k;}h.gC(g);g=j;}else{HQ(g);g=g.nextSibling;}}h.normalize();}static PN(n h,l j,{String cssName,String cssValue}){for(n g=h.firstChild;g!=null;){if((cssValue!=null&&TN(g,j,cssName,cssValue))||SN(g,j,cssName)){if(g is YE&&cssName!=null&&(new uD((g as YE).css)).keys.length>1){uD k=new uD((g as YE).css);k.remove(cssName);(g as YE).css=k.toString();}else{n m=g.firstChild;for(n i=g.firstChild;i!=null;){n o=i.nextSibling;h.insertBefore(i,g);i=o;}h.gC(g);g=m;}}else{PN(g,j,cssName:cssName,cssValue:cssValue);g=g.nextSibling;}}h.normalize();}static int IQ(n i){n k=i;int m=i.PB;int j=0;n g=i;int h=0;while(g!=k||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}return (j);}static GB EU(q o,[l k,String i]){n h=o.u;if(h is OB)h=h.parent;for(n g=h;g!=null;g=g.parent){if((k==null&&g is zB)||SN(g,k,i)){if(g is YE&&i!=null&&(new uD((g as YE).css)).keys.length>1){uD m=new uD((g as YE).css);m.remove(i);aB s=new aB((g as YE).Nb,m.toString());return (new GB.tX(g,s));}else{GB j=new GB.uX(LB.MB('undo.remove_element'));n v=new n.yX(g);q BB=new q(g.parent,g.parent.ZB(g)+1);j.TB(t.LE(v,BB,checkValidity:false));j.TB(new GB.rX(g));return (j);}}}return (null);}static void eL([l i,String j]){q g=IB.vC();q k=IB.GF();if(g==null)return;if(g==k){GB m=EU(g,i,j);if(m!=null)t.DC(m);IB.LC();}else{sE h=GQ(g,k,i,j);t.DC(h.xH);IB.cursor.gE(h.start,h.end);IB.LC();}}static bool SN(n g,l i,String h){if(g is!zB)return (false);if(g.DB!=i)return (false);if(h==null)return (true);if((g as zB).css==null)return (false);return ((g as zB).LS(h));}static bool TN(n g,l h,String i,String j){if(g is!zB)return (false);if(g.DB!=h)return (false);if((g as zB).css==null)return (true);return ((g as zB).CH(i,j));}static sE JQ(q k,q m,l o,{String cssName,String cssValue}){assert(k!=m);GB EB=new GB.uX(LB.MB('style.apply_style'));q HB=k;q s=new q.gX(k);q g=new q.pX(k);g.zE();if(g.u is OB&&g.KB==0){n h=g.u.previousSibling;if(h is zB&&TN(h,o,cssName,cssValue)){HB=new q(h.parent,h.parent.ZB(h));s=new q.gX(g);s.PG(-2);if(h.lastChild is OB)s.PG(-1);}}q v=m;q BB=new q.lX(m);q j=new q.pX(m);j.zE();if(j.u is OB&&j.KB==j.u.PB){n i=g.u.nextSibling;if(i is zB&&TN(i,o,cssName,cssValue)){v=new q(i.parent,i.parent.ZB(i)+1);BB=new q.lX(j);BB.PG(2);if(i.firstChild is OB)BB.PG(1);}}n JB=t.iI(HB,v);PN(JB,o,cssName:cssName,cssValue:cssValue);UN(JB,o,cssName,cssValue);EB.TB(t.LE(JB,v,checkValidity:false));EB.TB(t.GI(HB,v));return (new sE(EB,s,BB));}static void KQ(l i,{String cssName,String cssValue}){q g=IB.vC();q o=IB.GF();if(g==o){n h=g.u;if(h is OB)h=h.parent;n j=ND.NF(i,'element');if(cssName!=null&&cssValue!=null)(j as zB).css="${cssName}: ${cssValue}";bool s=false;if(t.ZC!=null){if(!t.CB.fD(h.DB,i)){l k=t.CB.fF(h.DB,t.ZC);if(k!=null&&t.CB.fD(k,i)){kB v=new kB.WY(k);v.jB(j);t.insertNode(v,g);s=true;}}}if(!s)t.insertNode(j,g);q BB=j.QE();if(BB!=null){IB.KD(BB);IB.LC();}return;}sE m=JQ(g,o,i,cssName:cssName,cssValue:cssValue);t.DC(m.xH);IB.cursor.gE(m.start,m.end);IB.LC();}static void UN(n i,l j,String k,String m){if(t.CB.fD(i.DB,j)){n h=null;for(n g=i.firstChild;g!=null;){if(g is OB||t.CB.fD(j,g.DB)){n o=g.nextSibling;i.gC(g);if(h==null){h=ND.NF(j,'element');if(k!=null&&m!=null)(h as zB).css="${k}: ${m}";}h.jB(g);g=o;}else{if(h!=null){i.insertBefore(h,g);h=null;}UN(g,j,k,m);g=g.nextSibling;}}if(h!=null)i.jB(h);}else{for(n g=i.firstChild;g!=null;g=g.nextSibling){if(g is!OB)UN(g,j,k,m);}}}static void JU(l g,String h,String k){q m=IB.vC();q o=IB.GF();if(m==o){zB.KQ(g,cssName:h,cssValue:k);}else{sE i=zB.GQ(m,o,g,h);t.DC(i.xH);sE j=JQ(i.start,i.end,g,cssName:h,cssValue:k);t.DC(j.xH);t.lK(LB.MB('style.apply_style'),2);IB.cursor.gE(j.start,j.end);IB.LC();}}static sE VN(q g){zB h=null,i=null;if(g.u is zB&&g.KB==g.u.PB)h=g.u;else if(g.u is OB&&g.KB==g.u.PB&&g.u.parent is zB&&g.u.parent.ZB(g.u)==g.u.parent.PB)h=g.u.parent;else if(g.u is!OB&&g.KB>0&&g.u.PB>0&&g.u.eB(g.KB-1) is zB)h=g.u.eB(g.KB-1);if(g.u is zB&&g.KB==0)i=g.u;else if(g.u is OB&&g.KB==0&&g.u.parent is zB&&g.u.parent.ZB(g.u)==0)i=g.u.parent;else if(g.u is!OB&&g.KB<g.u.PB&&g.u.PB>0&&g.u.eB(g.KB) is zB)i=g.u.eB(g.KB);if(h==null||i==null)return (null);if(!h.matches(i))return (null);q j;if(h.lastChild is OB&&i.firstChild is OB)j=new q(h.lastChild,h.lastChild.PB);else j=new q(h,h.PB);GB k=new GB.uX('merge');k.TB(new GB.rX(i));n m=new n.yX(i);k.TB(t.LE(m,new q(h,h.PB)));return (new sE(k,j,new q.pX(j)));}}class EJ extends n{ImageElement Ub;String Wb;String Zb;String ab;String Xb;ON Rb;EJ.wY(l g):super.vX(g){Wb=t.CB.bC(DB,'texteAtt',null);Zb=t.CB.bC(DB,'labelAtt',null);ab=t.CB.bC(DB,'serveur',null);}EJ.AZ(AB g,n h):super.qX(g,h,createChildren:false){Wb=t.CB.bC(DB,'texteAtt','texte');ab=t.CB.bC(DB,'serveur',null);if(g.firstChild!=null)Xb=g.firstChild.nodeValue;else Xb=null;}Element html(){Ub=new ImageElement();Ub.attributes['id']="${id}";Ub.attributes['class']='dn';if(Xb!=null){String g="data:image/png;base64,${Xb}";Ub.attributes['src']=g;}Ub.onLoad.listen((Event h)=>nO());Ub.onClick.listen((MouseEvent h)=>JE());Ub.style.verticalAlign='middle';return (Ub);}void nO(){if(Ub.naturalWidth>500){Ub.width=500;}}q QE(){return (null);}q SF(){return (null);}void JE([GD g]){String h=getAttribute(Wb);String i=getAttribute(Zb);Rb=new ON(ab,h,labelName:Zb,labelValue:i,okfct:()=>tU(g));Rb.show();}void tU(GD g){if(g!=null)g();String j=Rb.fB();String h=Rb.kR();if(g==null){List<aB> i=new List<aB>();i.add(new aB(Wb,j));if(Zb!=null&&h!='')i.add(new aB(Zb,h));GB k=new GB.sX(this,i,updateDisplay:false);t.DC(k);}else{setAttribute(Wb,j);if(Zb!=null)setAttribute(Zb,h);}IL();}void vI(){IL();}void IL(){String g=getAttribute(Wb);getData(g).then((String h){Xb=h;sD();IB.KD(new q(parent,parent.ZB(this)+1));},onError:(Object i){window.alert(i.toString());});}Future<String> getData(String g){if(g==null||g=='')g='?';Completer<String> h=new Completer<String>();String j="${ab}?${Uri.encodeComponent(g)}";HttpRequest.request(j,method:'GET',responseType:'arraybuffer').then((HttpRequest k){Object i=k.response;if(i is ByteBuffer){Uint8List m=new Uint8List.view(i);String o=IT.JT(m);h.complete(o);}else h.completeError(new CD('request response is not a ByteBuffer'));},onError:(Object s){h.completeError(new CD("Error getting the equation image from the server ${ab} : ${s}"));});return (h.future);}AB KF(sB i){l g=i.createElementNS(pB,nodeName);for(aB h in attributes)g.setAttributeNS(h.pB,h.name,h.value);if(Xb!=null)g.jB(i.wG(Xb));return (g);}}class bG extends n{String bb;String cb;String eb;l fb;l gb;l hb;String ib;String jb;String kb;String lb;String mb;String nb;bool header;bG.xY(l g):super.vX(g){yE();NV();}bG.zY(AB h,n i):super.qX(h,i,createChildren:false){yE();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==ib)ob(g);}for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==jb)ob(g);}ob(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==kb)ob(g);}if(firstChild!=null&&firstChild.firstChild is CG)header=true;}void ob(AB j){for(AB h=j.firstChild;h!=null;h=h.nextSibling){if(h.nodeType==AB.FE&&h.nodeName==bb){n i=new rE.CZ(h,this);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE){if(g.nodeName==cb){n k=new NC.EZ(g,i);i.jB(k);}else if(g.nodeName==eb){n m=new CG.GZ(g,i);i.jB(m);}}}jB(i);}}}void yE(){mM=true;bb=t.CB.bC(DB,'trTag','tr');List<l> g=t.CB.nK(bb);fb=t.CB.fF(DB,g);cb=t.CB.bC(DB,'tdTag','td');List<l> h=t.CB.nK(cb);gb=t.CB.fF(fb,h);eb=t.CB.bC(DB,'thTag','th');List<l> i=t.CB.nK(eb);hb=t.CB.fF(fb,i);jb=t.CB.bC(DB,'tbodyTag','tbody');ib=t.CB.bC(DB,'theadTag','thead');kb=t.CB.bC(DB,'tfootTag','tfoot');lb=t.CB.bC(DB,'colspanAttr',null);mb=t.CB.bC(DB,'rowspanAttr',null);nb=t.CB.bC(DB,'alignAttr',null);header=false;}Element html(){DivElement j=new DivElement();j.id="${id}";j.classes.add('dn');j.classes.add('table');FormElement g=new FormElement();g.classes.add('table_buttons');ButtonElement v=new ButtonElement();v.attributes['type']='button';v.appendText(LB.MB("table.Table"));v.onClick.listen((MouseEvent h)=>JE());v.style.marginRight='1em';g.append(v);ButtonElement BB=new ButtonElement();BB.attributes['type']='button';BB.appendText(LB.MB("table.Row"));BB.onClick.listen((MouseEvent h)=>aW());BB.style.marginRight='0.2em';g.append(BB);ButtonElement EB=new ButtonElement();EB.attributes['type']='button';EB.appendText("+");EB.onClick.listen((MouseEvent h)=>insertRow());EB.style.marginRight='0.2em';g.append(EB);ButtonElement HB=new ButtonElement();HB.attributes['type']='button';HB.appendText("-");HB.onClick.listen((MouseEvent h)=>TW());HB.style.marginRight='1em';g.append(HB);g.appendText(LB.MB('table.Column'));ButtonElement JB=new ButtonElement();JB.attributes['type']='button';JB.appendText("+");JB.onClick.listen((MouseEvent h)=>uV());JB.style.marginRight='0.2em';g.append(JB);ButtonElement QB=new ButtonElement();QB.attributes['type']='button';QB.appendText("-");QB.onClick.listen((MouseEvent h)=>RW());QB.style.marginRight='1em';g.append(QB);ButtonElement SB=new ButtonElement();SB.attributes['type']='button';SB.appendText(LB.MB("table.Cell"));SB.onClick.listen((MouseEvent h)=>FV());SB.style.marginRight='1em';g.append(SB);CheckboxInputElement cB=new CheckboxInputElement();cB.id="header${id}";cB.checked=header;cB.onClick.listen((MouseEvent h)=>rW());g.append(cB);LabelElement hB=new LabelElement();hB.htmlFor="header${id}";hB.appendText(LB.MB('table.header'));hB.style.marginRight='1em';g.append(hB);ButtonElement k=new ButtonElement();k.attributes['type']='button';ImageElement i=new ImageElement();i.src='packages/daxe/images/mergeright.png';k.append(i);k.onClick.listen((MouseEvent h)=>EW());k.style.marginRight='0.2em';k.title=LB.MB('table.merge_right');g.append(k);ButtonElement m=new ButtonElement();m.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/splitx.png';m.append(i);m.onClick.listen((MouseEvent h)=>bS());m.style.marginRight='0.2em';m.title=LB.MB('table.split_x');g.append(m);ButtonElement o=new ButtonElement();o.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/mergebottom.png';o.append(i);o.onClick.listen((MouseEvent h)=>DW());o.style.marginRight='0.2em';o.title=LB.MB('table.merge_bottom');g.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/splity.png';s.append(i);s.onClick.listen((MouseEvent h)=>ZP());s.style.marginRight='0.2em';s.title=LB.MB('table.split_y');g.append(s);j.append(g);TableElement IC=new TableElement();IC.classes.add('indent');n CC=firstChild;while(CC!=null){IC.append(CC.html());CC=CC.nextSibling;}j.append(IC);return (j);}q QE(){if(firstChild==null||firstChild.firstChild==null){return (null);}return (new q(firstChild.firstChild,0));}q SF(){if(lastChild==null||lastChild.lastChild==null){return (null);}return (new q(lastChild.lastChild,lastChild.lastChild.PB));}void NV(){int j=2;int k=2;for(int g=0;g<j;g++ ){rE h=new rE.BZ(fb);for(int i=0;i<k;i++ ){NC m=new NC.DZ(gb);h.jB(m);}jB(h);}}void aW(){rE g=rO();if(g==null)return;g.JE();}void insertRow(){rE h=rO();if(h==null)return;n g=new rE.BZ(fb);for(int i=0;i<eP();i++ ){NC j=new NC.DZ(gb);g.jB(j);}t.insertNode(g,new q(this,ZB(h)+1));IB.KD(g.QE());}void TW(){rE g=rO();if(g==null)return;GB h=new GB.uX(LB.MB('undo.remove'));for(NC i in g.childNodes){if(i.SG>1)ZP(i,h);}h.TB(new GB.rX(g));t.DC(h);}void uV(){NC g=oI();if(g==null)return;GB j=new GB.uX(LB.MB('undo.insert'));int m=lI(g);for(n h in childNodes){NC i;if(firstChild==h&&header)i=new CG.FZ(hb);else i=new NC.DZ(gb);int k=0;for(NC g=h.firstChild;g!=null&&m>=lI(g);g=g.nextSibling){k++ ;}j.TB(new GB.oX(new q(h,k),i));}t.DC(j);IB.KD(new q(g.nextSibling,0));}void RW(){NC g=oI();if(g==null)return;q h;if(g.nextSibling!=null)h=new q(g.nextSibling,0);else if(g.previousSibling!=null)h=new q(g.previousSibling,0);else h=null;GB j=new GB.uX(LB.MB('undo.remove'));int k=lI(g);int i=0;for(n m in childNodes){NC g=TM(k,i);while(g.JG>1){bS(g);g=TM(k,i);}j.TB(new GB.rX(g));i++ ;}t.DC(j);if(h!=null)IB.KD(h);}void FV(){NC g=oI();if(g==null)return;g.JE();}NC oI(){q h=IB.vC();n g=h.u;while(g!=null&&g is!NC)g=g.parent;return (g);}rE rO(){q h=IB.vC();n g=h.u;while(g!=null&&g is!rE)g=g.parent;return (g);}NC TM(int g,int h){return (grid()[g][h]);}int lI(NC j){List<List<NC>> h=grid();for(int g=0;g<h.length;g++ )for(int i=0;i<h[0].length;i++ )if(h[g][i]==j)return (g);assert(false);return (-1);}int oO(NC j){List<List<NC>> h=grid();for(int i=0;i<h.length;i++ )for(int g=0;g<h[0].length;g++ )if(h[i][g]==j)return (g);assert(false);return (-1);}List<List<NC>> grid(){int j=eP();int s=iS();List<List<NC>> h=new List<List<NC>>(j);for(int g=0;g<j;g++ )h[g]=new List<NC>(s);int k=0;for(rE v in childNodes){int g=0;for(NC i in v.childNodes){while(g<j&&h[g][k]!=null)g++ ;for(int m=0;m<i.JG;m++ ){for(int o=0;o<i.SG;o++ ){h[g+m][k+o]=i;}}g+= i.JG;}k++ ;}return (h);}int eP(){int g=0;for(rE i in childNodes){int h=0;for(NC j in i.childNodes){h+= j.JG;}g=max(g,h);}return (g);}int iS(){int g=0;for(rE h in childNodes){NC i=h.firstChild;g+= i.SG;}return (g);}void rW(){rE j=firstChild;if(j==null)return;n g=j.firstChild;while(g!=null){n s=g.nextSibling;if(header&&g is CG){NC k=new NC.DZ(gb);n h=g.firstChild;while(h!=null){n m=h.nextSibling;g.gC(h);k.jB(h);h=m;}for(aB i in g.attributes)k.setAttribute(i.name,i.value);g.replaceWith(k);}else if(!header&&g is NC&&g is!CG){CG o=new CG.FZ(hb);n h=g.firstChild;while(h!=null){n m=h.nextSibling;g.gC(h);o.jB(h);h=m;}for(aB i in g.attributes)o.setAttribute(i.name,i.value);g.replaceWith(o);}g=s;}header=!header;j.sD();}void EW([NC g]){if(g==null)g=oI();if(g==null)return;int m=lI(g);int o=oO(g);int j=m+g.JG;if(j>=eP())return;NC k=TM(j,o);if(k.parent!=g.parent)ZP(k);NC h=g.nextSibling;if(h==null)return;if(h.SG!=g.SG){return;}GB i=new GB.uX(LB.MB('table.merge'));i.TB(new GB.tX(g,new aB(lb,(g.JG+h.JG).toString())));i.TB(new GB.rX(h));t.DC(i);IB.KD(g.QE());IB.LC();}void DW([NC g]){if(g==null)g=oI();if(g==null)return;int k=lI(g);int m=oO(g);int j=m+g.SG;if(j>=iS())return;NC h=TM(k,j);if(h.JG!=g.JG){return;}GB i=new GB.uX(LB.MB('table.merge'));i.TB(new GB.tX(g,new aB(mb,(g.SG+h.SG).toString())));i.TB(new GB.rX(h));t.DC(i);IB.KD(g.QE());IB.LC();}void bS([NC g,GB i]){if(g==null)g=oI();if(g==null)return;if(g.JG<2)return;NC j;if(g is CG)j=new CG.FZ(hb);else j=new NC.DZ(gb);rE k=g.parent;GB h;if(i!=null)h=i;else h=new GB.uX(LB.MB('table.split'));h.TB(new GB.oX(new q(k,k.ZB(g)+1),j));h.TB(new GB.tX(g,new aB(lb,(g.JG-1).toString())));if(i==null)t.DC(h);}void ZP([NC g,GB i]){if(g==null)g=oI();if(g==null)return;if(g.SG<2)return;int m=lI(g);int o=oO(g);int s=o+g.SG-1;rE j=eB(s);if(j==null)return;int k=0;for(NC g=j.firstChild;g!=null&&m>lI(g);g=g.nextSibling){k++ ;}NC v=new NC.DZ(gb);GB h;if(i!=null)h=i;else h=new GB.uX(LB.MB('table.split'));h.TB(new GB.oX(new q(j,k),v));h.TB(new GB.tX(g,new aB(mb,(g.SG-1).toString())));if(i==null)t.DC(h);}bool RE(){return (true);}bool RG(){return (true);}}class MN{static final List<List<String>> VI=[["\u0393","\u0394","\u0398","\u039B","\u039E","\u03A0","\u03A3","\u03A5","\u03A6","\u03A7","\u03A8","\u03A9"],["\u03B1","\u03B2","\u03B3","\u03B4","\u03B5","\u03B6","\u03B7","\u03B8","\u03B9","\u03BA","\u03BB","\u03BC","\u03BD","\u03BE","\u03BF","\u03C0","\u03C1","\u03C2","\u03C3","\u03C4","\u03C5","\u03C6","\u03C7","\u03C8","\u03C9"],["\u03D1","\u03D5","\u03D6"],["\u00AC","\u00B1","\u00D7","\u2113","\u2102","\u2115","\u211A","\u211D","\u2124","\u212B","\u2190","\u2192","\u2194","\u21D0","\u21D2","\u21D4","\u2200","\u2202","\u2203","\u2205","\u2207","\u2208","\u2209","\u2211","\u221D","\u221E","\u2227","\u2228","\u2229","\u222A","\u222B","\u223C","\u2248","\u2260","\u2261","\u2264","\u2265","\u2282"],["\u{1D49C}","\u212C","\u{1D49E}","\u{1D49F}","\u2130","\u2131","\u{1D4A2}","\u210B","\u2110","\u{1D4A5}","\u{1D4A6}","\u2112","\u2133","\u{1D4A9}","\u{1D4AA}","\u{1D4AB}","\u{1D4AC}","\u211B","\u{1D4AE}","\u{1D4AF}","\u{1D4B0}","\u{1D4B1}","\u{1D4B2}","\u{1D4B3}","\u{1D4B4}","\u{1D4B5}"]];static final int NN=13;String RH;GD okfct;TableCellElement kG;MN(this.RH,{this.okfct}){}void show(){DivElement s=new DivElement();s.id='dlg1';s.classes.add('dlg1');DivElement HB=new DivElement();HB.classes.add('dlg2');DivElement JB=new DivElement();JB.classes.add('dlg3');FormElement QB=new FormElement();int cB=0;for(int g=0;g<VI.length;g++ )cB+= (VI[g].length/NN).ceil();TableElement h=new TableElement();h.classes.add('special_dlg');int i=0;for(int g=0;g<VI.length;g++ ){TableRowElement m=new TableRowElement();for(int o=0;o<VI[g].length;o++ ){TableCellElement v=new TableCellElement();v.text=VI[g][o];v.style.textAlign='center';if(RH==VI[g][o]){kG=v;kG.style.border='1px solid black';}m.append(v);i++ ;if(i>=NN){i=0;if(o<VI[g].length-1){h.append(m);m=new TableRowElement();}}}if(i!=0){for(int SB=i;SB<NN;SB++ )m.append(new TableCellElement());i=0;}h.append(m);}h.onClick.listen((MouseEvent j)=>select(j.target));h.onDoubleClick.listen((MouseEvent j){select(j.target);if(kG!=null)iF(null);});QB.append(h);DivElement BB=new DivElement();BB.classes.add('buttons');ButtonElement EB=new ButtonElement();EB.attributes['type']='button';EB.appendText(LB.MB("button.Cancel"));EB.onClick.listen((MouseEvent j)=>cancel());BB.append(EB);ButtonElement k=new ButtonElement();k.id='special_ok';if(RH==null)k.disabled=true;k.attributes['type']='submit';k.appendText(LB.MB("button.OK"));k.onClick.listen((MouseEvent j)=>iF(j));BB.append(k);QB.append(BB);JB.append(QB);HB.append(JB);s.append(HB);document.body.append(s);}void select(EventTarget h){if(h is!Node)return;Node g=h as Node;if(g is TableCellElement){if(kG!=null)kG.style.border='';kG=g;}else if(g.parent is TableCellElement){if(kG!=null)kG.style.border=null;kG=g.parent;}else return;kG.style.border='1px solid black';RH=kG.text;ButtonElement i=querySelector('button#special_ok');i.disabled=false;}void iF(MouseEvent g){querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(okfct!=null)okfct();}void cancel(){querySelector('div#dlg1').remove();IB.AH();}String bV(){return (RH);}}class ON{String pb;String qb;String rb;GD sb;String ab;String Xb;ON(this.ab,String g,{String labelName,String labelValue,GD okfct}){pb=g;qb=labelName;rb=labelValue;sb=okfct;}void show(){DivElement i=new DivElement();i.id='dlg1';i.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement BB=new DivElement();BB.classes.add('dlg3');FormElement h=new FormElement();ImageElement EB=new ImageElement();EB.id='eqimg';EB.src=jR();h.append(EB);TextAreaElement g=new TextAreaElement();g.id='eqtext';if(pb!=null)g.value=pb;g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event j)=>HV());h.append(g);if(qb!=null){DivElement k=new DivElement();SpanElement QB=new SpanElement();QB.text=qb;k.append(QB);k.appendText(' ');TextInputElement HB=new TextInputElement();HB.id='eqlabel';if(rb!=null)HB.value=rb;k.append(HB);h.append(k);}DivElement SB=new DivElement();ButtonElement JB=new ButtonElement();JB.appendText(LB.MB("equation.preview"));JB.onClick.listen((MouseEvent j)=>QW(j));SB.append(JB);h.append(SB);DivElement m=new DivElement();m.classes.add('buttons');ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent j)=>i.remove());m.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent j)=>iF(j));m.append(s);h.append(m);BB.append(h);v.append(BB);i.append(v);document.body.append(i);g.focus();}void iF(MouseEvent g){TextAreaElement h=querySelector('textarea#eqtext');pb=h.value;if(qb!=null){TextInputElement i=querySelector('input#eqlabel');rb=i.value;}querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(sb!=null)sb();}String fB(){return (pb);}void IL(){if(pb=='')return (null);ImageElement g=querySelector('img#eqimg');CanvasElement h=new CanvasElement(width:g.width,height:g.height);CanvasRenderingContext2D i=h.context2D;i.drawImage(g,0,0);String j=h.toDataUrl('image/png');Xb=j.substring('data:image/png;base64,'.length);}String kR(){return (rb);}String jR(){String g=pb;if(g==null||g=='')g='?';return ("${ab}?${Uri.encodeComponent(g)}");}void uW(){ImageElement g=querySelector('img#eqimg');g.src=jR();}void QW(MouseEvent g){g.preventDefault();TextAreaElement h=querySelector('textarea#eqtext');pb=h.value;uW();}void HV(){TextAreaElement h=querySelector('textarea#eqtext');String g=h.value;if(g.length>0&&g.contains('\n')){h.value=g.replaceAll('\n','');iF(null);return;}}}class rE extends n{rE.BZ(l g):super.vX(g){dJ=true;mM=true;}rE.CZ(AB g,n h):super.qX(g,h,createChildren:false){dJ=true;mM=true;NG();}Element html(){TableRowElement g=new TableRowElement();g.attributes['id']="${id}";g.attributes['class']='dn';n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}return (g);}q QE(){if(firstChild==null){return (null);}return (new q(firstChild,0));}q SF(){if(lastChild==null){return (null);}return (new q(lastChild,lastChild.PB));}bool RE(){return (true);}}class NC extends n{NC.DZ(l g):super.vX(g){dJ=true;}NC.EZ(AB g,n h):super.qX(g,h){dJ=true;NG();}Element html(){TableCellElement g=new TableCellElement();g.id="${id}";g.classes.add('dn');if(this is CG)g.classes.add('header');g.attributes['rowspan']=SG.toString();g.attributes['colspan']=JG.toString();if(align!='')g.attributes['align']=align;n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}if(lastChild==null||!lastChild.eC)g.appendText(' ');return (g);}void BF(List<n> h){super.BF(h);TableCellElement g=oB();if(lastChild==null||!lastChild.eC){if(g.lastChild is!Text)g.appendText(' ');}else{if(g.lastChild is Text)g.lastChild.remove();}}int get SG{bG h=parent.parent;String g=getAttribute(h.mb);if(g==null||g=='')return (1);else return (int.parse(g,onError:(String i)=>1));}int get JG{bG h=parent.parent;String g=getAttribute(h.lb);if(g==null||g=='')return (1);else return (int.parse(g,onError:(String i)=>1));}String get align{bG h=parent.parent;String g=getAttribute(h.nb);if(g==null||g=='')return ('');else return (g);}}class sE{GB xH;q start;q end;sE(this.xH,this.start,this.end);}class CG extends NC{CG.FZ(l g):super.DZ(g){}CG.GZ(AB g,n h):super.EZ(g,h){NG();}}class gL implements XL{HashMap<String,String> tb;l ub;HashMap<String,l> vb;HashMap<l,String> wb;gL(l g,HashMap<String,String> h){ub=g;tb=h;xb();}l QM(final String g){return (vb[g]);}List<l> iO(final String g){return ([vb[g]]);}l hG(final l g,final l i){String h;if(g.EC==null)h=g.nodeName;else h=g.localName;return (QM(h));}String cD(final l g){return (wb[g]);}String kI(final l g){return (null);}String PM(final l g){return (null);}String gO(final l g){return (null);}List<String> pK(final l g){return (null);}List<String> kM(final l g){return (null);}bool jO(final l g,final String h){return (true);}List<String> EP(){return (null);}String jG(final String g){return (null);}String KE(){return (null);}List<l> JD(){return (new List.from(wb.keys));}List<l> II(){return (JD());}bool HI(final l g,final l h){return (false);}bool mD(final l g,final l h){return (true);}List<l> XC(final l j){final List<l> h=new List<l>();final List<AB> k=j.getElementsByTagName('SOUS-ELEMENT');for(int g=0;g<k.length;g++ ){final l v=k[g] as l;h.add(vb[v.getAttribute('element')]);}final List<AB> m=j.getElementsByTagName('SOUS-ENSEMBLE');for(int g=0;g<m.length;g++ ){final l BB=m[g] as l;final String EB=BB.getAttribute('ensemble');final List<AB> o=ub.getElementsByTagName('ENSEMBLE');for(int i=0;i<o.length;i++ ){final l s=o[i] as l;if(EB==s.getAttribute('nom'))h.addAll(XC(s));}}return (h);}String ZD(final l m,final bool k,final bool o){final List<l> j=XC(m);final StringBuffer g=new StringBuffer();final int i=j.length;for(int h=0;h<i;h++ ){if(h!=0)g.write('|');if(k)g.write(yb(j[h]));else g.write(cD(j[h]));if(!k)g.write(',');}if(i!=0){String i=g.toString();g.clear();g.write('(');g.write(i);g.write(')*');}return (g.toString());}List<l> fC(final l j){final List<l> i=new List<l>();if(j.nodeName=='ELEMENT'){final List<AB> k=ub.getElementsByTagName('SOUS-ELEMENT');for(int h=0;h<k.length;h++ ){final l m=k[h] as l;if(m.getAttribute('element')==j.getAttribute('nom')){final l g=m.parentNode as l;if(g.nodeName=='ELEMENT')i.add(g);else if(g.nodeName=='ENSEMBLE')i.addAll(fC(g));}}}else if(j.nodeName=='ENSEMBLE'){final String v=j.getAttribute('nom');final List<AB> o=ub.getElementsByTagName('SOUS-ENSEMBLE');for(int h=0;h<o.length;h++ ){final l s=o[h] as l;if(s.getAttribute('ensemble')==v){final l g=s.parentNode as l;if(g.nodeName=='ELEMENT')i.add(g);else if(g.nodeName=='ENSEMBLE')i.addAll(fC(g));}}}return (i);}List<l> fE(final l h){final List<AB> i=h.getElementsByTagName('ATTRIBUT');final List<l> g=new List<l>();for(AB j in i)g.add(j as l);return (g);}String attributeName(final l g){return (g.getAttribute('nom'));}String attributeNamespace(final l g){return (null);}String vG(final l g){return (null);}String eK(final String g){return (null);}bool UO(final l i,final l g){final String h=g.getAttribute('presence');return (h=='obligatoire');}List<String> hI(final l j){final List<AB> g=j.getElementsByTagName('VALEUR');if(g.length==0)return (null);final List<String> i=new List<String>();for(int h=0;h<g.length;h++ ){final l k=g[h] as l;final String m=k.firstChild.nodeValue.trim();i.add(m);}return (i);}List<String> aP(final l g){return (null);}String dF(final l g){return (null);}VO(final l h,final String g){final String j=h.getAttribute('presence');bool k=(j=='obligatoire');if((g==null||g=='')&&k)return (false);final List<String> i=hI(h);if(i!=null)return (i.contains(g));return (true);}bool PE(final l g){final String h=g.getAttribute('texte');return (h=='autorise');}void xb(){vb=new HashMap<String,l>();wb=new HashMap<l,String>();final List<AB> i=ub.getElementsByTagName('ELEMENT');for(int g=0;g<i.length;g++ ){final l h=i[g] as l;final String j=h.getAttribute('nom');vb[j]=h;wb[h]=j;}}String yb(final l h){String g=wb[h];if(tb[g]!=null)return (tb[g]);else return (g);}}class LB{static String LQ="packages/daxe/LocalStrings";static HashMap<String,String> WN=null;static String hL;static const KU='en';static Future<bool> LU(){Completer<bool> i=new Completer<bool>();bQ().then((String k){if(k!=null)hL=k;else hL=KU;String m=hL.split('_')[0];String o="${LQ}_${m}.properties";HttpRequest g=new HttpRequest();g.open("GET",o);g.onLoad.listen((ProgressEvent s){String v=g.responseText;WN=new HashMap<String,String>();List<String> BB=v.split("\n");for(String h in BB){if(h.startsWith('#'))continue;int j=h.indexOf('=');if(j==-1)continue;String EB=h.substring(0,j).trim();String HB=h.substring(j+1).trim();WN[EB]=HB;}i.complete(true);});g.onError.listen((ProgressEvent s){i.completeError("Error when reading the strings in ${LQ}");});g.send();});return (i.future);}static String MB(String g){return (WN[g]);}}class XN implements vB{List<tJ> zb;XN(final l h){zb=new List<tJ>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="documentation"){zb.add(new tJ(g as l));break;}}}String sK(){if(zb==null)return (null);StringBuffer g=new StringBuffer();for(tJ h in zb){if(h.hF()!=null)g.write(h.hF());}return (g.toString());}}class rF implements Exception{final String message;final Exception parentException;const rF([this.message,this.parentException]);String toString(){String g;if(message==null)g='WXSException';else g=message;if(parentException!=null)g="${g} (parent exception: ${parentException})";return (g);}}class qG extends EE implements TD,sC{kC Ac=null;List<DF> Bc;TD Cc=null;List<vB> Dc;String Ec=null;cG Fc=null;l Gc;DG Hc;qG(final l j,final DG k,final YB i){Ic(j);Bc=new List<DF>();Dc=new List<vB>();for(AB g=j.firstChild;g!=null;g=g.nextSibling){if(g is l){String h=g.localName;if(h=="simpleType")Ac=new kC(g as l,this,i);else if(h=="minExclusive")Bc.add(new DF(g as l));else if(h=="minInclusive")Bc.add(new DF(g as l));else if(h=="maxExclusive")Bc.add(new DF(g as l));else if(h=="maxInclusive")Bc.add(new DF(g as l));else if(h=="totalDigits")Bc.add(new DF(g as l));else if(h=="fractionDigits")Bc.add(new DF(g as l));else if(h=="length")Bc.add(new DF(g as l));else if(h=="minLength")Bc.add(new DF(g as l));else if(h=="maxLength")Bc.add(new DF(g as l));else if(h=="enumeration")Bc.add(new DF(g as l));else if(h=="pattern")Bc.add(new DF(g as l));else if(h=="group")Cc=new DE(g as l,this,i);else if(h=="all")Cc=new vJ(g as l,this,i);else if(h=="choice")Cc=new WI(g as l,this,i);else if(h=="sequence")Cc=new XI(g as l,this,i);else if(h=="attribute")Dc.add(new iB(g as l,this,i));else if(h=="attributeGroup")Dc.add(new lD(g as l,this,i));}}if(j.AC("base"))Ec=j.getAttribute("base");Gc=j;this.Hc=k;}void BC(final YB g,final vB h){if(Ac!=null)Ac.BC(g,h);if(Cc!=null)Cc.BC(g,h);for(vB i in Dc){if(i is iB)i.BC(g);else if(i is lD)i.BC(g,h);}if(Ec!=null){final String j=Gc.YD(wB.aE(Ec));Fc=g.XJ(wB.ZE(Ec),j,h);}}List<FB> JD(){final List<FB> g=new List<FB>();if(Cc!=null)g.addAll(Cc.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();if(Cc!=null)g.addAll(Cc.XC());return (g);}List<FB> fC(){if(Hc is DG)return (Hc.fC());else return (new List<FB>());}String ZD(){if(Cc!=null)return (Cc.ZD());return (null);}bool TE(final FB g){if(Cc!=null)return (Cc.TE(g));return (null);}bool mD(final FB g){if(Cc!=null)return (Cc.mD(g));return (null);}List<String> hD(){List<String> g=null;for(DF h in Bc){if(h.qO()=="enumeration"){if(g==null)g=new List<String>();g.add(h.hF());}}return (g);}List<String> LD(){return (hD());}List<iB> attributes(){final List<iB> h=new List<iB>();for(vB i in Dc){if(i is iB)h.add(i);else if(i is lD)h.addAll(i.attributes());}if(Fc is jC){final List<iB> g=(Fc as jC).attributes();final List<iB> m=new List<iB>();for(iB j in h){final String o=j.getName();final bool s=j.yR()=="prohibited";for(iB k in g)if(o==k.getName()){if(s)m.add(k);else g[g.indexOf(k)]=j;break;}}for(iB v in m)g.remove(v);return (g);}return (h);}int VE(final List<FB> h,final int g,final bool i){if(Cc==null)return (g);return (Cc.VE(h,g,i));}bool eD(){if(Cc!=null)return (Cc.eD());return (true);}bool FD(final String h){if(Fc!=null){if(!Fc.FD(h))return (false);}bool i=false;for(final DF g in Bc){if(g.qO()=="enumeration"){if(g.FD(h))return (true);i=true;}else if(g.qO()=="pattern"){if(g.FD(h))return (true);i=true;}else if(!g.FD(h))return (false);}if(i)return (false);return (true);}}class vJ extends EE implements TD,sC{List<FB> Jc;int Kc=1;int Lc=1;sC Hc;vJ(final l h,final sC i,final YB j){Ic(h);Jc=new List<FB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="element")Jc.add(new FB(g as l,this,j));}try {if(h.AC("minOccurs"))Kc=int.parse(h.getAttribute("minOccurs"));}on FormatException {}this.Hc=i;}void BC(final YB g,final vB h){for(FB i in Jc)i.BC(g,h);}List<FB> JD(){final List<FB> g=new List<FB>();for(FB h in Jc)g.addAll(h.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();for(FB h in Jc)g.addAll(h.DH());return (g);}List<FB> fC(){if(Hc!=null)return (Hc.fC());return (new List<FB>());}String ZD(){final StringBuffer g=new StringBuffer();g.write('(');bool h=true;for(FB j in Jc){final String i=j.ZD();if(i!=null){if(!h)g.write(" & ");h=false;g.write(i);}}g.write(')');if(Kc==0)g.write('?');return (g.toString());}bool TE(final FB h){for(FB g in Jc)for(FB i in g.DH())if(i==h)return (Kc>0&&g.sR()>0);return (null);}bool mD(final FB g){for(FB h in Jc)for(FB i in h.DH())if(i==g)return (false);return (null);}int VE(final List<FB> k,final int h,final bool s){if(Jc.length==0)return (h);List<int> i=new List<int>(Jc.length);for(int g=0;g<Jc.length;g++ )i[g]=0;int m=0;for(int g=h;g<k.length;g++ ){final FB v=k[g];bool o=false;for(int j=0;j<Jc.length;j++ ){if(v==Jc[j]){o=true;i[j]++;break;}}if(!o)break;m++ ;}for(int g=0;g<Jc.length;g++ )if(i[g]>1)return (h);if(!s){for(int g=0;g<Jc.length;g++ )if(i[g]==0&&!Jc[g].eD())return (h);}return (h+m);}bool eD(){if(Jc.length==0)return (true);if(Kc==0)return (true);for(FB g in Jc){if(!g.eD())return (false);}return (true);}}class WI extends lL{WI(final l g,final sC h,final YB i){Mc(g,h,i);}int VE(final List<FB> k,final int m,final bool i){int j=0;for(int g=m;g<k.length;){if(j>=Lc)return (g);int h=g;int o=g;for(TD s in Nc){h=s.VE(k,g,i);if(i){if(h>o)o=h;}else{if(h>g)break;}}if(i)h=o;if(h==g){if(!i&&j<Kc)return (m);return (g);}g=h;j++ ;}if(!i&&j<Kc)return (m);return (k.length);}bool eD(){if(Nc.length==0)return (true);if(Kc==0)return (true);for(TD g in Nc){if(g.eD())return (true);}return (false);}}class uJ extends EE{String Oc=null;YB Pc=null;uJ(final l g,final YB h){Ic(g);if(g.AC("schemaLocation"))Oc=g.getAttribute("schemaLocation");}Future Qc(final YB g){Completer h=new Completer();g.GP(Oc,null,g).then((YB g){Pc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}}class jL extends EE implements TD{String Rc="##any";String Sc="strict";int Kc=1;int Lc=1;lL Hc;YB Tc;List<FB> Jc;jL(final l g,final lL h,final YB i){if(g.AC("namespace"))Rc=g.getAttribute("namespace");if(g.AC("processContents"))Sc=g.getAttribute("processContents");try {if(g.AC("minOccurs"))Kc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Lc=9007199254740992;else Lc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}this.Hc=h;this.Tc=i;Jc=null;}void BC(final YB g,final vB i){Jc=new List<FB>();Jc.addAll(g.wU(Rc));for(FB h in Jc)h.NJ(this);}List<FB> JD(){return (new List<FB>());}List<FB> XC(){if(Jc==null)BC(Tc,null);return (Jc);}List<FB> fC(){return (Hc.fC());}String ZD(){if(Jc==null)BC(Tc,null);final StringBuffer g=new StringBuffer();g.write('(');for(int h=0;h<Jc.length;h++ ){g.write(Tc.OD(Jc[h]));if(h!=Jc.length-1)g.write('|');}g.write(')');if(Kc==0&&Lc==1)g.write('?');else if(Kc==0&&Lc>1)g.write('*');else if(Kc>0&&Lc>1)g.write('+');return (g.toString());}bool TE(final FB g){if(Jc==null)BC(Tc,null);if(Jc.contains(g))return (Kc>0&&Jc.length==1);else return (null);}bool mD(final FB g){if(Jc==null)BC(Tc,null);if(Jc.contains(g))return (Lc>1);else return (null);}int VE(final List<FB> i,final int h,final bool j){if(Jc==null)BC(Tc,null);if(!j&&i.length<Kc)return (h);for(int g=h;g<i.length;g++ ){if(g-h>=Lc)return (g);if(!Jc.contains(i[g])){if(!j&&g-h<Kc)return (h);return (g);}}return (i.length);}bool eD(){return (Kc==0);}}class MQ extends YN{MQ(final l g){Mc(g);}}abstract class YN extends EE{ZN Uc=null;List<iL> Vc;String Wc=null;void Mc(final l h){Ic(h);Vc=new List<iL>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="selector")Uc=new ZN(g as l);else if(g.localName=="field")Vc.add(new iL(g as l));}}if(h.AC("name"))Wc=h.getAttribute("name");}}class NQ extends YN{NQ(final l g){Mc(g);}}class OQ extends YN{String Xc=null;OQ(final l g){Mc(g);}}class ZN extends EE{String Yc=null;ZN(final l g){if(g.AC("xpath"))Yc=g.getAttribute("xpath");}}class iL extends EE{String Yc=null;iL(final l g){if(g.AC("xpath"))Yc=g.getAttribute("xpath");}}class sF extends EE implements TD,sC{TD Cc=null;List<vB> Dc;String Ec=null;cG Fc=null;l Gc;DG Hc;sF(final l i,final DG j,final YB h){Ic(i);Dc=new List<vB>();for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="group")Cc=new DE(g as l,this,h);else if(g.localName=="all")Cc=new vJ(g as l,this,h);else if(g.localName=="choice")Cc=new WI(g as l,this,h);else if(g.localName=="sequence")Cc=new XI(g as l,this,h);else if(g.localName=="attribute")Dc.add(new iB(g as l,this,h));else if(g.localName=="attributeGroup")Dc.add(new lD(g as l,this,h));}}if(i.AC("base"))Ec=i.getAttribute("base");Gc=i;this.Hc=j;}void BC(final YB g,final vB i){if(Cc!=null)Cc.BC(g,i);for(vB h in Dc){if(h is iB)h.BC(g);else if(h is lD)h.BC(g,i);}if(Ec!=null){final String j=Gc.YD(wB.aE(Ec));Fc=g.XJ(wB.ZE(Ec),j,i);if(Fc is jC)(Fc as jC).pU(this);}}List<FB> JD(){final List<FB> g=new List<FB>();if(Cc!=null)g.addAll(Cc.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();if(Fc is jC)g.addAll((Fc as jC).XC());if(Cc!=null)g.addAll(Cc.XC());return (g);}List<FB> fC(){if(Hc!=null)return (Hc.fC());else return (new List<FB>());}String ZD(){String g;if(Fc is jC)g=(Fc as jC).ZD();else g=null;String h;if(Cc!=null)h=Cc.ZD();else h=null;if(g==null&&h==null)return ("");else if(g!=null&&h==null)return (g);else if(g==null&&h!=null)return (h);else return ("(${g}, ${h})");}bool TE(final FB i){bool g=null;if(Fc is jC)g=(Fc as jC).TE(i);if(g!=null&&g)return (g);bool h=null;if(Cc!=null)h=Cc.TE(i);if(h!=null&&h)return (h);return (g!=null?g:h);}bool mD(final FB h){bool g=null;if(Fc is jC)g=(Fc as jC).mD(h);if(g!=null&&g)return (g);bool i=null;if(Cc!=null)i=Cc.mD(h);return (g!=null?g:i);}List<String> hD(){if(Fc!=null)return (Fc.hD());else if(Ec!=null)return (wB.sG(Ec,Gc));return (null);}List<String> LD(){if(Fc!=null)return (Fc.LD());else if(Ec!=null)return (wB.sG(Ec,Gc));return (null);}List<iB> attributes(){final List<iB> g=new List<iB>();for(vB h in Dc){if(h is iB)g.add(h);else if(h is lD)g.addAll(h.attributes());}if(Fc is jC){final List<iB> i=(Fc as jC).attributes();final List<iB> j=new List<iB>();for(iB k in g){final String o=k.getName();bool m=false;for(iB s in i)if(o==s.getName()){m=true;break;}if(!m)j.add(k);}i.addAll(j);return (i);}return (g);}int VE(final List<FB> j,final int h,final bool i){int g=h;if(Fc is jC){g=(Fc as jC).VE(j,h,i);if(g==h&&!i&&!(Fc as jC).eD())return (h);}if(Cc!=null){int k=Cc.VE(j,g,i);if(k==g&&!i&&!Cc.eD())return (h);g=k;}return (g);}bool eD(){if(Fc is jC&&!(Fc as jC).eD())return (false);if(Cc!=null)return (Cc.eD());return (true);}bool FD(final String g){if(Fc!=null)return (Fc.FD(g));else if(Ec!=null)return (kC.xJ(wB.ZE(Ec),g));return (false);}}abstract class EE implements vB{XN Zc=null;void Ic(final l h){for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="annotation"){Zc=new XN(g as l);break;}}}String sK(){if(Zc==null)return (null);return (Zc.sK());}}class tJ implements vB{String ac=null;String bc=null;String cc=null;tJ(final l g){if(g.AC("source"))ac=g.getAttribute("source");if(g.AC("xml:lang"))bc=g.getAttribute("xml:lang");if(g.firstChild!=null)cc=g.firstChild.nodeValue;}String hF(){return (cc);}}class kC extends EE implements cG{qG dc=null;aN ec=null;bN fc=null;String Wc=null;sC Hc;YB Tc;kC(final l h,final sC j,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")dc=new qG(g as l,null,i);else if(g.localName=="list")ec=new aN(g as l,i);else if(g.localName=="union")fc=new bN(g as l,i);}}if(h.AC("name"))Wc=h.getAttribute("name");this.Hc=j;this.Tc=i;}String getName(){return (Wc);}String gF(){return (Tc.KE());}sC getParent(){return (Hc);}void BC(final YB g,final vB h){if(dc!=null)dc.BC(g,h);if(ec!=null)ec.BC(g,h);if(fc!=null)fc.BC(g,h);}List<String> hD(){if(dc!=null)return (dc.hD());if(fc!=null)return (fc.hD());return (null);}List<String> LD(){if(dc!=null)return (dc.LD());if(fc!=null)return (fc.LD());return (null);}bool FD(final String g){if(dc!=null)return (dc.FD(g));if(ec!=null)return (ec.FD(g));if(fc!=null)return (fc.FD(g));return (false);}static bool xJ(final String h,final String g){if(h=="string")return (true);else if(h=="normalizedString")return (UC(g,"[^\\t\\r\\n]*"));else if(h=="token"){if(g.indexOf('\n')!=-1||g.indexOf('\r')!=-1||g.indexOf('\t')!=-1||g.indexOf("  ")!=-1)return (false);return (!g.startsWith(" ")&&!g.endsWith(" "));}else if(h=="base64Binary")return (UC(g,"(([a-zA-Z0-9+/=]\\s?){4})*"));else if(h=="hexBinary")return (UC(g,"(([0-9a-fA-F]){2})*"));else if(h=="integer")return (UC(g,"[+\\-]?\\d+"));else if(h=="positiveInteger")return (UC(g,"\\+?0*[1-9]\\d*"));else if(h=="negativeInteger")return (UC(g,"-0*[1-9]\\d*"));else if(h=="nonNegativeInteger")return (UC(g,"(-0+)|(\\+?\\d+)"));else if(h=="nonPositiveInteger")return (UC(g,"(\\+?0+)|(-\\d+)"));else if(h=="long"){if(!UC(g,"[+\\-]?\\d+"))return (false);try {final int m=int.parse(g);final int o=int.parse("9223372036854775807");final int v=int.parse("-9223372036854775808");if(m.compareTo(o)>0)return (false);if(m.compareTo(v)<0)return (false);return (true);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedLong"){if(!UC(g,"\\d+"))return (false);try {final int m=int.parse(g);final int o=int.parse("18446744073709551615");return (m.compareTo(o)<=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="int"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=2147483647&&i>=-2147483648);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedInt"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=4294967295&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="short"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=32767&&i>=-32768);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedShort"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=65535&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="byte"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=127&&i>=-128);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedByte"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=255&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="decimal"){return (UC(g,"[+\\-]?\\d+\\.?\\d*"));}else if(h=="float"){if(!UC(g,"(-?INF)|(NaN)|([+\\-]?\\d+\\.?\\d*([eE][+\\-]?\\d{1,3})?)"))return (false);if(g=="INF"||g=="-INF")return (true);try {double s=double.parse(g);if(log(s.abs())/LN2>127)return (false);if(log(s.abs())/LN2<-126)return (false);return (true);}on FormatException {return (false);}}else if(h=="double"){if(!UC(g,"(-?INF)|(NaN)|([+\\-]?\\d+\\.?\\d*([eE][+\\-]?\\d{1,3})?)"))return (false);if(g=="INF"||g=="-INF")return (true);try {double.parse(g);return (true);}on FormatException {return (false);}}else if(h=="boolean")return (UC(g,"(true)|(false)|1|0"));else if(h=="duration")return (UC(g,"-?P(\\d{1,4}Y)?(\\d{1,2}M)?(\\d{1,2}D)?(T(\\d{1,2}H)?(\\d{1,2}M)?(\\d{1,2}(\\.\\d+)?S)?)?"));else if(h=="dateTime")return (UC(g,"-?\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d(\\.\\d+)?(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="date")return (UC(g,"-?\\d{4}-[01]\\d-[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="time")return (UC(g,"[0-2]\\d:[0-5]\\d:[0-5]\\d(\\.\\d+)?(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gYear")return (UC(g,"-?\\d{4}(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gYearMonth")return (UC(g,"-?\\d{4}-[01]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gMonth")return (UC(g,"--[01]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gMonthDay")return (UC(g,"--[01]\\d-[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gDay")return (UC(g,"---[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="Name")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*"));else if(h=="QName")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*"));else if(h=="NCName")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="anyURI")return (true);else if(h=="language")return (UC(g,"[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*"));else if(h=="ID")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="IDREF")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="IDREFS")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:]*"));else if(h=="ENTITY")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="ENTITIES")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:]*"));else if(h=="NOTATION")return (UC(g,"[^0-9.\\-\\s][^\\s]*(\\s[^0-9.\\-\\s][^\\s]*)*"));else if(h=="NMTOKEN")return (UC(g,"[^<>&#!/?'\",\\s]+"));else if(h=="NMTOKENS")return (UC(g,"[^<>&#!/?'\",]+"));else return (true);}static bool UC(final String g,final String h){final RegExp i=new RegExp("^${h}\$");return (i.hasMatch(g));}}class jC extends EE implements cG,TD,sC{kL gc=null;TD Cc=null;List<vB> Dc;String Wc=null;bool hc=false;bool ic=false;sC Hc;YB Tc;List<FB> jc;List<sF> kc;jC(final l h,final sC j,final YB i){Ic(h);Dc=new List<vB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="simpleContent")gc=new kL(g as l,i);else if(g.localName=="complexContent")Cc=new DG(g as l,this,i);else if(g.localName=="group")Cc=new DE(g as l,this,i);else if(g.localName=="all")Cc=new vJ(g as l,this,i);else if(g.localName=="choice")Cc=new WI(g as l,this,i);else if(g.localName=="sequence")Cc=new XI(g as l,this,i);else if(g.localName=="attribute")Dc.add(new iB(g as l,this,i));else if(g.localName=="attributeGroup")Dc.add(new lD(g as l,this,i));}}if(h.AC("name"))Wc=h.getAttribute("name");if(h.AC("mixed"))hc=h.getAttribute("mixed")=="true"||h.getAttribute("mixed")=="1";if(h.AC("abstract"))ic=h.getAttribute("abstract")=="true"||h.getAttribute("abstract")=="1";this.Hc=j;this.Tc=i;jc=null;kc=null;}kL oV(){return (gc);}String getName(){return (Wc);}bool iV(){return (hc);}String gF(){return (Tc.KE());}sC getParent(){return (Hc);}void BC(final YB g,final vB i){if(gc!=null)gc.BC(g,i);if(Cc!=null)Cc.BC(g,i);for(vB h in Dc){if(h is iB)h.BC(g);else if(h is lD)h.BC(g,i);}}void NJ(final FB g){if(jc==null)jc=new List<FB>();jc.add(g);}void pU(final sF g){if(kc==null)kc=new List<sF>();kc.add(g);}List<FB> JD(){if(Cc!=null)return (Cc.JD());return (new List<FB>());}List<FB> XC(){final List<FB> g=new List<FB>();if(Cc!=null)g.addAll(Cc.XC());return (g);}List<FB> fC(){final List<FB> g=new List<FB>();if(Hc is FB){if(!(Hc as FB).TH())g.add(Hc as FB);final List<FB> h=(Hc as FB).wR();if(h!=null)g.addAll(h);}if(jc!=null){for(FB i in jc){if(!i.TH())g.add(i);final List<FB> h=i.wR();if(h!=null)g.addAll(h);}}if(kc!=null){for(sF j in kc)g.addAll(j.fC());}return (g);}String ZD(){if(Cc!=null)return (Cc.ZD());return (null);}bool TE(final FB g){if(Cc!=null)return (Cc.TE(g));return (null);}bool mD(final FB g){if(Cc!=null)return (Cc.mD(g));return (null);}List<String> hD(){if(gc!=null)return (gc.hD());return (null);}List<String> LD(){if(gc!=null)return (gc.LD());return (null);}List<iB> attributes(){if(gc!=null)return (gc.attributes());else if(Cc is DG)return ((Cc as DG).attributes());final List<iB> h=new List<iB>();for(vB g in Dc){if(g is iB)h.add(g);else if(g is lD)h.addAll(g.attributes());}return (h);}int VE(final List<FB> h,final int g,final bool i){if(gc!=null)return (g);else if(Cc!=null)return (Cc.VE(h,g,i));return (g);}bool eD(){if(gc!=null)return (true);else if(Cc!=null)return (Cc.eD());return (true);}bool FD(final String g){if(gc!=null)return (gc.FD(g));return (g.trim()==''||QJ());}bool QJ(){if(Cc is DG){DG h=Cc as DG;cG g=null;if(h.Cc is sF){sF i=h.Cc as sF;if(i.Cc==null)g=i.Fc;}else{qG j=h.Cc as qG;if(j.Cc==null)g=j.Fc;}if(g is jC)return ((g as jC).QJ());}if(iV())return (true);if(oV()!=null)return (true);return (false);}}class DE extends EE implements TD,sC{TD lc=null;String Wc=null;String mc=null;DE nc=null;int Kc=1;int Lc=1;l Gc;sC Hc;YB Tc;List<DE> jc;DE(final l g,final sC j,final YB i){Ic(g);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l){if(h.localName=="all")lc=new vJ(h as l,this,i);else if(h.localName=="choice")lc=new WI(h as l,this,i);else if(h.localName=="sequence")lc=new XI(h as l,this,i);}}if(g.AC("name"))Wc=g.getAttribute("name");if(g.AC("ref"))mc=g.getAttribute("ref");try {if(g.AC("minOccurs"))Kc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Lc=9007199254740992;else Lc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}Gc=g;this.Hc=j;this.Tc=i;jc=null;}String getName(){if(Wc==null&&nc!=null)return (nc.getName());return (Wc);}String gF(){return (Tc.KE());}sC getParent(){return (Hc);}void BC(final YB g,final vB h){if(lc!=null)lc.BC(g,h);if(mc!=null){final String i=Gc.YD(wB.aE(mc));nc=g.ZW(wB.ZE(mc),i,h);if(nc!=null)nc.NJ(this);else print("Rfrence de groupe introuvable : ${mc}");}}void NJ(final DE g){if(jc==null)jc=new List<DE>();jc.add(g);}List<FB> JD(){if(lc!=null)return (lc.JD());return (new List<FB>());}List<FB> XC(){if(nc!=null)return (nc.XC());if(lc!=null)return (lc.XC());return (new List<FB>());}List<FB> fC(){final List<FB> g=new List<FB>();if(Hc!=null)g.addAll(Hc.fC());if(jc!=null){for(DE h in jc)g.addAll(h.fC());}return (g);}String ZD(){String g;if(nc!=null)g=nc.ZD();else if(lc!=null)g=lc.ZD();else g="()";if(Kc==0&&Lc==1)return ("${g}?");else if(Kc==0&&Lc>1)return ("${g}*");else if(Kc>0&&Lc>1)return ("${g}+");else return (g);}bool TE(final FB g){if(nc!=null)return (nc.TE(g));bool h=null;if(lc!=null)h=lc.TE(g);return (h);}bool mD(final FB g){if(nc!=null)return (nc.mD(g));bool h=null;if(lc!=null)h=lc.mD(g);return (h);}int VE(final List<FB> h,final int k,final bool j){if(!j&&h.length<Kc)return (k);int m=0;for(int g=k;g<h.length;){if(m>=Lc)return (g);int i=g;if(nc!=null)i=nc.VE(h,g,j);else if(lc!=null)i=lc.VE(h,g,j);if(i==g)return (g);g=i;m++ ;}return (h.length);}bool eD(){if(Kc==0)return (true);if(nc!=null)return (nc.eD());if(lc!=null)return (lc.eD());return (true);}}class lD extends EE implements sC{List<vB> Dc;String Wc=null;String mc=null;lD nc=null;l Gc;sC Hc;YB Tc;lD(final l h,final sC j,final YB i){Ic(h);Dc=new List<vB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="attribute")Dc.add(new iB(g as l,this,i));else if(g.localName=="attributeGroup")Dc.add(new lD(g as l,this,i));}}if(h.AC("name"))Wc=h.getAttribute("name");if(h.AC("ref"))mc=h.getAttribute("ref");Gc=h;this.Hc=j;this.Tc=i;}String gF(){return (Tc.KE());}sC getParent(){return (Hc);}void BC(final YB h,final vB j){for(vB g in Dc){if(g is iB)g.BC(h);else if(g is lD)g.BC(h,j);}if(mc!=null){final String k=wB.aE(mc);String i;if(k=="xml")i="http://www.w3.org/XML/1998/namespace";else i=Gc.YD(k);nc=h.XW(wB.ZE(mc),i,j);}}String getName(){if(Wc==null&&nc!=null)return (nc.getName());return (Wc);}List<FB> fC(){if(Hc!=null)return (Hc.fC());return (new List<FB>());}List<iB> attributes(){if(nc!=null)return (nc.attributes());final List<iB> h=new List<iB>();for(vB g in Dc){if(g is iB)h.add(g);else if(g is lD)h.addAll(g.attributes());}return (h);}}class iB extends EE{kC Ac=null;String Wc=null;String mc=null;String oc=null;String qc=null;String rc=null;String sc=null;String tc=null;iB nc=null;l Gc;sC Hc;YB Tc;iB(final l g,final sC j,final YB i){Ic(g);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l&&h.localName=="simpleType"){Ac=new kC(h as l,null,i);break;}}if(g.AC("name"))Wc=g.getAttribute("name");if(g.AC("ref"))mc=g.getAttribute("ref");if(g.AC("type"))oc=g.getAttribute("type");if(g.AC("use"))qc=g.getAttribute("use");if(g.AC("default"))rc=g.getAttribute("default");if(g.AC("fixed"))sc=g.getAttribute("fixed");if(g.AC("form"))tc=g.getAttribute("form");Gc=g;this.Hc=j;this.Tc=i;}void BC(final YB h){if(Ac!=null)Ac.BC(h,null);if(mc!=null){final String i=wB.aE(mc);String g;if(i=="xml")g="http://www.w3.org/XML/1998/namespace";else g=Gc.YD(i);nc=h.YW(wB.ZE(mc),g);if(nc==null)print("WXSAttribute: Rfrence d'attribut introuvable : ${mc}");}if(Ac==null&&oc!=null){final String g=Gc.YD(wB.aE(oc));if(g==null||g!=Gc.pB||h.KE()==null||h.KE()==Gc.pB){final cG j=h.XJ(wB.ZE(oc),g,null);if(j is kC)Ac=j;}}if(Ac==null&&nc!=null)Ac=nc.Ac;}String getName(){if(Wc==null&&nc!=null)return (nc.getName());return (Wc);}String yR(){return (qc);}l OG(){return (Gc);}String gF(){if(mc!=null){final String h=wB.aE(mc);if(h!=null){final String i=Gc.YD(h);if(i!=null)return (i);if(h=="xml")return ("http://www.w3.org/XML/1998/namespace");return (null);}}bool g;if(Tc.qV().contains(this))g=true;else if(tc!=null)g=(tc=="qualified");else g=(Tc.YV()=="qualified");if(g){final String j=Tc.KE();if(j=="")return (null);else return (j);}else return (null);}List<FB> fC(){if(Hc!=null)return (Hc.fC());return (new List<FB>());}List<String> hD(){if(sc!=null){final List<String> g=new List<String>();g.add(sc);return (g);}if(Tc.KE()!=null&&Tc.KE()==Gc.pB&&wB.ZE(oc)=="bool")return (wB.sG(oc,Gc));if(Ac!=null)return (Ac.hD());else if(oc!=null)return (wB.sG(oc,Gc));return (null);}List<String> LD(){if(sc!=null){final List<String> g=new List<String>();g.add(sc);return (g);}if(Tc.KE()!=null&&Tc.KE()==Gc.pB&&wB.ZE(oc)=="bool")return (wB.sG(oc,Gc));if(Ac!=null)return (Ac.LD());else if(oc!=null)return (wB.sG(oc,Gc));return (null);}String defaultValue(){if(rc!=null)return (rc);else if(sc!=null)return (sc);else if(nc!=null)return (nc.defaultValue());return (null);}bool FD(final String g){if(sc!=null)return (sc==g);if((g==null||g=="")&&qc=="required")return (false);if(Ac!=null)return (Ac.FD(g));if(oc!=null){final String h=Gc.YD(wB.aE(oc));if(h!=null&&h==Gc.pB)return (kC.xJ(wB.ZE(oc),g));}if(nc!=null)return (nc.FD(g));if(oc==null)return (true);return (false);}}class aN extends EE{kC Ac=null;String uc=null;l Gc;aN(final l h,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="simpleType"){Ac=new kC(g as l,null,i);break;}}if(h.AC("itemType"))uc=h.getAttribute("itemType");Gc=h;}void BC(final YB g,final vB h){if(Ac!=null)Ac.BC(g,h);if(uc!=null&&Ac==null){final String i=Gc.YD(wB.aE(uc));final cG j=g.XJ(wB.ZE(uc),i,h);if(j is kC)Ac=j;else{final String k=Gc.pB;if(k!=i)uc=null;}}}bool FD(final String g){if(Ac==null&&uc==null)return (false);if(g==null)return (false);final List<String> i=g.trim().split(new RegExp(r"\s+"));for(String h in i){if(Ac!=null){if(!Ac.FD(h))return (false);}else{if(!kC.xJ(wB.ZE(uc),h))return (false);}}return (true);}}class bN extends EE{List<kC> vc;List<String> wc=null;l Gc;List<kC> xc;bN(final l h,final YB i){Ic(h);vc=new List<kC>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="simpleType")vc.add(new kC(g as l,null,i));}if(h.AC("memberTypes"))wc=(h.getAttribute("memberTypes")).split(new RegExp(r"\s+"));Gc=h;xc=null;}void BC(final YB h,final vB i){for(kC o in vc)o.BC(h,i);if(wc!=null){xc=new List<kC>(wc.length);for(int g=0;g<wc.length;g++ ){final String j=wc[g];final String k=Gc.YD(wB.aE(j));final cG m=h.XJ(wB.ZE(j),k,i);if(m is kC)xc[g]=m;else{xc[g]=null;final String s=Gc.pB;if(s!=k)wc[g]=null;}}}}List<String> hD(){final List<String> g=new List<String>();if(wc!=null){for(int h=0;h<wc.length;h++ ){if(xc[h]!=null){final List<String> i=xc[h].hD();if(i==null)return (null);g.addAll(i);}else{final String j=wc[h];final String m=Gc.YD(wB.aE(j));final String o=Gc.pB;if(o==m){final List<String> i=wB.sG(j,Gc);if(i==null)return (null);g.addAll(i);}}}}for(kC s in vc){final List<String> k=s.hD();if(k==null)return (null);g.addAll(k);}if(g.length==0)return (null);return (g);}List<String> LD(){final List<String> g=new List<String>();if(wc!=null){for(int h=0;h<wc.length;h++ ){if(xc[h]!=null){final List<String> i=xc[h].hD();if(i!=null)g.addAll(i);}else{final String j=wc[h];final String m=Gc.YD(wB.aE(j));final String o=Gc.pB;if(o==m){final List<String> i=wB.sG(j,Gc);if(i!=null)g.addAll(i);}}}}for(kC s in vc){final List<String> k=s.hD();if(k!=null)g.addAll(k);}if(g.length==0)return (null);return (g);}bool FD(final String h){if(wc!=null){for(int g=0;g<wc.length;g++ ){if(xc[g]!=null){if(xc[g].FD(h))return (true);}else if(wc[g]!=null){if(kC.xJ(wB.ZE(wc[g]),h))return (true);}}}for(final kC i in vc){if(i.FD(h))return (true);}return (false);}}class YB implements vB{List<uJ> yc;List<wJ> zc;List<rG> Ad;LinkedHashMap<String,kC> vc;LinkedHashMap<String,jC> Bd;LinkedHashMap<String,DE> Cd;LinkedHashMap<String,lD> Dd;LinkedHashMap<String,FB> Jc;LinkedHashMap<String,iB> Ed;String Fd=null;String Gd=null;String Hd=null;String Id;wB Jd;List<YB> Kd;YB Ld;HashMap<String,String> Md;YB(final l h,final String JB,final wB QB,final YB SB){this.Id=JB;this.Jd=QB;this.Ld=SB;yc=new List<uJ>();zc=new List<wJ>();Ad=new List<rG>();vc=new LinkedHashMap<String,kC>();Bd=new LinkedHashMap<String,jC>();Cd=new LinkedHashMap<String,DE>();Dd=new LinkedHashMap<String,lD>();Jc=new LinkedHashMap<String,FB>();Ed=new LinkedHashMap<String,iB>();Kd=new List<YB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){String i=g.localName;if(i=="include")yc.add(new uJ(g as l,this));else if(i=="import")zc.add(new wJ(g as l,this));else if(i=="redefine"){final rG BB=new rG(g as l,this);Ad.add(BB);for(vB j in BB.lV()){if(j is kC){final kC k=j;vc[k.getName()]=k;}else if(j is jC){final jC m=j;Bd[m.getName()]=m;}else if(j is DE){final DE o=j;Cd[o.getName()]=o;}else if(j is lD){final lD s=j;Dd[s.getName()]=s;}}}else if(i=="simpleType"){final kC k=new kC(g as l,null,this);vc[k.getName()]=k;}else if(i=="complexType"){final jC m=new jC(g as l,null,this);Bd[m.getName()]=m;}else if(i=="group"){final DE o=new DE(g as l,null,this);Cd[o.getName()]=o;}else if(i=="attributeGroup"){final lD s=new lD(g as l,null,this);Dd[s.getName()]=s;}else if(i=="element"){final FB EB=new FB(g as l,null,this);Jc[EB.getName()]=EB;}else if(i=="attribute"){final iB HB=new iB(g as l,null,this);Ed[HB.getName()]=HB;}}}if(h.AC("targetNamespace")){Fd=h.getAttribute("targetNamespace");if(Fd=="")Fd=null;}if(h.AC("attributeFormDefault"))Gd=h.getAttribute("attributeFormDefault");if(h.AC("elementFormDefault"))Hd=h.getAttribute("elementFormDefault");Md=new HashMap<String,String>();if(h.attributes!=null){for(lC v in h.attributes.values){if(v.name.startsWith("xmlns:")){final String cB=v.name.substring(6);Md[v.value]=cB;}}}}Future Qc(){List<Future> g=new List<Future>();for(uJ h in yc)g.add(h.Qc(this));for(wJ i in zc)g.add(i.Qc(this));for(rG j in Ad)g.add(j.Qc(this));return (Future.wait(g));}Iterable<FB> sO(){return (Jc.values);}Iterable<iB> qV(){return (Ed.values);}String KE(){return (Fd);}String YV(){return (Gd);}String cV(){return (Hd);}String rV(){return (Id);}Future<YB> GP(final String i,final String j,final YB k){Completer h=new Completer();Jd.Nd(Id,i,j,k).then((YB g){if(g!=null&&!Kd.contains(g))Kd.add(g);h.complete(g);},onError:(rF m){h.completeError(m);});return (h.future);}void Od(){for(kC g in vc.values)g.BC(this,g.getParent() is rG?g:null);for(jC h in Bd.values)h.BC(this,h.getParent() is rG?h:null);for(DE i in Cd.values)i.BC(this,i.getParent() is rG?i:null);for(lD j in Dd.values)j.BC(this,j.getParent() is rG?j:null);for(FB k in Jc.values)k.BC(this,null);for(iB m in Ed.values)m.BC(this);}String jG(final String g){return (Md[g]);}String PW(final String g){if(g==null)return (null);for(String h in Md.keys){if(g==Md[h])return (h);}return (null);}List<FB> JD(){final List<FB> g=new List<FB>();for(jC h in Bd.values)g.addAll(h.JD());for(DE i in Cd.values)g.addAll(i.JD());for(FB j in Jc.values)g.addAll(j.JD());return (g);}List<FB> wU(final String g){return (Jd.Pd(g,Fd));}FB WS(final String g,final String h){return (Qd(g,h,null,null,'WXSElement') as FB);}cG XJ(final String g,final String h,final vB i){return (Qd(g,h,null,i,'WXSType') as cG);}DE ZW(final String g,final String h,final vB i){return (Qd(g,h,null,i,'WXSGroup') as DE);}lD XW(final String g,final String h,final vB i){return (Qd(g,h,null,i,'WXSAttributeGroup') as lD);}iB YW(final String g,final String h){return (Qd(g,h,null,null,'WXSAttribute') as iB);}vB Qd(final String i,final String m,final HashSet<YB> j,final vB o,final String k){if(i==null)return (null);HashSet<YB> h=null;if(Ld!=null&&(j==null||!j.contains(Ld))){if(h==null){if(j==null)h=new HashSet<YB>();else h=j;h.add(this);}final vB g=Ld.Qd(i,m,h,o,k);if(g!=null)return (g);}if((m==null&&Fd==null)||(m!=null&&m==Fd)){vB g;if(k=='WXSElement')g=Jc[i];else if(k=='WXSType'){g=Bd[i];if(g!=null&&g!=o)return (g);g=vc[i];}else if(k=='WXSGroup')g=Cd[i];else if(k=='WXSAttributeGroup')g=Dd[i];else if(k=='WXSAttribute')g=Ed[i];else g=null;if(g!=null&&g!=o)return (g);}for(YB s in Kd){if(j==null||!j.contains(s)){if(h==null){if(j==null)h=new HashSet<YB>();else h=j;h.add(this);}final vB g=s.Qd(i,m,h,o,k);if(g!=null)return (g);}}return (null);}String OD(final FB g){return (Jd.Rd(g));}}abstract class vB{}class kL extends EE{qG dc=null;sF Sd=null;kL(final l h,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")dc=new qG(g as l,null,i);else if(g.localName=="extension")Sd=new sF(g as l,null,i);}}}void BC(final YB g,final vB h){if(dc!=null)dc.BC(g,h);else if(Sd!=null)Sd.BC(g,h);}List<String> hD(){if(dc!=null)return (dc.hD());else if(Sd!=null)return (Sd.hD());return (null);}List<String> LD(){if(dc!=null)return (dc.LD());else if(Sd!=null)return (Sd.LD());return (null);}List<iB> attributes(){if(dc!=null)return (dc.attributes());else if(Sd!=null)return (Sd.attributes());return (new List<iB>());}bool FD(final String g){if(dc!=null)return (dc.FD(g));if(Sd!=null)return (Sd.FD(g));return (false);}}class DG extends EE implements TD,sC{TD Cc=null;bool hc=null;jC Hc;DG(final l h,final jC j,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")Cc=new qG(g as l,this,i);else if(g.localName=="extension")Cc=new sF(g as l,this,i);}}if(h.AC("mixed"))hc=(h.getAttribute("mixed")=="true"||h.getAttribute("mixed")=="1");this.Hc=j;}void BC(final YB g,final vB h){if(Cc!=null)Cc.BC(g,h);}List<FB> JD(){if(Cc!=null)return (Cc.JD());return (new List<FB>());}List<FB> XC(){if(Cc!=null)return (Cc.XC());return (new List<FB>());}String ZD(){if(Cc!=null)return (Cc.ZD());return (null);}bool TE(final FB g){if(Cc!=null)return (Cc.TE(g));return (null);}bool mD(final FB g){if(Cc!=null)return (Cc.mD(g));return (null);}List<iB> attributes(){if(Cc is qG)return ((Cc as qG).attributes());else if(Cc is sF)return ((Cc as sF).attributes());return (new List<iB>());}List<FB> fC(){return (Hc.fC());}int VE(final List<FB> h,final int g,final bool i){if(Cc!=null)return (Cc.VE(h,g,i));return (g);}bool eD(){if(Cc!=null)return (Cc.eD());return (true);}}class DF extends EE{String Td;String cc=null;bool sc=false;int Ud=0;DF(final l h){Ic(h);Td=h.localName;if(h.AC("value")){cc=h.getAttribute("value");Ud=int.parse(cc,onError:(String i)=>0);if(Td=="pattern"){cc=cc.replaceAll("\\i","[^<>&#!/?'\",0-9.\\-\\s]");cc=cc.replaceAll("\\I","[^a-zA-Z]");cc=cc.replaceAll("\\c","[^<>&#!/?'\",\\s]");cc=cc.replaceAll("\\C","\\W");cc=cc.replaceAll("\$","\\\$");for(int g=0;g<cc.length;g++ ){if(cc[g]=='^'&&(g==0||(cc[g-1]!='['||(g>1&&cc[g-2]=='\\')))){cc=cc.substring(0,g)+"\\^"+cc.substring(g+1);g++ ;}}}}if(h.AC("fixed"))sc=h.getAttribute("fixed")=="true"||h.getAttribute("fixed")=="1";}String qO(){return (Td);}String hF(){return (cc);}bool FD(final String g){if(Td=="minExclusive"){try {final double i=double.parse(g);return (i>Ud);}on FormatException {return (false);}}else if(Td=="minInclusive"){try {final double i=double.parse(g);return (i>=Ud);}on FormatException {return (false);}}else if(Td=="maxExclusive"){try {final double i=double.parse(g);return (i<Ud);}on FormatException {return (false);}}else if(Td=="maxInclusive"){try {final double i=double.parse(g);return (i<=Ud);}on FormatException {return (false);}}else if(Td=="totalDigits"){int j=0;for(int h=0;h<g.length;h++ )if(g[h].compareTo('0')>=0&&g[h].compareTo('9')<=0)j++ ;return (j<=Ud);}else if(Td=="fractionDigits"){int j=0;bool k=false;for(int h=0;h<g.length;h++ ){if(!k){if(g[h]=='.')k=true;}else if(g[h].compareTo('0')>=0&&g[h].compareTo('9')<=0)j++ ;}return (j<=Ud);}else if(Td=="length")return (g.length==Ud);else if(Td=="minLength")return (g.length>=Ud);else if(Td=="maxLength")return (g.length<=Ud);else if(Td=="enumeration"){return (cc!=null&&cc==g);}else if(Td=="whiteSpace"){return (true);}else if(Td=="pattern"){return (kC.UC(g,cc));}else return (true);}}class rG implements vB,sC{List<vB> Vd;String Oc=null;YB Pc=null;YB Tc;rG(final l i,final YB h){Vd=new List<vB>();for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="simpleType")Vd.add(new kC(g as l,this,h));else if(g.localName=="complexType")Vd.add(new jC(g as l,this,h));else if(g.localName=="group")Vd.add(new DE(g as l,this,h));else if(g.localName=="attributeGroup")Vd.add(new lD(g as l,this,h));}}if(i.AC("schemaLocation"))Oc=i.getAttribute("schemaLocation");this.Tc=h;}Future Qc(final YB g){Completer h=new Completer();g.GP(Oc,null,g).then((YB g){Pc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}List<vB> lV(){return (Vd);}List<FB> fC(){return (new List<FB>());}String gF(){return (Tc.KE());}}class FB extends EE implements TD,sC{kC Ac=null;jC Wd=null;List<vB> Xd;String Wc=null;String mc=null;String oc=null;String Yd=null;int Kc=1;int Lc=1;String rc=null;String sc=null;bool ic=false;String tc=null;FB nc=null;FB Zd=null;l Gc;sC Hc;YB Tc;List<vB> jc;List<FB> ad;List<FB> bd;List<FB> cd;FB(final l g,final sC j,final YB i){Ic(g);Xd=new List<vB>();for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l){if(h.localName=="simpleType")Ac=new kC(h as l,this,i);else if(h.localName=="complexType")Wd=new jC(h as l,this,i);else if(h.localName=="unique")Xd.add(new MQ(h as l));else if(h.localName=="key")Xd.add(new NQ(h as l));else if(h.localName=="keyref")Xd.add(new OQ(h as l));}}if(g.AC("name"))Wc=g.getAttribute("name");if(g.AC("ref"))mc=g.getAttribute("ref");if(g.AC("type"))oc=g.getAttribute("type");if(g.AC("substitutionGroup"))Yd=g.getAttribute("substitutionGroup");try {if(g.AC("minOccurs"))Kc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Lc=9007199254740992;else Lc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}if(g.AC("default"))rc=g.getAttribute("default");if(g.AC("fixed"))sc=g.getAttribute("fixed");if(g.AC("abstract"))ic=g.getAttribute("abstract")=="true"||g.getAttribute("abstract")=="1";if(g.AC("form"))tc=g.getAttribute("form");Gc=g;this.Hc=j;this.Tc=i;jc=null;ad=null;cd=null;bd=null;}String getName(){if(Wc==null&&nc!=null)return (nc.getName());return (Wc);}String AI(){return (mc);}int sR(){return (Kc);}int hV(){return (Lc);}bool TH(){return (ic);}l OG(){return (Gc);}String gF(){bool g;if(Tc.sO().contains(this))g=true;else if(tc!=null)g=tc=="qualified";else g=Tc.cV()=="qualified";if(g)return (Tc.KE());else return (null);}sC getParent(){return (Hc);}void BC(final YB h,final vB j){if(Ac!=null)Ac.BC(h,null);if(Wd!=null)Wd.BC(h,j);if(mc!=null){final String g=Gc.YD(wB.aE(mc));nc=h.WS(wB.ZE(mc),g);if(nc!=null)nc.NJ(this);else print("Element reference not found : ${mc} (namespace: ${g})");}if(Wd==null&&Ac==null&&oc!=null){final String g=Gc.YD(wB.aE(oc));final cG i=h.XJ(wB.ZE(oc),g,j);if(i is jC){Wd=i;Wd.NJ(this);}else if(i is kC)Ac=i;}if(Yd!=null){final String g=Gc.YD(wB.aE(Yd));Zd=h.WS(wB.ZE(Yd),g);Zd.sU(this);}}void NJ(final vB g){if(jc==null)jc=new List<vB>();jc.add(g);}void sU(final FB g){if(ad==null)ad=new List<FB>();ad.add(g);}List<FB> wR(){return (ad);}List<FB> JD(){final List<FB> g=new List<FB>();g.add(this);if(Wd!=null)g.addAll(Wd.JD());return (g);}List<FB> DH(){if(bd!=null)return (bd);bd=new List<FB>();if(!ic&&Wc!=null)bd.add(this);if(nc!=null)bd.addAll(nc.DH());if(ad!=null)for(FB g in ad)bd.addAll(g.DH());return (bd);}List<FB> XC(){if(cd!=null)return (cd);final LinkedHashSet<FB> g=new LinkedHashSet<FB>();if(nc!=null)g.addAll(nc.XC());else if(Wd!=null)g.addAll(Wd.XC());else if(Ac==null&&oc==null&&Zd!=null)g.addAll(Zd.XC());cd=new List.from(g);return (cd);}List<FB> fC(){final LinkedHashSet<FB> g=new LinkedHashSet<FB>();if(Hc!=null)g.addAll(Hc.fC());if(jc!=null){for(vB h in jc){if(h is FB)g.addAll(h.fC());else if(h is jL)g.addAll(h.fC());}}if(Zd!=null)g.addAll(Zd.fC());return (new List.from(g));}String eR(){if(Wd==null&&Ac==null&&oc==null&&Zd!=null)return (Zd.eR());if(Wd==null)return (null);return (Wd.ZD());}String ZD(){final List<FB> h=DH();if(h.length==0)return (null);final StringBuffer g=new StringBuffer();if(h.length>1)g.write('(');for(int i=0;i<h.length;i++ ){final FB j=h[i];g.write(Tc.OD(j));if(i!=h.length-1)g.write('|');}if(h.length>1)g.write(')');if(Kc==0&&Lc==1)g.write('?');else if(Kc==0&&Lc>1)g.write('*');else if(Kc>0&&Lc>1)g.write('+');return (g.toString());}bool TE(final FB g){if(Wd==null&&Ac==null&&oc==null&&Zd!=null)return (Zd.TE(g));if(Wd==null)return (null);return (Wd.TE(g));}bool mD(final FB g){if(Wd==null&&Ac==null&&oc==null&&Zd!=null)return (Zd.mD(g));if(Wd==null)return (null);return (Wd.mD(g));}List<String> hD(){if(sc!=null){final List<String> g=new List<String>();g.add(sc);return (g);}if(Ac!=null)return (Ac.hD());else if(Wd!=null)return (Wd.hD());else if(oc!=null)return (wB.sG(oc,Gc));else if(Ac==null&&Zd!=null)return (Zd.hD());return (null);}List<String> LD(){if(sc!=null){final List<String> g=new List<String>();g.add(sc);return (g);}if(Ac!=null)return (Ac.LD());else if(Wd!=null)return (Wd.LD());else if(oc!=null)return (wB.sG(oc,Gc));else if(Ac==null&&Zd!=null)return (Zd.LD());return (null);}List<iB> attributes(){if(nc!=null)return (nc.attributes());if(Wd!=null)return (Wd.attributes());else if(Ac==null&&oc==null&&Zd!=null)return (Zd.attributes());return (new List<iB>());}bool QJ(){if(oc!=null){final String h=Gc.YD(wB.aE(oc));final String g=Gc.pB;if(g!=Tc.KE()&&g==h)return (true);}if(Wd!=null)return (Wd.QJ());if(Ac!=null)return (true);if(Wd==null&&oc==null&&Zd!=null)return (Zd.QJ());return (false);}bool gS(final List<FB> g,final bool h){if(Wd==null){if(Ac==null&&oc==null&&Zd!=null)return (Zd.gS(g,h));return (g.length==0);}if(g.length==0){if(h)return (true);if(Wd.eD())return (true);}final int i=Wd.VE(g,0,h);return (i>0&&i==g.length);}int VE(final List<FB> j,final int i,final bool k){int g=0;final List<FB> o=DH();for(int h=i;h<j.length;h++ ){if(g>=Lc)return (h);bool m=false;for(FB s in o)if(s==j[h])m=true;if(!m){if(!k&&g<Kc)return (i);return (h);}g++ ;}if(!k&&g<Kc)return (i);return (i+g);}bool eD(){return (Kc==0);}bool FD(final String g){if(sc!=null)return (sc==g);if(Ac!=null)return (Ac.FD(g));if(Wd!=null)return (Wd.FD(g));if(oc!=null){final String h=Gc.YD(wB.aE(oc));if(h!=null&&h==Gc.pB)return (kC.xJ(wB.ZE(oc),g));return (false);}else return (true);}}class wJ extends EE{String Rc=null;String Oc=null;YB Pc=null;wJ(final l g,final YB h){if(g.AC("namespace"))Rc=g.getAttribute("namespace");if(g.AC("schemaLocation"))Oc=g.getAttribute("schemaLocation");}Future Qc(final YB g){if(Oc==null)return (new Future.value(null));Completer h=new Completer();g.GP(Oc,Rc,g).then((YB g){Pc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}}class XI extends lL{XI(final l g,final sC h,final YB i){Mc(g,h,i);}int VE(final List<FB> j,final int k,final bool m){int i=0;for(int g=k;g<j.length;){if(i>=Lc)return (g);int h=g;for(TD o in Nc){int s=o.VE(j,h,m);if(s==h){if(!m&&!o.eD()){if(i<Kc)return (k);return (g);}}h=s;}if(h==g)return (g);g=h;i++ ;}if(!m&&i<Kc)return (k);return (j.length);}bool eD(){if(Kc==0)return (true);for(TD g in Nc){if(!g.eD())return (false);}return (true);}}abstract class cG{String getName();String gF();sC getParent();void BC(final YB g,final vB h);List<String> hD();List<String> LD();bool FD(final String g);}abstract class lL extends EE implements TD,sC{List<TD> Nc;int Kc=1;int Lc=1;sC Hc;void Mc(final l h,final sC j,final YB i){Ic(h);Nc=new List<TD>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="element")Nc.add(new FB(g as l,this,i));else if(g.localName=="group")Nc.add(new DE(g as l,this,i));else if(g.localName=="choice")Nc.add(new WI(g as l,this,i));else if(g.localName=="sequence")Nc.add(new XI(g as l,this,i));else if(g.localName=="any")Nc.add(new jL(g as l,this,i));}}try {if(h.AC("minOccurs"))Kc=int.parse(h.getAttribute("minOccurs"));if(h.AC("maxOccurs")){if(h.getAttribute("maxOccurs")=="unbounded")Lc=9007199254740992;else Lc=int.parse(h.getAttribute("maxOccurs"));}}on FormatException {}this.Hc=j;}void BC(final YB h,final vB i){for(TD g in Nc)if(!(g is jL))g.BC(h,i);}List<FB> JD(){final List<FB> g=new List<FB>();for(TD h in Nc)g.addAll(h.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();for(TD h in Nc){if(h is FB)g.addAll(h.DH());else g.addAll(h.XC());}return (g);}List<FB> fC(){if(Hc!=null)return (Hc.fC());return (new List<FB>());}String ZD(){if(Nc.length==0)return (null);final String k=(this is WI)?"|":", ";StringBuffer g=new StringBuffer();if(Nc.length>1||Kc!=1||Lc!=1)g.write('(');bool i=true;for(TD m in Nc){final String j=m.ZD();if(j!=null){if(!i)g.write(k);i=false;g.write(j);}}if(Nc.length>1||Kc!=1||Lc!=1)g.write(')');if(Nc.length==1&&g.length>2){String h=g.toString();if(h.substring(0,2)=="(("&&h.substring(g.length-2,g.length)=="))"){g=new StringBuffer(h.substring(1,h.length-1));}}if(Kc==0&&Lc==1)g.write('?');else if(Kc==0&&Lc>1)g.write('*');else if(Kc>0&&Lc>1)g.write('+');return (g.toString());}bool TE(final FB h){for(TD g in Nc){if(g is FB){for(FB j in g.DH())if(j==h)return ((this is XI||Nc.length==1)&&Kc!=0&&g.sR()!=0);}else{bool i=g.TE(h);if(i!=null)return (i);}}return (null);}bool mD(final FB i){for(TD h in Nc){if(h is FB){for(FB j in h.DH())if(j==i)return (h.hV()>1||Lc>1);}else{bool g=h.mD(i);if(g!=null&&!g&&Lc>1)g=true;if(g!=null)return (g);}}return (null);}}class wB implements XL{YB Tc;final HashMap<l,FB> dd=new HashMap<l,FB>();final HashMap<l,iB> ed=new HashMap<l,iB>();final HashMap<String,List<FB>> fd=new HashMap<String,List<FB>>();HashMap<String,String> Md;final LinkedHashSet<FB> gd=new LinkedHashSet<FB>();Set<YB> Kd;HashMap<String,String> hd;wB(HashMap<String,String> g){this.hd=g;Kd=new HashSet<YB>();Md=new HashMap<String,String>();}Future load(final String k){Completer i=new Completer();PQ(k).then((l s){Tc=new YB(s,k,this,null);jd(Tc,null,null);Kd.add(Tc);Tc.Qc().then((BB){for(final YB j in Kd)gd.addAll(j.JD());for(final YB j in Kd)j.Od();for(FB g in gd){dd[g.OG()]=g;if(g.getName()!=null&&g.AI()==null){List<FB> h=fd[g.getName()];if(h==null){h=new List<FB>();fd[g.getName()]=h;}h.add(g);}}for(FB g in gd){final List<iB> m=g.attributes();if(m!=null){for(iB o in m)ed[o.OG()]=o;}}i.complete();});},onError:(rF v){i.completeError(v);});return (i.future);}l QM(final String h){final List<FB> g=fd[h];if(g==null)return (null);return (g[0].OG());}List<l> iO(final String i){final List<FB> g=fd[i];if(g==null)return (null);List<l> h=new List<l>();for(FB j in g)h.add(j.OG());return (h);}l hG(final l g,final l j){if(j==null){String h;if(g.EC==null)h=g.nodeName;else h=g.localName;final String o=g.pB;for(final YB s in Kd){for(final FB i in s.sO()){if(i.AI()==null&&!i.TH()&&h==i.getName()&&o==i.gF())return (i.OG());}}print("DaxeWXS: elementReference: no matching root element in the schema for ${h}");return (null);}final FB m=dd[j];if(m==null){print("DaxeWXS: elementReference: unknown element reference: ${j}");return (null);}final List<FB> v=m.XC();final String h=g.localName;final String BB=g.pB;for(final FB k in v){if(k.getName()==h&&k.gF()==BB)return (k.OG());}return (null);}String cD(final l g){final FB h=dd[g];if(h==null){print("DaxeWXS: elementName: unknown element reference: ${g}");return (null);}return (h.getName());}String kI(final l h){final FB g=dd[h];if(g==null)return (null);return (g.gF());}String PM(final l h){final String g=kI(h);if(g==null)return (null);return (Md[g]);}String gO(final l i){final FB g=dd[i];if(g==null)return (null);String h=g.sK();if(h!=null)return (h);if(g.Wd!=null)return (g.Wd.sK());return (null);}List<String> pK(final l h){final FB g=dd[h];if(g==null)return (null);return (g.hD());}List<String> kM(final l h){final FB g=dd[h];if(g==null)return (null);return (g.LD());}bool jO(final l h,final String i){final FB g=dd[h];if(g==null)return (false);return (g.FD(i));}List<String> EP(){final LinkedHashSet<String> g=new LinkedHashSet<String>();if(Tc.KE()!=null)g.add(Tc.KE());for(final String h in Md.keys)g.add(h);return (new List.from(g));}String jG(final String g){return (Md[g]);}String KE(){return (Tc.KE());}List<l> JD(){final List<l> h=new List<l>();for(final FB g in gd){if(g.getName()!=null&&g.AI()==null&&!g.TH())h.add(g.OG());}return (h);}List<l> II(){final List<l> h=new List<l>();for(final YB i in Kd){for(final FB g in i.sO()){if(g.getName()!=null&&g.AI()==null&&!g.TH())h.add(g.OG());}}return (h);}bool HI(final l g,final l h){final FB i=dd[g];if(i==null){print("DaxeWXS: requiredElement: unknown element reference: ${g}");return (false);}final FB j=dd[h];if(j==null){print("DaxeWXS: requiredElement: unknown element reference: ${h}");return (false);}bool k=i.TE(j);return (k!=null&&k);}bool mD(final l g,final l h){final FB i=dd[g];if(i==null){print("DaxeWXS: multipleChildren: unknown element reference: ${g}");return (false);}final FB j=dd[h];if(j==null){print("DaxeWXS: multipleChildren: unknown element reference: ${h}");return (false);}bool k=i.mD(j);return (k!=null&&k);}List<l> XC(final l g){assert(g!=null);final FB h=dd[g];if(h==null){print("DaxeWXS: subElements: unknown element reference: ${g}");return (null);}final List<FB> j=h.XC();final List<l> i=new List<l>();for(FB k in j)i.add(k.OG());return (i);}String ZD(final l g,final bool i,final bool j){final FB h=dd[g];if(h==null){print("DaxeWXS: regularExpression: unknown element reference: ${g}");return (null);}return (h.eR());}List<l> fC(final l g){final FB h=dd[g];if(h==null){print("DaxeWXS: parentElements: unknown element reference: ${g}");return (null);}final List<FB> j=h.fC();final List<l> i=new List<l>();for(FB k in j)i.add(k.OG());return (i);}List<l> fE(final l g){final FB h=dd[g];if(h==null){print("DaxeWXS: elementAttributes: unknown element reference: ${g}");return (null);}final List<iB> j=h.attributes();final List<l> i=new List<l>();for(iB k in j)i.add(k.OG());return (i);}String attributeName(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: attributeName: unknown attribute reference: ${g}");return (null);}return (h.getName());}String attributeNamespace(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: attributeNamespace: unknown attribute reference: ${g}");return (null);}return (h.gF());}String vG(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: attributeDocumentation: unknown attribute reference: ${g}");return (null);}return (h.sK());}String eK(final String h){if(h==null)return (null);final String g=aE(h);if(g==null)return (null);if(g=="xml")return ("http://www.w3.org/XML/1998/namespace");return (Tc.PW(g));}bool vV(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: isRequired: unknown attribute reference: ${g}");return (false);}return (h.yR()=="required");}bool UO(final l h,final l g){return (vV(g));}List<String> hI(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: attributeValues: unknown attribute reference: ${g}");return (null);}return (h.hD());}List<String> aP(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: suggestedAttributeValues: unknown attribute reference: ${g}");return (null);}return (h.LD());}String dF(final l g){final iB h=ed[g];if(h==null){print("DaxeWXS: defaultAttributeValue: unknown attribute reference: ${g}");return (null);}return (h.defaultValue());}bool VO(final l g,final String i){final iB h=ed[g];if(h==null){print("DaxeWXS: attributeIsValid: unknown attribute reference: ${g}");return (false);}return (h.FD(i));}bool PE(final l g){final FB h=dd[g];if(h==null){print("DaxeWXS: canContainText: unknown element reference: ${g}");return (false);}return (h.QJ());}bool fS(final l g,final List<l> k,final bool m){final FB h=dd[g];if(h==null){print("DaxeWXS: validElement: unknown element reference: ${g}");return (false);}final List<FB> i=new List<FB>();for(l o in k){final FB j=dd[o];if(j!=null)i.add(j);}return (h.gS(i,m));}Future<YB> Nd(final String v,final String h,final String s,final YB k){String g;if(h.startsWith("http"))g=h;else g="${MU(v)}/${h}";if(g==null)return (new Future.error(new rF("include/import : location not found : ${h}")));for(YB m in Kd){if(kd(m.rV())==kd(g)){jd(m,k,s);return (new Future.value(m));}}Completer<YB> i=new Completer<YB>();PQ(g).then((l BB){final YB j=new YB(BB,g,this,k);jd(j,k,s);Kd.add(j);j.Qc().then((EB){i.complete(j);},onError:(rF o){i.completeError(new rF("include/import: ${o}"));});},onError:(rF o){i.completeError(new rF("include/import: ${o}"));});return (i.future);}String kd(String g){int h=g.indexOf('/');if(h==-1)return (g);String j=g.substring(0,h);int i=g.substring(h+1).indexOf('/');if(i==-1)return (g);i+= h+1;String k=g.substring(h+1,i);if(j!='..'&&k=='..')return (kd(g.substring(i+1)));else return ("${g.substring(0,h+1)}${kd(g.substring(h+1))}");}void jd(final YB j,final YB k,final String h){if(h!=null&&Md[h]==null){String g=j.jG(h);if(g!=null)Md[h]=g;else if(k!=null){g=k.jG(h);if(g!=null)Md[h]=g;}}final String i=j.KE();if(i!=null&&i!=""){final String g=j.jG(i);if(g!=null)Md[i]=g;}}static Future<l> PQ(final String g){Completer<l> h=new Completer<l>();EG j=new EG();j.AL(g).then((sB k){h.complete(k.documentElement);},onError:(UD i){print("DaxeWXS: Error reading ${g}: ${i}");h.completeError(new rF("DaxeWXS: reading ${g}: ${i}"));});return (h.future);}static String MU(final String g){final int h=g.lastIndexOf("/");if(h==-1){return (null);}else{return (g.substring(0,h));}}List<FB> Pd(final String j,final String m){final List<FB> k=new List<FB>();if(j==null||j==""||j=="##any"){for(final FB g in gd)if(g.getName()!=null&&g.AI()==null&&!g.TH())k.add(g);}else if(j=="##local"){for(final FB g in gd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h==null||h==m)k.add(g);}}}else if(j=="##other"){for(final FB g in gd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h!=null&&h!=m)k.add(g);}}}else{final HashSet<String> i=new HashSet.from(j.split(new RegExp(r"\s+")));if(i.contains("##targetNamespace")){i.remove("##targetNamespace");i.add(m);}if(i.contains("##local")){i.remove("##local");i.add("");}for(final FB g in gd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h!=null&&i.contains(h))k.add(g);}}}return (k);}static String ZE(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (g);return (g.substring(h+1));}static String aE(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (null);else return (g.substring(0,h));}static List<String> sG(final String g,final l h){final String i=h.YD(aE(g));final String j=h.pB;if(ZE(g)=="boolean"&&j==i){final List<String> k=["true","false","1","0"];return (k);}return (null);}String Rd(final FB g){if(hd[g.getName()]!=null)return (hd[g.getName()]);else return (g.getName());}}abstract class TD{void BC(final YB g,final vB h);List<FB> JD();List<FB> XC();String ZD();bool TE(final FB g);bool mD(final FB g);int VE(final List<FB> g,final int h,final bool i);bool eD();}abstract class sC{List<FB> fC();}class gN extends FG implements pL{gN(final sB g,final String h){nodeName="#comment";nodeValue=h;nodeType=AB.DK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}String toString(){return ("<!--${nodeValue}-->");}}abstract class oL extends AB{String target;String data;}class cN extends FG implements oL{String target;String data;cN(final sB i,final String g,final String h){this.target=g;this.data=h;nodeName=g;nodeValue=h;nodeType=AB.CK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=i;pB=null;EC=null;localName=null;}String toString(){return ("<?${target} ${data}?>");}}abstract class nL extends zJ{}class eN extends FG implements nL{eN(final sB g,final String h){nodeName="#cdata-section";nodeValue=h;nodeType=AB.BK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}String toString(){String g=nodeValue;if(g==null)g='';return ("<![CDATA[${g}]]>");}}abstract class AB{static const int FE=1;static const int SQ=2;static const int kE=3;static const int BK=4;static const int TQ=5;static const int UQ=6;static const int CK=7;static const int DK=8;static const int FK=9;static const int qL=10;static const int QU=11;static const int YQ=12;String nodeName;String nodeValue;int nodeType;AB parentNode;List<AB> childNodes;AB firstChild;AB lastChild;AB previousSibling;AB nextSibling;LinkedHashMap<String,lC> attributes;sB ownerDocument;String pB;String EC;String localName;AB insertBefore(AB g,AB h);AB gC(AB g);AB jB(AB g);bool hasChildNodes();String BP(String g);String YD(String g);}abstract class zJ extends AB{}class mL extends FG implements zJ{mL(final sB g,final String h){nodeName="#text";nodeValue=h;nodeType=AB.kE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}String toString(){return (FG.aQ(nodeValue));}}abstract class NU extends AB{}class fN extends FG implements NU{fN(final sB g,final String h){nodeName=h;nodeValue=null;nodeType=AB.TQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}String toString(){return ("&${nodeName};");}}abstract class pL extends AB{}class JC{String id;String BE;List<JC> cC;Object data;int position;JC.JZ(this.id,this.BE,this.position);JC.MZ(this.id,this.cC,this.position);String toString(){StringBuffer g=new StringBuffer();g.write("[${id}");if(BE!=null)g.write(" ${BE}");else{for(JC h in cC){g.write(' ');g.write(h);}}g.write(']');return (g.toString());}}abstract class kH extends AB{String name;String rI;String bJ;}class RQ extends FG implements kH{String name;String rI;String bJ;RQ(final String g,final String h,final String i){name=g;this.rI=h;this.bJ=i;nodeName=g;nodeValue=null;nodeType=AB.qL;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=null;pB=null;EC=null;localName=null;}String toString(){if(rI==null&&bJ!=null)return ('<!DOCTYPE ${name} SYSTEM "${bJ}">');if(rI!=null&&bJ!=null)return ('<!DOCTYPE ${name} PUBLIC "${rI}" "${bJ}">');if(rI!=null)return ('<!DOCTYPE ${name} PUBLIC "${rI}">');return ('<!DOCTYPE ${name}>');}}class xC extends tE{String id;xC(this.id);QC KG(String g,int h){return (null);}QC LG(List<JC> g,int h){if(g[h].id==id)return (new QC.KZ(1,[g[h]]));else return (null);}}class dG extends tE{List<tE> items;dG(this.items);QC KG(String h,int i){for(tE j in items){QC g=j.KG(h,i);if(g!=null)return (g);}return (null);}QC LG(List<JC> h,int i){for(tE j in items){QC g=j.LG(h,i);if(g!=null)return (g);}return (null);}}class NE extends tE{static const int iN=0;static const int jN=1;static const int PU=2;int repeat;tE item;NE.LZ(this.item){repeat=iN;}NE.OZ(this.item){repeat=jN;}NE.QZ(this.item){repeat=PU;}QC KG(String j,int k){if(repeat==iN){QC g=item.KG(j,k);if(g==null)return (new QC.HZ(0,''));else return (g);}StringBuffer h=null;int i=k;while(i<j.length){QC g=item.KG(j,i);if(g==null)break;if(h==null)h=new StringBuffer();h.write(g.kK);i=i+g.QG;}int o=i-k;if(o>0||repeat==jN){String m;if(h!=null)m=h.toString();else m='';return (new QC.HZ(o,m));}else return (null);}QC LG(List<JC> i,int j){if(repeat==iN){QC g=item.LG(i,j);if(g==null)return (new QC.KZ(0,new List<JC>()));else return (g);}List<JC> k=new List<JC>();int h=j;while(h<i.length){QC g=item.LG(i,h);if(g==null)break;k.addAll(g.ZH);h=h+g.QG;}int m=h-j;if(m>0||repeat==jN)return (new QC.KZ(m,k));else return (null);}}class mC extends tE{String RH=null;bool HS=false;bool IS=false;bool wV=false;List<String> lO=null;mC(this.RH);mC.NZ(){HS=true;}mC.PZ(){IS=true;}mC.RZ(this.lO);QC KG(String i,int h){String g=i[h];if(RH!=null){if(g==RH)return (new QC.HZ(1,g));}else if(HS){if('0123456789'.contains(g)){return (new QC.HZ(1,g));}}else if(IS){if('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'.contains(g))return (new QC.HZ(1,g));}else if(wV){return (new QC.HZ(1,g));}else if(lO!=null){for(String j in lO){if(h+j.length<=i.length&&j==i.substring(h,h+j.length))return (null);}return (new QC.HZ(1,g));}return (null);}QC LG(List<JC> g,int h){return (null);}}abstract class l extends AB{String tagName;String getAttribute(String g);void setAttribute(String g,String h);lC RM(String g);lC YS(lC g);List<AB> getElementsByTagName(String g);String getAttributeNS(String g,String h);void setAttributeNS(String g,String h,String i);lC SM(String g,String h);bool AC(String g);}class pD{String name;bool value;pD(this.name,this.value);}abstract class tE{QC KG(String g,int h);QC LG(List<JC> g,int h);}class DD extends tE{List<tE> items;DD(this.items);DD.IZ(String h){items=new List<tE>();for(int g=0;g<h.length;g++ )items.add(new mC(h[g]));}QC KG(String k,int m){StringBuffer g=null;int h=m;for(tE o in items){if(h>=k.length)return (null);QC i=o.KG(k,h);if(i==null)return (null);if(g==null)g=new StringBuffer();g.write(i.kK);h=h+i.QG;}int s=h-m;String j;if(g!=null)j=g.toString();else j='';return (new QC.HZ(s,j));}QC LG(List<JC> i,int j){List<JC> k=new List<JC>();int g=j;for(tE m in items){if(g>=i.length)return (null);QC h=m.LG(i,g);if(h==null)return (null);k.addAll(h.ZH);g=g+h.QG;}int o=g-j;return (new QC.KZ(o,k));}}class uE{String name;bool value;uE(this.name,this.value);}abstract class lC extends AB{String name;String value;bool HL;l WH;bool xO;}class EG{Future<sB> AL(String g,{bool disableCache: true}){Completer<sB> i=new Completer<sB>();HttpRequest h=new HttpRequest();if(disableCache){if(!g.contains('.php?')){Random m=new Random();String j="random_workaround=${m.nextDouble()}";if(g.contains('?'))g="${g}&${j}";else g="${g}?${j}";}}h.open('GET',g);h.onLoad.listen((ProgressEvent o){if(h.status!=200){i.completeError(new UD("Error reading ${g}",errorCode:h.status));return;}sB k;if(h.responseText==null){i.completeError(new UD("Error reading ${g}"));return;}try {k=parseFromString(h.responseText);}on UD catch (s){i.completeError(new UD("Error reading ${g}: ${s.message}"));return;}i.complete(k);});h.onError.listen((ProgressEvent o){i.completeError(new UD("Error reading ${g}"));});h.send();return (i.future);}sB parseFromString(String g){lN h=new lN();try {return (h.LP(g));}on Exception catch (i){throw new UD(i.toString());}}}class QC{int QG;String kK;List<JC> ZH;QC.HZ(this.QG,this.kK);QC.KZ(this.QG,this.ZH);}class eG extends FG implements l{String tagName;eG(final sB h,final String g){this.tagName=g;nodeName=g;nodeValue=null;nodeType=AB.FE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=h;pB=null;EC=null;localName=null;}eG.TZ(final sB i,final String j,final String g){tagName=g;nodeName=g;nodeValue=null;nodeType=AB.FE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=i;this.pB=j;int h=g.indexOf(":");if(h!=-1){EC=g.substring(0,h);localName=g.substring(h+1);}else{EC=null;localName=g;}}String getAttribute(String i){if(attributes==null)return ("");lC g=attributes[i];if(g==null)return ("");String h=g.nodeValue;if(h==null)return ("");return (h);}void setAttribute(String h,String i){if(attributes==null)attributes=new LinkedHashMap<String,lC>();lC g=attributes[h];if(g==null){g=new AK(ownerDocument,h);g.parentNode=this;g.WH=this;attributes[h]=g;}g.nodeValue=i;}lC RM(String g){if(attributes==null)return (null);return (attributes[g]);}lC YS(lC g){if(ownerDocument!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(attributes==null)attributes=new LinkedHashMap<String,lC>();g.parentNode=this;g.WH=this;attributes[g.name]=g;return (g);}List<AB> getElementsByTagName(String i){List<AB> g=new List<AB>();if(childNodes==null)return (g);for(AB h in childNodes){if(i=='*'||h.nodeName==i)g.add(h);if(h is l)g.addAll(h.getElementsByTagName(i));}return (g);}String getAttributeNS(String h,String i){if(attributes==null)return ("");for(lC g in attributes.values){if(g.pB==h&&g.localName==i){if(g.value==null)return ("");return (g.value);}}return ("");}void setAttributeNS(String m,String h,String o){if(attributes==null)attributes=new LinkedHashMap<String,lC>();String i,j;int k=h.indexOf(":");if(k!=-1){i=h.substring(0,k);j=h.substring(k+1);}else{i=null;j=h;}lC g=SM(m,j);if(g!=null){g.EC=i;g.nodeValue=o;return;}g=new AK.SZ(ownerDocument,m,h);g.parentNode=this;g.WH=this;g.nodeValue=o;attributes[h]=g;}lC SM(String h,String i){if(attributes==null)return (null);for(lC g in attributes.values){if(g.pB==h&&g.localName==i){return (g);}}return (null);}bool AC(String g){if(attributes==null)return (false);return (attributes[g]!=null);}String toString(){StringBuffer g=new StringBuffer();g.write("<${tagName}");if(attributes!=null){for(lC h in attributes.values){g.write(" ");g.write(h.toString());}}if(childNodes!=null&&childNodes.length>0){g.write(">");for(AB i in childNodes){g.write(i.toString());}g.write("</${tagName}>");}else{g.write("/>");}return (g.toString());}}abstract class dN extends AB{}class QQ extends FG implements dN{QQ(final sB g){nodeName="#document-fragment";nodeValue=null;nodeType=AB.QU;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}String toString(){StringBuffer g=new StringBuffer();for(AB h in childNodes){g.write(h.toString());}return (g.toString());}}class UD implements Exception{final String message;final int errorCode;const UD(this.message,{this.errorCode});String toString(){String g="DOMException";if(message!=null)g+= ": ${message}";if(errorCode!=null)g+= ": ${errorCode}";return (g);}}class yJ implements lH{yJ();sB createDocument(String g,String h,kH i){return (new hN(this,g,h,i));}}abstract class sB extends AB{lH implementation;l documentElement;String vO;String nF;bool hS;String VG;String aR;kH mK;l createElement(String g);dN createDocumentFragment();zJ wG(String g);pL YR(String g);nL XR(String g);oL ZR(String g,String h);List<AB> getElementsByTagName(String g);l createElementNS(String g,String h);AB adoptNode(AB g);}abstract class FG implements AB{static const int mH=1;static const int kN=2;static const int VQ=6;static const int tF=9;static const int WQ=10;static const int XQ=11;static const int ZQ=12;String nodeName;String nodeValue;int nodeType;AB parentNode;List<AB> childNodes;AB firstChild;AB lastChild;AB previousSibling;AB nextSibling;LinkedHashMap<String,lC> attributes;sB ownerDocument;String pB;String EC;String localName;AB insertBefore(AB g,AB h){if(childNodes==null||!childNodes.contains(h))throw new UD("NOT_FOUND_ERR");ld(g);if(nodeType==tF&&g.nodeType==mH&&(this as sB).documentElement!=null)throw new UD("HIERARCHY_REQUEST_ERR");if(childNodes==null)childNodes=new List<AB>();if(g.parentNode!=null)g.parentNode.gC(g);g.parentNode=this;if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=g;if(firstChild==h)firstChild=g;g.nextSibling=h;g.previousSibling=h.previousSibling;return (g);}AB gC(AB g){if(childNodes==null||!childNodes.contains(g))throw new UD("NOT_FOUND_ERR");if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=null;if(firstChild==g)firstChild=g.nextSibling;if(lastChild==g)lastChild=g.previousSibling;if(g.previousSibling!=null)g.previousSibling.nextSibling=g.nextSibling;if(g.nextSibling!=null)g.nextSibling.previousSibling=g.previousSibling;g.parentNode=null;childNodes.remove(g);return (g);}AB jB(AB g){ld(g);if(nodeType==tF&&g.nodeType==mH&&(this as sB).documentElement!=null)throw new UD("HIERARCHY_REQUEST_ERR");if(childNodes==null)childNodes=new List<AB>();if(g.parentNode!=null)g.parentNode.gC(g);g.parentNode=this;if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=g;g.nextSibling=null;if(firstChild==null){g.previousSibling=null;firstChild=g;lastChild=g;}else{lastChild.nextSibling=g;g.previousSibling=lastChild;lastChild=g;}childNodes.add(g);return (g);}bool hasChildNodes(){return (firstChild!=null);}String BP(String g){if(g==null||g==''){return (null);}switch (nodeType){case mH:return (md(g));case tF:return (((this as sB).documentElement as eG).md(g));case VQ:case ZQ:case XQ:case WQ:return (null);case kN:if((this as lC).WH!=null){return (((this as lC).WH as eG).md(g));}return null;default:if(parentNode!=null){return ((parentNode as eG).md(g));}return (null);}}md(final String g){final RegExp i=new RegExp(r"/^xmlns:(.*)$/");if(g!=null&&this.pB==g&&EC!=null&&YD(EC)==g){return (EC);}if(attributes!=null){for(lC h in attributes.values){if(i.hasMatch(h.name)&&h.value==g&&YD(h.localName)==g){return (localName);}}}if(parentNode!=null){return ((parentNode as eG).md(g));}return null;}String YD(String h){switch (nodeType){case mH:if(pB!=null&&this.EC==h){return (pB);}if(attributes!=null){for(lC g in attributes.values){if(g.EC=='xmlns'&&g.localName==h){if(g.value!=null&&g.value!=''){return (g.value);}return (null);}else if(g.localName=='xmlns'&&h==null){if(g.value!=null&&g.value!=''){return (g.value);}return (null);}}}if(parentNode!=null&&parentNode.nodeType!=tF){return parentNode.YD(h);}return null;case tF:return ((this as sB).documentElement.YD(h));case VQ:case ZQ:case WQ:case XQ:return (null);case kN:if(parentNode!=null)return (parentNode.YD(h));return (null);default:if(parentNode!=null)return (parentNode.YD(h));return (null);}}ld(AB g){if(nodeType!=tF&&ownerDocument!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(nodeType==tF&&this!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(nodeType!=mH&&nodeType!=tF)throw new UD("HIERARCHY_REQUEST_ERR");if(g.nodeType==tF)throw new UD("HIERARCHY_REQUEST_ERR");if(nodeType!=tF&&g.nodeType==kN)throw new UD("HIERARCHY_REQUEST_ERR");AB h=this;while(h!=null){if(g==h)throw new UD("HIERARCHY_REQUEST_ERR");h=h.parentNode;}}static String aQ(String g){g=g.replaceAll('&','&amp;');g=g.replaceAll('"','&quot;');g=g.replaceAll('<','&lt;');g=g.replaceAll('>','&gt;');return (g);}}abstract class lH{sB createDocument(String g,String h,kH i);}class hN extends FG implements sB{lH implementation;l documentElement;String vO;String nF;bool hS;String VG;String aR;kH mK;HashMap<String,l> nd;hN(final lH i,final String h,final String g,final kH j){this.implementation=i;vO=null;nF="UTF-8";hS=false;VG="1.0";aR=null;this.mK=j;nd=new HashMap<String,l>();nodeName="#document";nodeValue=null;nodeType=AB.FK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=null;this.pB=null;EC=null;localName=null;if(g!=null){if(h!=null)documentElement=new eG.TZ(this,h,g);else documentElement=new eG(this,g);documentElement.parentNode=this;}}l createElement(String g){return (new eG(this,g));}dN createDocumentFragment(){return (new QQ(this));}zJ wG(String g){return (new mL(this,g));}pL YR(String g){return (new gN(this,g));}nL XR(String g){return (new eN(this,g));}oL ZR(String g,String h){return (new cN(this,g,h));}List<AB> getElementsByTagName(String h){List<AB> i=new List<AB>();for(AB g in childNodes){if(h=='*'||g.nodeName==h)i.add(g);if(g is l)i.addAll(g.getElementsByTagName(h));}return (i);}l createElementNS(String g,String h){return (new eG.TZ(this,g,h));}AB adoptNode(AB g){if(g.nodeType==AB.FK||g.nodeType==AB.qL||g.nodeType==AB.UQ||g.nodeType==AB.YQ)throw new UD("NOT_SUPPORTED_ERR");if(g.parentNode!=null){g.parentNode.gC(g);}if(g is lC){lC h=g;h.WH=null;h.HL=true;}od(g);return (g);}void od(AB g){g.ownerDocument=this;if(g.attributes!=null){List<String> j=new List<String>();for(lC i in g.attributes.values){if(i.HL)i.ownerDocument=this;else j.add(i.name);}for(String k in j){g.attributes.remove(k);}}if(g.childNodes!=null){for(AB h in g.childNodes){if(h.nodeType!=AB.qL&&h.nodeType!=AB.UQ&&h.nodeType!=AB.YQ)od(h);}}}String toString(){StringBuffer g=new StringBuffer();g.write("<?xml");if(VG!=null)g.write(' version="${VG}"');if(nF!=null)g.write(' encoding="${nF}"');g.writeln("?>");if(mK!=null)g.write(mK.toString());for(AB h in childNodes){g.write(h.toString());}return (g.toString());}}typedef void OU(Token);class tB extends tE{String id;List<uE> conditions;List<pD> changes;tE content;bool ignore;OU action;EK qK;tB(this.id,this.content,{this.conditions: null,this.changes: null,this.ignore: false,this.action: null});QC KG(String m,int j){if(!qK.SR(this))return (null);QC g=content.KG(m,j);if(g==null)return (null);JC h=new JC.JZ(id,g.kK,j);if(action!=null)action(h);qK.QR(this);List<JC> i;if(ignore)i=new List<JC>();else i=[h];QC k=new QC.KZ(g.QG,i);if(!ignore)k.kK=h.BE;return (k);}QC LG(List<JC> j,int k){if(!qK.SR(this))return (null);QC g=content.LG(j,k);if(g==null)return (null);JC i=new JC.MZ(id,g.ZH,g.ZH[0].position);if(action!=null)action(i);qK.QR(this);List<JC> h;if(ignore)h=new List<JC>();else h=[i];QC m=new QC.KZ(g.QG,h);return (m);}String toString(){return (id);}}class AK extends FG implements lC{bool HL;l WH;bool xO;AK(final sB g,final String h){HL=true;WH=null;xO=false;nodeName=h;nodeValue=null;nodeType=AB.SQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;pB=null;EC=null;localName=null;}AK.SZ(final sB h,final String i,final String j){HL=true;WH=null;xO=false;nodeName=j;nodeValue=null;nodeType=AB.SQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=h;this.pB=i;int g=name.indexOf(":");if(g!=-1){EC=name.substring(0,g);localName=name.substring(g+1);}else{EC=null;localName=name;}}String get name{return (nodeName);}void set name(String g){nodeName=g;}String get value{return (nodeValue);}void set value(String g){nodeValue=g;}String toString(){return ('${nodeName}="${FG.aQ(nodeValue)}"');}}class lN{List<tB> XD;List<tB> oF;sB nE;lN(){pd();}pd(){XD=new List<tB>();uE v=new uE('in_tag',true);XD.add(new tB('CDATA_SECTION_OPEN',new DD.IZ('<![CDATA['),conditions:[new uE('in_cdata_section',false)],changes:[new pD('in_cdata_section',true)]));XD.add(new tB('CDATA_SECTION_DATA',new NE.QZ(new mC.RZ([']]>'])),conditions:[new uE('in_cdata_section',true)]));XD.add(new tB('CDATA_SECTION_CLOSE',new DD.IZ(']]>'),conditions:[new uE('in_cdata_section',true)],changes:[new pD('in_cdata_section',false)]));XD.add(new tB('COMMENT_OPEN',new DD.IZ('<!--'),changes:[new pD('in_comment',true)]));XD.add(new tB('COMMENT_CLOSE',new DD.IZ('-->'),conditions:[new uE('in_comment',true)],changes:[new pD('in_comment',false)]));XD.add(new tB('COMMENT_DATA',new NE.QZ(new mC.RZ(['-->'])),conditions:[new uE('in_comment',true)]));XD.add(new tB('DOC_DECL_OPEN',new DD.IZ('<?xml'),changes:[new pD('in_tag',true),new pD('in_decl',true)]));XD.add(new tB('DOC_DECL_CLOSE',new DD.IZ('?>'),conditions:[new uE('in_decl',true)],changes:[new pD('in_tag',false),new pD('in_decl',false)]));XD.add(new tB('DOCTYPE_OPEN',new DD.IZ('<!DOCTYPE'),changes:[new pD('in_tag',true),new pD('in_doctype',true)]));XD.add(new tB('DOCTYPE_CLOSE',new DD.IZ('>'),conditions:[new uE('in_doctype',true)],changes:[new pD('in_tag',false),new pD('in_doctype',false)]));XD.add(new tB('PI_OPEN',new DD.IZ('<?'),changes:[new pD('in_pi',true)]));tE jS=new dG([new mC.PZ(),new mC('_'),new mC(':')]);tE tD=new dG([new mC.PZ(),new mC.NZ(),new mC('.'),new mC('-'),new mC('_'),new mC(':')]);XD.add(new tB('PI_TARGET',new DD([jS,new NE.OZ(tD)]),conditions:[new uE('in_pi',true),new uE('pi_after_target',false)],changes:[new pD('pi_after_target',true)]));XD.add(new tB('PI_DATA',new NE.QZ(new mC.RZ(['?>'])),conditions:[new uE('pi_after_target',true)]));XD.add(new tB('PI_CLOSE',new DD.IZ('?>'),conditions:[new uE('in_pi',true)],changes:[new pD('in_pi',false),new pD('pi_after_target',false)]));XD.add(new tB('TAG_END_OPEN',new DD.IZ('</'),changes:[new pD('in_tag',true)]));XD.add(new tB('TAG_START_OPEN',new mC('<'),changes:[new pD('in_tag',true)]));XD.add(new tB('TAG_CLOSE',new mC('>'),conditions:[v],changes:[new pD('in_tag',false)]));XD.add(new tB('TAG_EMPTY_CLOSE',new DD.IZ('/>'),conditions:[v],changes:[new pD('in_tag',false)]));XD.add(new tB('ATTR_EQ',new mC('='),conditions:[v]));tB EB=new tB('ENTITY_REF',new DD([new mC('&'),new NE.QZ(new dG([new mC('#'),new mC.NZ(),new mC.PZ()])),new mC(';')]),action:(JC g){String h=g.BE;h=h.substring(1,h.length-1);if(h.startsWith('#')){int JB;if(h[1]=='x'){h=h.substring(2);JB=int.parse(h,radix:16);}else{h=h.substring(1);JB=int.parse(h);}String k=new String.fromCharCode(JB);g.BE=new String.fromCharCode(JB);}else{String k=null;if(h=='amp')k='&';else if(h=='lt')k='<';else if(h=='gt')k='>';else if(h=='apos')k="'";else if(h=='quot')k='"';if(k!=null){g.BE=k;}else{}}});XD.add(EB);XD.add(new tB('ATTR_VALUE',new dG([new DD([new mC('"'),new NE.OZ(new dG([new mC.RZ(['"','&','<']),EB])),new mC('"')]),new DD([new mC("'"),new NE.OZ(new dG([new mC.RZ(["'",'&','<']),EB])),new mC("'")])]),conditions:[v]));XD.add(new tB('PCDATA',new NE.QZ(new mC.RZ(['<','&'])),conditions:[new uE('in_tag',false)]));XD.add(new tB('GENERIC_ID',new DD([jS,new NE.OZ(tD)]),conditions:[v]));XD.add(new tB('WHITE',new dG([new mC(' '),new mC('\n'),new mC('\r'),new mC('\t')]),conditions:[v],ignore:true));oF=new List<tB>();tB QB=new tB('ATTRIBUTE',new DD([new xC('GENERIC_ID'),new xC('ATTR_EQ'),new xC('ATTR_VALUE')]),action:(JC g){String m=g.cC[0].BE;String cB=g.cC[2].BE;cB=cB.substring(1,cB.length-1);lC j=new AK.SZ(nE,null,m);j.value=cB;g.data=j;});oF.add(new tB('DOC_DECL',new DD([new xC('DOC_DECL_OPEN'),new NE.OZ(QB),new xC('DOC_DECL_CLOSE')]),action:(JC g){int QD=g.cC.length-2;if(QD>0){for(int i=1;i<g.cC.length-1;i++ ){Object h=g.cC[i].data;if(h is lC){lC j=h;if(j.name=='version')nE.VG=j.value;else if(j.name=='encoding'){nE.nF=j.value;nE.vO=j.value;}}}}}));oF.add(new tB('DOCTYPE',new DD([new xC('DOCTYPE_OPEN'),new NE.QZ(new dG([new xC('GENERIC_ID'),new xC('ATTR_VALUE')])),new xC('DOCTYPE_CLOSE')]),action:(JC g){String m=g.cC[1].BE;String SB=null;String BB=null;for(int i=2;i<g.cC.length-1;i++ ){if(g.cC[i].id=='GENERIC_ID'&&g.cC[i].BE=='PUBLIC'&&i<g.cC.length-2&&g.cC[i+1].id=='ATTR_VALUE'){SB=g.cC[i+1].BE;SB=SB.substring(1,BB.length-1);}else if(g.cC[i].id=='GENERIC_ID'&&g.cC[i].BE=='SYSTEM'&&i<g.cC.length-2&&g.cC[i+1].id=='ATTR_VALUE'){BB=g.cC[i+1].BE;BB=BB.substring(1,BB.length-1);}}kH qE=new RQ(m,SB,BB);qE.ownerDocument=nE;g.data=qE;}));oF.add(new tB('OUTSIDE_ROOT',new xC('PCDATA'),ignore:true));tB MF=new tB('START_TAG',new DD([new xC('TAG_START_OPEN'),new xC('GENERIC_ID'),new NE.OZ(QB),new xC('TAG_CLOSE')]));tB WG=new tB('END_TAG',new DD([new xC('TAG_END_OPEN'),new xC('GENERIC_ID'),new xC('TAG_CLOSE')]));tB NI=new tB('EMPTY_ELEMENT',new DD([new xC('TAG_START_OPEN'),new xC('GENERIC_ID'),new NE.OZ(QB),new xC('TAG_EMPTY_CLOSE')]));tB eJ=new tB('COMMENT',new DD([new xC('COMMENT_OPEN'),new NE.LZ(new xC('COMMENT_DATA')),new xC('COMMENT_CLOSE')]),action:(JC g){String h;if(g.cC.length==3)h=g.cC[1].BE;else h='';g.data=new gN(nE,h);});tB fJ=new tB('ENTITY_REF',new DD([new xC('ENTITY_REF')]),action:(JC g){String h=g.cC[0].BE;if(h.startsWith('&')&&h.length>1){h=h.substring(1,h.length-1);fN EB=new fN(nE,h);g.data=EB;}else{g.data=new mL(nE,h);}});tB ML=new tB('CDATA',new DD([new xC('CDATA_SECTION_OPEN'),new NE.LZ(new xC('CDATA_SECTION_DATA')),new xC('CDATA_SECTION_CLOSE')]),action:(JC g){String h;if(g.cC.length==3)h=g.cC[1].BE;else h='';g.data=new eN(nE,h);});tB kS=new tB('PI',new DD([new xC('PI_OPEN'),new xC('PI_TARGET'),new NE.LZ(new xC('PI_DATA')),new xC('PI_CLOSE')]),action:(JC g){String xW=g.cC[1].BE;String h;if(g.cC.length==4)h=g.cC[2].BE.replaceAll(new RegExp(r"^\s+"),'');else h='';g.data=new cN(nE,xW,h);});tB CC=new tB('ELEMENT',null,action:(JC g){bool lS=(g.cC[0].id=='EMPTY_ELEMENT');JC hB=g.cC[0];String m=hB.cC[1].BE;if(!lS){JC yW=g.cC[g.cC.length-1];String mS=yW.cC[1].BE;if(mS!=m)throw new Exception("End tag not matching start tag: ${mS} != ${m}");}l s=new eG.TZ(nE,null,m);int QD=hB.cC.length-3;if(QD>0){for(int i=2;i<hB.cC.length-1;i++ ){Object h=hB.cC[i].data;if(h is lC)s.YS(h);}}if(!lS){int zW=g.cC.length-2;if(zW>0){for(int i=1;i<g.cC.length-1;i++ ){JC IC=g.cC[i];if(IC.id=='PCDATA'){zJ AX=new mL(nE,IC.BE);s.jB(AX);}else{Object h=IC.data;if(h is AB)s.jB(h);}}for(AB o=s.firstChild;o!=null;o=o.nextSibling){if(o.nodeType==AB.kE){AB HB=o.nextSibling;while(HB!=null&&HB.nodeType==AB.kE){o.nodeValue+= HB.nodeValue;s.gC(HB);HB=o.nextSibling;}}}}}g.data=s;});CC.content=new dG([new DD([MF,new NE.OZ(new dG([CC,eJ,new xC('PCDATA'),fJ,ML,kS])),WG]),NI]);oF.add(CC);oF.add(QB);oF.add(MF);oF.add(WG);oF.add(NI);oF.add(eJ);oF.add(fJ);oF.add(ML);oF.add(kS);}sB LP(String h){h=h.replaceAll('\r\n','\n');lH k=new yJ();nE=new hN(k,null,null,null);EK i=new EK(XD);List<JC> j=i.LP(h);i=new EK(oF);j=i.NW(j);for(JC m in j){Object g=m.data;if(g is kH)nE.mK=g;else if(g is AB)nE.jB(g);}if(nE.documentElement!=null)qd(nE.documentElement);return (nE);}void qd(l g){if(g.attributes!=null){for(lC i in g.attributes.values){if(i.name=='xmlns'||(i.EC=='xmlns'&&i.localName==g.EC)){g.pB=i.value;break;}}}if(g.pB==null&&g.parentNode!=null)g.pB=g.parentNode.YD(g.EC);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l)qd(h as l);}}}class EK{List<tB> rules;HashMap<String,bool> jM;EK(this.rules){for(tB g in rules)g.qK=this;}List<JC> LP(String i){List<JC> j=new List<JC>();jM=new HashMap<String,bool>();int g=0;while(g<i.length){int k=g;for(tB m in rules){QC h=m.KG(i,g);if(h==null)continue;g+= h.QG;if(h.ZH.length>0){assert(h.QG!=0);j.addAll(h.ZH);break;}}if(k==g){throw new UD("parser blocking at character ${g}: ${i.substring(g,min(g+10,i.length))}");}}return (j);}List<JC> NW(List<JC> i){List<JC> j=new List<JC>();jM=new HashMap<String,bool>();int g=0;while(g<i.length){int k=g;for(tB m in rules){QC h=m.LG(i,g);if(h==null)continue;g+= h.QG;if(h.ZH.length>0){assert(h.QG!=0);j.addAll(h.ZH);break;}}if(k==g){throw new UD("parser blocking at character ${i[g].position}");}}return (j);}bool SR(tB h){if(h.conditions==null)return (true);bool j=false;for(uE i in h.conditions){bool g=jM[i.name];if(g==null)g=false;if(g!=i.value)return (false);}return (true);}void QR(tB g){if(g.changes==null)return;for(pD h in g.changes){jM[h.name]=h.value;}}}class mN{static String nN;static String oN='en_US';static String RU(String g){if(g==null)return SU();if(g=="C")return "en_ISO";if(g.length<5)return g;if(g[2]!='-'&&(g[2]!='_'))return g;var h=g.substring(3);if(h.length<=3)h=h.toUpperCase();return '${g[0]}${g[1]}_${h}';}static String SU(){if(nN==null)nN=oN;return nN;}}Future<String> bQ(){mN.oN=mN.RU(window.navigator.language);return new Future.value(mN.oN);}